📂 KODTRÄD
==========
├── Documents
│   ├── KLR_AI
│   │   ├── Projekt_MacSpot
│   │   │   ├── macspot-api
│   │   │   │   ├── AllSyncCodes_history
│   │   │   │   │   ├── 🏠_lokal_temp.txt
│   │   │   │   │   ├── 🧊_azure_temp.txt
│   │   │   │   │   ├── 🧮_diff_output.txt
│   │   │   │   ├── healthcheck_sync.py
│   │   │   │   ├── sync.py
│   │   │   │   ├── sync_all.py
│   │   │   │   ├── sync_from_cloud.py
│   │   │   │   ├── sync_generate_fromcloud_pending.py
│   │   │   │   ├── sync_generate_pending_from_diff.py
│   │   │   │   ├── sync_plist.xml
│   │   │   │   ├── sync_static_tables.py
│   │   │   │   ├── sync_to_cloud.py
├── Library
│   ├── LaunchAgents
│   │   ├── com.macspot.sync.plist
==========

====================
📄 Fil: Documents/KLR_AI/Projekt_MacSpot/macspot-api/sync_from_cloud.py
📂 Kodtyp: 📄 Övrigt
🗂 Filtyp: 🐍 Python
📅 Senast ändrad: 2025-06-02 20:29:53
📏 Antal rader: 117
🧩 Antal funktioner: 0
💬 Kommentarstäckning: 0 rader (0.0%)
📥 Imports: 2 – ['import psycopg2', 'import json']
🔍 Längsta funktion: 0 rader
🧠 Komplexitetspoäng: 16
🧪 TODO/FIXME: 0
====================
START: sync_from_cloud.py
import psycopg2
import json
from config import LOCAL_DB_CONFIG, REMOTE_DB_CONFIG

def connect_db(config):
    return psycopg2.connect(**config)

def safe_json_load(data, default={}):
    try:
        return json.loads(data) if isinstance(data, str) else data
    except Exception:
        return default

def metadata_equal(meta1, meta2):
    m1 = safe_json_load(meta1)
    m2 = safe_json_load(meta2)
    return m1 == m2

def apply_change(cur, table, operation, payload):
    try:
        if operation == "INSERT":
            cols = ", ".join(payload.keys())
            placeholders = ", ".join(["%s"] * len(payload))
            sql = f"INSERT INTO {table} ({cols}) VALUES ({placeholders}) ON CONFLICT (id) DO NOTHING"
            cur.execute(sql, [json.dumps(v) if isinstance(v, dict) else v for v in payload.values()])

        elif operation == "UPDATE":
            sets = ", ".join([f"{col} = %s" for col in payload if col != "id"])
            values = [json.dumps(payload[col]) if isinstance(payload[col], dict) else payload[col]
                      for col in payload if col != "id"]
            values.append(payload["id"])
            sql = f"UPDATE {table} SET {sets} WHERE id = %s"
            cur.execute(sql, values)

        elif operation == "DELETE":
            cur.execute(f"DELETE FROM {table} WHERE id = %s", [payload["id"]])
            print(f"🗑️ Raderade post {payload['id']} från {table}")

    except Exception as e:
        print(f"❌ Fel i apply_change för {table} ({operation}): {e}")
        raise

def sync():
    remote_conn = connect_db(REMOTE_DB_CONFIG)
    remote_cur = remote_conn.cursor()

    local_conn = connect_db(LOCAL_DB_CONFIG)
    local_cur = local_conn.cursor()

    try:
        remote_cur.execute("""
            SELECT id, table_name, record_id, operation, payload
            FROM (
                SELECT *, ROW_NUMBER() OVER (PARTITION BY record_id ORDER BY created_at ASC) AS rn
                FROM pending_changes
                WHERE direction = 'out' AND processed = false
                  AND table_name IN ('contact', 'bookings')
            ) sub
            WHERE rn = 1
            ORDER BY created_at ASC, id
        """)
        rows = remote_cur.fetchall()

        remote_cur.execute("""
            DELETE FROM pending_changes
            WHERE id NOT IN (
                SELECT id FROM (
                    SELECT id, ROW_NUMBER() OVER (PARTITION BY record_id ORDER BY created_at ASC) AS rn
                    FROM pending_changes
                    WHERE direction = 'out' AND processed = false
                ) sub
                WHERE rn = 1
            ) AND direction = 'out' AND processed = false AND operation = 'UPDATE';
        """)

        count = 0
        for row in rows:
            change_id, table, record_id, operation, payload_json = row
            try:
                payload = safe_json_load(payload_json)
                # Removed 'if not isinstance(payload.get("id"), str)' check per instructions

                apply_change(local_cur, table, operation, payload)

                if table == "bookings" and operation == "INSERT":
                    local_cur.execute("""
                        UPDATE pending_changes
                        SET booking_id = %s
                        WHERE record_id = %s AND table_name = 'bookings' AND booking_id IS NULL
                    """, (record_id, record_id))

                # Simplified kontaktimport log
                if table == "contact":
                    print(f"📥 Importerad kontakt: {payload.get('booking_email', '(okänd e-post)')}")

                local_cur.execute("""
                    INSERT INTO event_log (id, source, event_type, payload, received_at)
                    VALUES (gen_random_uuid(), %s, %s, %s, now())
                """, ('sync', f"{operation.lower()}_{table}", json.dumps(payload)))

                remote_cur.execute("UPDATE pending_changes SET processed = true WHERE id = %s", [change_id])
                remote_conn.commit()
                local_conn.commit()
                count += 1

            except Exception as e:
                print(f"❌ Fel vid synk för {table} (id={change_id}): {e}")
                continue

    finally:
        local_cur.close()
        remote_cur.close()
        local_conn.close()
        remote_conn.close()

if __name__ == "__main__":
    sync()
END: sync_from_cloud.py

====================
📄 Fil: Documents/KLR_AI/Projekt_MacSpot/macspot-api/sync_to_cloud.py
📂 Kodtyp: 📄 Övrigt
🗂 Filtyp: 🐍 Python
📅 Senast ändrad: 2025-06-02 21:04:35
📏 Antal rader: 151
🧩 Antal funktioner: 0
💬 Kommentarstäckning: 0 rader (0.0%)
📥 Imports: 2 – ['import psycopg2', 'import json']
🔍 Längsta funktion: 0 rader
🧠 Komplexitetspoäng: 16
🧪 TODO/FIXME: 0
====================
START: sync_to_cloud.py
import psycopg2
import json
from datetime import datetime, timezone
from config import LOCAL_DB_CONFIG, REMOTE_DB_CONFIG

def connect_db(config):
    return psycopg2.connect(**config)

def safe_json_load(data, default={}):
    try:
        return json.loads(data) if isinstance(data, str) else data
    except Exception:
        return default


def fetch_pending_changes(conn):
    with conn.cursor() as cur:
        cur.execute("""
            SELECT id, table_name, record_id, operation, payload
            FROM pending_changes
            WHERE processed = false AND direction = 'out'
            ORDER BY created_at ASC
        """)
        return cur.fetchall()

def get_table_columns(conn, table_name):
    with conn.cursor() as cur:
        cur.execute("""
            SELECT column_name FROM information_schema.columns
            WHERE table_name = %s
        """, (table_name,))
        return [row[0] for row in cur.fetchall()]

def build_insert_sql(table_name, payload):
    cols = ", ".join(payload.keys())
    placeholders = ", ".join(["%s"] * len(payload))
    return f"INSERT INTO {table_name} ({cols}) VALUES ({placeholders}) ON CONFLICT (id) DO NOTHING", list(payload.values())

def build_update_sql(table_name, payload):
    cleaned_payload = {k: v for k, v in payload.items() if k != "id"}

    set_clause = ", ".join([f"{k} = %s" for k in cleaned_payload])
    values = [
        json.dumps(v) if isinstance(v, dict) else v
        for v in cleaned_payload.values()
    ]
    values.append(payload["id"])
    return f"UPDATE {table_name} SET {set_clause} WHERE id = %s", values

def sync():
    local_conn = connect_db(LOCAL_DB_CONFIG)
    remote_conn = connect_db(REMOTE_DB_CONFIG)

    try:
        # Hämta tillåtna kolumner för varje tabell
        allowed_columns = {
            'contact': get_table_columns(remote_conn, 'contact'),
            'bookings': get_table_columns(remote_conn, 'bookings')
        }

        changes = fetch_pending_changes(local_conn)
        print(f"📦 {len(changes)} ändringar att synka...")

        for change in changes:
            change_id, table_name, record_id, operation, payload_json = change
            print(f"🔄 Hanterar {operation} för {table_name} (ID: {record_id})")
            try:
                payload = json.loads(payload_json) if isinstance(payload_json, str) else payload_json
                # Filtrera payload till endast tillåtna kolumner
                payload = {k: v for k, v in payload.items() if k in allowed_columns.get(table_name, [])}
                with remote_conn.cursor() as cur:
                    if operation == "INSERT":
                        sql, values = build_insert_sql(table_name, payload)
                        cur.execute(sql, values)
                        print(f"✅ INSERT till {table_name} klar (ID: {record_id})")
                        # Logga till event_log
                        cur.execute("""
                            INSERT INTO event_log (id, source, event_type, payload, received_at)
                            VALUES (gen_random_uuid(), %s, %s, %s, now())
                        """, (
                            'sync',
                            f"sync_to_cloud_insert_{table_name}",
                            json.dumps({
                                "record_id": record_id,
                                "table": table_name,
                                "operation": operation,
                                "email": payload.get("booking_email", None)
                            })
                        ))

                    elif operation == "UPDATE":
                        sql, values = build_update_sql(table_name, payload)
                        cur.execute(sql, values)
                        if cur.rowcount == 0:
                            print(f"⚠️ UPDATE påverkade inga rader i {table_name} (ID: {record_id})")
                        else:
                            print(f"✅ UPDATE till {table_name} klar (ID: {record_id})")
                        # Verifiering av UPDATE
                        cur.execute(f"SELECT * FROM {table_name} WHERE id = %s", (record_id,))
                        after = cur.fetchone()
                        print(f"🔍 Verifiering av UPDATE för {table_name} ID: {record_id} → {after}")
                        # Logga till event_log
                        cur.execute("""
                            INSERT INTO event_log (id, source, event_type, payload, received_at)
                            VALUES (gen_random_uuid(), %s, %s, %s, now())
                        """, (
                            'sync',
                            f"sync_to_cloud_update_{table_name}",
                            json.dumps({
                                "record_id": record_id,
                                "table": table_name,
                                "operation": operation,
                                "email": payload.get("booking_email", None)
                            })
                        ))

                    elif operation == "DELETE":
                        cur.execute(f"DELETE FROM {table_name} WHERE id = %s", [record_id])
                        print(f"🗑️ DELETE från {table_name} klar (ID: {record_id})")
                        # Logga till event_log
                        cur.execute("""
                            INSERT INTO event_log (id, source, event_type, payload, received_at)
                            VALUES (gen_random_uuid(), %s, %s, %s, now())
                        """, (
                            'sync',
                            f"sync_to_cloud_delete_{table_name}",
                            json.dumps({
                                "record_id": record_id,
                                "table": table_name,
                                "operation": operation,
                                "email": payload.get("booking_email", None)
                            })
                        ))

                with local_conn.cursor() as local_cur:
                    local_cur.execute("UPDATE pending_changes SET processed = true WHERE id = %s", [change_id])
                    local_conn.commit()
                    print(f"📍 Markerat som bearbetad: {change_id}")

            except Exception as op_err:
                print(f"❌ Fel vid hantering av ändring ({operation}) för {table_name} – {op_err}")

    except Exception as e:
        print(f"❌ Fel under synk: {e}")

    finally:
        local_conn.close()
        remote_conn.close()

if __name__ == "__main__":
    sync()
END: sync_to_cloud.py

====================
📄 Fil: Documents/KLR_AI/Projekt_MacSpot/macspot-api/sync_static_tables.py
📂 Kodtyp: 📄 Övrigt
🗂 Filtyp: 🐍 Python
📅 Senast ändrad: 2025-04-24 17:01:52
📏 Antal rader: 61
🧩 Antal funktioner: 0
💬 Kommentarstäckning: 0 rader (0.0%)
📥 Imports: 2 – ['import psycopg2', 'import json']
🔍 Längsta funktion: 0 rader
🧠 Komplexitetspoäng: 6
🧪 TODO/FIXME: 0
====================
START: sync_static_tables.py
from config import LOCAL_DB_CONFIG, REMOTE_DB_CONFIG
import psycopg2
import json
from datetime import datetime


TABLES = ["translation", "booking_settings"]


def connect_db(config):
    return psycopg2.connect(**config)


def fetch_all_from_local(conn, table):
    with conn.cursor() as cur:
        cur.execute(f"SELECT * FROM {table}")
        colnames = [desc[0] for desc in cur.description]
        rows = cur.fetchall()
        return colnames, rows


def clear_remote_table(conn, table):
    with conn.cursor() as cur:
        cur.execute(f"DELETE FROM {table}")
        conn.commit()


def insert_to_remote(conn, table, columns, rows):
    with conn.cursor() as cur:
        placeholders = ', '.join(['%s'] * len(columns))
        colnames = ', '.join(columns)
        for row in rows:
            # Hantera jsonb-värden som json-strängar
            formatted_row = []
            for i, col in enumerate(columns):
                value = row[i]
                if table == 'booking_settings' and col == 'value':
                    formatted_row.append(json.dumps(value))
                else:
                    formatted_row.append(value)
            cur.execute(f"INSERT INTO {table} ({colnames}) VALUES ({placeholders})", formatted_row)
        conn.commit()


def sync_static_tables():
    local_conn = connect_db(LOCAL_DB_CONFIG)
    remote_conn = connect_db(REMOTE_DB_CONFIG)

    for table in TABLES:
        print(f"\n⏳ Synkar tabell: {table}...")
        columns, rows = fetch_all_from_local(local_conn, table)
        clear_remote_table(remote_conn, table)
        insert_to_remote(remote_conn, table, columns, rows)
        print(f"✅ Klar med tabell: {table} ({len(rows)} rader)")

    local_conn.close()
    remote_conn.close()


if __name__ == "__main__":
    sync_static_tables()

END: sync_static_tables.py

====================
📄 Fil: Documents/KLR_AI/Projekt_MacSpot/macspot-api/sync.py
📂 Kodtyp: 📄 Övrigt
🗂 Filtyp: 🐍 Python
📅 Senast ändrad: 2025-06-02 22:04:06
📏 Antal rader: 130
🧩 Antal funktioner: 0
💬 Kommentarstäckning: 0 rader (0.0%)
📥 Imports: 2 – ['import psycopg2', 'import json']
🔍 Längsta funktion: 0 rader
🧠 Komplexitetspoäng: 22
🧪 TODO/FIXME: 0
====================
START: sync.py
import psycopg2
import json
from config import LOCAL_DB_CONFIG, REMOTE_DB_CONFIG

def safe_json(data):
    return json.loads(data) if isinstance(data, str) else data


# Deep diff for metadata fields
def deep_metadata_diff(meta1, meta2):
    m1 = safe_json(meta1)
    m2 = safe_json(meta2)
    diffs = []
    all_keys = set(m1.keys()).union(m2.keys())
    for key in sorted(all_keys):
        v1 = m1.get(key)
        v2 = m2.get(key)
        if v1 != v2:
            diffs.append(f"    • metadata.{key}: lokal='{v1}' vs moln='{v2}'")
    return diffs

def connect_db(config):
    return psycopg2.connect(**config)

def fetch_contacts(conn):
    with conn.cursor() as cur:
        cur.execute("SELECT * FROM contact")
        colnames = [desc[0] for desc in cur.description]
        return {
            row[colnames.index("id")]: dict(zip(colnames, row))
            for row in cur.fetchall()
        }

def fetch_bookings(conn):
    with conn.cursor() as cur:
        cur.execute("SELECT * FROM bookings")
        colnames = [desc[0] for desc in cur.description]
        return {
            row[colnames.index("id")]: dict(zip(colnames, row))
            for row in cur.fetchall()
        }

def compare_and_print(local_data, cloud_data, label, local):
    print(f"\n📋 Jämför {label}...")
    for cid, local_item in sorted(local_data.items(), key=lambda item: item[1].get("booking_email", "")):
        cloud = cloud_data.get(cid)
        if not cloud:
            print(f"🆕 Finns lokalt men inte i molnet: {local_item.get('booking_email', '(okänd)')}")
            continue

        differences = []
        # Jämför varje fält i raden (förutom id)
        for key in local_item:
            if key == 'id':
                continue
            local_val = local_item[key]
            cloud_val = cloud.get(key)
            if key == 'metadata':
                meta_diffs = deep_metadata_diff(
                    safe_json(local_val),
                    safe_json(cloud_val)
                )
                if meta_diffs:
                    differences.append(f"  🔹 {key}: METADATA skiljer sig")
                    differences.extend(meta_diffs)
            elif local_val != cloud_val:
                if key == 'updated_at':
                    # Jämför även timestamp exakt
                    if local_val == cloud_val:
                        differences.append(f"  ⚠️ Mismatch i {key} men identisk updated_at – kontrollera dataintegritet")
                        with local.cursor() as cur:
                            cur.execute("""
                                INSERT INTO event_log (id, source, event_type, payload, received_at)
                                VALUES (gen_random_uuid(), %s, %s, %s, now())
                            """, (
                                'sync',
                                f"sync_warning_{label}",
                                json.dumps({
                                    "email": local_item.get("booking_email", "(okänd)"),
                                    "warning": f"MATCH updated_at men data skiljer sig",
                                    "field": key,
                                    "local": str(local_val),
                                    "cloud": str(cloud_val)
                                })
                            ))
                        local.commit()
                differences.append(f"  🔸 {key}: lokal='{local_val}' vs moln='{cloud_val}'")

        if differences:
            print(f"✏️ Skillnad för {local_item.get('booking_email', '(okänd)')}")
            for diff in differences:
                print(diff)

            with local.cursor() as cur:
                cur.execute("""
                    INSERT INTO event_log (id, source, event_type, payload, received_at)
                    VALUES (gen_random_uuid(), %s, %s, %s, now())
                """, (
                    'sync',
                    f"sync_local_diff_{label}",
                    json.dumps({
                        "email": local_item.get("booking_email", "(okänd)"),
                        "diff_summary": differences
                    })
                ))
            # Observera: sync.py lägger bara till diff i event_log – ingen ändring sker i pending_changes.
            local.commit()

    for cid, cloud in sorted(cloud_data.items(), key=lambda item: item[1].get("booking_email", "")):
        if cid in local_data:
            continue
        print(f"🆕 Finns i molnet men inte lokalt: {cloud.get('booking_email', '(okänd)')}")


if __name__ == "__main__":
    try:
        local = connect_db(LOCAL_DB_CONFIG)
        cloud = connect_db(REMOTE_DB_CONFIG)
    except Exception as e:
        print(f"❌ Fel vid databasanslutning: {e}")
        exit(1)
    local_contacts = fetch_contacts(local)
    cloud_contacts = fetch_contacts(cloud)
    compare_and_print(local_contacts, cloud_contacts, "contacts", local)

    local_bookings = fetch_bookings(local)
    cloud_bookings = fetch_bookings(cloud)
    compare_and_print(local_bookings, cloud_bookings, "bookings", local)
    local.close()
    cloud.close()

END: sync.py

====================
📄 Fil: Documents/KLR_AI/Projekt_MacSpot/macspot-api/sync_all.py
📂 Kodtyp: 📄 Övrigt
🗂 Filtyp: 🐍 Python
📅 Senast ändrad: 2025-06-02 22:20:02
📏 Antal rader: 239
🧩 Antal funktioner: 0
💬 Kommentarstäckning: 0 rader (0.0%)
📥 Imports: 7 – ['import os', 'import subprocess', 'import sys', 'import psycopg2', 'import json', 'import socket', 'import traceback']
🔍 Längsta funktion: 0 rader
🧠 Komplexitetspoäng: 26
🧪 TODO/FIXME: 0
====================
START: sync_all.py
BASE = "/Users/danielkallberg/Documents/KLR_AI/Projekt_MacSpot/macspot-api"


import os
import subprocess
from datetime import datetime, timezone
import sys
import psycopg2
import json

with open("/tmp/launchd_debug.txt", "a") as f:
    f.write("[sync_all.py] Körning initierad\n")


# Delad json- och metadata-funktionalitet som används i flera synkmoduler
def safe_json_load(data, default={}):
    try:
        return json.loads(data) if isinstance(data, str) else data
    except Exception:
        return default

def metadata_equal(meta1, meta2):
    m1 = safe_json_load(meta1)
    m2 = safe_json_load(meta2)
    return m1 == m2

log_dir = "/Users/danielkallberg/Documents/KLR_AI/Projekt_MacSpot"
log_out = os.path.join(log_dir, "macspot_sync.log")
log_err = os.path.join(log_dir, "macspot_sync_error.log")

# Se till att loggfilerna existerar
for path in [log_out, log_err]:
    if not os.path.exists(path):
        with open(path, 'w'):
            pass

# Skriv ut manuell/automatisk körningsinfo till loggen
is_manual = os.environ.get("LAUNCHD_RUN") != "true"
log_mode = "MANUELL" if is_manual else "AUTOMATISK (launchd)"
with open("/tmp/env_debug.txt", "a") as f:
    f.write(f"LAUNCHD_RUN: {os.environ.get('LAUNCHD_RUN')}\n")
# Debug environment variables to file
with open("/tmp/env_debug.txt", "w") as f:
    f.write(str(dict(os.environ)))
out = open(log_out, 'a')
err = open(log_err, 'a')
sys.stdout = out
sys.stderr = err
print(f"🚀 Körläge: {log_mode} – {datetime.now(timezone.utc).isoformat()}")

def run_script(name, script_path):
    subprocess.run(["/Users/danielkallberg/Documents/KLR_AI/venv/bin/python", f"{BASE}/{script_path}"], check=True)

try:
    start_time = datetime.now(timezone.utc)
    def is_database_online(host, port):
        import socket
        try:
            socket.create_connection((host, port), timeout=2)
            return True
        except:
            return False

    def run_healthcheck():
        try:
            subprocess.run(
                ["/Users/danielkallberg/Documents/KLR_AI/venv/bin/python", f"{BASE}/healthcheck_sync.py"],
                check=True
            )
        except Exception as e:
            print(f"❌ Healthcheck misslyckades: {e}")

    # Kontrollera att båda databaser är online innan sync startar
    if not is_database_online("localhost", 5433):
        print("❌ Lokal databas är inte tillgänglig (localhost:5433)")
        exit(1)

    if not is_database_online("macspotpg.postgres.database.azure.com", 5432):
        print("❌ Azure-databasen är inte tillgänglig (macspotpg.postgres.database.azure.com:5432)")
        exit(1)

    print(f"📌 Körning initierad: {datetime.now(timezone.utc).isoformat()}")

    print("🧪 Kör healthcheck_sync.py...")
    run_healthcheck()

    print(f"\n🔄 [{datetime.now(timezone.utc).strftime('%Y-%m-%d %H:%M:%S')}] Startar fullständig synk...")

    # Kör sync.py först
    run_script("🟡 Kör sync.py...", "sync.py")

    # Efter sync.py, kontrollera om det finns diffar i event_log
    # Efter sync.py, kontrollera om det finns diffar i event_log
    with psycopg2.connect(dbname="macspot", user="postgres", host="localhost", port=5433) as conn:
        with conn.cursor() as cur:
            cur.execute("""
                SELECT COUNT(*) FROM event_log
                WHERE received_at > now() - interval '5 minutes'
                  AND event_type IN ('sync_local_diff_contacts', 'sync_local_diff_bookings')
            """)
            diff_count = cur.fetchone()[0]
            if diff_count > 0:
                print(f"🚦 Det finns {diff_count} diff-loggar från sync.py – överväg att köra sync_to_cloud.py manuellt eller automatiskt.")
                print("⚙️ Kör sync_generate_pending_from_diff.py för att skapa riktiga pending_changes...")
                run_script("⚙️ Kör sync_generate_pending_from_diff.py...", "sync_generate_pending_from_diff.py")

    # Kör sync_to_cloud.py efter kontrollen
    run_script("🟢 Kör sync_to_cloud.py...", "sync_to_cloud.py")

    scripts_part2 = [
        ("🔵 Kör sync_from_cloud.py...", "sync_from_cloud.py")
    ]

    for msg, script in scripts_part2:
        run_script(msg, script)

    # Kör generate_fromcloud_pending.py om event_log innehåller sync_fromcloud_mismatch
    with psycopg2.connect(dbname="macspot", user="postgres", host="localhost", port=5433) as conn:
        with conn.cursor() as cur:
            cur.execute("""
                SELECT COUNT(*) FROM event_log
                WHERE received_at > now() - interval '5 minutes'
                  AND event_type IN ('sync_mismatch_contact', 'sync_fromcloud_mismatch')
            """)
            cloud_diff_count = cur.fetchone()[0]
            if cloud_diff_count > 0:
                print(f"🚦 Det finns {cloud_diff_count} moln→lokalt-diffar – kör sync_generate_fromcloud_pending.py...")
                run_script("⚙️ Kör sync_generate_fromcloud_pending.py...", "sync_generate_fromcloud_pending.py")

    today_prefix = datetime.now(timezone.utc).strftime('%Y%m%d')
    outbox_dir = os.path.join(BASE, 'sync_outbox')
    files = [f for f in os.listdir(outbox_dir) if f.startswith(today_prefix)]
    files_with_type = [f for f in files if len(f.split("_")) >= 3]
    num_changes = len(files_with_type)

    if num_changes == 0:
        print("ℹ️ Ingen förändring hittades att synka.")
        print("📭 Inga fler ändringar kvar i pending_changes.")
    else:
        print(f"📤 Totalt {num_changes} ändring(ar) skickades till molnet:")
        files = [f for f in sorted(os.listdir(outbox_dir)) if f.startswith(today_prefix)]
        summary = {}
        for f in files:
            parts = f.split("_")
            if len(parts) >= 3:
                typ = parts[2].split(".")[0]
                summary[typ] = summary.get(typ, 0) + 1

        if summary:
            print("🧾 Sammanfattning per typ:")
            for typ, count in summary.items():
                print(f"   • {typ}: {count} st")

        # --- Kontrollera och skriv ut äldre JSON-filer i sync_outbox ---
        old_files = [f for f in os.listdir(outbox_dir) if not f.startswith(today_prefix)]
        if old_files:
            print("📂 Äldre JSON-filer som ligger kvar i sync_outbox:")
            for f in old_files:
                print(f"   • {f}")

        print("📊 Kontroll av återstående ändringar i pending_changes...")

        # Lokalt
        local = psycopg2.connect(
            dbname="macspot",
            user="postgres",
            host="localhost",
            port=5433
        )
        cur_local = local.cursor()
        cur_local.execute("""
            SELECT COUNT(*) FROM pending_changes
            WHERE direction = 'out' AND processed = false
        """)
        out_local = cur_local.fetchone()[0]
        cur_local.execute("""
            SELECT COUNT(*) FROM pending_changes
            WHERE direction = 'out' AND processed = false
            GROUP BY record_id
        """)
        print(f"   • Lokalt → molnet: {out_local} ändring(ar) kvar över {cur_local.rowcount} kontakt(er).")
        cur_local.close()
        local.close()

        # Molnet
        cloud = psycopg2.connect(
            dbname="postgres",
            user="daniel",
            host="macspotpg.postgres.database.azure.com",
            port=5432
        )
        cur_cloud = cloud.cursor()
        cur_cloud.execute("""
            SELECT COUNT(*) FROM pending_changes
            WHERE direction = 'out' AND processed = false
        """)
        out_cloud = cur_cloud.fetchone()[0]
        cur_cloud.execute("""
            SELECT COUNT(*) FROM pending_changes
            WHERE direction = 'out' AND processed = false
            GROUP BY record_id
        """)
        cur_cloud.close()
        cloud.close()

    print(f"\n✅ [{datetime.now(timezone.utc).strftime('%Y-%m-%d %H:%M:%S')}] Fullständig synk körd.")

    # Sammanfatta diff-loggar (senaste 5 poster, med email och tabell-format)
    with psycopg2.connect(dbname="macspot", user="postgres", host="localhost", port=5433) as conn:
        with conn.cursor() as cur:
            cur.execute("""
                SELECT received_at, event_type, payload->>'email'
                FROM event_log
                WHERE received_at > now() - interval '10 minutes'
                  AND event_type IN ('sync_local_diff_contacts', 'sync_local_diff_bookings', 'sync_mismatch_contact', 'sync_fromcloud_mismatch')
                ORDER BY received_at DESC
                LIMIT 5
            """)
            rows = cur.fetchall()
            if rows:
                print("📜 Senaste 5 event_log-poster:")
                print("| tidpunkt            | event_type              | e-post                     |")
                print("|---------------------|--------------------------|-----------------------------|")
                for received_at, event_type, email in rows:
                    print(f"| {received_at.strftime('%Y-%m-%d %H:%M:%S')} | {event_type:<24} | {email or '(okänd)':<27} |")
            else:
                print("📜 Inga event_log-poster senaste 10 minuter.")

except Exception as e:
    import traceback
    print("❌ Ett oväntat fel inträffade under körningen:")
    print(traceback.format_exc())

finally:
    print(f"🏁 Körning avslutad: {datetime.now(timezone.utc).isoformat()}")
    duration = datetime.now(timezone.utc) - start_time
    print(f"⏱️ Total körtid: {int(duration.total_seconds())} sekunder")
    out.close()
    err.close()
END: sync_all.py

====================
📄 Fil: Documents/KLR_AI/Projekt_MacSpot/macspot-api/sync_plist.xml
📂 Kodtyp: 📄 Övrigt
🗂 Filtyp: 📄 Okänt format
📅 Senast ändrad: 2025-06-02 16:22:08
📏 Antal rader: 26
🧩 Antal funktioner: 0
💬 Kommentarstäckning: 0 rader (0.0%)
📥 Imports: 0 – Inga
🔍 Längsta funktion: 0 rader
🧠 Komplexitetspoäng: 0
🧪 TODO/FIXME: 0
====================
START: sync_plist.xml
cat > ~/Library/LaunchAgents/com.macspot.sync.plist <<EOF
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN"
  "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
  <key>Label</key>
  <string>com.macspot.sync</string>
  <key>ProgramArguments</key>
  <array>
    <string>/Users/danielkallberg/Documents/KLR_AI/venv/bin/python3</string>
    <string>/Users/danielkallberg/Documents/KLR_AI/Projekt_MacSpot/macspot-api/sync_all.py</string>
  </array>
  <key>WorkingDirectory</key>
  <string>/Users/danielkallberg/Documents/KLR_AI/Projekt_MacSpot/macspot-api</string>
  <key>StartInterval</key>
  <integer>300</integer>
  <key>RunAtLoad</key>
  <true/>
  <key>StandardOutPath</key>
  <string>/tmp/macspot_sync.log</string>
  <key>StandardErrorPath</key>
  <string>/tmp/macspot_sync_error.log</string>
</dict>
</plist>
EOF
END: sync_plist.xml

====================
📄 Fil: Documents/KLR_AI/Projekt_MacSpot/macspot-api/sync_generate_fromcloud_pending.py
📂 Kodtyp: 📄 Övrigt
🗂 Filtyp: 🐍 Python
📅 Senast ändrad: 2025-06-02 22:22:42
📏 Antal rader: 77
🧩 Antal funktioner: 0
💬 Kommentarstäckning: 0 rader (0.0%)
📥 Imports: 2 – ['import psycopg2', 'import json']
🔍 Längsta funktion: 0 rader
🧠 Komplexitetspoäng: 8
🧪 TODO/FIXME: 0
====================
START: sync_generate_fromcloud_pending.py
import psycopg2
import json
from config import LOCAL_DB_CONFIG
from datetime import datetime

def connect_db():
    return psycopg2.connect(**LOCAL_DB_CONFIG)

def get_diff_events(cur):
    cur.execute("""
        SELECT payload->>'email' AS email, payload->>'record_id' AS record_id,
               payload->>'table' AS table_name, payload->>'diff_summary' AS diff,
               MAX(received_at) AS latest
        FROM event_log
        WHERE event_type LIKE 'sync_fromcloud_mismatch%'
        GROUP BY 1, 2, 3, 4
        ORDER BY latest DESC
    """)
    return cur.fetchall()

def get_latest_payload(cur, table_name, record_id):
    cur.execute(f"SELECT * FROM {table_name} WHERE id = %s", (record_id,))
    row = cur.fetchone()
    if not row:
        return None
    colnames = [desc[0] for desc in cur.description]
    row_dict = dict(zip(colnames, row))
    
    def safe_serialize(value):
        if isinstance(value, dict):
            return json.dumps(value)
        elif isinstance(value, datetime):
            return value.isoformat()
        return value

    row_dict = {k: safe_serialize(v) for k, v in row_dict.items()}
    return row_dict

def create_pending_change(cur, table_name, record_id, payload):
    cur.execute("""
        INSERT INTO pending_changes (
            table_name, record_id, change_type, operation, direction,
            processed, created_at, payload
        ) VALUES (
            %s, %s, 'UPDATE', 'UPDATE', 'out', false, now(), %s
        )
    """, (table_name, record_id, json.dumps(payload)))

def main():
    conn = connect_db()
    cur = conn.cursor()

    print("🔄 Genererar pending_changes från event_log (moln → lokal)...")
    events = get_diff_events(cur)
    print(f"📌 Hittade {len(events)} diff-loggar att bearbeta...")

    count = 0
    for email, record_id, table_name, _, _ in events:
        payload = get_latest_payload(cur, table_name, record_id)
        if not payload:
            print(f"⚠️ Kunde inte hitta rad i {table_name} för ID: {record_id}")
            continue
        try:
            create_pending_change(cur, table_name, record_id, payload)
            print(f"📥 Skapade pending_change för {table_name}: {email}")
            count += 1
        except Exception as e:
            print(f"❌ Misslyckades att skapa pending_change: {e}")

    conn.commit()
    cur.close()
    conn.close()

    print(f"✅ Klart – {count} pending_changes skapade.")

if __name__ == "__main__":
    main()
END: sync_generate_fromcloud_pending.py

====================
📄 Fil: Documents/KLR_AI/Projekt_MacSpot/macspot-api/sync_generate_pending_from_diff.py
📂 Kodtyp: 📄 Övrigt
🗂 Filtyp: 🐍 Python
📅 Senast ändrad: 2025-06-02 22:22:42
📏 Antal rader: 79
🧩 Antal funktioner: 0
💬 Kommentarstäckning: 0 rader (0.0%)
📥 Imports: 2 – ['import psycopg2', 'import json']
🔍 Längsta funktion: 0 rader
🧠 Komplexitetspoäng: 11
🧪 TODO/FIXME: 0
====================
START: sync_generate_pending_from_diff.py
import psycopg2
import json
from config import LOCAL_DB_CONFIG
from datetime import datetime

def connect_local():
    return psycopg2.connect(**LOCAL_DB_CONFIG)

def extract_pending_changes_from_eventlog(conn):
    with conn.cursor() as cur:
        cur.execute("""
            SELECT id, event_type, payload, received_at
            FROM event_log
            WHERE event_type LIKE 'sync_local_diff_%'
            AND received_at > now() - interval '1 hour'
            ORDER BY received_at DESC
        """)
        rows = cur.fetchall()

    count = 0
    with conn.cursor() as cur:

        def safe_serialize(value):
            if isinstance(value, dict):
                return json.dumps(value)
            elif isinstance(value, datetime):
                return value.isoformat()
            return value

        for row in rows:
            event_id, event_type, payload_json, _ = row
            payload = payload_json if isinstance(payload_json, dict) else json.loads(payload_json)
            email = payload.get("email")
            table = "contact" if "contacts" in event_type else "bookings"

            if not email:
                continue

            # Hämta aktuell post från databasen
            cur.execute(f"SELECT * FROM {table} WHERE booking_email = %s", (email,))
            result = cur.fetchone()
            if not result:
                print(f"⚠️ Ingen rad hittades för {email} i {table}")
                continue

            colnames = [desc[0] for desc in cur.description]
            row_dict = dict(zip(colnames, result))
            row_id = row_dict["id"]
            row_dict = {k: safe_serialize(v) for k, v in row_dict.items()}

            # Kontrollera om redan finns
            cur.execute("""
                SELECT 1 FROM pending_changes
                WHERE table_name = %s AND record_id = %s AND direction = 'out' AND processed = false
            """, (table, row_id))
            if cur.fetchone():
                print(f"⏩ Redan pending: {email} i {table}")
                continue

            cur.execute("""
                INSERT INTO pending_changes (
                    table_name, record_id, change_type, operation, direction,
                    processed, created_at, payload
                ) VALUES (
                    %s, %s, 'UPDATE', 'UPDATE', 'out', false, now(), %s
                )
            """, (table, row_id, json.dumps(row_dict)))
            count += 1

    conn.commit()
    return count

if __name__ == "__main__":
    conn = connect_local()
    try:
        total = extract_pending_changes_from_eventlog(conn)
        print(f"✅ Skapade {total} nya pending_changes från event_log.")
    finally:
        conn.close()
END: sync_generate_pending_from_diff.py

====================
📄 Fil: Library/LaunchAgents/com.macspot.sync.plist
📂 Kodtyp: 📄 Övrigt
🗂 Filtyp: 📄 Okänt format
📅 Senast ändrad: 2025-06-02 16:30:38
📏 Antal rader: 23
🧩 Antal funktioner: 0
💬 Kommentarstäckning: 0 rader (0.0%)
📥 Imports: 0 – Inga
🔍 Längsta funktion: 0 rader
🧠 Komplexitetspoäng: 0
🧪 TODO/FIXME: 0
====================
START: com.macspot.sync.plist
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
	<key>Label</key>
	<string>com.macspot.sync</string>
	<key>ProgramArguments</key>
	<array>
		<string>/Users/danielkallberg/Documents/KLR_AI/venv/bin/python3</string>
		<string>/Users/danielkallberg/Documents/KLR_AI/Projekt_MacSpot/macspot-api/sync_all.py</string>
	</array>
	<key>RunAtLoad</key>
	<true/>
	<key>StandardErrorPath</key>
	<string>/tmp/macspot_sync_error.log</string>
	<key>StandardOutPath</key>
	<string>/tmp/macspot_sync.log</string>
	<key>StartInterval</key>
	<integer>300</integer>
	<key>WorkingDirectory</key>
	<string>/Users/danielkallberg/Documents/KLR_AI/Projekt_MacSpot/macspot-api</string>
</dict>
</plist>

END: com.macspot.sync.plist

====================
📄 Fil: Documents/KLR_AI/Projekt_MacSpot/macspot-api/healthcheck_sync.py
📂 Kodtyp: 📄 Övrigt
🗂 Filtyp: 🐍 Python
📅 Senast ändrad: 2025-06-02 22:31:32
📏 Antal rader: 294
🧩 Antal funktioner: 0
💬 Kommentarstäckning: 0 rader (0.0%)
📥 Imports: 2 – ['import psycopg2', 'import sys']
🔍 Längsta funktion: 0 rader
🧠 Komplexitetspoäng: 47
🧪 TODO/FIXME: 0
====================
START: healthcheck_sync.py
# 📄 Förbättrad version av healthcheck_sync.py

import psycopg2
from config import LOCAL_DB_CONFIG, REMOTE_DB_CONFIG
from datetime import datetime, timezone
import sys

__version__ = "1.0.1"

def get_pending_count(conn, label):
    with conn.cursor() as cur:
        cur.execute("""
            SELECT COUNT(*) FROM pending_changes
            WHERE direction = 'out' AND processed = false
        """)
        count = cur.fetchone()[0]
        print(f"🔍 {label}: {count} osynkade förändringar")
        return count

def check_db_connection(name, config):
    try:
        start = datetime.now(timezone.utc)
        conn = psycopg2.connect(**config)
        latency = (datetime.now(timezone.utc) - start).total_seconds()
        print(f"✅ Anslutning till {name} OK (latens: {latency:.2f} sek)")
        return conn
    except Exception as e:
        print(f"❌ Fel vid anslutning till {name}: {e}")
        return None

def main():
    print(f"\n📋 Healthcheck MacSpot sync v{__version__} – {datetime.now(timezone.utc).isoformat()} UTC\n")
    errors = 0

    local_conn = check_db_connection("Lokal databas", LOCAL_DB_CONFIG)
    if local_conn:
        get_pending_count(local_conn, "Lokal → moln")
        local_conn.close()
    else:
        errors += 1

    remote_conn = check_db_connection("Molndatabas", REMOTE_DB_CONFIG)
    if remote_conn:
        get_pending_count(remote_conn, "Moln → lokal")
        # --- Kontaktjämförelse mellan lokal och moln ---
        try:
            print("\n🔍 Jämför kontaktposter mellan lokal och moln...")
            with psycopg2.connect(**LOCAL_DB_CONFIG) as local_conn, psycopg2.connect(**REMOTE_DB_CONFIG) as remote_conn:
                with local_conn.cursor() as local_cur, remote_conn.cursor() as remote_cur:
                    local_cur.execute("SELECT id, metadata FROM contact")
                    remote_cur.execute("SELECT id, metadata FROM contact")

                    local_contacts = {str(row[0]): row[1] for row in local_cur.fetchall()}
                    remote_contacts = {str(row[0]): row[1] for row in remote_cur.fetchall()}

                    mismatch_count = 0
                    for contact_id, local_meta in local_contacts.items():
                        remote_meta = remote_contacts.get(contact_id)
                        if remote_meta is None:
                            print(f"⚠️ Kontakt {contact_id} finns inte i molnet.")
                            mismatch_count += 1
                        elif local_meta != remote_meta:
                            if {k: v for k, v in local_meta.items() if k != 'updated_at'} != {k: v for k, v in remote_meta.items() if k != 'updated_at'}:
                                print(f"⚠️ Kontakt {contact_id} skiljer sig mellan lokal och moln (förutom updated_at).")
                                mismatch_count += 1

                    for contact_id in remote_contacts:
                        if contact_id not in local_contacts:
                            print(f"⚠️ Kontakt {contact_id} finns i molnet men saknas lokalt.")
                            mismatch_count += 1

                    if mismatch_count == 0:
                        print("✅ Alla kontakter matchar mellan lokal och moln.")
                    else:
                        print(f"❗ Totalt {mismatch_count} avvikelse(r) i kontaktmetadata.")
        except Exception as e:
            print(f"⚠️ Fel vid jämförelse av kontakter: {e}")
        remote_conn.close()
    else:
        errors += 1

    # Hämta senaste mismatch-loggar från event_log
    try:
        with psycopg2.connect(**LOCAL_DB_CONFIG) as conn:
            with conn.cursor() as cur:
                cur.execute("""
                    SELECT event_type, payload->>'email', payload->>'diff_summary', received_at
                    FROM event_log
                    WHERE received_at > now() - interval '10 minutes'
                      AND event_type IN (
                          'sync_local_diff', 'sync_mismatch_contact', 'sync_fromcloud_mismatch', 'sync_forced_rewrite'
                      )
                    ORDER BY received_at DESC
                    LIMIT 10
                """)
                rows = cur.fetchall()
                if rows:
                    print("\n🚨 Senaste synkavvikelser:")
                    for event_type, email, diff, timestamp in rows:
                        print(f"• {event_type}: {email} – {diff} @ {timestamp}")
                else:
                    print("\n✅ Inga mismatch-loggar i event_log senaste 10 minuterna.")
    except Exception as e:
        print(f"⚠️ Kunde inte läsa mismatch-loggar: {e}")

    # Lista alla tabeller i lokal och molndatabas
    def list_tables(conn, label):
        try:
            with conn.cursor() as cur:
                cur.execute("""
                    SELECT table_name
                    FROM information_schema.tables
                    WHERE table_schema = 'public'
                    ORDER BY table_name
                """)
                tables = [row[0] for row in cur.fetchall()]
                print(f"\n📋 Tabeller i {label}:")
                for t in tables:
                    print(f"• {t}")
        except Exception as e:
            print(f"⚠️ Kunde inte hämta tabeller från {label}: {e}")

    # Lista triggers per tabell
    def list_triggers(conn, label):
        try:
            with conn.cursor() as cur:
                cur.execute("""
                    SELECT event_object_table, trigger_name, action_timing, event_manipulation
                    FROM information_schema.triggers
                    ORDER BY event_object_table, trigger_name
                """)
                rows = cur.fetchall()
                if rows:
                    print(f"\n📌 Triggers i {label}:")
                    for table, trigger, timing, event in rows:
                        print(f"• {table} – {trigger} ({timing} {event})")
                else:
                    print(f"\nℹ️ Inga triggers i {label}.")
        except Exception as e:
            print(f"⚠️ Kunde inte hämta triggers från {label}: {e}")

    def analyze_triggers(conn, table_name, label):
        try:
            with conn.cursor() as cur:
                cur.execute("""
                    SELECT trigger_name, action_timing, event_manipulation, action_statement
                    FROM information_schema.triggers
                    WHERE event_object_table = %s
                """, (table_name,))
                rows = cur.fetchall()
                if rows:
                    print(f"\n🔍 Triggers för tabell '{table_name}' i {label}:")
                    for trigger_name, timing, event, stmt in rows:
                        print(f"• {trigger_name} – {timing} {event}: {stmt}")
                else:
                    print(f"\nℹ️ Inga triggers för tabell '{table_name}' i {label}.")
        except Exception as e:
            print(f"⚠️ Fel vid analys av triggers i {label}: {e}")

    def list_columns(conn, table_name, label):
        try:
            with conn.cursor() as cur:
                cur.execute("""
                    SELECT column_name, data_type
                    FROM information_schema.columns
                    WHERE table_name = %s
                    ORDER BY ordinal_position
                """, (table_name,))
                rows = cur.fetchall()
                print(f"\n📑 Kolumner för '{table_name}' i {label}:")
                for name, dtype in rows:
                    print(f"• {name} ({dtype})")
        except Exception as e:
            print(f"⚠️ Fel vid kolumnhämtning i {label} för tabell '{table_name}': {e}")

    # Anropa för båda databaser om öppna
    if local_conn:
        local_conn = check_db_connection("Lokal databas", LOCAL_DB_CONFIG)
        if local_conn:
            list_tables(local_conn, "lokal databas")
            list_triggers(local_conn, "lokal databas")
            local_conn.close()
    if remote_conn:
        remote_conn = check_db_connection("Molndatabas", REMOTE_DB_CONFIG)
        if remote_conn:
            list_tables(remote_conn, "molndatabas")
            list_triggers(remote_conn, "molndatabas")
            remote_conn.close()

    if local_conn := check_db_connection("Lokal databas", LOCAL_DB_CONFIG):
        for tabell in ["contact", "bookings"]:
            analyze_triggers(local_conn, tabell, "lokal databas")
        local_conn.close()

    if remote_conn := check_db_connection("Molndatabas", REMOTE_DB_CONFIG):
        for tabell in ["contact", "bookings"]:
            analyze_triggers(remote_conn, tabell, "molndatabas")
        remote_conn.close()

    if local_conn := check_db_connection("Lokal databas", LOCAL_DB_CONFIG):
        for tabell in ["contact", "bookings"]:
            list_columns(local_conn, tabell, "lokal databas")
        local_conn.close()

    if remote_conn := check_db_connection("Molndatabas", REMOTE_DB_CONFIG):
        for tabell in ["contact", "bookings"]:
            list_columns(remote_conn, tabell, "molndatabas")
        remote_conn.close()

    def verify_trigger_connections():
        print("\n📎 Verifierar att triggers är kopplade till rätt funktioner...")
        for label, config in [("lokal databas", LOCAL_DB_CONFIG), ("molndatabas", REMOTE_DB_CONFIG)]:
            try:
                with psycopg2.connect(**config) as conn:
                    with conn.cursor() as cur:
                        for table, trigger, function in [
                            ("contact", "audit_sync_contact_trigger", "log_contact_change"),
                            ("bookings", "audit_sync_bookings_trigger", "log_bookings_change")
                        ]:
                            cur.execute("""
                                SELECT trigger_name, action_statement
                                FROM information_schema.triggers
                                WHERE event_object_table = %s AND trigger_name = %s
                            """, (table, trigger))
                            row = cur.fetchone()
                            if row:
                                if function in row[1]:
                                    print(f"✅ {label}: {trigger} på '{table}' kör {function}()")
                                else:
                                    print(f"❌ {label}: {trigger} hittades men pekar inte på {function}()")
                            else:
                                print(f"❌ {label}: Trigger '{trigger}' på tabell '{table}' saknas")
            except Exception as e:
                print(f"⚠️ Kunde inte verifiera triggers i {label}: {e}")

    def verify_trigger_cloud():
        print("\n🌩️ Verifierar triggerfunktioner i molndatabasen separat...")
        try:
            with psycopg2.connect(**REMOTE_DB_CONFIG) as conn:
                with conn.cursor() as cur:
                    for table, trigger, expected_func in [
                        ("contact", "audit_sync_contact_trigger", "log_contact_change"),
                        ("bookings", "audit_sync_bookings_trigger", "log_bookings_change")
                    ]:
                        cur.execute("""
                            SELECT trigger_name, action_statement
                            FROM information_schema.triggers
                            WHERE event_object_table = %s AND trigger_name = %s
                        """, (table, trigger))
                        row = cur.fetchone()
                        if row:
                            if expected_func in row[1]:
                                print(f"✅ Molndatabas: {trigger} på '{table}' kör {expected_func}()")
                            else:
                                print(f"❌ Molndatabas: {trigger} pekar INTE på {expected_func}()")
                        else:
                            print(f"❌ Molndatabas: Trigger '{trigger}' saknas på tabell '{table}'")
        except Exception as e:
            print(f"⚠️ Kunde inte verifiera molntriggers: {e}")

    verify_trigger_connections()
    verify_trigger_cloud()

    # Visa de senaste 5 event_log-posterna med e-post och diff_summary
    try:
        with psycopg2.connect(**LOCAL_DB_CONFIG) as conn:
            with conn.cursor() as cur:
                cur.execute("""
                    SELECT received_at, event_type, payload->>'email', payload->>'diff_summary'
                    FROM event_log
                    WHERE payload->>'email' IS NOT NULL
                    ORDER BY received_at DESC
                    LIMIT 5
                """)
                rows = cur.fetchall()
                if rows:
                    print("\n📜 Senaste 5 event_log-poster:")
                    print(f"| {'tidpunkt':<20} | {'event_type':<25} | {'e-post':<30} | {'diff_summary':<40} |")
                    print("|" + "-"*22 + "|" + "-"*27 + "|" + "-"*32 + "|" + "-"*42 + "|")
                    for t, e, m, d in rows:
                        print(f"| {t.strftime('%Y-%m-%d %H:%M:%S')} | {e:<25} | {m:<30} | {d or '':<40} |")
                else:
                    print("ℹ️ Inga loggposter hittades.")
    except Exception as e:
        print(f"⚠️ Kunde inte hämta senaste event_log-poster: {e}")

    if errors > 0:
        print(f"\n❌ Healthcheck avslutades med {errors} fel.\n")
        sys.exit(1)
    else:
        print(f"\n✅ Healthcheck genomförd utan fel.\n")

if __name__ == "__main__":
    main()
END: healthcheck_sync.py

📁 KONFIGURATIONSFILER (function.json / host.json / package.json / .funcignore)
====================================

📄 Documents/KLR_AI/Projekt_MacSpot/macspot-api/.funcignore
   # Exclude dev-only files and folders
   .git
   .vscode
   .env
   *.log
   test/
   tests/
   
   # Explicitly include all required files and folders
   !host.json
   !package.json
   !package-lock.json
   
   !node_modules/
   !node_modules/**
   
   !shared/
   !shared/**
   
   !bookings/
   !bookings/**
   !getavailableslots/
   !getavailableslots/**
   !validate_contact/
   !validate_contact/**
   !meeting_types/
   !meeting_types/**
   !refreshCalendarOrigins/
   !refreshCalendarOrigins/**
   !refreshTravelTimes/
   !refreshTravelTimes/**
   !booking_settings/
   !booking_settings/**
   !test_azurecloud/
   !test_azurecloud/**
   !trackingPixel/
   !trackingPixel/**
📄 Documents/KLR_AI/Projekt_MacSpot/macspot-api/booking_settings/function.json
   {
     "bindings": [
       {
         "authLevel": "anonymous",
         "type": "httpTrigger",
         "direction": "in",
         "name": "req",
         "methods": ["get"],
         "route": "booking_settings"
       },
       {
         "type": "http",
         "direction": "out",
         "name": "res"
       }
     ],
     "scriptFile": "index.js"
   }
📄 Documents/KLR_AI/Projekt_MacSpot/macspot-api/bookings/function.json
   {
     "bindings": [
       {
         "authLevel": "anonymous",
         "type": "httpTrigger",
         "direction": "in",
         "name": "req",
         "methods": ["post", "options"],
         "route": "bookings"
       },
       {
         "type": "http",
         "direction": "out",
         "name": "res"
       }
     ],
     "scriptFile": "index.js"
   }
📄 Documents/KLR_AI/Projekt_MacSpot/macspot-api/getavailableslots/function.json
   {
     "bindings": [
       {
         "authLevel": "anonymous",
         "type": "httpTrigger",
         "direction": "in",
         "name": "req",
         "methods": ["post", "options"],
         "route": "getavailableslots"
       },
       {
         "type": "http",
         "direction": "out",
         "name": "res"
       }
     ],
     "scriptFile": "index.js"
   }
📄 Documents/KLR_AI/Projekt_MacSpot/macspot-api/host.json
   {
     "version": "2.0",
     "extensionBundle": {
       "id": "Microsoft.Azure.Functions.ExtensionBundle",
       "version": "[4.*, 5.0.0)"
     },
     "extensions": {
       "http": {
         "cors": {
           "allowedOrigins": [
             "https://www.klrab.se"
           ],
           "supportCredentials": false
         }
       }
     }
   }
📄 Documents/KLR_AI/Projekt_MacSpot/macspot-api/meeting_types/function.json
   {
     "bindings": [
       {
         "authLevel": "anonymous",
         "type": "httpTrigger",
         "direction": "in",
         "name": "req",
         "methods": [ "get" ],
         "route": "meeting_types"
       },
       {
         "type": "http",
         "direction": "out",
         "name": "res"
       }
     ],
     "scriptFile": "index.js"
   }
📄 Documents/KLR_AI/Projekt_MacSpot/macspot-api/package.json
   {
     "name": "macspot-api",
     "version": "1.0.0",
     "description": "Azure Functions backend för MacSpot CRM/ERP",
     "scripts": {
       "start": "func start",
       "dev": "func start --verbose",
       "deploy": "func azure functionapp publish macspotbackend",
       "build": "echo 'Nothing to build'"
     },
     "dependencies": {
       "@azure/functions": "^4.7.0",
       "@azure/msal-node": "^3.5.1",
       "@microsoft/microsoft-graph-client": "^3.0.0",
       "date-holidays": "^3.24.3",
       "dav": "^1.8.0",
       "dotenv": "^16.5.0",
       "isomorphic-fetch": "^3.0.0",
       "jsonwebtoken": "^9.0.0",
       "luxon": "^3.4.4",
       "node-fetch": "^2.7.0",
       "node-ical": "^0.20.1",
       "p-limit": "^6.2.0",
       "pg": "^8.15.6",
       "uuid": "^9.0.0",
       "xml2js": "^0.6.2"
     }
   }

📄 Documents/KLR_AI/Projekt_MacSpot/macspot-api/refreshCalendarOrigins/function.json
   {
     "bindings": [
       {
         "name": "myTimer",
         "type": "timerTrigger",
         "direction": "in",
         "schedule": "0 0 * * * *"
       }
     ],
     "scriptFile": "index.js"
   }
📄 Documents/KLR_AI/Projekt_MacSpot/macspot-api/refreshTravelTimes/function.json
   {
     "bindings": [
       {
         "name": "myTimer",
         "type": "timerTrigger",
         "direction": "in",
         "schedule": "0 0 * * * *"
       }
     ],
     "scriptFile": "index.js"
   }
📄 Documents/KLR_AI/Projekt_MacSpot/macspot-api/test_azurecloud/function.json
   {
     "bindings": [
       {
         "authLevel": "anonymous",
         "type": "httpTrigger",
         "direction": "in",
         "name": "req",
         "methods": ["get"],
         "route": "test_azurecloud"
       },
       {
         "type": "http",
         "direction": "out",
         "name": "res"
       }
     ],
     "scriptFile": "index.js"
   }
📄 Documents/KLR_AI/Projekt_MacSpot/macspot-api/validate_contact/function.json
   {
     "bindings": [
       {
         "authLevel": "anonymous",
         "type": "httpTrigger",
         "direction": "in",
         "name": "req",
         "methods": ["get", "post"],
         "route": "validate_contact"
       },
       {
         "type": "http",
         "direction": "out",
         "name": "res"
       }
     ],
     "scriptFile": "index.js"
   }
📈 SUMMERING AV ALLA JS-FILER
====================================
📏 Totalt antal rader kod: 1197
🧩 Totalt antal funktioner: 0
🧠 Total komplexitetspoäng: 152
🧪 Antal TODO/FIXME totalt: 0

📊 Per fil:
fil,rader,funktioner,komplexitet,kommentarer,imports
sync_from_cloud.py,117,0,16,0,2
sync_to_cloud.py,151,0,16,0,2
sync_static_tables.py,61,0,6,0,2
sync.py,130,0,22,0,2
sync_all.py,239,0,26,0,7
sync_plist.xml,26,0,0,0,0
sync_generate_fromcloud_pending.py,77,0,8,0,2
sync_generate_pending_from_diff.py,79,0,11,0,2
com.macspot.sync.plist,23,0,0,0,0
healthcheck_sync.py,294,0,47,0,2
📊 MOLNDATABAS (Azure) – STRUKTUR & INNEHÅLL
====================================

📁 Tabell: slot_cache
  • created_at (timestamp without time zone)
  • slot_day (date)
  • slots (jsonb)
  • id (uuid)
  • meeting_length (integer)
  • booking_email (text)
  • meeting_type (text)
  • slot_part (text)
  🔑 [p] slot_cache_pkey: PRIMARY KEY (id)

📁 Tabell: calendar_origin_cache
  • created_at (timestamp without time zone)
  • timestamp (timestamp with time zone)
  • event_date (date)
  • id (integer)
  • end_time (timestamp without time zone)
  • address (text)
  • source (text)
  🔑 [c] calendar_origin_cache_source_check: CHECK ((source = ANY (ARRAY['Apple Calendar'::text, 'Microsoft 365'::text])))
  🔑 [p] calendar_origin_cache_pkey: PRIMARY KEY (id)

📁 Tabell: available_slots_cache
  • id (uuid)
  • travel_time_min (integer)
  • generated_at (timestamp without time zone)
  • expires_at (timestamp without time zone)
  • meeting_length (integer)
  • slot_day (date)
  • slot_score (integer)
  • meeting_type (text)
  • slot_part (text)
  • slot_iso (text)
  🔑 [p] available_slots_cache_pkey: PRIMARY KEY (id)

📁 Tabell: travel_time_cache
  • travel_minutes (integer)
  • updated_at (timestamp with time zone)
  • is_fallback (boolean)
  • hour (integer)
  • created_at (timestamp with time zone)
  • to_address (text)
  • from_address (text)
  🔑 [u] unique_travel_key: UNIQUE (from_address, to_address, hour)
  🧪 Topp 5 rader:
    - from_address=Taxgatan 4, 115 45 Stockholm, to_address=Maria Skolgata 79A, 118 53 Stockholm, hour=7, travel_minutes=17, created_at=2025-06-01 20:37:36.958100+00:00, updated_at=2025-06-01 20:37:36.958100+00:00, is_fallback=False
    - from_address=Taxgatan 4, 115 45 Stockholm, to_address=Maria Skolgata 79A, 118 53 Stockholm, hour=9, travel_minutes=17, created_at=2025-06-01 20:37:37.880289+00:00, updated_at=2025-06-01 20:37:37.880289+00:00, is_fallback=False
    - from_address=Taxgatan 4, 115 45 Stockholm, to_address=Maria Skolgata 79A, 118 53 Stockholm, hour=11, travel_minutes=17, created_at=2025-06-01 20:37:37.776032+00:00, updated_at=2025-06-01 20:37:37.776032+00:00, is_fallback=False
    - from_address=Taxgatan 4, 115 45 Stockholm, to_address=Maria Skolgata 79A, 118 53 Stockholm, hour=6, travel_minutes=17, created_at=2025-06-01 20:37:37.156222+00:00, updated_at=2025-06-01 20:37:37.156222+00:00, is_fallback=False
    - from_address=Taxgatan 4, 115 45 Stockholm, to_address=Maria Skolgata 79A, 118 53 Stockholm, hour=8, travel_minutes=17, created_at=2025-06-01 20:37:37.648891+00:00, updated_at=2025-06-01 20:37:37.648891+00:00, is_fallback=False

📁 Tabell: event_log
  • received_at (timestamp with time zone)
  • record_id (uuid)
  • timestamp (timestamp with time zone)
  • booking_id (uuid)
  • id (uuid)
  • payload (jsonb)
  • action (text)
  • event_type (text)
  • source (text)
  • table_name (text)
  🔑 [p] event_log_pkey: PRIMARY KEY (id)
  🧪 Topp 5 rader:
    - source=None, event_type=None, payload=None, received_at=2025-06-01 20:37:30.699890+00:00, id=2c00583c-cc66-44ed-ad81-1b404c8385ac, action=INSERT, table_name=contact, record_id=4ce9fc3f-d44f-40ca-aa9d-13e4db7f0f31, timestamp=2025-06-01 20:37:30.699890+00:00, booking_id=None
    - source=None, event_type=calendar_response_status, payload={'response': 'none'}, received_at=2025-06-01 20:38:18.897492+00:00, id=c06ba994-c60f-4c92-8203-dc7e00070b74, action=None, table_name=None, record_id=None, timestamp=2025-06-01 20:38:18.897492+00:00, booking_id=3d09c33e-52c9-4736-975b-61ee3713551c
    - source=None, event_type=calendar_invite_sent, payload={'subject': 'Möte med KLRA Ledningsrådgivning', 'webLink': 'https://outlook.office365.com/owa/?itemid=AAMkADIyMzUxMTE1LWQ0NDUtNDMwNC05YmE3LTRhMThmNDkyNzA2ZABGAAAAAAD8zD4S9766TIdQsQEV5sX5BwB0FUy6J9MkSLnOAsVgC0tuAAAAAAENAAB0FUy6J9MkSLnOAsVgC0tuAAAnEf1vAAA%3D&exvsurl=1&path=/calendar/item', 'location': 'Online'}, received_at=2025-06-01 20:38:18.923033+00:00, id=b47ba88d-c7d2-4382-8aa5-9dcff24a5e35, action=None, table_name=None, record_id=None, timestamp=2025-06-01 20:38:18.923033+00:00, booking_id=3d09c33e-52c9-4736-975b-61ee3713551c
    - source=None, event_type=calendar_event_created, payload={'end': {'dateTime': '2025-06-02T06:30:00.0000000', 'timeZone': 'UTC'}, 'body': {'content': '<html>\r\n<head>\r\n<meta http-equiv="Content-Type" content="text/html; charset=utf-8">\r\n</head>\r\n<body>\r\nDetta är en inbjudan till möte: Möte med KLRA Ledningsrådgivning\r\n</body>\r\n</html>\r\n', 'contentType': 'html'}, 'start': {'dateTime': '2025-06-02T06:20:00.0000000', 'timeZone': 'UTC'}, 'eventId': 'AAMkADIyMzUxMTE1LWQ0NDUtNDMwNC05YmE3LTRhMThmNDkyNzA2ZABGAAAAAAD8zD4S9766TIdQsQEV5sX5BwB0FUy6J9MkSLnOAsVgC0tuAAAAAAENAAB0FUy6J9MkSLnOAsVgC0tuAAAnEf1vAAA=', 'subject': 'Möte med KLRA Ledningsrådgivning', 'webLink': 'https://outlook.office365.com/owa/?itemid=AAMkADIyMzUxMTE1LWQ0NDUtNDMwNC05YmE3LTRhMThmNDkyNzA2ZABGAAAAAAD8zD4S9766TIdQsQEV5sX5BwB0FUy6J9MkSLnOAsVgC0tuAAAAAAENAAB0FUy6J9MkSLnOAsVgC0tuAAAnEf1vAAA%3D&exvsurl=1&path=/calendar/item', 'location': 'Online', 'attendees': [{'type': 'required', 'status': {'time': '0001-01-01T00:00:00Z', 'response': 'none'}, 'emailAddress': {'name': 'daniel.kallberg@mac.com', 'address': 'daniel.kallberg@mac.com'}}], 'onlineMeetingUrl': None}, received_at=2025-06-01 20:38:18.949898+00:00, id=a8781988-c135-4f0b-9eb0-16b2a88c9f9c, action=None, table_name=None, record_id=None, timestamp=2025-06-01 20:38:18.949898+00:00, booking_id=3d09c33e-52c9-4736-975b-61ee3713551c
    - source=None, event_type=calendar_invite_sent, payload={'subject': 'Möte med KLRA Ledningsrådgivning', 'webLink': 'https://us05web.zoom.us/j/82144172118?pwd=zJm2Xe3RjuaM7e7HeDLoeacSdnbaVc.1', 'location': 'Online'}, received_at=2025-06-01 20:38:18.975463+00:00, id=835d1bab-4d1a-4fe5-8da0-4597f7131fde, action=None, table_name=None, record_id=None, timestamp=2025-06-01 20:38:18.975463+00:00, booking_id=3d09c33e-52c9-4736-975b-61ee3713551c

📁 Tabell: booking_settings
  • value (jsonb)
  • updated_at (timestamp with time zone)
  • key (text)
  • value_type (text)
  🔑 [u] unique_key: UNIQUE (key)
  🧪 Topp 5 rader:
    - key=email_subject_templates, value={'zoom': 'Zoommöte: {{first_name}} | {{company}} & Daniel | Kinnekulle Ledningsrådgivning AB', 'teams': 'Teamsmöte: {{first_name}} | {{company}} & Daniel | Kinnekulle Ledningsrådgivning AB', 'atclient': 'Möte hos {{company}}: {{first_name}} | {{company}} & Daniel | Kinnekulle Ledningsrådgivning AB', 'atoffice': 'Möte hos KLR AB (Stockholm | Södermalm): {{first_name}} | {{company}} & Daniel | Kinnekulle Ledningsrådgivning AB', 'facetime': 'FaceTime-möte: {{first_name}} | {{company}} & Daniel | Kinnekulle Ledningsrådgivning AB'}, value_type=json, updated_at=2025-05-30 20:46:14.058171+00:00
    - key=default_language, value=sv, value_type=string, updated_at=2025-05-25 10:37:53.619684+00:00
    - key=default_meeting_length_atclient, value=[90, 180, 270, 360], value_type=array, updated_at=2025-04-23 12:48:49.778155+00:00
    - key=default_meeting_length_atoffice, value=[60, 90], value_type=array, updated_at=2025-04-23 12:48:49.778155+00:00
    - key=default_meeting_length_digital, value=[10, 20, 60], value_type=array, updated_at=2025-04-23 12:48:49.778155+00:00

📁 Tabell: translation
  • key (character varying)
  • sv (text)
  • en (text)
  🧪 Topp 5 rader:
    - key=error_invalid_phone, sv=Ogiltigt telefonnummer. Vi vet att det är svårt att komma ihåg sitt nummer., en=Invalid phone number. We know remembering your own number is hard.
    - key=error_invalid_name, sv=Namnet är ogiltigt (minst 2 tecken, max 50). Smeknamn som "X" är för Elon., en=Invalid name (min 2 characters, max 50). Nicknames like "X" are taken.
    - key=error_missing_fields, sv=Alla fält måste vara ifyllda. Vi är petiga så du slipper bli det senare., en=All fields must be filled. We’re picky so you don’t have to be later.
    - key=error_missing_meeting_link, sv=Möteslänk krävs. Om inte mötet sker via brevduva., en=A meeting link is required. Unless the meeting is via carrier pigeon.
    - key=error_missing_recaptcha, sv=reCAPTCHA måste verifieras. Nej, det är inte en känslomässig fråga., en=reCAPTCHA verification required. And no, it’s not a personality test.

📁 Tabell: bookings
  • start_time (timestamp with time zone)
  • end_time (timestamp with time zone)
  • id (uuid)
  • updated_at (timestamp with time zone)
  • metadata (jsonb)
  • created_at (timestamp with time zone)
  • contact_id (uuid)
  • meeting_type (text)
  • booking_email (text)
  🔑 [p] bookings_pkey: PRIMARY KEY (id)
  🔑 [f] fk_bookings_contact: FOREIGN KEY (contact_id) REFERENCES contact(id) ON DELETE SET NULL
  🧪 Topp 5 rader:
    - start_time=2025-06-02 11:20:00+00:00, end_time=2025-06-02 11:30:00+00:00, meeting_type=facetime, metadata={'phone': '070-2656868', 'company': 'Anna AB', 'subject': 'FaceTime-möte: Anna | Anna AB & Daniel | Kinnekulle Ledningsrådgivning AB', 'location': 'FaceTime', 'last_name': 'Sahlin', 'first_name': 'Anna', 'ip_address': '81.233.161.165:58650', 'user_agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/18.5 Safari/605.1.15', 'online_link': 'facetime:070-2656868', 'body_preview': '<html>\r\n<head>\r\n<meta http-equiv="Content-Type" content="text/html; charset=utf-8">\r\n</head>\r\n<body>\r\nDetta är en inbjudan till möte: FaceTime-möte: Anna | Anna AB &amp; Daniel | Kinnekulle Ledningsrådgivning AB\r\n</body>\r\n</html>\r\n', 'meeting_length': 10, 'calendar_response_status': 'none'}, created_at=2025-06-01 21:14:06.367000+00:00, contact_id=6dedbbd8-661f-4f87-9b54-e302bdd6f61a, id=affd507f-ee62-4ad0-b723-609100422f3b, updated_at=2025-06-01 21:14:06.367000+00:00, booking_email=annapanna79@yahoo.com
    - start_time=2025-06-02 06:20:00+00:00, end_time=2025-06-02 06:30:00+00:00, meeting_type=zoom, metadata={'phone': '098765432', 'company': 'persson AB', 'subject': 'Möte med KLRA Ledningsrådgivning', 'location': 'Online', 'last_name': 'Johansson', 'first_name': 'Per', 'ip_address': '172.226.49.45:48167', 'meeting_id': 82144172118, 'user_agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/18.5 Safari/605.1.15', 'online_link': 'https://us05web.zoom.us/j/82144172118?pwd=zJm2Xe3RjuaM7e7HeDLoeacSdnbaVc.1', 'meeting_length': 10, 'calendar_response_status': 'none'}, created_at=2025-06-01 20:38:17.398000+00:00, contact_id=4ce9fc3f-d44f-40ca-aa9d-13e4db7f0f31, id=3d09c33e-52c9-4736-975b-61ee3713551c, updated_at=2025-06-02 19:41:44.074564+00:00, booking_email=daniel.kallberg@mac.com
    - start_time=2025-06-02 08:00:00+00:00, end_time=2025-06-02 08:10:00+00:00, meeting_type=zoom, metadata={'phone': '098765432', 'company': 'persson AB', 'subject': 'Möte med KLRA Ledningsrådgivning', 'location': 'Online', 'last_name': 'Johansson', 'first_name': 'Per', 'ip_address': '172.226.49.45:47716', 'meeting_id': 83811214708, 'user_agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/18.5 Safari/605.1.15', 'online_link': 'https://us05web.zoom.us/j/83811214708?pwd=uDzaG32s3i87PlV0pOwojrXUzZ7aEg.1', 'meeting_length': 10, 'calendar_response_status': 'none'}, created_at=2025-06-01 20:50:09.892000+00:00, contact_id=4ce9fc3f-d44f-40ca-aa9d-13e4db7f0f31, id=059ec692-02af-40c7-9501-0679d86b81dd, updated_at=2025-06-02 19:41:44.074564+00:00, booking_email=daniel.kallberg@mac.com
    - start_time=2025-06-02 08:40:00+00:00, end_time=2025-06-02 09:00:00+00:00, meeting_type=zoom, metadata={'phone': '098765432', 'company': 'persson AB', 'subject': 'Möte med KLRA Ledningsrådgivning', 'location': 'Online', 'last_name': 'Johansson', 'first_name': 'Per', 'ip_address': '172.226.49.45:47708', 'meeting_id': 86400396910, 'user_agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/18.5 Safari/605.1.15', 'online_link': 'https://us05web.zoom.us/j/86400396910?pwd=z8fdhAA8ibZ5hxJEpmebYHaX57JugC.1', 'meeting_length': 20, 'calendar_response_status': 'none'}, created_at=2025-06-01 20:56:02.371000+00:00, contact_id=4ce9fc3f-d44f-40ca-aa9d-13e4db7f0f31, id=967fa70d-2409-4884-8d5b-f2c036eb1a99, updated_at=2025-06-02 19:41:44.074564+00:00, booking_email=daniel.kallberg@mac.com
    - start_time=2025-06-02 09:20:00+00:00, end_time=2025-06-02 09:30:00+00:00, meeting_type=zoom, metadata={'phone': '098765432', 'company': 'persson AB', 'subject': 'Zoommöte: Per | persson AB & Daniel | Kinnekulle Ledningsrådgivning AB', 'location': 'Online', 'last_name': 'Johansson', 'first_name': 'Per', 'ip_address': '172.226.49.45:46831', 'meeting_id': 81612591010, 'user_agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/18.5 Safari/605.1.15', 'online_link': 'https://us05web.zoom.us/j/81612591010?pwd=3Pu0VQxyWyR0pPab7OlpAfKb7CpiWq.1', 'meeting_length': 10, 'calendar_response_status': 'none'}, created_at=2025-06-01 21:01:27.794000+00:00, contact_id=4ce9fc3f-d44f-40ca-aa9d-13e4db7f0f31, id=1a231d98-2e66-41ae-a718-6048aa624601, updated_at=2025-06-02 19:41:44.074564+00:00, booking_email=daniel.kallberg@mac.com

📁 Tabell: pending_changes
  • booking_id (uuid)
  • processed (boolean)
  • created_at (timestamp with time zone)
  • payload (jsonb)
  • id (uuid)
  • record_id (uuid)
  • table_name (text)
  • operation (text)
  • change_type (text)
  • direction (text)
  🔑 [p] pending_changes_pkey: PRIMARY KEY (id)
  🔑 [f] fk_pending_changes_booking_id: FOREIGN KEY (booking_id) REFERENCES bookings(id) ON DELETE CASCADE
  🧪 Topp 5 rader:
    - id=fff97701-6232-4ac2-ba9f-b1c02769b414, table_name=bookings, record_id=3d09c33e-52c9-4736-975b-61ee3713551c, change_type=INSERT, direction=cloud_to_local, processed=False, created_at=2025-06-01 20:38:19.055000+00:00, operation=None, payload=None, booking_id=3d09c33e-52c9-4736-975b-61ee3713551c
    - id=93cd0ba6-50f9-4c4b-80f4-5822c0f14912, table_name=bookings, record_id=059ec692-02af-40c7-9501-0679d86b81dd, change_type=INSERT, direction=cloud_to_local, processed=False, created_at=2025-06-01 20:50:11.295000+00:00, operation=None, payload=None, booking_id=059ec692-02af-40c7-9501-0679d86b81dd
    - id=c13128f8-3198-4d29-9b4b-673ff2dabe41, table_name=bookings, record_id=967fa70d-2409-4884-8d5b-f2c036eb1a99, change_type=INSERT, direction=cloud_to_local, processed=False, created_at=2025-06-01 20:56:03.629000+00:00, operation=None, payload=None, booking_id=967fa70d-2409-4884-8d5b-f2c036eb1a99
    - id=fbd2921d-a75d-49b3-b1af-a62fc5cb4652, table_name=bookings, record_id=1a231d98-2e66-41ae-a718-6048aa624601, change_type=INSERT, direction=cloud_to_local, processed=False, created_at=2025-06-01 21:01:29.511000+00:00, operation=None, payload=None, booking_id=1a231d98-2e66-41ae-a718-6048aa624601
    - id=9c53a7e8-4147-482e-93e7-0e5c9a4002a1, table_name=bookings, record_id=affd507f-ee62-4ad0-b723-609100422f3b, change_type=INSERT, direction=cloud_to_local, processed=False, created_at=2025-06-01 21:14:07.151000+00:00, operation=None, payload=None, booking_id=affd507f-ee62-4ad0-b723-609100422f3b

📁 Tabell: contact
  • metadata (jsonb)
  • created_at (timestamp with time zone)
  • id (uuid)
  • updated_at (timestamp with time zone)
  • booking_email (text)
  • email (text)
  🔑 [p] contact_pkey: PRIMARY KEY (id)
  🧪 Topp 5 rader:
    - metadata={'phone': '098765432', 'origin': 'klrab.se', 'company': 'persson AB', 'last_name': 'Johansson', 'first_name': 'Per'}, created_at=2025-06-01 20:37:30.699890+00:00, id=4ce9fc3f-d44f-40ca-aa9d-13e4db7f0f31, booking_email=daniel.kallberg@mac.com, updated_at=2025-06-02 06:13:47.337045+00:00, email=daniel.kallberg@mac.com
    - metadata={'phone': '070-2656868', 'origin': 'klrab.se', 'company': 'Anna AB', 'last_name': 'Sahlin', 'first_name': 'Anna-Molnroundtrip'}, created_at=2025-06-01 21:13:46.657884+00:00, id=6dedbbd8-661f-4f87-9b54-e302bdd6f61a, booking_email=annapanna79@yahoo.com, updated_at=2025-06-02 19:45:03.859019+00:00, email=annapanna79@yahoo.com

📊 LOKAL DATABAS – STRUKTUR & INNEHÅLL
====================================

📁 Tabell: booking_settings
  • value (jsonb)
  • updated_at (timestamp with time zone)
  • key (text)
  • value_type (text)
  🔑 [p] booking_settings_pkey: PRIMARY KEY (key)
  🧪 Topp 5 rader:
    - key=email_subject_templates, value={'zoom': 'Zoommöte: {{first_name}} | {{company}} & Daniel | Kinnekulle Ledningsrådgivning AB', 'teams': 'Teamsmöte: {{first_name}} | {{company}} & Daniel | Kinnekulle Ledningsrådgivning AB', 'atclient': 'Möte hos {{company}}: {{first_name}} | {{company}} & Daniel | Kinnekulle Ledningsrådgivning AB', 'atoffice': 'Möte hos KLR AB (Stockholm | Södermalm): {{first_name}} | {{company}} & Daniel | Kinnekulle Ledningsrådgivning AB', 'facetime': 'FaceTime-möte: {{first_name}} | {{company}} & Daniel | Kinnekulle Ledningsrådgivning AB'}, value_type=json, updated_at=2025-05-30 22:46:14.058171+02:00
    - key=default_language, value=sv, value_type=string, updated_at=2025-05-25 12:37:53.619684+02:00
    - key=default_meeting_length_atclient, value=[90, 180, 270, 360], value_type=array, updated_at=2025-04-23 14:48:49.778155+02:00
    - key=default_meeting_length_atoffice, value=[60, 90], value_type=array, updated_at=2025-04-23 14:48:49.778155+02:00
    - key=default_meeting_length_digital, value=[10, 20, 60], value_type=array, updated_at=2025-04-23 14:48:49.778155+02:00

📁 Tabell: bookings
  • start_time (timestamp with time zone)
  • end_time (timestamp with time zone)
  • id (uuid)
  • updated_at (timestamp with time zone)
  • metadata (jsonb)
  • created_at (timestamp with time zone)
  • contact_id (uuid)
  • meeting_type (text)
  • booking_email (text)
  🔑 [p] bookings_pkey: PRIMARY KEY (id)
  🔑 [f] fk_bookings_contact: FOREIGN KEY (contact_id) REFERENCES contact(id) ON DELETE SET NULL
  🧪 Topp 5 rader:
    - start_time=2025-06-02 08:20:00+02:00, end_time=2025-06-02 08:30:00+02:00, meeting_type=zoom, metadata={'phone': '098765432', 'company': 'persson AB', 'subject': 'Möte med KLRA Ledningsrådgivning', 'location': 'Online', 'last_name': 'Johansson', 'first_name': 'Per', 'ip_address': '172.226.49.45:48167', 'meeting_id': 82144172118, 'user_agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/18.5 Safari/605.1.15', 'online_link': 'https://us05web.zoom.us/j/82144172118?pwd=zJm2Xe3RjuaM7e7HeDLoeacSdnbaVc.1', 'meeting_length': 10, 'calendar_response_status': 'none'}, created_at=2025-06-01 22:38:17.398000+02:00, contact_id=4ce9fc3f-d44f-40ca-aa9d-13e4db7f0f31, id=3d09c33e-52c9-4736-975b-61ee3713551c, updated_at=2025-06-02 21:41:27.189031+02:00, booking_email=daniel.kallberg@mac.com
    - start_time=2025-06-02 13:20:00+02:00, end_time=2025-06-02 13:30:00+02:00, meeting_type=facetime, metadata={'phone': '070-2656868', 'company': 'Anna AB', 'subject': 'FaceTime-möte: Anna | Anna AB & Daniel | Kinnekulle Ledningsrådgivning AB', 'location': 'FaceTime', 'last_name': 'Sahlin', 'first_name': 'Anna', 'ip_address': '81.233.161.165:58650', 'user_agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/18.5 Safari/605.1.15', 'online_link': 'facetime:070-2656868', 'body_preview': '<html>\r\n<head>\r\n<meta http-equiv="Content-Type" content="text/html; charset=utf-8">\r\n</head>\r\n<body>\r\nDetta är en inbjudan till möte: FaceTime-möte: Anna | Anna AB &amp; Daniel | Kinnekulle Ledningsrådgivning AB\r\n</body>\r\n</html>\r\n', 'meeting_length': 10, 'calendar_response_status': 'none'}, created_at=2025-06-01 23:14:06.367000+02:00, contact_id=6dedbbd8-661f-4f87-9b54-e302bdd6f61a, id=affd507f-ee62-4ad0-b723-609100422f3b, updated_at=2025-06-01 23:14:06.367000+02:00, booking_email=annapanna79@yahoo.com
    - start_time=2025-06-02 10:00:00+02:00, end_time=2025-06-02 10:10:00+02:00, meeting_type=zoom, metadata={'phone': '098765432', 'company': 'persson AB', 'subject': 'Möte med KLRA Ledningsrådgivning', 'location': 'Online', 'last_name': 'Johansson', 'first_name': 'Per', 'ip_address': '172.226.49.45:47716', 'meeting_id': 83811214708, 'user_agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/18.5 Safari/605.1.15', 'online_link': 'https://us05web.zoom.us/j/83811214708?pwd=uDzaG32s3i87PlV0pOwojrXUzZ7aEg.1', 'meeting_length': 10, 'calendar_response_status': 'none'}, created_at=2025-06-01 22:50:09.892000+02:00, contact_id=4ce9fc3f-d44f-40ca-aa9d-13e4db7f0f31, id=059ec692-02af-40c7-9501-0679d86b81dd, updated_at=2025-06-02 21:41:27.189031+02:00, booking_email=daniel.kallberg@mac.com
    - start_time=2025-06-02 11:20:00+02:00, end_time=2025-06-02 11:30:00+02:00, meeting_type=zoom, metadata={'phone': '098765432', 'company': 'persson AB', 'subject': 'Zoommöte: Per | persson AB & Daniel | Kinnekulle Ledningsrådgivning AB', 'location': 'Online', 'last_name': 'Johansson', 'first_name': 'Per', 'ip_address': '172.226.49.45:46831', 'meeting_id': 81612591010, 'user_agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/18.5 Safari/605.1.15', 'online_link': 'https://us05web.zoom.us/j/81612591010?pwd=3Pu0VQxyWyR0pPab7OlpAfKb7CpiWq.1', 'meeting_length': 10, 'calendar_response_status': 'none'}, created_at=2025-06-01 23:01:27.794000+02:00, contact_id=4ce9fc3f-d44f-40ca-aa9d-13e4db7f0f31, id=1a231d98-2e66-41ae-a718-6048aa624601, updated_at=2025-06-02 21:41:27.189031+02:00, booking_email=daniel.kallberg@mac.com
    - start_time=2025-06-02 10:40:00+02:00, end_time=2025-06-02 11:00:00+02:00, meeting_type=zoom, metadata={'phone': '098765432', 'company': 'persson AB', 'subject': 'Möte med KLRA Ledningsrådgivning', 'location': 'Online', 'last_name': 'Johansson', 'first_name': 'Per', 'ip_address': '172.226.49.45:47708', 'meeting_id': 86400396910, 'user_agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/18.5 Safari/605.1.15', 'online_link': 'https://us05web.zoom.us/j/86400396910?pwd=z8fdhAA8ibZ5hxJEpmebYHaX57JugC.1', 'meeting_length': 20, 'calendar_response_status': 'none'}, created_at=2025-06-01 22:56:02.371000+02:00, contact_id=4ce9fc3f-d44f-40ca-aa9d-13e4db7f0f31, id=967fa70d-2409-4884-8d5b-f2c036eb1a99, updated_at=2025-06-02 21:41:27.189031+02:00, booking_email=daniel.kallberg@mac.com

📁 Tabell: contact
  • metadata (jsonb)
  • created_at (timestamp with time zone)
  • id (uuid)
  • updated_at (timestamp with time zone)
  • booking_email (text)
  • email (text)
  🔑 [p] contact_pkey: PRIMARY KEY (id)
  🧪 Topp 5 rader:
    - metadata={'phone': '070-2656868', 'origin': 'klrab.se', 'company': 'Anna AB', 'last_name': 'Sahlin', 'first_name': 'Anna-Molnroundtrip'}, created_at=2025-06-01 23:13:46.657884+02:00, id=6dedbbd8-661f-4f87-9b54-e302bdd6f61a, booking_email=annapanna79@yahoo.com, updated_at=2025-06-02 21:45:03.859019+02:00, email=annapanna79@yahoo.com
    - metadata={'phone': '098765432', 'origin': 'klrab.se', 'company': 'persson AB', 'last_name': 'Johansson', 'first_name': 'Per'}, created_at=2025-06-01 22:37:30.699890+02:00, id=4ce9fc3f-d44f-40ca-aa9d-13e4db7f0f31, booking_email=daniel.kallberg@mac.com, updated_at=2025-06-02 08:13:47.337045+02:00, email=daniel.kallberg@mac.com

📁 Tabell: company
  • metadata (jsonb)
  • created_at (timestamp with time zone)
  • id (uuid)
  • name (text)
  • org_number (text)
  🔑 [p] company_pkey: PRIMARY KEY (id)

📁 Tabell: translation
  • key (character varying)
  • sv (text)
  • en (text)
  🔑 [u] unique_translation_key: UNIQUE (key)
  🔑 [p] translation_pkey: PRIMARY KEY (key)
  🧪 Topp 5 rader:
    - key=error_min_duration_fysiskt_kund, sv=Mötestiden för 'Fysiskt hos kund' måste vara minst {{minutes}} minuter. Du visste det redan., en=The meeting time for 'On-site at customer' must be at least {{minutes}} minutes. You knew that.
    - key=error_min_duration_fysiskt_mig, sv=Mötestiden för 'Fysiskt hos mig' måste vara minst {{minutes}} minuter. Annars hinner vi bara säga hej., en=The meeting time for 'At my office' must be at least {{minutes}} minutes. Otherwise, we’ll only have time to say hello.
    - key=email_body_booking_received, sv=Hej {{name}}! Vi har tagit emot din bokning för {{meeting_type}} mellan {{start_time}} och {{end_time}}. Ingen panik – vi återkommer med bekräftelse. / Daniel, en=Hello {{name}}, We’ve received your booking for {{meeting_type}} between {{start_time}} and {{end_time}}. No need to panic – we’ll confirm shortly. / Daniel
    - key=email_body_booking_confirmed, sv=Hej {{name}}! Din bokning för {{meeting_type}} mellan {{start_time}} och {{end_time}} är nu spikad. Ser fram emot det! / Daniel, en=Hello {{name}}, Your booking for {{meeting_type}} between {{start_time}} and {{end_time}} is now locked in. Looking forward! / Daniel
    - key=email_body_booking_cancelled, sv=Hej {{name}}! Din bokning för {{meeting_type}} mellan {{start_time}} och {{end_time}} är avbokad. Hör av dig om du vill hitta en ny tid. / Daniel, en=Hello {{name}}, Your booking for {{meeting_type}} between {{start_time}} and {{end_time}} has been cancelled. Let me know if you'd like a new one. / Daniel

📁 Tabell: ccrelation
  • id (uuid)
  • company_id (uuid)
  • contact_id (uuid)
  • main_contact (boolean)
  • start_date (date)
  • end_date (date)
  • metadata (jsonb)
  • created_at (timestamp with time zone)
  • role (text)
  🔑 [p] ccrelation_pkey: PRIMARY KEY (id)
  🔑 [f] fk_ccrelation_contact_id: FOREIGN KEY (contact_id) REFERENCES contact(id) ON DELETE CASCADE
  🔑 [f] fk_ccrelation_company_id: FOREIGN KEY (company_id) REFERENCES company(id) ON DELETE CASCADE

📁 Tabell: pending_changes
  • booking_id (uuid)
  • processed (boolean)
  • created_at (timestamp with time zone)
  • payload (jsonb)
  • id (uuid)
  • record_id (uuid)
  • table_name (text)
  • operation (text)
  • change_type (text)
  • direction (text)
  🔑 [p] pending_changes_pkey: PRIMARY KEY (id)
  🔑 [f] fk_pending_changes_booking_id: FOREIGN KEY (booking_id) REFERENCES bookings(id) ON DELETE CASCADE
  🧪 Topp 5 rader:
    - id=6031d83d-dae9-44a6-be41-ee943d051de2, table_name=bookings, record_id=3d09c33e-52c9-4736-975b-61ee3713551c, change_type=UPDATE, direction=out, processed=True, created_at=2025-06-02 22:22:55.395743+02:00, operation=UPDATE, payload={'id': '3d09c33e-52c9-4736-975b-61ee3713551c', 'end_time': '2025-06-02T08:30:00+02:00', 'metadata': '{"phone": "098765432", "company": "persson AB", "subject": "M\\u00f6te med KLRA Ledningsr\\u00e5dgivning", "location": "Online", "last_name": "Johansson", "first_name": "Per", "ip_address": "172.226.49.45:48167", "meeting_id": 82144172118, "user_agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/18.5 Safari/605.1.15", "online_link": "https://us05web.zoom.us/j/82144172118?pwd=zJm2Xe3RjuaM7e7HeDLoeacSdnbaVc.1", "meeting_length": 10, "calendar_response_status": "none"}', 'contact_id': '4ce9fc3f-d44f-40ca-aa9d-13e4db7f0f31', 'created_at': '2025-06-01T22:38:17.398000+02:00', 'start_time': '2025-06-02T08:20:00+02:00', 'updated_at': '2025-06-02T21:41:27.189031+02:00', 'meeting_type': 'zoom', 'booking_email': 'daniel.kallberg@mac.com'}, booking_id=None
    - id=68ab7988-60ee-4072-80da-03a2a865f95b, table_name=contact, record_id=4ce9fc3f-d44f-40ca-aa9d-13e4db7f0f31, change_type=UPDATE, direction=out, processed=True, created_at=2025-06-02 22:22:55.395743+02:00, operation=UPDATE, payload={'id': '4ce9fc3f-d44f-40ca-aa9d-13e4db7f0f31', 'email': 'daniel.kallberg@mac.com', 'metadata': '{"phone": "098765432", "origin": "klrab.se", "company": "Persson AB", "last_name": "Johansson", "first_name": "Per"}', 'created_at': '2025-06-01T22:37:30.699890+02:00', 'updated_at': '2025-06-02T17:10:00.571594+02:00', 'booking_email': 'daniel.kallberg@mac.com'}, booking_id=None
    - id=7e66e129-fce4-40a9-9404-b20134ee388b, table_name=bookings, record_id=3d09c33e-52c9-4736-975b-61ee3713551c, change_type=UPDATE, direction=out, processed=True, created_at=2025-06-02 22:23:43.581668+02:00, operation=UPDATE, payload={'id': '3d09c33e-52c9-4736-975b-61ee3713551c', 'end_time': '2025-06-02T08:30:00+02:00', 'metadata': '{"phone": "098765432", "company": "persson AB", "subject": "M\\u00f6te med KLRA Ledningsr\\u00e5dgivning", "location": "Online", "last_name": "Johansson", "first_name": "Per", "ip_address": "172.226.49.45:48167", "meeting_id": 82144172118, "user_agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/18.5 Safari/605.1.15", "online_link": "https://us05web.zoom.us/j/82144172118?pwd=zJm2Xe3RjuaM7e7HeDLoeacSdnbaVc.1", "meeting_length": 10, "calendar_response_status": "none"}', 'contact_id': '4ce9fc3f-d44f-40ca-aa9d-13e4db7f0f31', 'created_at': '2025-06-01T22:38:17.398000+02:00', 'start_time': '2025-06-02T08:20:00+02:00', 'updated_at': '2025-06-02T21:41:27.189031+02:00', 'meeting_type': 'zoom', 'booking_email': 'daniel.kallberg@mac.com'}, booking_id=None
    - id=6d8a1146-f3bf-48ea-9e86-537274894090, table_name=contact, record_id=4ce9fc3f-d44f-40ca-aa9d-13e4db7f0f31, change_type=UPDATE, direction=out, processed=True, created_at=2025-06-02 22:23:43.581668+02:00, operation=UPDATE, payload={'id': '4ce9fc3f-d44f-40ca-aa9d-13e4db7f0f31', 'email': 'daniel.kallberg@mac.com', 'metadata': '{"phone": "098765432", "origin": "klrab.se", "company": "Persson AB", "last_name": "Johansson", "first_name": "Per"}', 'created_at': '2025-06-01T22:37:30.699890+02:00', 'updated_at': '2025-06-02T17:10:00.571594+02:00', 'booking_email': 'daniel.kallberg@mac.com'}, booking_id=None
    - id=024e1985-24e5-46d5-b162-83833e19e93f, table_name=bookings, record_id=3d09c33e-52c9-4736-975b-61ee3713551c, change_type=UPDATE, direction=out, processed=True, created_at=2025-06-02 22:25:24.766081+02:00, operation=UPDATE, payload={'id': '3d09c33e-52c9-4736-975b-61ee3713551c', 'end_time': '2025-06-02T08:30:00+02:00', 'metadata': '{"phone": "098765432", "company": "persson AB", "subject": "M\\u00f6te med KLRA Ledningsr\\u00e5dgivning", "location": "Online", "last_name": "Johansson", "first_name": "Per", "ip_address": "172.226.49.45:48167", "meeting_id": 82144172118, "user_agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/18.5 Safari/605.1.15", "online_link": "https://us05web.zoom.us/j/82144172118?pwd=zJm2Xe3RjuaM7e7HeDLoeacSdnbaVc.1", "meeting_length": 10, "calendar_response_status": "none"}', 'contact_id': '4ce9fc3f-d44f-40ca-aa9d-13e4db7f0f31', 'created_at': '2025-06-01T22:38:17.398000+02:00', 'start_time': '2025-06-02T08:20:00+02:00', 'updated_at': '2025-06-02T21:41:27.189031+02:00', 'meeting_type': 'zoom', 'booking_email': 'daniel.kallberg@mac.com'}, booking_id=None

📁 Tabell: event_log
  • record_id (uuid)
  • received_at (timestamp with time zone)
  • timestamp (timestamp with time zone)
  • booking_id (uuid)
  • id (uuid)
  • payload (jsonb)
  • table_name (text)
  • event_type (text)
  • source (text)
  • action (text)
  🔑 [p] event_log_pkey: PRIMARY KEY (id)
  🧪 Topp 5 rader:
    - source=None, event_type=None, payload=None, received_at=2025-06-02 08:01:46.519546+02:00, id=276bd979-65e7-45ce-a637-d5b9a5a937db, table_name=contact, record_id=4ce9fc3f-d44f-40ca-aa9d-13e4db7f0f31, action=INSERT, timestamp=2025-06-02 08:01:46.519546+02:00, booking_id=None
    - source=sync, event_type=insert_contact, payload={'id': '4ce9fc3f-d44f-40ca-aa9d-13e4db7f0f31', 'email': 'daniel.kallberg@mac.com', 'metadata': {'phone': '098765432', 'company': 'persson AB', 'last_name': 'Johansson', 'first_name': 'Per'}, 'created_at': '2025-06-01T20:37:30.69989+00:00', 'updated_at': '2025-06-01T20:37:30.69989+00:00', 'booking_email': 'daniel.kallberg@mac.com'}, received_at=2025-06-02 08:01:46.519546+02:00, id=40bc4c2c-cecf-4a26-8585-85693f57ae34, table_name=None, record_id=None, action=None, timestamp=2025-06-02 08:01:46.519546+02:00, booking_id=None
    - source=None, event_type=None, payload=None, received_at=2025-06-02 08:01:46.605879+02:00, id=ce179f2c-5d73-4924-8bfd-4e6e7944a2d9, table_name=bookings, record_id=3d09c33e-52c9-4736-975b-61ee3713551c, action=INSERT, timestamp=2025-06-02 08:01:46.605879+02:00, booking_id=None
    - source=sync, event_type=insert_bookings, payload={'id': '3d09c33e-52c9-4736-975b-61ee3713551c', 'end_time': '2025-06-02T06:30:00+00:00', 'metadata': {'phone': '098765432', 'company': 'persson AB', 'subject': 'Möte med KLRA Ledningsrådgivning', 'location': 'Online', 'last_name': 'Johansson', 'first_name': 'Per', 'ip_address': '172.226.49.45:48167', 'meeting_id': 82144172118, 'user_agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/18.5 Safari/605.1.15', 'online_link': 'https://us05web.zoom.us/j/82144172118?pwd=zJm2Xe3RjuaM7e7HeDLoeacSdnbaVc.1', 'meeting_length': 10, 'calendar_response_status': 'none'}, 'contact_id': '4ce9fc3f-d44f-40ca-aa9d-13e4db7f0f31', 'created_at': '2025-06-01T20:38:17.398+00:00', 'start_time': '2025-06-02T06:20:00+00:00', 'updated_at': '2025-06-01T20:38:17.398+00:00', 'meeting_type': 'zoom', 'booking_email': 'daniel.kallberg@mac.com'}, received_at=2025-06-02 08:01:46.605879+02:00, id=c39ce22a-8d19-459a-9c2b-cf78b6050e03, table_name=None, record_id=None, action=None, timestamp=2025-06-02 08:01:46.605879+02:00, booking_id=None
    - source=None, event_type=None, payload=None, received_at=2025-06-02 08:01:46.678529+02:00, id=9ec839f6-4b26-4609-87a0-f6b9b39b9f85, table_name=bookings, record_id=059ec692-02af-40c7-9501-0679d86b81dd, action=INSERT, timestamp=2025-06-02 08:01:46.678529+02:00, booking_id=None

📊 DIFFANALYS Azure vs Lokal
====================================
--- Azure
+++ Lokal
@@ -1,99 +1,18 @@
-📊 MOLNDATABAS (Azure) – STRUKTUR & INNEHÅLL

+📊 LOKAL DATABAS – STRUKTUR & INNEHÅLL

 ====================================

-

-📁 Tabell: slot_cache

-  • created_at (timestamp without time zone)

-  • slot_day (date)

-  • slots (jsonb)

-  • id (uuid)

-  • meeting_length (integer)

-  • booking_email (text)

-  • meeting_type (text)

-  • slot_part (text)

-  🔑 [p] slot_cache_pkey: PRIMARY KEY (id)

-

-📁 Tabell: calendar_origin_cache

-  • created_at (timestamp without time zone)

-  • timestamp (timestamp with time zone)

-  • event_date (date)

-  • id (integer)

-  • end_time (timestamp without time zone)

-  • address (text)

-  • source (text)

-  🔑 [c] calendar_origin_cache_source_check: CHECK ((source = ANY (ARRAY['Apple Calendar'::text, 'Microsoft 365'::text])))

-  🔑 [p] calendar_origin_cache_pkey: PRIMARY KEY (id)

-

-📁 Tabell: available_slots_cache

-  • id (uuid)

-  • travel_time_min (integer)

-  • generated_at (timestamp without time zone)

-  • expires_at (timestamp without time zone)

-  • meeting_length (integer)

-  • slot_day (date)

-  • slot_score (integer)

-  • meeting_type (text)

-  • slot_part (text)

-  • slot_iso (text)

-  🔑 [p] available_slots_cache_pkey: PRIMARY KEY (id)

-

-📁 Tabell: travel_time_cache

-  • travel_minutes (integer)

-  • updated_at (timestamp with time zone)

-  • is_fallback (boolean)

-  • hour (integer)

-  • created_at (timestamp with time zone)

-  • to_address (text)

-  • from_address (text)

-  🔑 [u] unique_travel_key: UNIQUE (from_address, to_address, hour)

-  🧪 Topp 5 rader:

-    - from_address=Taxgatan 4, 115 45 Stockholm, to_address=Maria Skolgata 79A, 118 53 Stockholm, hour=7, travel_minutes=17, created_at=2025-06-01 20:37:36.958100+00:00, updated_at=2025-06-01 20:37:36.958100+00:00, is_fallback=False

-    - from_address=Taxgatan 4, 115 45 Stockholm, to_address=Maria Skolgata 79A, 118 53 Stockholm, hour=9, travel_minutes=17, created_at=2025-06-01 20:37:37.880289+00:00, updated_at=2025-06-01 20:37:37.880289+00:00, is_fallback=False

-    - from_address=Taxgatan 4, 115 45 Stockholm, to_address=Maria Skolgata 79A, 118 53 Stockholm, hour=11, travel_minutes=17, created_at=2025-06-01 20:37:37.776032+00:00, updated_at=2025-06-01 20:37:37.776032+00:00, is_fallback=False

-    - from_address=Taxgatan 4, 115 45 Stockholm, to_address=Maria Skolgata 79A, 118 53 Stockholm, hour=6, travel_minutes=17, created_at=2025-06-01 20:37:37.156222+00:00, updated_at=2025-06-01 20:37:37.156222+00:00, is_fallback=False

-    - from_address=Taxgatan 4, 115 45 Stockholm, to_address=Maria Skolgata 79A, 118 53 Stockholm, hour=8, travel_minutes=17, created_at=2025-06-01 20:37:37.648891+00:00, updated_at=2025-06-01 20:37:37.648891+00:00, is_fallback=False

-

-📁 Tabell: event_log

-  • received_at (timestamp with time zone)

-  • record_id (uuid)

-  • timestamp (timestamp with time zone)

-  • booking_id (uuid)

-  • id (uuid)

-  • payload (jsonb)

-  • action (text)

-  • event_type (text)

-  • source (text)

-  • table_name (text)

-  🔑 [p] event_log_pkey: PRIMARY KEY (id)

-  🧪 Topp 5 rader:

-    - source=None, event_type=None, payload=None, received_at=2025-06-01 20:37:30.699890+00:00, id=2c00583c-cc66-44ed-ad81-1b404c8385ac, action=INSERT, table_name=contact, record_id=4ce9fc3f-d44f-40ca-aa9d-13e4db7f0f31, timestamp=2025-06-01 20:37:30.699890+00:00, booking_id=None

-    - source=None, event_type=calendar_response_status, payload={'response': 'none'}, received_at=2025-06-01 20:38:18.897492+00:00, id=c06ba994-c60f-4c92-8203-dc7e00070b74, action=None, table_name=None, record_id=None, timestamp=2025-06-01 20:38:18.897492+00:00, booking_id=3d09c33e-52c9-4736-975b-61ee3713551c

-    - source=None, event_type=calendar_invite_sent, payload={'subject': 'Möte med KLRA Ledningsrådgivning', 'webLink': 'https://outlook.office365.com/owa/?itemid=AAMkADIyMzUxMTE1LWQ0NDUtNDMwNC05YmE3LTRhMThmNDkyNzA2ZABGAAAAAAD8zD4S9766TIdQsQEV5sX5BwB0FUy6J9MkSLnOAsVgC0tuAAAAAAENAAB0FUy6J9MkSLnOAsVgC0tuAAAnEf1vAAA%3D&exvsurl=1&path=/calendar/item', 'location': 'Online'}, received_at=2025-06-01 20:38:18.923033+00:00, id=b47ba88d-c7d2-4382-8aa5-9dcff24a5e35, action=None, table_name=None, record_id=None, timestamp=2025-06-01 20:38:18.923033+00:00, booking_id=3d09c33e-52c9-4736-975b-61ee3713551c

-    - source=None, event_type=calendar_event_created, payload={'end': {'dateTime': '2025-06-02T06:30:00.0000000', 'timeZone': 'UTC'}, 'body': {'content': '<html>\r\n<head>\r\n<meta http-equiv="Content-Type" content="text/html; charset=utf-8">\r\n</head>\r\n<body>\r\nDetta är en inbjudan till möte: Möte med KLRA Ledningsrådgivning\r\n</body>\r\n</html>\r\n', 'contentType': 'html'}, 'start': {'dateTime': '2025-06-02T06:20:00.0000000', 'timeZone': 'UTC'}, 'eventId': 'AAMkADIyMzUxMTE1LWQ0NDUtNDMwNC05YmE3LTRhMThmNDkyNzA2ZABGAAAAAAD8zD4S9766TIdQsQEV5sX5BwB0FUy6J9MkSLnOAsVgC0tuAAAAAAENAAB0FUy6J9MkSLnOAsVgC0tuAAAnEf1vAAA=', 'subject': 'Möte med KLRA Ledningsrådgivning', 'webLink': 'https://outlook.office365.com/owa/?itemid=AAMkADIyMzUxMTE1LWQ0NDUtNDMwNC05YmE3LTRhMThmNDkyNzA2ZABGAAAAAAD8zD4S9766TIdQsQEV5sX5BwB0FUy6J9MkSLnOAsVgC0tuAAAAAAENAAB0FUy6J9MkSLnOAsVgC0tuAAAnEf1vAAA%3D&exvsurl=1&path=/calendar/item', 'location': 'Online', 'attendees': [{'type': 'required', 'status': {'time': '0001-01-01T00:00:00Z', 'response': 'none'}, 'emailAddress': {'name': 'daniel.kallberg@mac.com', 'address': 'daniel.kallberg@mac.com'}}], 'onlineMeetingUrl': None}, received_at=2025-06-01 20:38:18.949898+00:00, id=a8781988-c135-4f0b-9eb0-16b2a88c9f9c, action=None, table_name=None, record_id=None, timestamp=2025-06-01 20:38:18.949898+00:00, booking_id=3d09c33e-52c9-4736-975b-61ee3713551c

-    - source=None, event_type=calendar_invite_sent, payload={'subject': 'Möte med KLRA Ledningsrådgivning', 'webLink': 'https://us05web.zoom.us/j/82144172118?pwd=zJm2Xe3RjuaM7e7HeDLoeacSdnbaVc.1', 'location': 'Online'}, received_at=2025-06-01 20:38:18.975463+00:00, id=835d1bab-4d1a-4fe5-8da0-4597f7131fde, action=None, table_name=None, record_id=None, timestamp=2025-06-01 20:38:18.975463+00:00, booking_id=3d09c33e-52c9-4736-975b-61ee3713551c

 

 📁 Tabell: booking_settings

   • value (jsonb)

   • updated_at (timestamp with time zone)

   • key (text)

   • value_type (text)

-  🔑 [u] unique_key: UNIQUE (key)

+  🔑 [p] booking_settings_pkey: PRIMARY KEY (key)

   🧪 Topp 5 rader:

-    - key=email_subject_templates, value={'zoom': 'Zoommöte: {{first_name}} | {{company}} & Daniel | Kinnekulle Ledningsrådgivning AB', 'teams': 'Teamsmöte: {{first_name}} | {{company}} & Daniel | Kinnekulle Ledningsrådgivning AB', 'atclient': 'Möte hos {{company}}: {{first_name}} | {{company}} & Daniel | Kinnekulle Ledningsrådgivning AB', 'atoffice': 'Möte hos KLR AB (Stockholm | Södermalm): {{first_name}} | {{company}} & Daniel | Kinnekulle Ledningsrådgivning AB', 'facetime': 'FaceTime-möte: {{first_name}} | {{company}} & Daniel | Kinnekulle Ledningsrådgivning AB'}, value_type=json, updated_at=2025-05-30 20:46:14.058171+00:00

-    - key=default_language, value=sv, value_type=string, updated_at=2025-05-25 10:37:53.619684+00:00

-    - key=default_meeting_length_atclient, value=[90, 180, 270, 360], value_type=array, updated_at=2025-04-23 12:48:49.778155+00:00

-    - key=default_meeting_length_atoffice, value=[60, 90], value_type=array, updated_at=2025-04-23 12:48:49.778155+00:00

-    - key=default_meeting_length_digital, value=[10, 20, 60], value_type=array, updated_at=2025-04-23 12:48:49.778155+00:00

-

-📁 Tabell: translation

-  • key (character varying)

-  • sv (text)

-  • en (text)

-  🧪 Topp 5 rader:

-    - key=error_invalid_phone, sv=Ogiltigt telefonnummer. Vi vet att det är svårt att komma ihåg sitt nummer., en=Invalid phone number. We know remembering your own number is hard.

-    - key=error_invalid_name, sv=Namnet är ogiltigt (minst 2 tecken, max 50). Smeknamn som "X" är för Elon., en=Invalid name (min 2 characters, max 50). Nicknames like "X" are taken.

-    - key=error_missing_fields, sv=Alla fält måste vara ifyllda. Vi är petiga så du slipper bli det senare., en=All fields must be filled. We’re picky so you don’t have to be later.

-    - key=error_missing_meeting_link, sv=Möteslänk krävs. Om inte mötet sker via brevduva., en=A meeting link is required. Unless the meeting is via carrier pigeon.

-    - key=error_missing_recaptcha, sv=reCAPTCHA måste verifieras. Nej, det är inte en känslomässig fråga., en=reCAPTCHA verification required. And no, it’s not a personality test.

+    - key=email_subject_templates, value={'zoom': 'Zoommöte: {{first_name}} | {{company}} & Daniel | Kinnekulle Ledningsrådgivning AB', 'teams': 'Teamsmöte: {{first_name}} | {{company}} & Daniel | Kinnekulle Ledningsrådgivning AB', 'atclient': 'Möte hos {{company}}: {{first_name}} | {{company}} & Daniel | Kinnekulle Ledningsrådgivning AB', 'atoffice': 'Möte hos KLR AB (Stockholm | Södermalm): {{first_name}} | {{company}} & Daniel | Kinnekulle Ledningsrådgivning AB', 'facetime': 'FaceTime-möte: {{first_name}} | {{company}} & Daniel | Kinnekulle Ledningsrådgivning AB'}, value_type=json, updated_at=2025-05-30 22:46:14.058171+02:00

+    - key=default_language, value=sv, value_type=string, updated_at=2025-05-25 12:37:53.619684+02:00

+    - key=default_meeting_length_atclient, value=[90, 180, 270, 360], value_type=array, updated_at=2025-04-23 14:48:49.778155+02:00

+    - key=default_meeting_length_atoffice, value=[60, 90], value_type=array, updated_at=2025-04-23 14:48:49.778155+02:00

+    - key=default_meeting_length_digital, value=[10, 20, 60], value_type=array, updated_at=2025-04-23 14:48:49.778155+02:00

 

 📁 Tabell: bookings

   • start_time (timestamp with time zone)

@@ -108,11 +27,58 @@
   🔑 [p] bookings_pkey: PRIMARY KEY (id)

   🔑 [f] fk_bookings_contact: FOREIGN KEY (contact_id) REFERENCES contact(id) ON DELETE SET NULL

   🧪 Topp 5 rader:

-    - start_time=2025-06-02 11:20:00+00:00, end_time=2025-06-02 11:30:00+00:00, meeting_type=facetime, metadata={'phone': '070-2656868', 'company': 'Anna AB', 'subject': 'FaceTime-möte: Anna | Anna AB & Daniel | Kinnekulle Ledningsrådgivning AB', 'location': 'FaceTime', 'last_name': 'Sahlin', 'first_name': 'Anna', 'ip_address': '81.233.161.165:58650', 'user_agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/18.5 Safari/605.1.15', 'online_link': 'facetime:070-2656868', 'body_preview': '<html>\r\n<head>\r\n<meta http-equiv="Content-Type" content="text/html; charset=utf-8">\r\n</head>\r\n<body>\r\nDetta är en inbjudan till möte: FaceTime-möte: Anna | Anna AB &amp; Daniel | Kinnekulle Ledningsrådgivning AB\r\n</body>\r\n</html>\r\n', 'meeting_length': 10, 'calendar_response_status': 'none'}, created_at=2025-06-01 21:14:06.367000+00:00, contact_id=6dedbbd8-661f-4f87-9b54-e302bdd6f61a, id=affd507f-ee62-4ad0-b723-609100422f3b, updated_at=2025-06-01 21:14:06.367000+00:00, booking_email=annapanna79@yahoo.com

-    - start_time=2025-06-02 06:20:00+00:00, end_time=2025-06-02 06:30:00+00:00, meeting_type=zoom, metadata={'phone': '098765432', 'company': 'persson AB', 'subject': 'Möte med KLRA Ledningsrådgivning', 'location': 'Online', 'last_name': 'Johansson', 'first_name': 'Per', 'ip_address': '172.226.49.45:48167', 'meeting_id': 82144172118, 'user_agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/18.5 Safari/605.1.15', 'online_link': 'https://us05web.zoom.us/j/82144172118?pwd=zJm2Xe3RjuaM7e7HeDLoeacSdnbaVc.1', 'meeting_length': 10, 'calendar_response_status': 'none'}, created_at=2025-06-01 20:38:17.398000+00:00, contact_id=4ce9fc3f-d44f-40ca-aa9d-13e4db7f0f31, id=3d09c33e-52c9-4736-975b-61ee3713551c, updated_at=2025-06-02 19:41:44.074564+00:00, booking_email=daniel.kallberg@mac.com

-    - start_time=2025-06-02 08:00:00+00:00, end_time=2025-06-02 08:10:00+00:00, meeting_type=zoom, metadata={'phone': '098765432', 'company': 'persson AB', 'subject': 'Möte med KLRA Ledningsrådgivning', 'location': 'Online', 'last_name': 'Johansson', 'first_name': 'Per', 'ip_address': '172.226.49.45:47716', 'meeting_id': 83811214708, 'user_agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/18.5 Safari/605.1.15', 'online_link': 'https://us05web.zoom.us/j/83811214708?pwd=uDzaG32s3i87PlV0pOwojrXUzZ7aEg.1', 'meeting_length': 10, 'calendar_response_status': 'none'}, created_at=2025-06-01 20:50:09.892000+00:00, contact_id=4ce9fc3f-d44f-40ca-aa9d-13e4db7f0f31, id=059ec692-02af-40c7-9501-0679d86b81dd, updated_at=2025-06-02 19:41:44.074564+00:00, booking_email=daniel.kallberg@mac.com

-    - start_time=2025-06-02 08:40:00+00:00, end_time=2025-06-02 09:00:00+00:00, meeting_type=zoom, metadata={'phone': '098765432', 'company': 'persson AB', 'subject': 'Möte med KLRA Ledningsrådgivning', 'location': 'Online', 'last_name': 'Johansson', 'first_name': 'Per', 'ip_address': '172.226.49.45:47708', 'meeting_id': 86400396910, 'user_agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/18.5 Safari/605.1.15', 'online_link': 'https://us05web.zoom.us/j/86400396910?pwd=z8fdhAA8ibZ5hxJEpmebYHaX57JugC.1', 'meeting_length': 20, 'calendar_response_status': 'none'}, created_at=2025-06-01 20:56:02.371000+00:00, contact_id=4ce9fc3f-d44f-40ca-aa9d-13e4db7f0f31, id=967fa70d-2409-4884-8d5b-f2c036eb1a99, updated_at=2025-06-02 19:41:44.074564+00:00, booking_email=daniel.kallberg@mac.com

-    - start_time=2025-06-02 09:20:00+00:00, end_time=2025-06-02 09:30:00+00:00, meeting_type=zoom, metadata={'phone': '098765432', 'company': 'persson AB', 'subject': 'Zoommöte: Per | persson AB & Daniel | Kinnekulle Ledningsrådgivning AB', 'location': 'Online', 'last_name': 'Johansson', 'first_name': 'Per', 'ip_address': '172.226.49.45:46831', 'meeting_id': 81612591010, 'user_agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/18.5 Safari/605.1.15', 'online_link': 'https://us05web.zoom.us/j/81612591010?pwd=3Pu0VQxyWyR0pPab7OlpAfKb7CpiWq.1', 'meeting_length': 10, 'calendar_response_status': 'none'}, created_at=2025-06-01 21:01:27.794000+00:00, contact_id=4ce9fc3f-d44f-40ca-aa9d-13e4db7f0f31, id=1a231d98-2e66-41ae-a718-6048aa624601, updated_at=2025-06-02 19:41:44.074564+00:00, booking_email=daniel.kallberg@mac.com

+    - start_time=2025-06-02 08:20:00+02:00, end_time=2025-06-02 08:30:00+02:00, meeting_type=zoom, metadata={'phone': '098765432', 'company': 'persson AB', 'subject': 'Möte med KLRA Ledningsrådgivning', 'location': 'Online', 'last_name': 'Johansson', 'first_name': 'Per', 'ip_address': '172.226.49.45:48167', 'meeting_id': 82144172118, 'user_agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/18.5 Safari/605.1.15', 'online_link': 'https://us05web.zoom.us/j/82144172118?pwd=zJm2Xe3RjuaM7e7HeDLoeacSdnbaVc.1', 'meeting_length': 10, 'calendar_response_status': 'none'}, created_at=2025-06-01 22:38:17.398000+02:00, contact_id=4ce9fc3f-d44f-40ca-aa9d-13e4db7f0f31, id=3d09c33e-52c9-4736-975b-61ee3713551c, updated_at=2025-06-02 21:41:27.189031+02:00, booking_email=daniel.kallberg@mac.com

+    - start_time=2025-06-02 13:20:00+02:00, end_time=2025-06-02 13:30:00+02:00, meeting_type=facetime, metadata={'phone': '070-2656868', 'company': 'Anna AB', 'subject': 'FaceTime-möte: Anna | Anna AB & Daniel | Kinnekulle Ledningsrådgivning AB', 'location': 'FaceTime', 'last_name': 'Sahlin', 'first_name': 'Anna', 'ip_address': '81.233.161.165:58650', 'user_agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/18.5 Safari/605.1.15', 'online_link': 'facetime:070-2656868', 'body_preview': '<html>\r\n<head>\r\n<meta http-equiv="Content-Type" content="text/html; charset=utf-8">\r\n</head>\r\n<body>\r\nDetta är en inbjudan till möte: FaceTime-möte: Anna | Anna AB &amp; Daniel | Kinnekulle Ledningsrådgivning AB\r\n</body>\r\n</html>\r\n', 'meeting_length': 10, 'calendar_response_status': 'none'}, created_at=2025-06-01 23:14:06.367000+02:00, contact_id=6dedbbd8-661f-4f87-9b54-e302bdd6f61a, id=affd507f-ee62-4ad0-b723-609100422f3b, updated_at=2025-06-01 23:14:06.367000+02:00, booking_email=annapanna79@yahoo.com

+    - start_time=2025-06-02 10:00:00+02:00, end_time=2025-06-02 10:10:00+02:00, meeting_type=zoom, metadata={'phone': '098765432', 'company': 'persson AB', 'subject': 'Möte med KLRA Ledningsrådgivning', 'location': 'Online', 'last_name': 'Johansson', 'first_name': 'Per', 'ip_address': '172.226.49.45:47716', 'meeting_id': 83811214708, 'user_agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/18.5 Safari/605.1.15', 'online_link': 'https://us05web.zoom.us/j/83811214708?pwd=uDzaG32s3i87PlV0pOwojrXUzZ7aEg.1', 'meeting_length': 10, 'calendar_response_status': 'none'}, created_at=2025-06-01 22:50:09.892000+02:00, contact_id=4ce9fc3f-d44f-40ca-aa9d-13e4db7f0f31, id=059ec692-02af-40c7-9501-0679d86b81dd, updated_at=2025-06-02 21:41:27.189031+02:00, booking_email=daniel.kallberg@mac.com

+    - start_time=2025-06-02 11:20:00+02:00, end_time=2025-06-02 11:30:00+02:00, meeting_type=zoom, metadata={'phone': '098765432', 'company': 'persson AB', 'subject': 'Zoommöte: Per | persson AB & Daniel | Kinnekulle Ledningsrådgivning AB', 'location': 'Online', 'last_name': 'Johansson', 'first_name': 'Per', 'ip_address': '172.226.49.45:46831', 'meeting_id': 81612591010, 'user_agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/18.5 Safari/605.1.15', 'online_link': 'https://us05web.zoom.us/j/81612591010?pwd=3Pu0VQxyWyR0pPab7OlpAfKb7CpiWq.1', 'meeting_length': 10, 'calendar_response_status': 'none'}, created_at=2025-06-01 23:01:27.794000+02:00, contact_id=4ce9fc3f-d44f-40ca-aa9d-13e4db7f0f31, id=1a231d98-2e66-41ae-a718-6048aa624601, updated_at=2025-06-02 21:41:27.189031+02:00, booking_email=daniel.kallberg@mac.com

+    - start_time=2025-06-02 10:40:00+02:00, end_time=2025-06-02 11:00:00+02:00, meeting_type=zoom, metadata={'phone': '098765432', 'company': 'persson AB', 'subject': 'Möte med KLRA Ledningsrådgivning', 'location': 'Online', 'last_name': 'Johansson', 'first_name': 'Per', 'ip_address': '172.226.49.45:47708', 'meeting_id': 86400396910, 'user_agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/18.5 Safari/605.1.15', 'online_link': 'https://us05web.zoom.us/j/86400396910?pwd=z8fdhAA8ibZ5hxJEpmebYHaX57JugC.1', 'meeting_length': 20, 'calendar_response_status': 'none'}, created_at=2025-06-01 22:56:02.371000+02:00, contact_id=4ce9fc3f-d44f-40ca-aa9d-13e4db7f0f31, id=967fa70d-2409-4884-8d5b-f2c036eb1a99, updated_at=2025-06-02 21:41:27.189031+02:00, booking_email=daniel.kallberg@mac.com

+

+📁 Tabell: contact

+  • metadata (jsonb)

+  • created_at (timestamp with time zone)

+  • id (uuid)

+  • updated_at (timestamp with time zone)

+  • booking_email (text)

+  • email (text)

+  🔑 [p] contact_pkey: PRIMARY KEY (id)

+  🧪 Topp 5 rader:

+    - metadata={'phone': '070-2656868', 'origin': 'klrab.se', 'company': 'Anna AB', 'last_name': 'Sahlin', 'first_name': 'Anna-Molnroundtrip'}, created_at=2025-06-01 23:13:46.657884+02:00, id=6dedbbd8-661f-4f87-9b54-e302bdd6f61a, booking_email=annapanna79@yahoo.com, updated_at=2025-06-02 21:45:03.859019+02:00, email=annapanna79@yahoo.com

+    - metadata={'phone': '098765432', 'origin': 'klrab.se', 'company': 'persson AB', 'last_name': 'Johansson', 'first_name': 'Per'}, created_at=2025-06-01 22:37:30.699890+02:00, id=4ce9fc3f-d44f-40ca-aa9d-13e4db7f0f31, booking_email=daniel.kallberg@mac.com, updated_at=2025-06-02 08:13:47.337045+02:00, email=daniel.kallberg@mac.com

+

+📁 Tabell: company

+  • metadata (jsonb)

+  • created_at (timestamp with time zone)

+  • id (uuid)

+  • name (text)

+  • org_number (text)

+  🔑 [p] company_pkey: PRIMARY KEY (id)

+

+📁 Tabell: translation

+  • key (character varying)

+  • sv (text)

+  • en (text)

+  🔑 [u] unique_translation_key: UNIQUE (key)

+  🔑 [p] translation_pkey: PRIMARY KEY (key)

+  🧪 Topp 5 rader:

+    - key=error_min_duration_fysiskt_kund, sv=Mötestiden för 'Fysiskt hos kund' måste vara minst {{minutes}} minuter. Du visste det redan., en=The meeting time for 'On-site at customer' must be at least {{minutes}} minutes. You knew that.

+    - key=error_min_duration_fysiskt_mig, sv=Mötestiden för 'Fysiskt hos mig' måste vara minst {{minutes}} minuter. Annars hinner vi bara säga hej., en=The meeting time for 'At my office' must be at least {{minutes}} minutes. Otherwise, we’ll only have time to say hello.

+    - key=email_body_booking_received, sv=Hej {{name}}! Vi har tagit emot din bokning för {{meeting_type}} mellan {{start_time}} och {{end_time}}. Ingen panik – vi återkommer med bekräftelse. / Daniel, en=Hello {{name}}, We’ve received your booking for {{meeting_type}} between {{start_time}} and {{end_time}}. No need to panic – we’ll confirm shortly. / Daniel

+    - key=email_body_booking_confirmed, sv=Hej {{name}}! Din bokning för {{meeting_type}} mellan {{start_time}} och {{end_time}} är nu spikad. Ser fram emot det! / Daniel, en=Hello {{name}}, Your booking for {{meeting_type}} between {{start_time}} and {{end_time}} is now locked in. Looking forward! / Daniel

+    - key=email_body_booking_cancelled, sv=Hej {{name}}! Din bokning för {{meeting_type}} mellan {{start_time}} och {{end_time}} är avbokad. Hör av dig om du vill hitta en ny tid. / Daniel, en=Hello {{name}}, Your booking for {{meeting_type}} between {{start_time}} and {{end_time}} has been cancelled. Let me know if you'd like a new one. / Daniel

+

+📁 Tabell: ccrelation

+  • id (uuid)

+  • company_id (uuid)

+  • contact_id (uuid)

+  • main_contact (boolean)

+  • start_date (date)

+  • end_date (date)

+  • metadata (jsonb)

+  • created_at (timestamp with time zone)

+  • role (text)

+  🔑 [p] ccrelation_pkey: PRIMARY KEY (id)

+  🔑 [f] fk_ccrelation_contact_id: FOREIGN KEY (contact_id) REFERENCES contact(id) ON DELETE CASCADE

+  🔑 [f] fk_ccrelation_company_id: FOREIGN KEY (company_id) REFERENCES company(id) ON DELETE CASCADE

 

 📁 Tabell: pending_changes

   • booking_id (uuid)

@@ -128,21 +94,28 @@
   🔑 [p] pending_changes_pkey: PRIMARY KEY (id)

   🔑 [f] fk_pending_changes_booking_id: FOREIGN KEY (booking_id) REFERENCES bookings(id) ON DELETE CASCADE

   🧪 Topp 5 rader:

-    - id=fff97701-6232-4ac2-ba9f-b1c02769b414, table_name=bookings, record_id=3d09c33e-52c9-4736-975b-61ee3713551c, change_type=INSERT, direction=cloud_to_local, processed=False, created_at=2025-06-01 20:38:19.055000+00:00, operation=None, payload=None, booking_id=3d09c33e-52c9-4736-975b-61ee3713551c

-    - id=93cd0ba6-50f9-4c4b-80f4-5822c0f14912, table_name=bookings, record_id=059ec692-02af-40c7-9501-0679d86b81dd, change_type=INSERT, direction=cloud_to_local, processed=False, created_at=2025-06-01 20:50:11.295000+00:00, operation=None, payload=None, booking_id=059ec692-02af-40c7-9501-0679d86b81dd

-    - id=c13128f8-3198-4d29-9b4b-673ff2dabe41, table_name=bookings, record_id=967fa70d-2409-4884-8d5b-f2c036eb1a99, change_type=INSERT, direction=cloud_to_local, processed=False, created_at=2025-06-01 20:56:03.629000+00:00, operation=None, payload=None, booking_id=967fa70d-2409-4884-8d5b-f2c036eb1a99

-    - id=fbd2921d-a75d-49b3-b1af-a62fc5cb4652, table_name=bookings, record_id=1a231d98-2e66-41ae-a718-6048aa624601, change_type=INSERT, direction=cloud_to_local, processed=False, created_at=2025-06-01 21:01:29.511000+00:00, operation=None, payload=None, booking_id=1a231d98-2e66-41ae-a718-6048aa624601

-    - id=9c53a7e8-4147-482e-93e7-0e5c9a4002a1, table_name=bookings, record_id=affd507f-ee62-4ad0-b723-609100422f3b, change_type=INSERT, direction=cloud_to_local, processed=False, created_at=2025-06-01 21:14:07.151000+00:00, operation=None, payload=None, booking_id=affd507f-ee62-4ad0-b723-609100422f3b

+    - id=6031d83d-dae9-44a6-be41-ee943d051de2, table_name=bookings, record_id=3d09c33e-52c9-4736-975b-61ee3713551c, change_type=UPDATE, direction=out, processed=True, created_at=2025-06-02 22:22:55.395743+02:00, operation=UPDATE, payload={'id': '3d09c33e-52c9-4736-975b-61ee3713551c', 'end_time': '2025-06-02T08:30:00+02:00', 'metadata': '{"phone": "098765432", "company": "persson AB", "subject": "M\\u00f6te med KLRA Ledningsr\\u00e5dgivning", "location": "Online", "last_name": "Johansson", "first_name": "Per", "ip_address": "172.226.49.45:48167", "meeting_id": 82144172118, "user_agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/18.5 Safari/605.1.15", "online_link": "https://us05web.zoom.us/j/82144172118?pwd=zJm2Xe3RjuaM7e7HeDLoeacSdnbaVc.1", "meeting_length": 10, "calendar_response_status": "none"}', 'contact_id': '4ce9fc3f-d44f-40ca-aa9d-13e4db7f0f31', 'created_at': '2025-06-01T22:38:17.398000+02:00', 'start_time': '2025-06-02T08:20:00+02:00', 'updated_at': '2025-06-02T21:41:27.189031+02:00', 'meeting_type': 'zoom', 'booking_email': 'daniel.kallberg@mac.com'}, booking_id=None

+    - id=68ab7988-60ee-4072-80da-03a2a865f95b, table_name=contact, record_id=4ce9fc3f-d44f-40ca-aa9d-13e4db7f0f31, change_type=UPDATE, direction=out, processed=True, created_at=2025-06-02 22:22:55.395743+02:00, operation=UPDATE, payload={'id': '4ce9fc3f-d44f-40ca-aa9d-13e4db7f0f31', 'email': 'daniel.kallberg@mac.com', 'metadata': '{"phone": "098765432", "origin": "klrab.se", "company": "Persson AB", "last_name": "Johansson", "first_name": "Per"}', 'created_at': '2025-06-01T22:37:30.699890+02:00', 'updated_at': '2025-06-02T17:10:00.571594+02:00', 'booking_email': 'daniel.kallberg@mac.com'}, booking_id=None

+    - id=7e66e129-fce4-40a9-9404-b20134ee388b, table_name=bookings, record_id=3d09c33e-52c9-4736-975b-61ee3713551c, change_type=UPDATE, direction=out, processed=True, created_at=2025-06-02 22:23:43.581668+02:00, operation=UPDATE, payload={'id': '3d09c33e-52c9-4736-975b-61ee3713551c', 'end_time': '2025-06-02T08:30:00+02:00', 'metadata': '{"phone": "098765432", "company": "persson AB", "subject": "M\\u00f6te med KLRA Ledningsr\\u00e5dgivning", "location": "Online", "last_name": "Johansson", "first_name": "Per", "ip_address": "172.226.49.45:48167", "meeting_id": 82144172118, "user_agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/18.5 Safari/605.1.15", "online_link": "https://us05web.zoom.us/j/82144172118?pwd=zJm2Xe3RjuaM7e7HeDLoeacSdnbaVc.1", "meeting_length": 10, "calendar_response_status": "none"}', 'contact_id': '4ce9fc3f-d44f-40ca-aa9d-13e4db7f0f31', 'created_at': '2025-06-01T22:38:17.398000+02:00', 'start_time': '2025-06-02T08:20:00+02:00', 'updated_at': '2025-06-02T21:41:27.189031+02:00', 'meeting_type': 'zoom', 'booking_email': 'daniel.kallberg@mac.com'}, booking_id=None

+    - id=6d8a1146-f3bf-48ea-9e86-537274894090, table_name=contact, record_id=4ce9fc3f-d44f-40ca-aa9d-13e4db7f0f31, change_type=UPDATE, direction=out, processed=True, created_at=2025-06-02 22:23:43.581668+02:00, operation=UPDATE, payload={'id': '4ce9fc3f-d44f-40ca-aa9d-13e4db7f0f31', 'email': 'daniel.kallberg@mac.com', 'metadata': '{"phone": "098765432", "origin": "klrab.se", "company": "Persson AB", "last_name": "Johansson", "first_name": "Per"}', 'created_at': '2025-06-01T22:37:30.699890+02:00', 'updated_at': '2025-06-02T17:10:00.571594+02:00', 'booking_email': 'daniel.kallberg@mac.com'}, booking_id=None

+    - id=024e1985-24e5-46d5-b162-83833e19e93f, table_name=bookings, record_id=3d09c33e-52c9-4736-975b-61ee3713551c, change_type=UPDATE, direction=out, processed=True, created_at=2025-06-02 22:25:24.766081+02:00, operation=UPDATE, payload={'id': '3d09c33e-52c9-4736-975b-61ee3713551c', 'end_time': '2025-06-02T08:30:00+02:00', 'metadata': '{"phone": "098765432", "company": "persson AB", "subject": "M\\u00f6te med KLRA Ledningsr\\u00e5dgivning", "location": "Online", "last_name": "Johansson", "first_name": "Per", "ip_address": "172.226.49.45:48167", "meeting_id": 82144172118, "user_agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/18.5 Safari/605.1.15", "online_link": "https://us05web.zoom.us/j/82144172118?pwd=zJm2Xe3RjuaM7e7HeDLoeacSdnbaVc.1", "meeting_length": 10, "calendar_response_status": "none"}', 'contact_id': '4ce9fc3f-d44f-40ca-aa9d-13e4db7f0f31', 'created_at': '2025-06-01T22:38:17.398000+02:00', 'start_time': '2025-06-02T08:20:00+02:00', 'updated_at': '2025-06-02T21:41:27.189031+02:00', 'meeting_type': 'zoom', 'booking_email': 'daniel.kallberg@mac.com'}, booking_id=None

 

-📁 Tabell: contact

-  • metadata (jsonb)

-  • created_at (timestamp with time zone)

+📁 Tabell: event_log

+  • record_id (uuid)

+  • received_at (timestamp with time zone)

+  • timestamp (timestamp with time zone)

+  • booking_id (uuid)

   • id (uuid)

-  • updated_at (timestamp with time zone)

-  • booking_email (text)

-  • email (text)

-  🔑 [p] contact_pkey: PRIMARY KEY (id)

+  • payload (jsonb)

+  • table_name (text)

+  • event_type (text)

+  • source (text)

+  • action (text)

+  🔑 [p] event_log_pkey: PRIMARY KEY (id)

   🧪 Topp 5 rader:

-    - metadata={'phone': '098765432', 'origin': 'klrab.se', 'company': 'persson AB', 'last_name': 'Johansson', 'first_name': 'Per'}, created_at=2025-06-01 20:37:30.699890+00:00, id=4ce9fc3f-d44f-40ca-aa9d-13e4db7f0f31, booking_email=daniel.kallberg@mac.com, updated_at=2025-06-02 06:13:47.337045+00:00, email=daniel.kallberg@mac.com

-    - metadata={'phone': '070-2656868', 'origin': 'klrab.se', 'company': 'Anna AB', 'last_name': 'Sahlin', 'first_name': 'Anna-Molnroundtrip'}, created_at=2025-06-01 21:13:46.657884+00:00, id=6dedbbd8-661f-4f87-9b54-e302bdd6f61a, booking_email=annapanna79@yahoo.com, updated_at=2025-06-02 19:45:03.859019+00:00, email=annapanna79@yahoo.com

+    - source=None, event_type=None, payload=None, received_at=2025-06-02 08:01:46.519546+02:00, id=276bd979-65e7-45ce-a637-d5b9a5a937db, table_name=contact, record_id=4ce9fc3f-d44f-40ca-aa9d-13e4db7f0f31, action=INSERT, timestamp=2025-06-02 08:01:46.519546+02:00, booking_id=None

+    - source=sync, event_type=insert_contact, payload={'id': '4ce9fc3f-d44f-40ca-aa9d-13e4db7f0f31', 'email': 'daniel.kallberg@mac.com', 'metadata': {'phone': '098765432', 'company': 'persson AB', 'last_name': 'Johansson', 'first_name': 'Per'}, 'created_at': '2025-06-01T20:37:30.69989+00:00', 'updated_at': '2025-06-01T20:37:30.69989+00:00', 'booking_email': 'daniel.kallberg@mac.com'}, received_at=2025-06-02 08:01:46.519546+02:00, id=40bc4c2c-cecf-4a26-8585-85693f57ae34, table_name=None, record_id=None, action=None, timestamp=2025-06-02 08:01:46.519546+02:00, booking_id=None

+    - source=None, event_type=None, payload=None, received_at=2025-06-02 08:01:46.605879+02:00, id=ce179f2c-5d73-4924-8bfd-4e6e7944a2d9, table_name=bookings, record_id=3d09c33e-52c9-4736-975b-61ee3713551c, action=INSERT, timestamp=2025-06-02 08:01:46.605879+02:00, booking_id=None

+    - source=sync, event_type=insert_bookings, payload={'id': '3d09c33e-52c9-4736-975b-61ee3713551c', 'end_time': '2025-06-02T06:30:00+00:00', 'metadata': {'phone': '098765432', 'company': 'persson AB', 'subject': 'Möte med KLRA Ledningsrådgivning', 'location': 'Online', 'last_name': 'Johansson', 'first_name': 'Per', 'ip_address': '172.226.49.45:48167', 'meeting_id': 82144172118, 'user_agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/18.5 Safari/605.1.15', 'online_link': 'https://us05web.zoom.us/j/82144172118?pwd=zJm2Xe3RjuaM7e7HeDLoeacSdnbaVc.1', 'meeting_length': 10, 'calendar_response_status': 'none'}, 'contact_id': '4ce9fc3f-d44f-40ca-aa9d-13e4db7f0f31', 'created_at': '2025-06-01T20:38:17.398+00:00', 'start_time': '2025-06-02T06:20:00+00:00', 'updated_at': '2025-06-01T20:38:17.398+00:00', 'meeting_type': 'zoom', 'booking_email': 'daniel.kallberg@mac.com'}, received_at=2025-06-02 08:01:46.605879+02:00, id=c39ce22a-8d19-459a-9c2b-cf78b6050e03, table_name=None, record_id=None, action=None, timestamp=2025-06-02 08:01:46.605879+02:00, booking_id=None

+    - source=None, event_type=None, payload=None, received_at=2025-06-02 08:01:46.678529+02:00, id=9ec839f6-4b26-4609-87a0-f6b9b39b9f85, table_name=bookings, record_id=059ec692-02af-40c7-9501-0679d86b81dd, action=INSERT, timestamp=2025-06-02 08:01:46.678529+02:00, booking_id=None

 

