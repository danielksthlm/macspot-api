ğŸ“‚ KODTRÃ„D
==========
â”œâ”€â”€ Documents
â”‚   â”œâ”€â”€ KLR_AI
â”‚   â”‚   â”œâ”€â”€ Projekt_MacSpot
â”‚   â”‚   â”‚   â”œâ”€â”€ macspot-api
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ AllSyncCodes_history
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ _lokal_temp.txt
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ§Š_azure_temp.txt
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ§®_diff_output.txt
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ healthcheck_sync.py
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ sync.py
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ sync_all.py
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ sync_from_cloud.py
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ sync_plist.xml
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ sync_static_tables.py
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ sync_to_cloud.py
â”œâ”€â”€ Library
â”‚   â”œâ”€â”€ LaunchAgents
â”‚   â”‚   â”œâ”€â”€ com.macspot.sync.plist
==========

====================
ğŸ“„ Fil: Documents/KLR_AI/Projekt_MacSpot/macspot-api/sync_from_cloud.py
ğŸ“‚ Kodtyp: ğŸ“„ Ã–vrigt
ğŸ—‚ Filtyp: ğŸ Python
ğŸ“… Senast Ã¤ndrad: 2025-06-02 17:06:13
ğŸ“ Antal rader: 161
ğŸ§© Antal funktioner: 0
ğŸ’¬ KommentarstÃ¤ckning: 0 rader (0.0%)
ğŸ“¥ Imports: 2 â€“ ['import psycopg2', 'import json']
ğŸ” LÃ¤ngsta funktion: 0 rader
ğŸ§  KomplexitetspoÃ¤ng: 22
ğŸ§ª TODO/FIXME: 0
====================
START: sync_from_cloud.py
import psycopg2
import json
from config import LOCAL_DB_CONFIG, REMOTE_DB_CONFIG

def connect_db(config):
    return psycopg2.connect(**config)

def safe_json_load(data, default={}):
    try:
        return json.loads(data) if isinstance(data, str) else data
    except Exception:
        return default

def metadata_equal(meta1, meta2):
    m1 = safe_json_load(meta1)
    m2 = safe_json_load(meta2)
    return m1 == m2

def apply_change(cur, table, operation, payload):
    try:
        if operation == "INSERT":
            cols = ", ".join(payload.keys())
            placeholders = ", ".join(["%s"] * len(payload))
            sql = f"INSERT INTO {table} ({cols}) VALUES ({placeholders}) ON CONFLICT (id) DO NOTHING"
            cur.execute(sql, [json.dumps(v) if isinstance(v, dict) else v for v in payload.values()])

        elif operation == "UPDATE":
            if table == "contact" and "metadata" in payload:
                local_meta = payload["metadata"]
                cur.execute("SELECT metadata FROM contact WHERE id = %s", (payload["id"],))
                row = cur.fetchone()
                if row and metadata_equal(row[0], local_meta):
                    print(f"â™»ï¸ Ingen skillnad i metadata fÃ¶r {payload['id']}, hoppar UPDATE.")
                    return
                else:
                    cur.execute("""
                        INSERT INTO event_log (id, source, event_type, payload, received_at)
                        VALUES (gen_random_uuid(), %s, %s, %s, now())
                    """, (
                        'sync',
                        'sync_fromcloud_mismatch',
                        json.dumps({
                            "record_id": str(payload["id"]),
                            "email": payload.get("booking_email"),
                            "metadata_before": row[0],
                            "metadata_after": local_meta,
                            "diff_summary": [k for k in local_meta if local_meta.get(k) != row[0].get(k)]
                        })
                    ))

            sets = ", ".join([f"{col} = %s" for col in payload if col != "id"])
            values = [json.dumps(payload[col]) if isinstance(payload[col], dict) else payload[col]
                      for col in payload if col != "id"]
            values.append(payload["id"])
            sql = f"UPDATE {table} SET {sets} WHERE id = %s"
            cur.execute(sql, values)

            # Verifiera resultat (endast fÃ¶r kontakt)
            if table == "contact":
                cur.execute("SELECT metadata, updated_at FROM contact WHERE id = %s", [payload["id"]])
                updated_row = cur.fetchone()
                if updated_row:
                    try:
                        metadata = safe_json_load(updated_row[0])
                        address = metadata.get("address") or metadata.get("company") or "(ingen adress)"
                    except Exception:
                        address = "(kunde inte tolkas)"
                    print(f"ğŸ§¾ Efter UPDATE: {payload['id']} â†’ {address} @ {updated_row[1]}")
                else:
                    print(f"âš ï¸ UPDATE-verifiering misslyckades: Inget resultat fÃ¶r {payload['id']}")

        elif operation == "DELETE":
            cur.execute(f"DELETE FROM {table} WHERE id = %s", [payload["id"]])
            print(f"ğŸ—‘ï¸ Raderade post {payload['id']} frÃ¥n {table}")
            print(f"ğŸ—‘ï¸ Raderade post {payload['id']} frÃ¥n {table}")

    except Exception as e:
        print(f"âŒ Fel i apply_change fÃ¶r {table} ({operation}): {e}")
        raise

def sync():
    remote_conn = connect_db(REMOTE_DB_CONFIG)
    remote_cur = remote_conn.cursor()

    local_conn = connect_db(LOCAL_DB_CONFIG)
    local_cur = local_conn.cursor()

    try:
        remote_cur.execute("""
            SELECT id, table_name, record_id, operation, payload
            FROM (
                SELECT *, ROW_NUMBER() OVER (PARTITION BY record_id ORDER BY created_at ASC) AS rn
                FROM pending_changes
                WHERE direction = 'out' AND processed = false
                  AND table_name IN ('contact', 'bookings')
            ) sub
            WHERE rn = 1
            ORDER BY created_at ASC, id
        """)
        rows = remote_cur.fetchall()

        remote_cur.execute("""
            DELETE FROM pending_changes
            WHERE id NOT IN (
                SELECT id FROM (
                    SELECT id, ROW_NUMBER() OVER (PARTITION BY record_id ORDER BY created_at ASC) AS rn
                    FROM pending_changes
                    WHERE direction = 'out' AND processed = false
                ) sub
                WHERE rn = 1
            ) AND direction = 'out' AND processed = false AND operation = 'UPDATE';
        """)

        count = 0
        for row in rows:
            change_id, table, record_id, operation, payload_json = row
            try:
                payload = safe_json_load(payload_json)
                if not isinstance(payload.get("id"), str) or "your-generated-id" in payload.get("id"):
                    continue

                apply_change(local_cur, table, operation, payload)

                if table == "bookings" and operation == "INSERT":
                    local_cur.execute("""
                        UPDATE pending_changes
                        SET booking_id = %s
                        WHERE record_id = %s AND table_name = 'bookings' AND booking_id IS NULL
                    """, (record_id, record_id))

                # Logga kontaktimport
                if table == "contact":
                    email = payload.get("booking_email", "(okÃ¤nd e-post)")
                    meta = safe_json_load(payload.get("metadata", {}))
                    address = meta.get("address", "(okÃ¤nd adress)")
                    print(f"ğŸ“¥ Importerad kontakt: {email} â†’ {address}")

                local_cur.execute("""
                    INSERT INTO event_log (id, source, event_type, payload, received_at)
                    VALUES (gen_random_uuid(), %s, %s, %s, now())
                """, ('sync', f"{operation.lower()}_{table}", json.dumps(payload)))

                remote_cur.execute("UPDATE pending_changes SET processed = true WHERE id = %s", [change_id])
                remote_conn.commit()
                local_conn.commit()
                count += 1

            except Exception as e:
                print(f"âŒ Fel vid synk fÃ¶r {table} (id={change_id}): {e}")
                local_conn.rollback()
                remote_conn.rollback()
                continue

    finally:
        local_cur.close()
        remote_cur.close()
        local_conn.close()
        remote_conn.close()

if __name__ == "__main__":
    sync()
END: sync_from_cloud.py

====================
ğŸ“„ Fil: Documents/KLR_AI/Projekt_MacSpot/macspot-api/sync_to_cloud.py
ğŸ“‚ Kodtyp: ğŸ“„ Ã–vrigt
ğŸ—‚ Filtyp: ğŸ Python
ğŸ“… Senast Ã¤ndrad: 2025-06-02 17:26:31
ğŸ“ Antal rader: 283
ğŸ§© Antal funktioner: 0
ğŸ’¬ KommentarstÃ¤ckning: 0 rader (0.0%)
ğŸ“¥ Imports: 3 â€“ ['import psycopg2', 'import json', 'import traceback']
ğŸ” LÃ¤ngsta funktion: 0 rader
ğŸ§  KomplexitetspoÃ¤ng: 45
ğŸ§ª TODO/FIXME: 0
====================
START: sync_to_cloud.py
import psycopg2
import json
from datetime import datetime, timezone
from config import LOCAL_DB_CONFIG, REMOTE_DB_CONFIG

def safe_json_load(data, default={}):
    try:
        return json.loads(data) if isinstance(data, str) else data
    except Exception:
        return default

def metadata_equal(meta1, meta2):
    m1 = safe_json_load(meta1)
    m2 = safe_json_load(meta2)
    return m1 == m2

def connect_db(config):
    return psycopg2.connect(**config)

def fetch_pending_changes(conn):
    with conn.cursor() as cur:
        cur.execute("""
            SELECT id, table_name, record_id, operation, payload
            FROM (
                SELECT *, ROW_NUMBER() OVER (PARTITION BY record_id ORDER BY created_at ASC) AS rn
                FROM pending_changes
                WHERE direction = 'out' AND processed = false
                  AND table_name IN ('contact', 'bookings')
            ) sub
            WHERE rn = 1
            ORDER BY created_at ASC, id
        """)
        rows = cur.fetchall()

        # Rensa Ã¤ldre UPDATE-poster med samma record_id
        cur.execute("""
            DELETE FROM pending_changes
            WHERE id NOT IN (
                SELECT id FROM (
                    SELECT id, ROW_NUMBER() OVER (PARTITION BY record_id ORDER BY created_at ASC) AS rn
                    FROM pending_changes
                    WHERE direction = 'out' AND processed = false
                ) sub
                WHERE rn = 1
            ) AND direction = 'out' AND processed = false AND operation = 'UPDATE';
        """)
        return rows

def mark_as_processed(conn, change_id):
    with conn.cursor() as cur:
        cur.execute("UPDATE pending_changes SET processed = true WHERE id = %s", (change_id,))
        conn.commit()

#
# ğŸ“ SYNC-BETEENDE: Hantering av metadata
#
# Viktigt att fÃ¶rstÃ¥ skillnaden:
#
# 1. Ã„ndring av vÃ¤rde:
#    - Exempel: "postal_code": "111 11" â†’ "115 32"
#    - Hanteras som en vanlig UPDATE (om updated_at Ã¤r nyare)
#
# 2. Ã„ndring av nyckel (etikett):
#    - Exempel: "postal_number" â†’ "postal_code"
#    - Molnet kommer *inte* ta bort "postal_number" utan force_resync
#    - LÃ¤gg till `"force_resync": true` i metadata fÃ¶r att tvinga full Ã¶verskrivning
#
# Detta minskar risken att data i molnet raderas av misstag.

def apply_change(conn, change, local_conn):
    table_name, record_id, operation, payload = change[1], change[2], change[3], change[4]
    with conn.cursor() as cur:
        data = safe_json_load(payload)

        # Skip contact records with metadata.origin != 'klrab.se'
        if table_name == 'contact' and 'metadata' in data:
            meta = safe_json_load(data['metadata'])
            if meta.get('origin') != 'klrab.se':
                print(f"âš ï¸ Skickas ej: origin != klrab.se â€“ {data.get('booking_email')}")
                mark_as_processed(local_conn, change[0])
                return

        # Ensure all values are serializable to SQL
        for k, v in data.items():
            if isinstance(v, dict):
                data[k] = json.dumps(v)

        if 'updated_at' in data:
            if isinstance(data['updated_at'], str):
                # Parse and convert to UTC if it's a string
                try:
                    dt = datetime.fromisoformat(data['updated_at'])
                    data['updated_at'] = dt.astimezone(timezone.utc).isoformat()
                except Exception as e:
                    print(f"âš ï¸ Kunde inte tolka updated_at: {data['updated_at']} ({e})")
            elif isinstance(data['updated_at'], datetime):
                data['updated_at'] = data['updated_at'].astimezone(timezone.utc).isoformat()

        if operation == 'INSERT':
            columns = ', '.join(data.keys())
            placeholders = ', '.join(['%s'] * len(data))
            values = list(data.values())
            cur.execute(
                f"INSERT INTO {table_name} ({columns}) VALUES ({placeholders}) "
                f"ON CONFLICT (id) DO UPDATE SET "
                f"{', '.join([f'{k} = EXCLUDED.{k}' for k in data.keys() if k != 'id'])}",
                values
            )
            if table_name == 'bookings':
                with local_conn.cursor() as local_cur:
                    local_cur.execute(
                        """
                        UPDATE pending_changes
                        SET booking_id = %s
                        WHERE record_id = %s AND table_name = 'bookings' AND booking_id IS NULL
                        """,
                        (record_id, record_id)
                    )
                    local_conn.commit()

        if data.get("force_resync") is True:
            print(f"ğŸ” Force resync aktiv â€“ uppdaterar {table_name} {record_id}")

        if operation == 'UPDATE':
            # Merge metadata with existing remote value and ensure JSON string (only for UPDATE)
            if 'metadata' in data and table_name == 'contact':
                cur.execute(f"SELECT metadata FROM {table_name} WHERE id = %s", (record_id,))
                row = cur.fetchone()
                if row and row[0]:
                    existing_metadata = safe_json_load(row[0])
                else:
                    existing_metadata = {}

                incoming_metadata = safe_json_load(data['metadata'])
                if metadata_equal(existing_metadata, incoming_metadata):
                    mark_as_processed(local_conn, change[0])
                    return
                existing_metadata.update(incoming_metadata)
                changed_keys = [k for k in incoming_metadata if existing_metadata.get(k) != incoming_metadata[k]]
                if not changed_keys:
                    mark_as_processed(local_conn, change[0])
                    return
                data['metadata'] = json.dumps(existing_metadata)

            # FÃ¶rbÃ¤ttrad hantering av tidsjÃ¤mfÃ¶relse fÃ¶r updated_at
            if 'updated_at' in data and not data.get("force_resync"):
                try:
                    # SÃ¤kerstÃ¤ll att local_ts Ã¤r datetime i UTC
                    local_ts = data['updated_at']
                    if isinstance(local_ts, str):
                        local_ts = datetime.fromisoformat(local_ts)
                    if local_ts.tzinfo is None:
                        local_ts = local_ts.replace(tzinfo=timezone.utc)
                    else:
                        local_ts = local_ts.astimezone(timezone.utc)

                    cur.execute(f"SELECT updated_at FROM {table_name} WHERE id = %s", (record_id,))
                    row = cur.fetchone()
                    if row and row[0] and isinstance(row[0], datetime):
                        remote_ts = row[0]
                        if remote_ts.tzinfo is None:
                            remote_ts = remote_ts.replace(tzinfo=timezone.utc)
                        else:
                            remote_ts = remote_ts.astimezone(timezone.utc)

                        if local_ts <= remote_ts:
                            if 'metadata' in data and table_name == 'contact':
                                cur.execute(f"SELECT metadata FROM {table_name} WHERE id = %s", (record_id,))
                                meta_row = cur.fetchone()
                                if meta_row and not metadata_equal(meta_row[0], data['metadata']):
                                    print(f"âš ï¸ updated_at Ã¤ldre men metadata skiljer sig â€“ synkar Ã¤ndÃ¥ {record_id}")
                                else:
                                    mark_as_processed(local_conn, change[0])
                                    return
                            else:
                                mark_as_processed(local_conn, change[0])
                                return
                except Exception:
                    pass

            if table_name == "contact" and "metadata" in data:
                local_meta = safe_json_load(data["metadata"])
                cur.execute("SELECT metadata FROM contact WHERE id = %s", (data["id"],))
                row = cur.fetchone()
                if row:
                    remote_meta = safe_json_load(row[0])
                    if remote_meta == local_meta:
                        mark_as_processed(local_conn, change[0])
                        return

            columns = ', '.join(data.keys())
            placeholders = ', '.join(['%s'] * len(data))
            values = list(data.values())
            update_keys = [k for k in data.keys() if k != 'id']
            update_set = ', '.join([f"{k} = %s" for k in update_keys])
            update_values = [data[k] for k in update_keys]
            update_values.append(record_id)
            cur.execute(
                f"UPDATE {table_name} SET {update_set} WHERE id = %s",
                update_values
            )
            if cur.rowcount == 0:
                print(f"âŒ UPDATE pÃ¥verkar 0 rader fÃ¶r {table_name} {record_id}")
                print(f"ğŸ” FÃ¶rsÃ¶ker DELETE + INSERT som fallback fÃ¶r {table_name} {record_id}")
                cur.execute(f"DELETE FROM {table_name} WHERE id = %s", (record_id,))
                columns = ', '.join(data.keys())
                placeholders = ', '.join(['%s'] * len(data))
                values = list(data.values())
                cur.execute(f"INSERT INTO {table_name} ({columns}) VALUES ({placeholders})", values)
                print(f"âœ… Fallback INSERT klar fÃ¶r {table_name} {record_id}")
                with local_conn.cursor() as local_cur:
                    local_cur.execute(
                        "INSERT INTO event_log (id, source, event_type, payload, received_at) VALUES (gen_random_uuid(), %s, %s, %s, now())",
                        (
                            'sync',
                            'sync_forced_rewrite',
                            json.dumps({
                                "record_id": str(record_id),
                                "email": data.get("booking_email"),
                                "metadata_after": data.get("metadata")
                            })
                        )
                    )
                local_conn.commit()
                print(f"ğŸ’¾ commit() efter event_log skrivning fÃ¶r {table_name} {record_id}")
                conn.commit()
                print(f"ğŸ’¾ commit() efter fallback INSERT fÃ¶r {table_name} {record_id}")
            else:
                print(f"âœ… UPDATE pÃ¥verkar {cur.rowcount} rad(er) fÃ¶r {table_name} {record_id}")
            # Kontrollera att Ã¤ndring verkligen slog igenom
            if table_name == 'contact' and 'metadata' in data:
                cur.execute(f"SELECT metadata FROM {table_name} WHERE id = %s", (record_id,))
                verify_row = cur.fetchone()
                if verify_row and not metadata_equal(verify_row[0], data.get("metadata")):
                    print(f"âŒ Molndatabas uppdaterades inte korrekt fÃ¶r {record_id}!")
                    with local_conn.cursor() as local_cur:
                        local_cur.execute(
                            "INSERT INTO event_log (id, source, event_type, payload, received_at) VALUES (gen_random_uuid(), %s, %s, %s, now())",
                            (
                                'sync',
                                'sync_mismatch_contact',
                                json.dumps({
                                    "record_id": str(record_id),
                                    "email": data.get("booking_email"),
                                    "metadata_before": verify_row[0],
                                    "metadata_after": data.get("metadata"),
                                    "diff_summary": [k for k in data.get("metadata", {}) if data["metadata"].get(k) != verify_row[0].get(k)]
                                })
                            )
                        )
                    local_conn.commit()
                else:
                    print(f"âœ… Verifierad update i molndatabasen fÃ¶r {record_id}")
            print(f"âœ… UPDATE kÃ¶rd fÃ¶r {table_name} {record_id}")
            cur.execute("SELECT metadata, updated_at FROM contact WHERE id = %s", [payload["id"]])
            updated_row = cur.fetchone()
        elif operation == 'DELETE':
            cur.execute(f"DELETE FROM {table_name} WHERE id = %s", (record_id,))
            print(f"ğŸ—‘ï¸ Raderade post {record_id} frÃ¥n {table_name}")
            print(f"ğŸ—‘ï¸ Raderade post {record_id} frÃ¥n {table_name}")
        conn.commit()
        mark_as_processed(local_conn, change[0])

def sync():
    import traceback
    local_conn = connect_db(LOCAL_DB_CONFIG)
    remote_conn = connect_db(REMOTE_DB_CONFIG)

    changes = fetch_pending_changes(local_conn)
    count = 0
    for change in changes:
        try:
            apply_change(remote_conn, change, local_conn)
            count += 1
        except Exception as e:
            print(f"âŒ Misslyckades att applicera Ã¤ndring pÃ¥ {change[1]} (id={change[2]}): {e}")
            traceback.print_exc()
    
    local_conn.close()
    remote_conn.close()

if __name__ == "__main__":
    sync()
END: sync_to_cloud.py

====================
ğŸ“„ Fil: Documents/KLR_AI/Projekt_MacSpot/macspot-api/sync_static_tables.py
ğŸ“‚ Kodtyp: ğŸ“„ Ã–vrigt
ğŸ—‚ Filtyp: ğŸ Python
ğŸ“… Senast Ã¤ndrad: 2025-04-24 17:01:52
ğŸ“ Antal rader: 61
ğŸ§© Antal funktioner: 0
ğŸ’¬ KommentarstÃ¤ckning: 0 rader (0.0%)
ğŸ“¥ Imports: 2 â€“ ['import psycopg2', 'import json']
ğŸ” LÃ¤ngsta funktion: 0 rader
ğŸ§  KomplexitetspoÃ¤ng: 6
ğŸ§ª TODO/FIXME: 0
====================
START: sync_static_tables.py
from config import LOCAL_DB_CONFIG, REMOTE_DB_CONFIG
import psycopg2
import json
from datetime import datetime


TABLES = ["translation", "booking_settings"]


def connect_db(config):
    return psycopg2.connect(**config)


def fetch_all_from_local(conn, table):
    with conn.cursor() as cur:
        cur.execute(f"SELECT * FROM {table}")
        colnames = [desc[0] for desc in cur.description]
        rows = cur.fetchall()
        return colnames, rows


def clear_remote_table(conn, table):
    with conn.cursor() as cur:
        cur.execute(f"DELETE FROM {table}")
        conn.commit()


def insert_to_remote(conn, table, columns, rows):
    with conn.cursor() as cur:
        placeholders = ', '.join(['%s'] * len(columns))
        colnames = ', '.join(columns)
        for row in rows:
            # Hantera jsonb-vÃ¤rden som json-strÃ¤ngar
            formatted_row = []
            for i, col in enumerate(columns):
                value = row[i]
                if table == 'booking_settings' and col == 'value':
                    formatted_row.append(json.dumps(value))
                else:
                    formatted_row.append(value)
            cur.execute(f"INSERT INTO {table} ({colnames}) VALUES ({placeholders})", formatted_row)
        conn.commit()


def sync_static_tables():
    local_conn = connect_db(LOCAL_DB_CONFIG)
    remote_conn = connect_db(REMOTE_DB_CONFIG)

    for table in TABLES:
        print(f"\nâ³ Synkar tabell: {table}...")
        columns, rows = fetch_all_from_local(local_conn, table)
        clear_remote_table(remote_conn, table)
        insert_to_remote(remote_conn, table, columns, rows)
        print(f"âœ… Klar med tabell: {table} ({len(rows)} rader)")

    local_conn.close()
    remote_conn.close()


if __name__ == "__main__":
    sync_static_tables()

END: sync_static_tables.py

====================
ğŸ“„ Fil: Documents/KLR_AI/Projekt_MacSpot/macspot-api/sync.py
ğŸ“‚ Kodtyp: ğŸ“„ Ã–vrigt
ğŸ—‚ Filtyp: ğŸ Python
ğŸ“… Senast Ã¤ndrad: 2025-06-02 17:06:12
ğŸ“ Antal rader: 114
ğŸ§© Antal funktioner: 0
ğŸ’¬ KommentarstÃ¤ckning: 0 rader (0.0%)
ğŸ“¥ Imports: 2 â€“ ['import psycopg2', 'import json']
ğŸ” LÃ¤ngsta funktion: 0 rader
ğŸ§  KomplexitetspoÃ¤ng: 15
ğŸ§ª TODO/FIXME: 0
====================
START: sync.py
import psycopg2
import json
from datetime import datetime
from config import LOCAL_DB_CONFIG

def safe_json_load(data, default={}):
    try:
        return json.loads(data) if isinstance(data, str) else data
    except Exception:
        return default

def metadata_equal(meta1, meta2):
    m1 = safe_json_load(meta1)
    m2 = safe_json_load(meta2)
    return m1 == m2

# Anslutning till lokal PostgreSQL
conn = psycopg2.connect(**LOCAL_DB_CONFIG)
cursor = conn.cursor()

# Rensa Ã¤ldre UPDATE-rader (endast senaste behÃ¶vs per record_id)
cursor.execute("""
    DELETE FROM pending_changes pc
    WHERE operation = 'UPDATE'
      AND processed = false
      AND direction = 'out'
      AND id NOT IN (
        SELECT id FROM (
          SELECT id,
                 ROW_NUMBER() OVER (PARTITION BY record_id ORDER BY created_at DESC) AS rn
          FROM pending_changes
          WHERE operation = 'UPDATE'
            AND processed = false
            AND direction = 'out'
        ) sub
        WHERE rn = 1
      );
""")

# HÃ¤mta EN Ã¤ndring per kontakt (record_id) â€“ endast senaste per kontakt exporteras med hjÃ¤lp av ROW_NUMBER()
cursor.execute("""
    SELECT id, table_name, record_id, operation, payload, created_at
    FROM (
        SELECT *, ROW_NUMBER() OVER (PARTITION BY record_id ORDER BY created_at DESC) as rn
        FROM pending_changes
        WHERE processed = false AND direction = 'out'
    ) sub
    WHERE rn = 1
""")

rows = cursor.fetchall()

# Filtrera bort poster dÃ¤r metadata Ã¤r identisk med befintlig kontakt
filtered_rows = []
for row in rows:
    change_id, table, record_id, operation, payload, created_at = row
    data = json.loads(payload) if isinstance(payload, str) else payload
    if table == "contact" and operation == "UPDATE":
        try:
            cursor.execute("SELECT metadata FROM contact WHERE id = %s", (record_id,))
            result = cursor.fetchone()
            if result:
                incoming_metadata = data.get("metadata")
                if metadata_equal(result[0], incoming_metadata):
                    continue
        except Exception as e:
            print(f"âš ï¸ Kunde inte jÃ¤mfÃ¶ra metadata fÃ¶r {record_id}: {e}")
    filtered_rows.append(row)
rows = filtered_rows

# Skapa exportformat
export = []
for row in rows:
    change_id, table, record_id, operation, payload, created_at = row
    export.append({
        "change_id": str(change_id),
        "table": table,
        "operation": operation,
        "data": payload
    })

# Logga diff fÃ¶r contact-uppdateringar innan exporten skrivs till disk
for entry in export:
    if entry["table"] == "contact" and entry["operation"] == "UPDATE":
        try:
            cursor.execute("SELECT metadata FROM contact WHERE id = %s", (entry["data"]["id"],))
            existing = cursor.fetchone()
            if existing and not metadata_equal(existing[0], entry["data"].get("metadata")):
                cursor.execute("""
                    INSERT INTO event_log (id, source, event_type, payload, received_at)
                    VALUES (gen_random_uuid(), %s, %s, %s, now())
                """, (
                    'sync',
                    'sync_local_diff',
                    json.dumps({
                        "record_id": str(entry["data"]["id"]),
                        "email": entry["data"].get("booking_email"),
                        "metadata_before": existing[0],
                        "metadata_after": entry["data"].get("metadata"),
                        "diff_summary": [k for k in entry["data"].get("metadata", {}) if entry["data"]["metadata"].get(k) != existing[0].get(k)]
                    })
                ))
        except Exception as e:
            print(f"âš ï¸ Kunde inte logga diff fÃ¶r contact {entry['data'].get('id')}: {e}")

# Spara till JSON-fil med tidsstÃ¤mpel
if export:
    first_type = export[0]["table"] if export else "unknown"
    filename = f"sync_outbox/{datetime.now().strftime('%Y%m%d_%H%M%S')}_{first_type}.json"
    with open(filename, "w", encoding="utf-8") as f:
        json.dump(export, f, indent=2, ensure_ascii=False)

cursor.close()
conn.close()

END: sync.py

====================
ğŸ“„ Fil: Documents/KLR_AI/Projekt_MacSpot/macspot-api/sync_all.py
ğŸ“‚ Kodtyp: ğŸ“„ Ã–vrigt
ğŸ—‚ Filtyp: ğŸ Python
ğŸ“… Senast Ã¤ndrad: 2025-06-02 17:07:11
ğŸ“ Antal rader: 213
ğŸ§© Antal funktioner: 0
ğŸ’¬ KommentarstÃ¤ckning: 0 rader (0.0%)
ğŸ“¥ Imports: 7 â€“ ['import os', 'import subprocess', 'import sys', 'import psycopg2', 'import json', 'import socket', 'import traceback']
ğŸ” LÃ¤ngsta funktion: 0 rader
ğŸ§  KomplexitetspoÃ¤ng: 25
ğŸ§ª TODO/FIXME: 0
====================
START: sync_all.py
BASE = "/Users/danielkallberg/Documents/KLR_AI/Projekt_MacSpot/macspot-api"


import os
import subprocess
from datetime import datetime, timezone
import sys
import psycopg2
import json

with open("/tmp/launchd_debug.txt", "a") as f:
    f.write("[sync_all.py] KÃ¶rning initierad\n")

with open("/tmp/env_debug.txt", "w") as f:
    f.write("START\n")
    f.write(str(dict(os.environ)))

# Delad json- och metadata-funktionalitet som anvÃ¤nds i flera synkmoduler
def safe_json_load(data, default={}):
    try:
        return json.loads(data) if isinstance(data, str) else data
    except Exception:
        return default

def metadata_equal(meta1, meta2):
    m1 = safe_json_load(meta1)
    m2 = safe_json_load(meta2)
    return m1 == m2

log_dir = "/Users/danielkallberg/Documents/KLR_AI/Projekt_MacSpot"
log_out = os.path.join(log_dir, "macspot_sync.log")
log_err = os.path.join(log_dir, "macspot_sync_error.log")

# Se till att loggfilerna existerar
for path in [log_out, log_err]:
    if not os.path.exists(path):
        with open(path, 'w'):
            pass

# Skriv ut manuell/automatisk kÃ¶rningsinfo till loggen
is_manual = os.environ.get("LAUNCHD_RUN") != "true"
log_mode = "MANUELL" if is_manual else "AUTOMATISK (launchd)"
with open("/tmp/env_debug.txt", "a") as f:
    f.write(f"LAUNCHD_RUN: {os.environ.get('LAUNCHD_RUN')}\n")
# Debug environment variables to file
with open("/tmp/env_debug.txt", "w") as f:
    f.write(str(dict(os.environ)))
out = open(log_out, 'a')
err = open(log_err, 'a')
sys.stdout = out
sys.stderr = err
print(f"ğŸš€ KÃ¶rlÃ¤ge: {log_mode} â€“ {datetime.now(timezone.utc).isoformat()}")

def run_script(name, script_path):
    subprocess.run(["/Users/danielkallberg/Documents/KLR_AI/venv/bin/python", f"{BASE}/{script_path}"], check=True)

try:
    start_time = datetime.now(timezone.utc)
    def is_database_online(host, port):
        import socket
        try:
            socket.create_connection((host, port), timeout=2)
            return True
        except:
            return False

    def run_healthcheck():
        try:
            subprocess.run(
                ["/Users/danielkallberg/Documents/KLR_AI/venv/bin/python", f"{BASE}/healthcheck_sync.py"],
                check=True
            )
        except Exception as e:
            print(f"âŒ Healthcheck misslyckades: {e}")

    # Kontrollera att bÃ¥da databaser Ã¤r online innan sync startar
    if not is_database_online("localhost", 5433):
        print("âŒ Lokal databas Ã¤r inte tillgÃ¤nglig (localhost:5433)")
        exit(1)

    if not is_database_online("macspotpg.postgres.database.azure.com", 5432):
        print("âŒ Azure-databasen Ã¤r inte tillgÃ¤nglig (macspotpg.postgres.database.azure.com:5432)")
        exit(1)

    print(f"ğŸ“Œ KÃ¶rning initierad: {datetime.now(timezone.utc).isoformat()}")

    print("ğŸ§ª KÃ¶r healthcheck_sync.py...")
    run_healthcheck()

    print(f"\nğŸ”„ [{datetime.now(timezone.utc).strftime('%Y-%m-%d %H:%M:%S')}] Startar fullstÃ¤ndig synk...")

    scripts_part1 = [
        ("ğŸŸ¡ KÃ¶r sync.py...", "sync.py"),
        ("ğŸŸ¢ KÃ¶r sync_to_cloud.py...", "sync_to_cloud.py")
    ]

    for msg, script in scripts_part1:
        run_script(msg, script)

    scripts_part2 = [
        ("ğŸ”µ KÃ¶r sync_from_cloud.py...", "sync_from_cloud.py")
    ]

    for msg, script in scripts_part2:
        run_script(msg, script)

    today_prefix = datetime.now(timezone.utc).strftime('%Y%m%d')
    outbox_dir = os.path.join(BASE, 'sync_outbox')
    files = [f for f in os.listdir(outbox_dir) if f.startswith(today_prefix)]
    files_with_type = [f for f in files if len(f.split("_")) >= 3]
    num_changes = len(files_with_type)

    if num_changes == 0:
        print("â„¹ï¸ Ingen fÃ¶rÃ¤ndring hittades att synka.")
        print("ğŸ“­ Inga fler Ã¤ndringar kvar i pending_changes.")
    else:
        print(f"ğŸ“¤ Totalt {num_changes} Ã¤ndring(ar) skickades till molnet:")
        files = [f for f in sorted(os.listdir(outbox_dir)) if f.startswith(today_prefix)]
        summary = {}
        for f in files:
            parts = f.split("_")
            if len(parts) >= 3:
                typ = parts[2].split(".")[0]
                summary[typ] = summary.get(typ, 0) + 1

        if summary:
            print("ğŸ§¾ Sammanfattning per typ:")
            for typ, count in summary.items():
                print(f"   â€¢ {typ}: {count} st")

        # --- Kontrollera och skriv ut Ã¤ldre JSON-filer i sync_outbox ---
        old_files = [f for f in os.listdir(outbox_dir) if not f.startswith(today_prefix)]
        if old_files:
            print("ğŸ“‚ Ã„ldre JSON-filer som ligger kvar i sync_outbox:")
            for f in old_files:
                print(f"   â€¢ {f}")

        print("ğŸ“Š Kontroll av Ã¥terstÃ¥ende Ã¤ndringar i pending_changes...")

        # Lokalt
        local = psycopg2.connect(
            dbname="macspot",
            user="postgres",
            host="localhost",
            port=5433
        )
        cur_local = local.cursor()
        cur_local.execute("""
            SELECT COUNT(*) FROM pending_changes
            WHERE direction = 'out' AND processed = false
        """)
        out_local = cur_local.fetchone()[0]
        cur_local.execute("""
            SELECT COUNT(*) FROM pending_changes
            WHERE direction = 'out' AND processed = false
            GROUP BY record_id
        """)
        print(f"   â€¢ Lokalt â†’ molnet: {out_local} Ã¤ndring(ar) kvar Ã¶ver {cur_local.rowcount} kontakt(er).")
        cur_local.close()
        local.close()

        # Molnet
        cloud = psycopg2.connect(
            dbname="postgres",
            user="daniel",
            host="macspotpg.postgres.database.azure.com",
            port=5432
        )
        cur_cloud = cloud.cursor()
        cur_cloud.execute("""
            SELECT COUNT(*) FROM pending_changes
            WHERE direction = 'out' AND processed = false
        """)
        out_cloud = cur_cloud.fetchone()[0]
        cur_cloud.execute("""
            SELECT COUNT(*) FROM pending_changes
            WHERE direction = 'out' AND processed = false
            GROUP BY record_id
        """)
        cur_cloud.close()
        cloud.close()

    print(f"\nâœ… [{datetime.now(timezone.utc).strftime('%Y-%m-%d %H:%M:%S')}] FullstÃ¤ndig synk kÃ¶rd.")

    # Sammanfatta diff-loggar
    with psycopg2.connect(dbname="macspot", user="postgres", host="localhost", port=5433) as conn:
        with conn.cursor() as cur:
            cur.execute("""
                SELECT event_type, COUNT(*) 
                FROM event_log 
                WHERE received_at > now() - interval '10 minutes' 
                  AND event_type IN ('sync_local_diff', 'sync_mismatch_contact', 'sync_fromcloud_mismatch')
                GROUP BY event_type
            """)
            results = cur.fetchall()
            if results:
                print("ğŸ§¾ Diff-loggar skapade (senaste 10 min):")
                for event_type, count in results:
                    print(f"   â€¢ {event_type}: {count}")
            else:
                print("ğŸ§¾ Inga diff-loggar skapades under senaste 10 minuter.")

except Exception as e:
    import traceback
    print("âŒ Ett ovÃ¤ntat fel intrÃ¤ffade under kÃ¶rningen:")
    print(traceback.format_exc())

finally:
    print(f"ğŸ KÃ¶rning avslutad: {datetime.now(timezone.utc).isoformat()}")
    duration = datetime.now(timezone.utc) - start_time
    print(f"â±ï¸ Total kÃ¶rtid: {int(duration.total_seconds())} sekunder")
    out.close()
    err.close()
END: sync_all.py

====================
ğŸ“„ Fil: Documents/KLR_AI/Projekt_MacSpot/macspot-api/sync_plist.xml
ğŸ“‚ Kodtyp: ğŸ“„ Ã–vrigt
ğŸ—‚ Filtyp: ğŸ“„ OkÃ¤nt format
ğŸ“… Senast Ã¤ndrad: 2025-06-02 16:22:08
ğŸ“ Antal rader: 26
ğŸ§© Antal funktioner: 0
ğŸ’¬ KommentarstÃ¤ckning: 0 rader (0.0%)
ğŸ“¥ Imports: 0 â€“ Inga
ğŸ” LÃ¤ngsta funktion: 0 rader
ğŸ§  KomplexitetspoÃ¤ng: 0
ğŸ§ª TODO/FIXME: 0
====================
START: sync_plist.xml
cat > ~/Library/LaunchAgents/com.macspot.sync.plist <<EOF
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN"
  "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
  <key>Label</key>
  <string>com.macspot.sync</string>
  <key>ProgramArguments</key>
  <array>
    <string>/Users/danielkallberg/Documents/KLR_AI/venv/bin/python3</string>
    <string>/Users/danielkallberg/Documents/KLR_AI/Projekt_MacSpot/macspot-api/sync_all.py</string>
  </array>
  <key>WorkingDirectory</key>
  <string>/Users/danielkallberg/Documents/KLR_AI/Projekt_MacSpot/macspot-api</string>
  <key>StartInterval</key>
  <integer>300</integer>
  <key>RunAtLoad</key>
  <true/>
  <key>StandardOutPath</key>
  <string>/tmp/macspot_sync.log</string>
  <key>StandardErrorPath</key>
  <string>/tmp/macspot_sync_error.log</string>
</dict>
</plist>
EOF
END: sync_plist.xml

====================
ğŸ“„ Fil: Library/LaunchAgents/com.macspot.sync.plist
ğŸ“‚ Kodtyp: ğŸ“„ Ã–vrigt
ğŸ—‚ Filtyp: ğŸ“„ OkÃ¤nt format
ğŸ“… Senast Ã¤ndrad: 2025-06-02 16:30:38
ğŸ“ Antal rader: 23
ğŸ§© Antal funktioner: 0
ğŸ’¬ KommentarstÃ¤ckning: 0 rader (0.0%)
ğŸ“¥ Imports: 0 â€“ Inga
ğŸ” LÃ¤ngsta funktion: 0 rader
ğŸ§  KomplexitetspoÃ¤ng: 0
ğŸ§ª TODO/FIXME: 0
====================
START: com.macspot.sync.plist
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
	<key>Label</key>
	<string>com.macspot.sync</string>
	<key>ProgramArguments</key>
	<array>
		<string>/Users/danielkallberg/Documents/KLR_AI/venv/bin/python3</string>
		<string>/Users/danielkallberg/Documents/KLR_AI/Projekt_MacSpot/macspot-api/sync_all.py</string>
	</array>
	<key>RunAtLoad</key>
	<true/>
	<key>StandardErrorPath</key>
	<string>/tmp/macspot_sync_error.log</string>
	<key>StandardOutPath</key>
	<string>/tmp/macspot_sync.log</string>
	<key>StartInterval</key>
	<integer>300</integer>
	<key>WorkingDirectory</key>
	<string>/Users/danielkallberg/Documents/KLR_AI/Projekt_MacSpot/macspot-api</string>
</dict>
</plist>

END: com.macspot.sync.plist

====================
ğŸ“„ Fil: Documents/KLR_AI/Projekt_MacSpot/macspot-api/healthcheck_sync.py
ğŸ“‚ Kodtyp: ğŸ“„ Ã–vrigt
ğŸ—‚ Filtyp: ğŸ Python
ğŸ“… Senast Ã¤ndrad: 2025-06-02 17:17:33
ğŸ“ Antal rader: 80
ğŸ§© Antal funktioner: 0
ğŸ’¬ KommentarstÃ¤ckning: 0 rader (0.0%)
ğŸ“¥ Imports: 2 â€“ ['import psycopg2', 'import sys']
ğŸ” LÃ¤ngsta funktion: 0 rader
ğŸ§  KomplexitetspoÃ¤ng: 6
ğŸ§ª TODO/FIXME: 0
====================
START: healthcheck_sync.py
# ğŸ“„ FÃ¶rbÃ¤ttrad version av healthcheck_sync.py

import psycopg2
from config import LOCAL_DB_CONFIG, REMOTE_DB_CONFIG
from datetime import datetime, timezone
import sys

__version__ = "1.0.1"

def get_pending_count(conn, label):
    with conn.cursor() as cur:
        cur.execute("""
            SELECT COUNT(*) FROM pending_changes
            WHERE direction = 'out' AND processed = false
        """)
        count = cur.fetchone()[0]
        print(f"ğŸ” {label}: {count} osynkade fÃ¶rÃ¤ndringar")
        return count

def check_db_connection(name, config):
    try:
        start = datetime.now(timezone.utc)
        conn = psycopg2.connect(**config)
        latency = (datetime.now(timezone.utc) - start).total_seconds()
        print(f"âœ… Anslutning till {name} OK (latens: {latency:.2f} sek)")
        return conn
    except Exception as e:
        print(f"âŒ Fel vid anslutning till {name}: {e}")
        return None

def main():
    print(f"\nğŸ“‹ Healthcheck MacSpot sync v{__version__} â€“ {datetime.now(timezone.utc).isoformat()} UTC\n")
    errors = 0

    local_conn = check_db_connection("Lokal databas", LOCAL_DB_CONFIG)
    if local_conn:
        get_pending_count(local_conn, "Lokal â†’ moln")
        local_conn.close()
    else:
        errors += 1

    remote_conn = check_db_connection("Molndatabas", REMOTE_DB_CONFIG)
    if remote_conn:
        get_pending_count(remote_conn, "Moln â†’ lokal")
        remote_conn.close()
    else:
        errors += 1

    # HÃ¤mta senaste mismatch-loggar frÃ¥n event_log
    try:
        with psycopg2.connect(**LOCAL_DB_CONFIG) as conn:
            with conn.cursor() as cur:
                cur.execute("""
                    SELECT event_type, payload->>'email', payload->>'diff_summary', received_at
                    FROM event_log
                    WHERE received_at > now() - interval '10 minutes'
                      AND event_type IN (
                          'sync_local_diff', 'sync_mismatch_contact', 'sync_fromcloud_mismatch', 'sync_forced_rewrite'
                      )
                    ORDER BY received_at DESC
                    LIMIT 10
                """)
                rows = cur.fetchall()
                if rows:
                    print("\nğŸš¨ Senaste synkavvikelser:")
                    for event_type, email, diff, timestamp in rows:
                        print(f"â€¢ {event_type}: {email} â€“ {diff} @ {timestamp}")
                else:
                    print("\nâœ… Inga mismatch-loggar i event_log senaste 10 minuterna.")
    except Exception as e:
        print(f"âš ï¸ Kunde inte lÃ¤sa mismatch-loggar: {e}")

    if errors > 0:
        print(f"\nâŒ Healthcheck avslutades med {errors} fel.\n")
        sys.exit(1)
    else:
        print(f"\nâœ… Healthcheck genomfÃ¶rd utan fel.\n")

if __name__ == "__main__":
    main()
END: healthcheck_sync.py

ğŸ“ KONFIGURATIONSFILER (function.json / host.json / package.json / .funcignore)
====================================

ğŸ“„ Documents/KLR_AI/Projekt_MacSpot/macspot-api/.funcignore
   # Exclude dev-only files and folders
   .git
   .vscode
   .env
   *.log
   test/
   tests/
   
   # Explicitly include all required files and folders
   !host.json
   !package.json
   !package-lock.json
   
   !node_modules/
   !node_modules/**
   
   !shared/
   !shared/**
   
   !bookings/
   !bookings/**
   !getavailableslots/
   !getavailableslots/**
   !validate_contact/
   !validate_contact/**
   !meeting_types/
   !meeting_types/**
   !refreshCalendarOrigins/
   !refreshCalendarOrigins/**
   !refreshTravelTimes/
   !refreshTravelTimes/**
   !booking_settings/
   !booking_settings/**
   !test_azurecloud/
   !test_azurecloud/**
   !trackingPixel/
   !trackingPixel/**
ğŸ“„ Documents/KLR_AI/Projekt_MacSpot/macspot-api/booking_settings/function.json
   {
     "bindings": [
       {
         "authLevel": "anonymous",
         "type": "httpTrigger",
         "direction": "in",
         "name": "req",
         "methods": ["get"],
         "route": "booking_settings"
       },
       {
         "type": "http",
         "direction": "out",
         "name": "res"
       }
     ],
     "scriptFile": "index.js"
   }
ğŸ“„ Documents/KLR_AI/Projekt_MacSpot/macspot-api/bookings/function.json
   {
     "bindings": [
       {
         "authLevel": "anonymous",
         "type": "httpTrigger",
         "direction": "in",
         "name": "req",
         "methods": ["post", "options"],
         "route": "bookings"
       },
       {
         "type": "http",
         "direction": "out",
         "name": "res"
       }
     ],
     "scriptFile": "index.js"
   }
ğŸ“„ Documents/KLR_AI/Projekt_MacSpot/macspot-api/getavailableslots/function.json
   {
     "bindings": [
       {
         "authLevel": "anonymous",
         "type": "httpTrigger",
         "direction": "in",
         "name": "req",
         "methods": ["post", "options"],
         "route": "getavailableslots"
       },
       {
         "type": "http",
         "direction": "out",
         "name": "res"
       }
     ],
     "scriptFile": "index.js"
   }
ğŸ“„ Documents/KLR_AI/Projekt_MacSpot/macspot-api/host.json
   {
     "version": "2.0",
     "extensionBundle": {
       "id": "Microsoft.Azure.Functions.ExtensionBundle",
       "version": "[4.*, 5.0.0)"
     },
     "extensions": {
       "http": {
         "cors": {
           "allowedOrigins": [
             "https://www.klrab.se"
           ],
           "supportCredentials": false
         }
       }
     }
   }
ğŸ“„ Documents/KLR_AI/Projekt_MacSpot/macspot-api/meeting_types/function.json
   {
     "bindings": [
       {
         "authLevel": "anonymous",
         "type": "httpTrigger",
         "direction": "in",
         "name": "req",
         "methods": [ "get" ],
         "route": "meeting_types"
       },
       {
         "type": "http",
         "direction": "out",
         "name": "res"
       }
     ],
     "scriptFile": "index.js"
   }
ğŸ“„ Documents/KLR_AI/Projekt_MacSpot/macspot-api/package.json
   {
     "name": "macspot-api",
     "version": "1.0.0",
     "description": "Azure Functions backend fÃ¶r MacSpot CRM/ERP",
     "scripts": {
       "start": "func start",
       "dev": "func start --verbose",
       "deploy": "func azure functionapp publish macspotbackend",
       "build": "echo 'Nothing to build'"
     },
     "dependencies": {
       "@azure/functions": "^4.7.0",
       "@azure/msal-node": "^3.5.1",
       "@microsoft/microsoft-graph-client": "^3.0.0",
       "date-holidays": "^3.24.3",
       "dav": "^1.8.0",
       "dotenv": "^16.5.0",
       "isomorphic-fetch": "^3.0.0",
       "jsonwebtoken": "^9.0.0",
       "luxon": "^3.4.4",
       "node-fetch": "^2.7.0",
       "node-ical": "^0.20.1",
       "p-limit": "^6.2.0",
       "pg": "^8.15.6",
       "uuid": "^9.0.0",
       "xml2js": "^0.6.2"
     }
   }

ğŸ“„ Documents/KLR_AI/Projekt_MacSpot/macspot-api/refreshCalendarOrigins/function.json
   {
     "bindings": [
       {
         "name": "myTimer",
         "type": "timerTrigger",
         "direction": "in",
         "schedule": "0 0 * * * *"
       }
     ],
     "scriptFile": "index.js"
   }
ğŸ“„ Documents/KLR_AI/Projekt_MacSpot/macspot-api/refreshTravelTimes/function.json
   {
     "bindings": [
       {
         "name": "myTimer",
         "type": "timerTrigger",
         "direction": "in",
         "schedule": "0 0 * * * *"
       }
     ],
     "scriptFile": "index.js"
   }
ğŸ“„ Documents/KLR_AI/Projekt_MacSpot/macspot-api/test_azurecloud/function.json
   {
     "bindings": [
       {
         "authLevel": "anonymous",
         "type": "httpTrigger",
         "direction": "in",
         "name": "req",
         "methods": ["get"],
         "route": "test_azurecloud"
       },
       {
         "type": "http",
         "direction": "out",
         "name": "res"
       }
     ],
     "scriptFile": "index.js"
   }
ğŸ“„ Documents/KLR_AI/Projekt_MacSpot/macspot-api/validate_contact/function.json
   {
     "bindings": [
       {
         "authLevel": "anonymous",
         "type": "httpTrigger",
         "direction": "in",
         "name": "req",
         "methods": ["get", "post"],
         "route": "validate_contact"
       },
       {
         "type": "http",
         "direction": "out",
         "name": "res"
       }
     ],
     "scriptFile": "index.js"
   }
ğŸ“ˆ SUMMERING AV ALLA JS-FILER
====================================
ğŸ“ Totalt antal rader kod: 961
ğŸ§© Totalt antal funktioner: 0
ğŸ§  Total komplexitetspoÃ¤ng: 119
ğŸ§ª Antal TODO/FIXME totalt: 0

ğŸ“Š Per fil:
fil,rader,funktioner,komplexitet,kommentarer,imports
sync_from_cloud.py,161,0,22,0,2
sync_to_cloud.py,283,0,45,0,3
sync_static_tables.py,61,0,6,0,2
sync.py,114,0,15,0,2
sync_all.py,213,0,25,0,7
sync_plist.xml,26,0,0,0,0
com.macspot.sync.plist,23,0,0,0,0
healthcheck_sync.py,80,0,6,0,2
ğŸ“Š MOLNDATABAS (Azure) â€“ STRUKTUR & INNEHÃ…LL
====================================

ğŸ“ Tabell: slot_cache
  â€¢ created_at (timestamp without time zone)
  â€¢ slot_day (date)
  â€¢ slots (jsonb)
  â€¢ id (uuid)
  â€¢ meeting_length (integer)
  â€¢ booking_email (text)
  â€¢ meeting_type (text)
  â€¢ slot_part (text)
  ğŸ”‘ [p] slot_cache_pkey: PRIMARY KEY (id)

ğŸ“ Tabell: calendar_origin_cache
  â€¢ created_at (timestamp without time zone)
  â€¢ timestamp (timestamp with time zone)
  â€¢ event_date (date)
  â€¢ id (integer)
  â€¢ end_time (timestamp without time zone)
  â€¢ address (text)
  â€¢ source (text)
  ğŸ”‘ [c] calendar_origin_cache_source_check: CHECK ((source = ANY (ARRAY['Apple Calendar'::text, 'Microsoft 365'::text])))
  ğŸ”‘ [p] calendar_origin_cache_pkey: PRIMARY KEY (id)

ğŸ“ Tabell: available_slots_cache
  â€¢ id (uuid)
  â€¢ travel_time_min (integer)
  â€¢ generated_at (timestamp without time zone)
  â€¢ expires_at (timestamp without time zone)
  â€¢ meeting_length (integer)
  â€¢ slot_day (date)
  â€¢ slot_score (integer)
  â€¢ meeting_type (text)
  â€¢ slot_part (text)
  â€¢ slot_iso (text)
  ğŸ”‘ [p] available_slots_cache_pkey: PRIMARY KEY (id)

ğŸ“ Tabell: travel_time_cache
  â€¢ travel_minutes (integer)
  â€¢ updated_at (timestamp with time zone)
  â€¢ is_fallback (boolean)
  â€¢ hour (integer)
  â€¢ created_at (timestamp with time zone)
  â€¢ to_address (text)
  â€¢ from_address (text)
  ğŸ”‘ [u] unique_travel_key: UNIQUE (from_address, to_address, hour)
  ğŸ§ª Topp 5 rader:
    - from_address=Taxgatan 4, 115 45 Stockholm, to_address=Maria Skolgata 79A, 118 53 Stockholm, hour=7, travel_minutes=17, created_at=2025-06-01 20:37:36.958100+00:00, updated_at=2025-06-01 20:37:36.958100+00:00, is_fallback=False
    - from_address=Taxgatan 4, 115 45 Stockholm, to_address=Maria Skolgata 79A, 118 53 Stockholm, hour=9, travel_minutes=17, created_at=2025-06-01 20:37:37.880289+00:00, updated_at=2025-06-01 20:37:37.880289+00:00, is_fallback=False
    - from_address=Taxgatan 4, 115 45 Stockholm, to_address=Maria Skolgata 79A, 118 53 Stockholm, hour=11, travel_minutes=17, created_at=2025-06-01 20:37:37.776032+00:00, updated_at=2025-06-01 20:37:37.776032+00:00, is_fallback=False
    - from_address=Taxgatan 4, 115 45 Stockholm, to_address=Maria Skolgata 79A, 118 53 Stockholm, hour=6, travel_minutes=17, created_at=2025-06-01 20:37:37.156222+00:00, updated_at=2025-06-01 20:37:37.156222+00:00, is_fallback=False
    - from_address=Taxgatan 4, 115 45 Stockholm, to_address=Maria Skolgata 79A, 118 53 Stockholm, hour=8, travel_minutes=17, created_at=2025-06-01 20:37:37.648891+00:00, updated_at=2025-06-01 20:37:37.648891+00:00, is_fallback=False

ğŸ“ Tabell: event_log
  â€¢ received_at (timestamp with time zone)
  â€¢ record_id (uuid)
  â€¢ timestamp (timestamp with time zone)
  â€¢ booking_id (uuid)
  â€¢ id (uuid)
  â€¢ payload (jsonb)
  â€¢ action (text)
  â€¢ event_type (text)
  â€¢ source (text)
  â€¢ table_name (text)
  ğŸ”‘ [p] event_log_pkey: PRIMARY KEY (id)
  ğŸ§ª Topp 5 rader:
    - source=None, event_type=None, payload=None, received_at=2025-06-01 20:37:30.699890+00:00, id=2c00583c-cc66-44ed-ad81-1b404c8385ac, action=INSERT, table_name=contact, record_id=4ce9fc3f-d44f-40ca-aa9d-13e4db7f0f31, timestamp=2025-06-01 20:37:30.699890+00:00, booking_id=None
    - source=None, event_type=calendar_response_status, payload={'response': 'none'}, received_at=2025-06-01 20:38:18.897492+00:00, id=c06ba994-c60f-4c92-8203-dc7e00070b74, action=None, table_name=None, record_id=None, timestamp=2025-06-01 20:38:18.897492+00:00, booking_id=3d09c33e-52c9-4736-975b-61ee3713551c
    - source=None, event_type=calendar_invite_sent, payload={'subject': 'MÃ¶te med KLRA LedningsrÃ¥dgivning', 'webLink': 'https://outlook.office365.com/owa/?itemid=AAMkADIyMzUxMTE1LWQ0NDUtNDMwNC05YmE3LTRhMThmNDkyNzA2ZABGAAAAAAD8zD4S9766TIdQsQEV5sX5BwB0FUy6J9MkSLnOAsVgC0tuAAAAAAENAAB0FUy6J9MkSLnOAsVgC0tuAAAnEf1vAAA%3D&exvsurl=1&path=/calendar/item', 'location': 'Online'}, received_at=2025-06-01 20:38:18.923033+00:00, id=b47ba88d-c7d2-4382-8aa5-9dcff24a5e35, action=None, table_name=None, record_id=None, timestamp=2025-06-01 20:38:18.923033+00:00, booking_id=3d09c33e-52c9-4736-975b-61ee3713551c
    - source=None, event_type=calendar_event_created, payload={'end': {'dateTime': '2025-06-02T06:30:00.0000000', 'timeZone': 'UTC'}, 'body': {'content': '<html>\r\n<head>\r\n<meta http-equiv="Content-Type" content="text/html; charset=utf-8">\r\n</head>\r\n<body>\r\nDetta Ã¤r en inbjudan till mÃ¶te: MÃ¶te med KLRA LedningsrÃ¥dgivning\r\n</body>\r\n</html>\r\n', 'contentType': 'html'}, 'start': {'dateTime': '2025-06-02T06:20:00.0000000', 'timeZone': 'UTC'}, 'eventId': 'AAMkADIyMzUxMTE1LWQ0NDUtNDMwNC05YmE3LTRhMThmNDkyNzA2ZABGAAAAAAD8zD4S9766TIdQsQEV5sX5BwB0FUy6J9MkSLnOAsVgC0tuAAAAAAENAAB0FUy6J9MkSLnOAsVgC0tuAAAnEf1vAAA=', 'subject': 'MÃ¶te med KLRA LedningsrÃ¥dgivning', 'webLink': 'https://outlook.office365.com/owa/?itemid=AAMkADIyMzUxMTE1LWQ0NDUtNDMwNC05YmE3LTRhMThmNDkyNzA2ZABGAAAAAAD8zD4S9766TIdQsQEV5sX5BwB0FUy6J9MkSLnOAsVgC0tuAAAAAAENAAB0FUy6J9MkSLnOAsVgC0tuAAAnEf1vAAA%3D&exvsurl=1&path=/calendar/item', 'location': 'Online', 'attendees': [{'type': 'required', 'status': {'time': '0001-01-01T00:00:00Z', 'response': 'none'}, 'emailAddress': {'name': 'daniel.kallberg@mac.com', 'address': 'daniel.kallberg@mac.com'}}], 'onlineMeetingUrl': None}, received_at=2025-06-01 20:38:18.949898+00:00, id=a8781988-c135-4f0b-9eb0-16b2a88c9f9c, action=None, table_name=None, record_id=None, timestamp=2025-06-01 20:38:18.949898+00:00, booking_id=3d09c33e-52c9-4736-975b-61ee3713551c
    - source=None, event_type=calendar_invite_sent, payload={'subject': 'MÃ¶te med KLRA LedningsrÃ¥dgivning', 'webLink': 'https://us05web.zoom.us/j/82144172118?pwd=zJm2Xe3RjuaM7e7HeDLoeacSdnbaVc.1', 'location': 'Online'}, received_at=2025-06-01 20:38:18.975463+00:00, id=835d1bab-4d1a-4fe5-8da0-4597f7131fde, action=None, table_name=None, record_id=None, timestamp=2025-06-01 20:38:18.975463+00:00, booking_id=3d09c33e-52c9-4736-975b-61ee3713551c

ğŸ“ Tabell: booking_settings
  â€¢ value (jsonb)
  â€¢ updated_at (timestamp with time zone)
  â€¢ key (text)
  â€¢ value_type (text)
  ğŸ”‘ [u] unique_key: UNIQUE (key)
  ğŸ§ª Topp 5 rader:
    - key=email_subject_templates, value={'zoom': 'ZoommÃ¶te: {{first_name}} | {{company}} & Daniel | Kinnekulle LedningsrÃ¥dgivning AB', 'teams': 'TeamsmÃ¶te: {{first_name}} | {{company}} & Daniel | Kinnekulle LedningsrÃ¥dgivning AB', 'atclient': 'MÃ¶te hos {{company}}: {{first_name}} | {{company}} & Daniel | Kinnekulle LedningsrÃ¥dgivning AB', 'atoffice': 'MÃ¶te hos KLR AB (Stockholm | SÃ¶dermalm): {{first_name}} | {{company}} & Daniel | Kinnekulle LedningsrÃ¥dgivning AB', 'facetime': 'FaceTime-mÃ¶te: {{first_name}} | {{company}} & Daniel | Kinnekulle LedningsrÃ¥dgivning AB'}, value_type=json, updated_at=2025-05-30 20:46:14.058171+00:00
    - key=default_language, value=sv, value_type=string, updated_at=2025-05-25 10:37:53.619684+00:00
    - key=default_meeting_length_atclient, value=[90, 180, 270, 360], value_type=array, updated_at=2025-04-23 12:48:49.778155+00:00
    - key=default_meeting_length_atoffice, value=[60, 90], value_type=array, updated_at=2025-04-23 12:48:49.778155+00:00
    - key=default_meeting_length_digital, value=[10, 20, 60], value_type=array, updated_at=2025-04-23 12:48:49.778155+00:00

ğŸ“ Tabell: translation
  â€¢ key (character varying)
  â€¢ sv (text)
  â€¢ en (text)
  ğŸ§ª Topp 5 rader:
    - key=error_invalid_phone, sv=Ogiltigt telefonnummer. Vi vet att det Ã¤r svÃ¥rt att komma ihÃ¥g sitt nummer., en=Invalid phone number. We know remembering your own number is hard.
    - key=error_invalid_name, sv=Namnet Ã¤r ogiltigt (minst 2 tecken, max 50). Smeknamn som "X" Ã¤r fÃ¶r Elon., en=Invalid name (min 2 characters, max 50). Nicknames like "X" are taken.
    - key=error_missing_fields, sv=Alla fÃ¤lt mÃ¥ste vara ifyllda. Vi Ã¤r petiga sÃ¥ du slipper bli det senare., en=All fields must be filled. Weâ€™re picky so you donâ€™t have to be later.
    - key=error_missing_meeting_link, sv=MÃ¶teslÃ¤nk krÃ¤vs. Om inte mÃ¶tet sker via brevduva., en=A meeting link is required. Unless the meeting is via carrier pigeon.
    - key=error_missing_recaptcha, sv=reCAPTCHA mÃ¥ste verifieras. Nej, det Ã¤r inte en kÃ¤nslomÃ¤ssig frÃ¥ga., en=reCAPTCHA verification required. And no, itâ€™s not a personality test.

ğŸ“ Tabell: bookings
  â€¢ start_time (timestamp with time zone)
  â€¢ end_time (timestamp with time zone)
  â€¢ id (uuid)
  â€¢ updated_at (timestamp with time zone)
  â€¢ metadata (jsonb)
  â€¢ created_at (timestamp with time zone)
  â€¢ contact_id (uuid)
  â€¢ meeting_type (text)
  â€¢ booking_email (text)
  ğŸ”‘ [p] bookings_pkey: PRIMARY KEY (id)
  ğŸ”‘ [f] fk_bookings_contact: FOREIGN KEY (contact_id) REFERENCES contact(id) ON DELETE SET NULL
  ğŸ§ª Topp 5 rader:
    - start_time=2025-06-02 06:20:00+00:00, end_time=2025-06-02 06:30:00+00:00, meeting_type=zoom, metadata={'phone': '098765432', 'company': 'persson AB', 'subject': 'MÃ¶te med KLRA LedningsrÃ¥dgivning', 'location': 'Online', 'last_name': 'Johansson', 'first_name': 'Per', 'ip_address': '172.226.49.45:48167', 'meeting_id': 82144172118, 'user_agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/18.5 Safari/605.1.15', 'online_link': 'https://us05web.zoom.us/j/82144172118?pwd=zJm2Xe3RjuaM7e7HeDLoeacSdnbaVc.1', 'meeting_length': 10, 'calendar_response_status': 'none'}, created_at=2025-06-01 20:38:17.398000+00:00, contact_id=4ce9fc3f-d44f-40ca-aa9d-13e4db7f0f31, id=3d09c33e-52c9-4736-975b-61ee3713551c, updated_at=2025-06-01 20:38:17.398000+00:00, booking_email=daniel.kallberg@mac.com
    - start_time=2025-06-02 08:00:00+00:00, end_time=2025-06-02 08:10:00+00:00, meeting_type=zoom, metadata={'phone': '098765432', 'company': 'persson AB', 'subject': 'MÃ¶te med KLRA LedningsrÃ¥dgivning', 'location': 'Online', 'last_name': 'Johansson', 'first_name': 'Per', 'ip_address': '172.226.49.45:47716', 'meeting_id': 83811214708, 'user_agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/18.5 Safari/605.1.15', 'online_link': 'https://us05web.zoom.us/j/83811214708?pwd=uDzaG32s3i87PlV0pOwojrXUzZ7aEg.1', 'meeting_length': 10, 'calendar_response_status': 'none'}, created_at=2025-06-01 20:50:09.892000+00:00, contact_id=4ce9fc3f-d44f-40ca-aa9d-13e4db7f0f31, id=059ec692-02af-40c7-9501-0679d86b81dd, updated_at=2025-06-01 20:50:09.892000+00:00, booking_email=daniel.kallberg@mac.com
    - start_time=2025-06-02 08:40:00+00:00, end_time=2025-06-02 09:00:00+00:00, meeting_type=zoom, metadata={'phone': '098765432', 'company': 'persson AB', 'subject': 'MÃ¶te med KLRA LedningsrÃ¥dgivning', 'location': 'Online', 'last_name': 'Johansson', 'first_name': 'Per', 'ip_address': '172.226.49.45:47708', 'meeting_id': 86400396910, 'user_agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/18.5 Safari/605.1.15', 'online_link': 'https://us05web.zoom.us/j/86400396910?pwd=z8fdhAA8ibZ5hxJEpmebYHaX57JugC.1', 'meeting_length': 20, 'calendar_response_status': 'none'}, created_at=2025-06-01 20:56:02.371000+00:00, contact_id=4ce9fc3f-d44f-40ca-aa9d-13e4db7f0f31, id=967fa70d-2409-4884-8d5b-f2c036eb1a99, updated_at=2025-06-01 20:56:02.371000+00:00, booking_email=daniel.kallberg@mac.com
    - start_time=2025-06-02 09:20:00+00:00, end_time=2025-06-02 09:30:00+00:00, meeting_type=zoom, metadata={'phone': '098765432', 'company': 'persson AB', 'subject': 'ZoommÃ¶te: Per | persson AB & Daniel | Kinnekulle LedningsrÃ¥dgivning AB', 'location': 'Online', 'last_name': 'Johansson', 'first_name': 'Per', 'ip_address': '172.226.49.45:46831', 'meeting_id': 81612591010, 'user_agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/18.5 Safari/605.1.15', 'online_link': 'https://us05web.zoom.us/j/81612591010?pwd=3Pu0VQxyWyR0pPab7OlpAfKb7CpiWq.1', 'meeting_length': 10, 'calendar_response_status': 'none'}, created_at=2025-06-01 21:01:27.794000+00:00, contact_id=4ce9fc3f-d44f-40ca-aa9d-13e4db7f0f31, id=1a231d98-2e66-41ae-a718-6048aa624601, updated_at=2025-06-01 21:01:27.794000+00:00, booking_email=daniel.kallberg@mac.com
    - start_time=2025-06-02 11:20:00+00:00, end_time=2025-06-02 11:30:00+00:00, meeting_type=facetime, metadata={'phone': '070-2656868', 'company': 'Anna AB', 'subject': 'FaceTime-mÃ¶te: Anna | Anna AB & Daniel | Kinnekulle LedningsrÃ¥dgivning AB', 'location': 'FaceTime', 'last_name': 'Sahlin', 'first_name': 'Anna', 'ip_address': '81.233.161.165:58650', 'user_agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/18.5 Safari/605.1.15', 'online_link': 'facetime:070-2656868', 'body_preview': '<html>\r\n<head>\r\n<meta http-equiv="Content-Type" content="text/html; charset=utf-8">\r\n</head>\r\n<body>\r\nDetta Ã¤r en inbjudan till mÃ¶te: FaceTime-mÃ¶te: Anna | Anna AB &amp; Daniel | Kinnekulle LedningsrÃ¥dgivning AB\r\n</body>\r\n</html>\r\n', 'meeting_length': 10, 'calendar_response_status': 'none'}, created_at=2025-06-01 21:14:06.367000+00:00, contact_id=6dedbbd8-661f-4f87-9b54-e302bdd6f61a, id=affd507f-ee62-4ad0-b723-609100422f3b, updated_at=2025-06-01 21:14:06.367000+00:00, booking_email=annapanna79@yahoo.com

ğŸ“ Tabell: pending_changes
  â€¢ booking_id (uuid)
  â€¢ processed (boolean)
  â€¢ created_at (timestamp with time zone)
  â€¢ payload (jsonb)
  â€¢ id (uuid)
  â€¢ record_id (uuid)
  â€¢ table_name (text)
  â€¢ operation (text)
  â€¢ change_type (text)
  â€¢ direction (text)
  ğŸ”‘ [p] pending_changes_pkey: PRIMARY KEY (id)
  ğŸ”‘ [f] fk_pending_changes_booking_id: FOREIGN KEY (booking_id) REFERENCES bookings(id) ON DELETE CASCADE
  ğŸ§ª Topp 5 rader:
    - id=fff97701-6232-4ac2-ba9f-b1c02769b414, table_name=bookings, record_id=3d09c33e-52c9-4736-975b-61ee3713551c, change_type=INSERT, direction=cloud_to_local, processed=False, created_at=2025-06-01 20:38:19.055000+00:00, operation=None, payload=None, booking_id=3d09c33e-52c9-4736-975b-61ee3713551c
    - id=93cd0ba6-50f9-4c4b-80f4-5822c0f14912, table_name=bookings, record_id=059ec692-02af-40c7-9501-0679d86b81dd, change_type=INSERT, direction=cloud_to_local, processed=False, created_at=2025-06-01 20:50:11.295000+00:00, operation=None, payload=None, booking_id=059ec692-02af-40c7-9501-0679d86b81dd
    - id=c13128f8-3198-4d29-9b4b-673ff2dabe41, table_name=bookings, record_id=967fa70d-2409-4884-8d5b-f2c036eb1a99, change_type=INSERT, direction=cloud_to_local, processed=False, created_at=2025-06-01 20:56:03.629000+00:00, operation=None, payload=None, booking_id=967fa70d-2409-4884-8d5b-f2c036eb1a99
    - id=fbd2921d-a75d-49b3-b1af-a62fc5cb4652, table_name=bookings, record_id=1a231d98-2e66-41ae-a718-6048aa624601, change_type=INSERT, direction=cloud_to_local, processed=False, created_at=2025-06-01 21:01:29.511000+00:00, operation=None, payload=None, booking_id=1a231d98-2e66-41ae-a718-6048aa624601
    - id=9c53a7e8-4147-482e-93e7-0e5c9a4002a1, table_name=bookings, record_id=affd507f-ee62-4ad0-b723-609100422f3b, change_type=INSERT, direction=cloud_to_local, processed=False, created_at=2025-06-01 21:14:07.151000+00:00, operation=None, payload=None, booking_id=affd507f-ee62-4ad0-b723-609100422f3b

ğŸ“ Tabell: contact
  â€¢ metadata (jsonb)
  â€¢ created_at (timestamp with time zone)
  â€¢ id (uuid)
  â€¢ updated_at (timestamp with time zone)
  â€¢ booking_email (text)
  â€¢ email (text)
  ğŸ”‘ [p] contact_pkey: PRIMARY KEY (id)
  ğŸ§ª Topp 5 rader:
    - metadata={'phone': '098765432', 'origin': 'klrab.se', 'company': 'persson AB', 'last_name': 'Johansson', 'first_name': 'Per'}, created_at=2025-06-01 20:37:30.699890+00:00, id=4ce9fc3f-d44f-40ca-aa9d-13e4db7f0f31, booking_email=daniel.kallberg@mac.com, updated_at=2025-06-02 06:13:47.337045+00:00, email=daniel.kallberg@mac.com
    - metadata={'phone': '070-2656868', 'origin': 'klrab.se', 'company': 'Anna AB', 'last_name': 'Sahlin', 'first_name': 'Anna'}, created_at=2025-06-01 21:13:46.657884+00:00, id=6dedbbd8-661f-4f87-9b54-e302bdd6f61a, booking_email=annapanna79@yahoo.com, updated_at=2025-06-02 06:13:47.337045+00:00, email=annapanna79@yahoo.com

ğŸ“Š LOKAL DATABAS â€“ STRUKTUR & INNEHÃ…LL
====================================

ğŸ“ Tabell: booking_settings
  â€¢ value (jsonb)
  â€¢ updated_at (timestamp with time zone)
  â€¢ key (text)
  â€¢ value_type (text)
  ğŸ”‘ [p] booking_settings_pkey: PRIMARY KEY (key)
  ğŸ§ª Topp 5 rader:
    - key=email_subject_templates, value={'zoom': 'ZoommÃ¶te: {{first_name}} | {{company}} & Daniel | Kinnekulle LedningsrÃ¥dgivning AB', 'teams': 'TeamsmÃ¶te: {{first_name}} | {{company}} & Daniel | Kinnekulle LedningsrÃ¥dgivning AB', 'atclient': 'MÃ¶te hos {{company}}: {{first_name}} | {{company}} & Daniel | Kinnekulle LedningsrÃ¥dgivning AB', 'atoffice': 'MÃ¶te hos KLR AB (Stockholm | SÃ¶dermalm): {{first_name}} | {{company}} & Daniel | Kinnekulle LedningsrÃ¥dgivning AB', 'facetime': 'FaceTime-mÃ¶te: {{first_name}} | {{company}} & Daniel | Kinnekulle LedningsrÃ¥dgivning AB'}, value_type=json, updated_at=2025-05-30 22:46:14.058171+02:00
    - key=default_language, value=sv, value_type=string, updated_at=2025-05-25 12:37:53.619684+02:00
    - key=default_meeting_length_atclient, value=[90, 180, 270, 360], value_type=array, updated_at=2025-04-23 14:48:49.778155+02:00
    - key=default_meeting_length_atoffice, value=[60, 90], value_type=array, updated_at=2025-04-23 14:48:49.778155+02:00
    - key=default_meeting_length_digital, value=[10, 20, 60], value_type=array, updated_at=2025-04-23 14:48:49.778155+02:00

ğŸ“ Tabell: bookings
  â€¢ start_time (timestamp with time zone)
  â€¢ end_time (timestamp with time zone)
  â€¢ id (uuid)
  â€¢ updated_at (timestamp with time zone)
  â€¢ metadata (jsonb)
  â€¢ created_at (timestamp with time zone)
  â€¢ contact_id (uuid)
  â€¢ meeting_type (text)
  â€¢ booking_email (text)
  ğŸ”‘ [p] bookings_pkey: PRIMARY KEY (id)
  ğŸ”‘ [f] fk_bookings_contact: FOREIGN KEY (contact_id) REFERENCES contact(id) ON DELETE SET NULL
  ğŸ§ª Topp 5 rader:
    - start_time=2025-06-02 08:20:00+02:00, end_time=2025-06-02 08:30:00+02:00, meeting_type=zoom, metadata={'phone': '098765432', 'company': 'persson AB', 'subject': 'MÃ¶te med KLRA LedningsrÃ¥dgivning', 'location': 'Online', 'last_name': 'Johansson', 'first_name': 'Per', 'ip_address': '172.226.49.45:48167', 'meeting_id': 82144172118, 'user_agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/18.5 Safari/605.1.15', 'online_link': 'https://us05web.zoom.us/j/82144172118?pwd=zJm2Xe3RjuaM7e7HeDLoeacSdnbaVc.1', 'meeting_length': 10, 'calendar_response_status': 'none'}, created_at=2025-06-01 22:38:17.398000+02:00, contact_id=4ce9fc3f-d44f-40ca-aa9d-13e4db7f0f31, id=3d09c33e-52c9-4736-975b-61ee3713551c, updated_at=2025-06-01 22:38:17.398000+02:00, booking_email=daniel.kallberg@mac.com
    - start_time=2025-06-02 10:00:00+02:00, end_time=2025-06-02 10:10:00+02:00, meeting_type=zoom, metadata={'phone': '098765432', 'company': 'persson AB', 'subject': 'MÃ¶te med KLRA LedningsrÃ¥dgivning', 'location': 'Online', 'last_name': 'Johansson', 'first_name': 'Per', 'ip_address': '172.226.49.45:47716', 'meeting_id': 83811214708, 'user_agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/18.5 Safari/605.1.15', 'online_link': 'https://us05web.zoom.us/j/83811214708?pwd=uDzaG32s3i87PlV0pOwojrXUzZ7aEg.1', 'meeting_length': 10, 'calendar_response_status': 'none'}, created_at=2025-06-01 22:50:09.892000+02:00, contact_id=4ce9fc3f-d44f-40ca-aa9d-13e4db7f0f31, id=059ec692-02af-40c7-9501-0679d86b81dd, updated_at=2025-06-01 22:50:09.892000+02:00, booking_email=daniel.kallberg@mac.com
    - start_time=2025-06-02 10:40:00+02:00, end_time=2025-06-02 11:00:00+02:00, meeting_type=zoom, metadata={'phone': '098765432', 'company': 'persson AB', 'subject': 'MÃ¶te med KLRA LedningsrÃ¥dgivning', 'location': 'Online', 'last_name': 'Johansson', 'first_name': 'Per', 'ip_address': '172.226.49.45:47708', 'meeting_id': 86400396910, 'user_agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/18.5 Safari/605.1.15', 'online_link': 'https://us05web.zoom.us/j/86400396910?pwd=z8fdhAA8ibZ5hxJEpmebYHaX57JugC.1', 'meeting_length': 20, 'calendar_response_status': 'none'}, created_at=2025-06-01 22:56:02.371000+02:00, contact_id=4ce9fc3f-d44f-40ca-aa9d-13e4db7f0f31, id=967fa70d-2409-4884-8d5b-f2c036eb1a99, updated_at=2025-06-01 22:56:02.371000+02:00, booking_email=daniel.kallberg@mac.com
    - start_time=2025-06-02 11:20:00+02:00, end_time=2025-06-02 11:30:00+02:00, meeting_type=zoom, metadata={'phone': '098765432', 'company': 'persson AB', 'subject': 'ZoommÃ¶te: Per | persson AB & Daniel | Kinnekulle LedningsrÃ¥dgivning AB', 'location': 'Online', 'last_name': 'Johansson', 'first_name': 'Per', 'ip_address': '172.226.49.45:46831', 'meeting_id': 81612591010, 'user_agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/18.5 Safari/605.1.15', 'online_link': 'https://us05web.zoom.us/j/81612591010?pwd=3Pu0VQxyWyR0pPab7OlpAfKb7CpiWq.1', 'meeting_length': 10, 'calendar_response_status': 'none'}, created_at=2025-06-01 23:01:27.794000+02:00, contact_id=4ce9fc3f-d44f-40ca-aa9d-13e4db7f0f31, id=1a231d98-2e66-41ae-a718-6048aa624601, updated_at=2025-06-01 23:01:27.794000+02:00, booking_email=daniel.kallberg@mac.com
    - start_time=2025-06-02 13:20:00+02:00, end_time=2025-06-02 13:30:00+02:00, meeting_type=facetime, metadata={'phone': '070-2656868', 'company': 'Anna AB', 'subject': 'FaceTime-mÃ¶te: Anna | Anna AB & Daniel | Kinnekulle LedningsrÃ¥dgivning AB', 'location': 'FaceTime', 'last_name': 'Sahlin', 'first_name': 'Anna', 'ip_address': '81.233.161.165:58650', 'user_agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/18.5 Safari/605.1.15', 'online_link': 'facetime:070-2656868', 'body_preview': '<html>\r\n<head>\r\n<meta http-equiv="Content-Type" content="text/html; charset=utf-8">\r\n</head>\r\n<body>\r\nDetta Ã¤r en inbjudan till mÃ¶te: FaceTime-mÃ¶te: Anna | Anna AB &amp; Daniel | Kinnekulle LedningsrÃ¥dgivning AB\r\n</body>\r\n</html>\r\n', 'meeting_length': 10, 'calendar_response_status': 'none'}, created_at=2025-06-01 23:14:06.367000+02:00, contact_id=6dedbbd8-661f-4f87-9b54-e302bdd6f61a, id=affd507f-ee62-4ad0-b723-609100422f3b, updated_at=2025-06-01 23:14:06.367000+02:00, booking_email=annapanna79@yahoo.com

ğŸ“ Tabell: contact
  â€¢ metadata (jsonb)
  â€¢ created_at (timestamp with time zone)
  â€¢ id (uuid)
  â€¢ updated_at (timestamp with time zone)
  â€¢ booking_email (text)
  â€¢ email (text)
  ğŸ”‘ [p] contact_pkey: PRIMARY KEY (id)
  ğŸ§ª Topp 5 rader:
    - metadata={'phone': '098765432', 'origin': 'klrab.se', 'company': 'Persson AB', 'last_name': 'Johansson', 'first_name': 'Per', 'force_resync': True}, created_at=2025-06-01 22:37:30.699890+02:00, id=4ce9fc3f-d44f-40ca-aa9d-13e4db7f0f31, booking_email=daniel.kallberg@mac.com, updated_at=2025-06-02 17:10:00.571594+02:00, email=daniel.kallberg@mac.com
    - metadata={'phone': '070-2656868', 'origin': 'klrab.se', 'company': 'Anna AB', 'last_name': 'Sahlin', 'first_name': 'Anna-Panna', 'force_resync': True}, created_at=2025-06-01 23:13:46.657884+02:00, id=6dedbbd8-661f-4f87-9b54-e302bdd6f61a, booking_email=annapanna79@yahoo.com, updated_at=2025-06-02 17:10:00.575093+02:00, email=annapanna79@yahoo.com

ğŸ“ Tabell: company
  â€¢ metadata (jsonb)
  â€¢ created_at (timestamp with time zone)
  â€¢ id (uuid)
  â€¢ name (text)
  â€¢ org_number (text)
  ğŸ”‘ [p] company_pkey: PRIMARY KEY (id)

ğŸ“ Tabell: translation
  â€¢ key (character varying)
  â€¢ sv (text)
  â€¢ en (text)
  ğŸ”‘ [u] unique_translation_key: UNIQUE (key)
  ğŸ”‘ [p] translation_pkey: PRIMARY KEY (key)
  ğŸ§ª Topp 5 rader:
    - key=error_min_duration_fysiskt_kund, sv=MÃ¶testiden fÃ¶r 'Fysiskt hos kund' mÃ¥ste vara minst {{minutes}} minuter. Du visste det redan., en=The meeting time for 'On-site at customer' must be at least {{minutes}} minutes. You knew that.
    - key=error_min_duration_fysiskt_mig, sv=MÃ¶testiden fÃ¶r 'Fysiskt hos mig' mÃ¥ste vara minst {{minutes}} minuter. Annars hinner vi bara sÃ¤ga hej., en=The meeting time for 'At my office' must be at least {{minutes}} minutes. Otherwise, weâ€™ll only have time to say hello.
    - key=email_body_booking_received, sv=Hej {{name}}! Vi har tagit emot din bokning fÃ¶r {{meeting_type}} mellan {{start_time}} och {{end_time}}. Ingen panik â€“ vi Ã¥terkommer med bekrÃ¤ftelse. / Daniel, en=Hello {{name}}, Weâ€™ve received your booking for {{meeting_type}} between {{start_time}} and {{end_time}}. No need to panic â€“ weâ€™ll confirm shortly. / Daniel
    - key=email_body_booking_confirmed, sv=Hej {{name}}! Din bokning fÃ¶r {{meeting_type}} mellan {{start_time}} och {{end_time}} Ã¤r nu spikad. Ser fram emot det! / Daniel, en=Hello {{name}}, Your booking for {{meeting_type}} between {{start_time}} and {{end_time}} is now locked in. Looking forward! / Daniel
    - key=email_body_booking_cancelled, sv=Hej {{name}}! Din bokning fÃ¶r {{meeting_type}} mellan {{start_time}} och {{end_time}} Ã¤r avbokad. HÃ¶r av dig om du vill hitta en ny tid. / Daniel, en=Hello {{name}}, Your booking for {{meeting_type}} between {{start_time}} and {{end_time}} has been cancelled. Let me know if you'd like a new one. / Daniel

ğŸ“ Tabell: ccrelation
  â€¢ id (uuid)
  â€¢ company_id (uuid)
  â€¢ contact_id (uuid)
  â€¢ main_contact (boolean)
  â€¢ start_date (date)
  â€¢ end_date (date)
  â€¢ metadata (jsonb)
  â€¢ created_at (timestamp with time zone)
  â€¢ role (text)
  ğŸ”‘ [p] ccrelation_pkey: PRIMARY KEY (id)
  ğŸ”‘ [f] fk_ccrelation_contact_id: FOREIGN KEY (contact_id) REFERENCES contact(id) ON DELETE CASCADE
  ğŸ”‘ [f] fk_ccrelation_company_id: FOREIGN KEY (company_id) REFERENCES company(id) ON DELETE CASCADE

ğŸ“ Tabell: pending_changes
  â€¢ booking_id (uuid)
  â€¢ processed (boolean)
  â€¢ created_at (timestamp with time zone)
  â€¢ payload (jsonb)
  â€¢ id (uuid)
  â€¢ record_id (uuid)
  â€¢ table_name (text)
  â€¢ operation (text)
  â€¢ change_type (text)
  â€¢ direction (text)
  ğŸ”‘ [p] pending_changes_pkey: PRIMARY KEY (id)
  ğŸ”‘ [f] fk_pending_changes_booking_id: FOREIGN KEY (booking_id) REFERENCES bookings(id) ON DELETE CASCADE
  ğŸ§ª Topp 5 rader:
    - id=aece4862-6155-4819-aaa3-a21f5ed522f5, table_name=bookings, record_id=967fa70d-2409-4884-8d5b-f2c036eb1a99, change_type=INSERT, direction=out, processed=True, created_at=2025-06-02 08:01:46.750394+02:00, operation=INSERT, payload={'id': '967fa70d-2409-4884-8d5b-f2c036eb1a99', 'end_time': '2025-06-02T11:00:00+02:00', 'metadata': {'phone': '098765432', 'company': 'persson AB', 'subject': 'MÃ¶te med KLRA LedningsrÃ¥dgivning', 'location': 'Online', 'last_name': 'Johansson', 'first_name': 'Per', 'ip_address': '172.226.49.45:47708', 'meeting_id': 86400396910, 'user_agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/18.5 Safari/605.1.15', 'online_link': 'https://us05web.zoom.us/j/86400396910?pwd=z8fdhAA8ibZ5hxJEpmebYHaX57JugC.1', 'meeting_length': 20, 'calendar_response_status': 'none'}, 'contact_id': '4ce9fc3f-d44f-40ca-aa9d-13e4db7f0f31', 'created_at': '2025-06-01T22:56:02.371+02:00', 'start_time': '2025-06-02T10:40:00+02:00', 'updated_at': '2025-06-01T22:56:02.371+02:00', 'meeting_type': 'zoom', 'booking_email': 'daniel.kallberg@mac.com'}, booking_id=967fa70d-2409-4884-8d5b-f2c036eb1a99
    - id=eadc9857-e839-4eee-be8a-d5ee6ece7ee7, table_name=bookings, record_id=1a231d98-2e66-41ae-a718-6048aa624601, change_type=INSERT, direction=out, processed=True, created_at=2025-06-02 08:01:46.822683+02:00, operation=INSERT, payload={'id': '1a231d98-2e66-41ae-a718-6048aa624601', 'end_time': '2025-06-02T11:30:00+02:00', 'metadata': {'phone': '098765432', 'company': 'persson AB', 'subject': 'ZoommÃ¶te: Per | persson AB & Daniel | Kinnekulle LedningsrÃ¥dgivning AB', 'location': 'Online', 'last_name': 'Johansson', 'first_name': 'Per', 'ip_address': '172.226.49.45:46831', 'meeting_id': 81612591010, 'user_agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/18.5 Safari/605.1.15', 'online_link': 'https://us05web.zoom.us/j/81612591010?pwd=3Pu0VQxyWyR0pPab7OlpAfKb7CpiWq.1', 'meeting_length': 10, 'calendar_response_status': 'none'}, 'contact_id': '4ce9fc3f-d44f-40ca-aa9d-13e4db7f0f31', 'created_at': '2025-06-01T23:01:27.794+02:00', 'start_time': '2025-06-02T11:20:00+02:00', 'updated_at': '2025-06-01T23:01:27.794+02:00', 'meeting_type': 'zoom', 'booking_email': 'daniel.kallberg@mac.com'}, booking_id=1a231d98-2e66-41ae-a718-6048aa624601
    - id=c4157273-3c00-4697-adfc-31cb615962c4, table_name=contact, record_id=4ce9fc3f-d44f-40ca-aa9d-13e4db7f0f31, change_type=INSERT, direction=out, processed=True, created_at=2025-06-02 08:01:46.519546+02:00, operation=INSERT, payload={'id': '4ce9fc3f-d44f-40ca-aa9d-13e4db7f0f31', 'email': 'daniel.kallberg@mac.com', 'metadata': {'phone': '098765432', 'company': 'persson AB', 'last_name': 'Johansson', 'first_name': 'Per'}, 'created_at': '2025-06-01T22:37:30.69989+02:00', 'updated_at': '2025-06-01T22:37:30.69989+02:00', 'booking_email': 'daniel.kallberg@mac.com'}, booking_id=None
    - id=87f2374b-c890-48b4-bafe-8a05db36079f, table_name=bookings, record_id=3d09c33e-52c9-4736-975b-61ee3713551c, change_type=INSERT, direction=out, processed=True, created_at=2025-06-02 08:01:46.605879+02:00, operation=INSERT, payload={'id': '3d09c33e-52c9-4736-975b-61ee3713551c', 'end_time': '2025-06-02T08:30:00+02:00', 'metadata': {'phone': '098765432', 'company': 'persson AB', 'subject': 'MÃ¶te med KLRA LedningsrÃ¥dgivning', 'location': 'Online', 'last_name': 'Johansson', 'first_name': 'Per', 'ip_address': '172.226.49.45:48167', 'meeting_id': 82144172118, 'user_agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/18.5 Safari/605.1.15', 'online_link': 'https://us05web.zoom.us/j/82144172118?pwd=zJm2Xe3RjuaM7e7HeDLoeacSdnbaVc.1', 'meeting_length': 10, 'calendar_response_status': 'none'}, 'contact_id': '4ce9fc3f-d44f-40ca-aa9d-13e4db7f0f31', 'created_at': '2025-06-01T22:38:17.398+02:00', 'start_time': '2025-06-02T08:20:00+02:00', 'updated_at': '2025-06-01T22:38:17.398+02:00', 'meeting_type': 'zoom', 'booking_email': 'daniel.kallberg@mac.com'}, booking_id=3d09c33e-52c9-4736-975b-61ee3713551c
    - id=fbb2164e-4690-4e16-8bd7-225294d9a75a, table_name=bookings, record_id=059ec692-02af-40c7-9501-0679d86b81dd, change_type=INSERT, direction=out, processed=True, created_at=2025-06-02 08:01:46.678529+02:00, operation=INSERT, payload={'id': '059ec692-02af-40c7-9501-0679d86b81dd', 'end_time': '2025-06-02T10:10:00+02:00', 'metadata': {'phone': '098765432', 'company': 'persson AB', 'subject': 'MÃ¶te med KLRA LedningsrÃ¥dgivning', 'location': 'Online', 'last_name': 'Johansson', 'first_name': 'Per', 'ip_address': '172.226.49.45:47716', 'meeting_id': 83811214708, 'user_agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/18.5 Safari/605.1.15', 'online_link': 'https://us05web.zoom.us/j/83811214708?pwd=uDzaG32s3i87PlV0pOwojrXUzZ7aEg.1', 'meeting_length': 10, 'calendar_response_status': 'none'}, 'contact_id': '4ce9fc3f-d44f-40ca-aa9d-13e4db7f0f31', 'created_at': '2025-06-01T22:50:09.892+02:00', 'start_time': '2025-06-02T10:00:00+02:00', 'updated_at': '2025-06-01T22:50:09.892+02:00', 'meeting_type': 'zoom', 'booking_email': 'daniel.kallberg@mac.com'}, booking_id=059ec692-02af-40c7-9501-0679d86b81dd

ğŸ“ Tabell: event_log
  â€¢ record_id (uuid)
  â€¢ received_at (timestamp with time zone)
  â€¢ timestamp (timestamp with time zone)
  â€¢ booking_id (uuid)
  â€¢ id (uuid)
  â€¢ payload (jsonb)
  â€¢ table_name (text)
  â€¢ event_type (text)
  â€¢ source (text)
  â€¢ action (text)
  ğŸ”‘ [p] event_log_pkey: PRIMARY KEY (id)
  ğŸ§ª Topp 5 rader:
    - source=None, event_type=None, payload=None, received_at=2025-06-02 08:01:46.519546+02:00, id=276bd979-65e7-45ce-a637-d5b9a5a937db, table_name=contact, record_id=4ce9fc3f-d44f-40ca-aa9d-13e4db7f0f31, action=INSERT, timestamp=2025-06-02 08:01:46.519546+02:00, booking_id=None
    - source=sync, event_type=insert_contact, payload={'id': '4ce9fc3f-d44f-40ca-aa9d-13e4db7f0f31', 'email': 'daniel.kallberg@mac.com', 'metadata': {'phone': '098765432', 'company': 'persson AB', 'last_name': 'Johansson', 'first_name': 'Per'}, 'created_at': '2025-06-01T20:37:30.69989+00:00', 'updated_at': '2025-06-01T20:37:30.69989+00:00', 'booking_email': 'daniel.kallberg@mac.com'}, received_at=2025-06-02 08:01:46.519546+02:00, id=40bc4c2c-cecf-4a26-8585-85693f57ae34, table_name=None, record_id=None, action=None, timestamp=2025-06-02 08:01:46.519546+02:00, booking_id=None
    - source=None, event_type=None, payload=None, received_at=2025-06-02 08:01:46.605879+02:00, id=ce179f2c-5d73-4924-8bfd-4e6e7944a2d9, table_name=bookings, record_id=3d09c33e-52c9-4736-975b-61ee3713551c, action=INSERT, timestamp=2025-06-02 08:01:46.605879+02:00, booking_id=None
    - source=sync, event_type=insert_bookings, payload={'id': '3d09c33e-52c9-4736-975b-61ee3713551c', 'end_time': '2025-06-02T06:30:00+00:00', 'metadata': {'phone': '098765432', 'company': 'persson AB', 'subject': 'MÃ¶te med KLRA LedningsrÃ¥dgivning', 'location': 'Online', 'last_name': 'Johansson', 'first_name': 'Per', 'ip_address': '172.226.49.45:48167', 'meeting_id': 82144172118, 'user_agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/18.5 Safari/605.1.15', 'online_link': 'https://us05web.zoom.us/j/82144172118?pwd=zJm2Xe3RjuaM7e7HeDLoeacSdnbaVc.1', 'meeting_length': 10, 'calendar_response_status': 'none'}, 'contact_id': '4ce9fc3f-d44f-40ca-aa9d-13e4db7f0f31', 'created_at': '2025-06-01T20:38:17.398+00:00', 'start_time': '2025-06-02T06:20:00+00:00', 'updated_at': '2025-06-01T20:38:17.398+00:00', 'meeting_type': 'zoom', 'booking_email': 'daniel.kallberg@mac.com'}, received_at=2025-06-02 08:01:46.605879+02:00, id=c39ce22a-8d19-459a-9c2b-cf78b6050e03, table_name=None, record_id=None, action=None, timestamp=2025-06-02 08:01:46.605879+02:00, booking_id=None
    - source=None, event_type=None, payload=None, received_at=2025-06-02 08:01:46.678529+02:00, id=9ec839f6-4b26-4609-87a0-f6b9b39b9f85, table_name=bookings, record_id=059ec692-02af-40c7-9501-0679d86b81dd, action=INSERT, timestamp=2025-06-02 08:01:46.678529+02:00, booking_id=None

ğŸ“Š DIFFANALYS Azure vs Lokal
====================================
--- Azure
+++ Lokal
@@ -1,99 +1,18 @@
-ğŸ“Š MOLNDATABAS (Azure) â€“ STRUKTUR & INNEHÃ…LL

+ğŸ“Š LOKAL DATABAS â€“ STRUKTUR & INNEHÃ…LL

 ====================================

-

-ğŸ“ Tabell: slot_cache

-  â€¢ created_at (timestamp without time zone)

-  â€¢ slot_day (date)

-  â€¢ slots (jsonb)

-  â€¢ id (uuid)

-  â€¢ meeting_length (integer)

-  â€¢ booking_email (text)

-  â€¢ meeting_type (text)

-  â€¢ slot_part (text)

-  ğŸ”‘ [p] slot_cache_pkey: PRIMARY KEY (id)

-

-ğŸ“ Tabell: calendar_origin_cache

-  â€¢ created_at (timestamp without time zone)

-  â€¢ timestamp (timestamp with time zone)

-  â€¢ event_date (date)

-  â€¢ id (integer)

-  â€¢ end_time (timestamp without time zone)

-  â€¢ address (text)

-  â€¢ source (text)

-  ğŸ”‘ [c] calendar_origin_cache_source_check: CHECK ((source = ANY (ARRAY['Apple Calendar'::text, 'Microsoft 365'::text])))

-  ğŸ”‘ [p] calendar_origin_cache_pkey: PRIMARY KEY (id)

-

-ğŸ“ Tabell: available_slots_cache

-  â€¢ id (uuid)

-  â€¢ travel_time_min (integer)

-  â€¢ generated_at (timestamp without time zone)

-  â€¢ expires_at (timestamp without time zone)

-  â€¢ meeting_length (integer)

-  â€¢ slot_day (date)

-  â€¢ slot_score (integer)

-  â€¢ meeting_type (text)

-  â€¢ slot_part (text)

-  â€¢ slot_iso (text)

-  ğŸ”‘ [p] available_slots_cache_pkey: PRIMARY KEY (id)

-

-ğŸ“ Tabell: travel_time_cache

-  â€¢ travel_minutes (integer)

-  â€¢ updated_at (timestamp with time zone)

-  â€¢ is_fallback (boolean)

-  â€¢ hour (integer)

-  â€¢ created_at (timestamp with time zone)

-  â€¢ to_address (text)

-  â€¢ from_address (text)

-  ğŸ”‘ [u] unique_travel_key: UNIQUE (from_address, to_address, hour)

-  ğŸ§ª Topp 5 rader:

-    - from_address=Taxgatan 4, 115 45 Stockholm, to_address=Maria Skolgata 79A, 118 53 Stockholm, hour=7, travel_minutes=17, created_at=2025-06-01 20:37:36.958100+00:00, updated_at=2025-06-01 20:37:36.958100+00:00, is_fallback=False

-    - from_address=Taxgatan 4, 115 45 Stockholm, to_address=Maria Skolgata 79A, 118 53 Stockholm, hour=9, travel_minutes=17, created_at=2025-06-01 20:37:37.880289+00:00, updated_at=2025-06-01 20:37:37.880289+00:00, is_fallback=False

-    - from_address=Taxgatan 4, 115 45 Stockholm, to_address=Maria Skolgata 79A, 118 53 Stockholm, hour=11, travel_minutes=17, created_at=2025-06-01 20:37:37.776032+00:00, updated_at=2025-06-01 20:37:37.776032+00:00, is_fallback=False

-    - from_address=Taxgatan 4, 115 45 Stockholm, to_address=Maria Skolgata 79A, 118 53 Stockholm, hour=6, travel_minutes=17, created_at=2025-06-01 20:37:37.156222+00:00, updated_at=2025-06-01 20:37:37.156222+00:00, is_fallback=False

-    - from_address=Taxgatan 4, 115 45 Stockholm, to_address=Maria Skolgata 79A, 118 53 Stockholm, hour=8, travel_minutes=17, created_at=2025-06-01 20:37:37.648891+00:00, updated_at=2025-06-01 20:37:37.648891+00:00, is_fallback=False

-

-ğŸ“ Tabell: event_log

-  â€¢ received_at (timestamp with time zone)

-  â€¢ record_id (uuid)

-  â€¢ timestamp (timestamp with time zone)

-  â€¢ booking_id (uuid)

-  â€¢ id (uuid)

-  â€¢ payload (jsonb)

-  â€¢ action (text)

-  â€¢ event_type (text)

-  â€¢ source (text)

-  â€¢ table_name (text)

-  ğŸ”‘ [p] event_log_pkey: PRIMARY KEY (id)

-  ğŸ§ª Topp 5 rader:

-    - source=None, event_type=None, payload=None, received_at=2025-06-01 20:37:30.699890+00:00, id=2c00583c-cc66-44ed-ad81-1b404c8385ac, action=INSERT, table_name=contact, record_id=4ce9fc3f-d44f-40ca-aa9d-13e4db7f0f31, timestamp=2025-06-01 20:37:30.699890+00:00, booking_id=None

-    - source=None, event_type=calendar_response_status, payload={'response': 'none'}, received_at=2025-06-01 20:38:18.897492+00:00, id=c06ba994-c60f-4c92-8203-dc7e00070b74, action=None, table_name=None, record_id=None, timestamp=2025-06-01 20:38:18.897492+00:00, booking_id=3d09c33e-52c9-4736-975b-61ee3713551c

-    - source=None, event_type=calendar_invite_sent, payload={'subject': 'MÃ¶te med KLRA LedningsrÃ¥dgivning', 'webLink': 'https://outlook.office365.com/owa/?itemid=AAMkADIyMzUxMTE1LWQ0NDUtNDMwNC05YmE3LTRhMThmNDkyNzA2ZABGAAAAAAD8zD4S9766TIdQsQEV5sX5BwB0FUy6J9MkSLnOAsVgC0tuAAAAAAENAAB0FUy6J9MkSLnOAsVgC0tuAAAnEf1vAAA%3D&exvsurl=1&path=/calendar/item', 'location': 'Online'}, received_at=2025-06-01 20:38:18.923033+00:00, id=b47ba88d-c7d2-4382-8aa5-9dcff24a5e35, action=None, table_name=None, record_id=None, timestamp=2025-06-01 20:38:18.923033+00:00, booking_id=3d09c33e-52c9-4736-975b-61ee3713551c

-    - source=None, event_type=calendar_event_created, payload={'end': {'dateTime': '2025-06-02T06:30:00.0000000', 'timeZone': 'UTC'}, 'body': {'content': '<html>\r\n<head>\r\n<meta http-equiv="Content-Type" content="text/html; charset=utf-8">\r\n</head>\r\n<body>\r\nDetta Ã¤r en inbjudan till mÃ¶te: MÃ¶te med KLRA LedningsrÃ¥dgivning\r\n</body>\r\n</html>\r\n', 'contentType': 'html'}, 'start': {'dateTime': '2025-06-02T06:20:00.0000000', 'timeZone': 'UTC'}, 'eventId': 'AAMkADIyMzUxMTE1LWQ0NDUtNDMwNC05YmE3LTRhMThmNDkyNzA2ZABGAAAAAAD8zD4S9766TIdQsQEV5sX5BwB0FUy6J9MkSLnOAsVgC0tuAAAAAAENAAB0FUy6J9MkSLnOAsVgC0tuAAAnEf1vAAA=', 'subject': 'MÃ¶te med KLRA LedningsrÃ¥dgivning', 'webLink': 'https://outlook.office365.com/owa/?itemid=AAMkADIyMzUxMTE1LWQ0NDUtNDMwNC05YmE3LTRhMThmNDkyNzA2ZABGAAAAAAD8zD4S9766TIdQsQEV5sX5BwB0FUy6J9MkSLnOAsVgC0tuAAAAAAENAAB0FUy6J9MkSLnOAsVgC0tuAAAnEf1vAAA%3D&exvsurl=1&path=/calendar/item', 'location': 'Online', 'attendees': [{'type': 'required', 'status': {'time': '0001-01-01T00:00:00Z', 'response': 'none'}, 'emailAddress': {'name': 'daniel.kallberg@mac.com', 'address': 'daniel.kallberg@mac.com'}}], 'onlineMeetingUrl': None}, received_at=2025-06-01 20:38:18.949898+00:00, id=a8781988-c135-4f0b-9eb0-16b2a88c9f9c, action=None, table_name=None, record_id=None, timestamp=2025-06-01 20:38:18.949898+00:00, booking_id=3d09c33e-52c9-4736-975b-61ee3713551c

-    - source=None, event_type=calendar_invite_sent, payload={'subject': 'MÃ¶te med KLRA LedningsrÃ¥dgivning', 'webLink': 'https://us05web.zoom.us/j/82144172118?pwd=zJm2Xe3RjuaM7e7HeDLoeacSdnbaVc.1', 'location': 'Online'}, received_at=2025-06-01 20:38:18.975463+00:00, id=835d1bab-4d1a-4fe5-8da0-4597f7131fde, action=None, table_name=None, record_id=None, timestamp=2025-06-01 20:38:18.975463+00:00, booking_id=3d09c33e-52c9-4736-975b-61ee3713551c

 

 ğŸ“ Tabell: booking_settings

   â€¢ value (jsonb)

   â€¢ updated_at (timestamp with time zone)

   â€¢ key (text)

   â€¢ value_type (text)

-  ğŸ”‘ [u] unique_key: UNIQUE (key)

+  ğŸ”‘ [p] booking_settings_pkey: PRIMARY KEY (key)

   ğŸ§ª Topp 5 rader:

-    - key=email_subject_templates, value={'zoom': 'ZoommÃ¶te: {{first_name}} | {{company}} & Daniel | Kinnekulle LedningsrÃ¥dgivning AB', 'teams': 'TeamsmÃ¶te: {{first_name}} | {{company}} & Daniel | Kinnekulle LedningsrÃ¥dgivning AB', 'atclient': 'MÃ¶te hos {{company}}: {{first_name}} | {{company}} & Daniel | Kinnekulle LedningsrÃ¥dgivning AB', 'atoffice': 'MÃ¶te hos KLR AB (Stockholm | SÃ¶dermalm): {{first_name}} | {{company}} & Daniel | Kinnekulle LedningsrÃ¥dgivning AB', 'facetime': 'FaceTime-mÃ¶te: {{first_name}} | {{company}} & Daniel | Kinnekulle LedningsrÃ¥dgivning AB'}, value_type=json, updated_at=2025-05-30 20:46:14.058171+00:00

-    - key=default_language, value=sv, value_type=string, updated_at=2025-05-25 10:37:53.619684+00:00

-    - key=default_meeting_length_atclient, value=[90, 180, 270, 360], value_type=array, updated_at=2025-04-23 12:48:49.778155+00:00

-    - key=default_meeting_length_atoffice, value=[60, 90], value_type=array, updated_at=2025-04-23 12:48:49.778155+00:00

-    - key=default_meeting_length_digital, value=[10, 20, 60], value_type=array, updated_at=2025-04-23 12:48:49.778155+00:00

-

-ğŸ“ Tabell: translation

-  â€¢ key (character varying)

-  â€¢ sv (text)

-  â€¢ en (text)

-  ğŸ§ª Topp 5 rader:

-    - key=error_invalid_phone, sv=Ogiltigt telefonnummer. Vi vet att det Ã¤r svÃ¥rt att komma ihÃ¥g sitt nummer., en=Invalid phone number. We know remembering your own number is hard.

-    - key=error_invalid_name, sv=Namnet Ã¤r ogiltigt (minst 2 tecken, max 50). Smeknamn som "X" Ã¤r fÃ¶r Elon., en=Invalid name (min 2 characters, max 50). Nicknames like "X" are taken.

-    - key=error_missing_fields, sv=Alla fÃ¤lt mÃ¥ste vara ifyllda. Vi Ã¤r petiga sÃ¥ du slipper bli det senare., en=All fields must be filled. Weâ€™re picky so you donâ€™t have to be later.

-    - key=error_missing_meeting_link, sv=MÃ¶teslÃ¤nk krÃ¤vs. Om inte mÃ¶tet sker via brevduva., en=A meeting link is required. Unless the meeting is via carrier pigeon.

-    - key=error_missing_recaptcha, sv=reCAPTCHA mÃ¥ste verifieras. Nej, det Ã¤r inte en kÃ¤nslomÃ¤ssig frÃ¥ga., en=reCAPTCHA verification required. And no, itâ€™s not a personality test.

+    - key=email_subject_templates, value={'zoom': 'ZoommÃ¶te: {{first_name}} | {{company}} & Daniel | Kinnekulle LedningsrÃ¥dgivning AB', 'teams': 'TeamsmÃ¶te: {{first_name}} | {{company}} & Daniel | Kinnekulle LedningsrÃ¥dgivning AB', 'atclient': 'MÃ¶te hos {{company}}: {{first_name}} | {{company}} & Daniel | Kinnekulle LedningsrÃ¥dgivning AB', 'atoffice': 'MÃ¶te hos KLR AB (Stockholm | SÃ¶dermalm): {{first_name}} | {{company}} & Daniel | Kinnekulle LedningsrÃ¥dgivning AB', 'facetime': 'FaceTime-mÃ¶te: {{first_name}} | {{company}} & Daniel | Kinnekulle LedningsrÃ¥dgivning AB'}, value_type=json, updated_at=2025-05-30 22:46:14.058171+02:00

+    - key=default_language, value=sv, value_type=string, updated_at=2025-05-25 12:37:53.619684+02:00

+    - key=default_meeting_length_atclient, value=[90, 180, 270, 360], value_type=array, updated_at=2025-04-23 14:48:49.778155+02:00

+    - key=default_meeting_length_atoffice, value=[60, 90], value_type=array, updated_at=2025-04-23 14:48:49.778155+02:00

+    - key=default_meeting_length_digital, value=[10, 20, 60], value_type=array, updated_at=2025-04-23 14:48:49.778155+02:00

 

 ğŸ“ Tabell: bookings

   â€¢ start_time (timestamp with time zone)

@@ -108,11 +27,58 @@
   ğŸ”‘ [p] bookings_pkey: PRIMARY KEY (id)

   ğŸ”‘ [f] fk_bookings_contact: FOREIGN KEY (contact_id) REFERENCES contact(id) ON DELETE SET NULL

   ğŸ§ª Topp 5 rader:

-    - start_time=2025-06-02 06:20:00+00:00, end_time=2025-06-02 06:30:00+00:00, meeting_type=zoom, metadata={'phone': '098765432', 'company': 'persson AB', 'subject': 'MÃ¶te med KLRA LedningsrÃ¥dgivning', 'location': 'Online', 'last_name': 'Johansson', 'first_name': 'Per', 'ip_address': '172.226.49.45:48167', 'meeting_id': 82144172118, 'user_agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/18.5 Safari/605.1.15', 'online_link': 'https://us05web.zoom.us/j/82144172118?pwd=zJm2Xe3RjuaM7e7HeDLoeacSdnbaVc.1', 'meeting_length': 10, 'calendar_response_status': 'none'}, created_at=2025-06-01 20:38:17.398000+00:00, contact_id=4ce9fc3f-d44f-40ca-aa9d-13e4db7f0f31, id=3d09c33e-52c9-4736-975b-61ee3713551c, updated_at=2025-06-01 20:38:17.398000+00:00, booking_email=daniel.kallberg@mac.com

-    - start_time=2025-06-02 08:00:00+00:00, end_time=2025-06-02 08:10:00+00:00, meeting_type=zoom, metadata={'phone': '098765432', 'company': 'persson AB', 'subject': 'MÃ¶te med KLRA LedningsrÃ¥dgivning', 'location': 'Online', 'last_name': 'Johansson', 'first_name': 'Per', 'ip_address': '172.226.49.45:47716', 'meeting_id': 83811214708, 'user_agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/18.5 Safari/605.1.15', 'online_link': 'https://us05web.zoom.us/j/83811214708?pwd=uDzaG32s3i87PlV0pOwojrXUzZ7aEg.1', 'meeting_length': 10, 'calendar_response_status': 'none'}, created_at=2025-06-01 20:50:09.892000+00:00, contact_id=4ce9fc3f-d44f-40ca-aa9d-13e4db7f0f31, id=059ec692-02af-40c7-9501-0679d86b81dd, updated_at=2025-06-01 20:50:09.892000+00:00, booking_email=daniel.kallberg@mac.com

-    - start_time=2025-06-02 08:40:00+00:00, end_time=2025-06-02 09:00:00+00:00, meeting_type=zoom, metadata={'phone': '098765432', 'company': 'persson AB', 'subject': 'MÃ¶te med KLRA LedningsrÃ¥dgivning', 'location': 'Online', 'last_name': 'Johansson', 'first_name': 'Per', 'ip_address': '172.226.49.45:47708', 'meeting_id': 86400396910, 'user_agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/18.5 Safari/605.1.15', 'online_link': 'https://us05web.zoom.us/j/86400396910?pwd=z8fdhAA8ibZ5hxJEpmebYHaX57JugC.1', 'meeting_length': 20, 'calendar_response_status': 'none'}, created_at=2025-06-01 20:56:02.371000+00:00, contact_id=4ce9fc3f-d44f-40ca-aa9d-13e4db7f0f31, id=967fa70d-2409-4884-8d5b-f2c036eb1a99, updated_at=2025-06-01 20:56:02.371000+00:00, booking_email=daniel.kallberg@mac.com

-    - start_time=2025-06-02 09:20:00+00:00, end_time=2025-06-02 09:30:00+00:00, meeting_type=zoom, metadata={'phone': '098765432', 'company': 'persson AB', 'subject': 'ZoommÃ¶te: Per | persson AB & Daniel | Kinnekulle LedningsrÃ¥dgivning AB', 'location': 'Online', 'last_name': 'Johansson', 'first_name': 'Per', 'ip_address': '172.226.49.45:46831', 'meeting_id': 81612591010, 'user_agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/18.5 Safari/605.1.15', 'online_link': 'https://us05web.zoom.us/j/81612591010?pwd=3Pu0VQxyWyR0pPab7OlpAfKb7CpiWq.1', 'meeting_length': 10, 'calendar_response_status': 'none'}, created_at=2025-06-01 21:01:27.794000+00:00, contact_id=4ce9fc3f-d44f-40ca-aa9d-13e4db7f0f31, id=1a231d98-2e66-41ae-a718-6048aa624601, updated_at=2025-06-01 21:01:27.794000+00:00, booking_email=daniel.kallberg@mac.com

-    - start_time=2025-06-02 11:20:00+00:00, end_time=2025-06-02 11:30:00+00:00, meeting_type=facetime, metadata={'phone': '070-2656868', 'company': 'Anna AB', 'subject': 'FaceTime-mÃ¶te: Anna | Anna AB & Daniel | Kinnekulle LedningsrÃ¥dgivning AB', 'location': 'FaceTime', 'last_name': 'Sahlin', 'first_name': 'Anna', 'ip_address': '81.233.161.165:58650', 'user_agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/18.5 Safari/605.1.15', 'online_link': 'facetime:070-2656868', 'body_preview': '<html>\r\n<head>\r\n<meta http-equiv="Content-Type" content="text/html; charset=utf-8">\r\n</head>\r\n<body>\r\nDetta Ã¤r en inbjudan till mÃ¶te: FaceTime-mÃ¶te: Anna | Anna AB &amp; Daniel | Kinnekulle LedningsrÃ¥dgivning AB\r\n</body>\r\n</html>\r\n', 'meeting_length': 10, 'calendar_response_status': 'none'}, created_at=2025-06-01 21:14:06.367000+00:00, contact_id=6dedbbd8-661f-4f87-9b54-e302bdd6f61a, id=affd507f-ee62-4ad0-b723-609100422f3b, updated_at=2025-06-01 21:14:06.367000+00:00, booking_email=annapanna79@yahoo.com

+    - start_time=2025-06-02 08:20:00+02:00, end_time=2025-06-02 08:30:00+02:00, meeting_type=zoom, metadata={'phone': '098765432', 'company': 'persson AB', 'subject': 'MÃ¶te med KLRA LedningsrÃ¥dgivning', 'location': 'Online', 'last_name': 'Johansson', 'first_name': 'Per', 'ip_address': '172.226.49.45:48167', 'meeting_id': 82144172118, 'user_agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/18.5 Safari/605.1.15', 'online_link': 'https://us05web.zoom.us/j/82144172118?pwd=zJm2Xe3RjuaM7e7HeDLoeacSdnbaVc.1', 'meeting_length': 10, 'calendar_response_status': 'none'}, created_at=2025-06-01 22:38:17.398000+02:00, contact_id=4ce9fc3f-d44f-40ca-aa9d-13e4db7f0f31, id=3d09c33e-52c9-4736-975b-61ee3713551c, updated_at=2025-06-01 22:38:17.398000+02:00, booking_email=daniel.kallberg@mac.com

+    - start_time=2025-06-02 10:00:00+02:00, end_time=2025-06-02 10:10:00+02:00, meeting_type=zoom, metadata={'phone': '098765432', 'company': 'persson AB', 'subject': 'MÃ¶te med KLRA LedningsrÃ¥dgivning', 'location': 'Online', 'last_name': 'Johansson', 'first_name': 'Per', 'ip_address': '172.226.49.45:47716', 'meeting_id': 83811214708, 'user_agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/18.5 Safari/605.1.15', 'online_link': 'https://us05web.zoom.us/j/83811214708?pwd=uDzaG32s3i87PlV0pOwojrXUzZ7aEg.1', 'meeting_length': 10, 'calendar_response_status': 'none'}, created_at=2025-06-01 22:50:09.892000+02:00, contact_id=4ce9fc3f-d44f-40ca-aa9d-13e4db7f0f31, id=059ec692-02af-40c7-9501-0679d86b81dd, updated_at=2025-06-01 22:50:09.892000+02:00, booking_email=daniel.kallberg@mac.com

+    - start_time=2025-06-02 10:40:00+02:00, end_time=2025-06-02 11:00:00+02:00, meeting_type=zoom, metadata={'phone': '098765432', 'company': 'persson AB', 'subject': 'MÃ¶te med KLRA LedningsrÃ¥dgivning', 'location': 'Online', 'last_name': 'Johansson', 'first_name': 'Per', 'ip_address': '172.226.49.45:47708', 'meeting_id': 86400396910, 'user_agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/18.5 Safari/605.1.15', 'online_link': 'https://us05web.zoom.us/j/86400396910?pwd=z8fdhAA8ibZ5hxJEpmebYHaX57JugC.1', 'meeting_length': 20, 'calendar_response_status': 'none'}, created_at=2025-06-01 22:56:02.371000+02:00, contact_id=4ce9fc3f-d44f-40ca-aa9d-13e4db7f0f31, id=967fa70d-2409-4884-8d5b-f2c036eb1a99, updated_at=2025-06-01 22:56:02.371000+02:00, booking_email=daniel.kallberg@mac.com

+    - start_time=2025-06-02 11:20:00+02:00, end_time=2025-06-02 11:30:00+02:00, meeting_type=zoom, metadata={'phone': '098765432', 'company': 'persson AB', 'subject': 'ZoommÃ¶te: Per | persson AB & Daniel | Kinnekulle LedningsrÃ¥dgivning AB', 'location': 'Online', 'last_name': 'Johansson', 'first_name': 'Per', 'ip_address': '172.226.49.45:46831', 'meeting_id': 81612591010, 'user_agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/18.5 Safari/605.1.15', 'online_link': 'https://us05web.zoom.us/j/81612591010?pwd=3Pu0VQxyWyR0pPab7OlpAfKb7CpiWq.1', 'meeting_length': 10, 'calendar_response_status': 'none'}, created_at=2025-06-01 23:01:27.794000+02:00, contact_id=4ce9fc3f-d44f-40ca-aa9d-13e4db7f0f31, id=1a231d98-2e66-41ae-a718-6048aa624601, updated_at=2025-06-01 23:01:27.794000+02:00, booking_email=daniel.kallberg@mac.com

+    - start_time=2025-06-02 13:20:00+02:00, end_time=2025-06-02 13:30:00+02:00, meeting_type=facetime, metadata={'phone': '070-2656868', 'company': 'Anna AB', 'subject': 'FaceTime-mÃ¶te: Anna | Anna AB & Daniel | Kinnekulle LedningsrÃ¥dgivning AB', 'location': 'FaceTime', 'last_name': 'Sahlin', 'first_name': 'Anna', 'ip_address': '81.233.161.165:58650', 'user_agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/18.5 Safari/605.1.15', 'online_link': 'facetime:070-2656868', 'body_preview': '<html>\r\n<head>\r\n<meta http-equiv="Content-Type" content="text/html; charset=utf-8">\r\n</head>\r\n<body>\r\nDetta Ã¤r en inbjudan till mÃ¶te: FaceTime-mÃ¶te: Anna | Anna AB &amp; Daniel | Kinnekulle LedningsrÃ¥dgivning AB\r\n</body>\r\n</html>\r\n', 'meeting_length': 10, 'calendar_response_status': 'none'}, created_at=2025-06-01 23:14:06.367000+02:00, contact_id=6dedbbd8-661f-4f87-9b54-e302bdd6f61a, id=affd507f-ee62-4ad0-b723-609100422f3b, updated_at=2025-06-01 23:14:06.367000+02:00, booking_email=annapanna79@yahoo.com

+

+ğŸ“ Tabell: contact

+  â€¢ metadata (jsonb)

+  â€¢ created_at (timestamp with time zone)

+  â€¢ id (uuid)

+  â€¢ updated_at (timestamp with time zone)

+  â€¢ booking_email (text)

+  â€¢ email (text)

+  ğŸ”‘ [p] contact_pkey: PRIMARY KEY (id)

+  ğŸ§ª Topp 5 rader:

+    - metadata={'phone': '098765432', 'origin': 'klrab.se', 'company': 'Persson AB', 'last_name': 'Johansson', 'first_name': 'Per', 'force_resync': True}, created_at=2025-06-01 22:37:30.699890+02:00, id=4ce9fc3f-d44f-40ca-aa9d-13e4db7f0f31, booking_email=daniel.kallberg@mac.com, updated_at=2025-06-02 17:10:00.571594+02:00, email=daniel.kallberg@mac.com

+    - metadata={'phone': '070-2656868', 'origin': 'klrab.se', 'company': 'Anna AB', 'last_name': 'Sahlin', 'first_name': 'Anna-Panna', 'force_resync': True}, created_at=2025-06-01 23:13:46.657884+02:00, id=6dedbbd8-661f-4f87-9b54-e302bdd6f61a, booking_email=annapanna79@yahoo.com, updated_at=2025-06-02 17:10:00.575093+02:00, email=annapanna79@yahoo.com

+

+ğŸ“ Tabell: company

+  â€¢ metadata (jsonb)

+  â€¢ created_at (timestamp with time zone)

+  â€¢ id (uuid)

+  â€¢ name (text)

+  â€¢ org_number (text)

+  ğŸ”‘ [p] company_pkey: PRIMARY KEY (id)

+

+ğŸ“ Tabell: translation

+  â€¢ key (character varying)

+  â€¢ sv (text)

+  â€¢ en (text)

+  ğŸ”‘ [u] unique_translation_key: UNIQUE (key)

+  ğŸ”‘ [p] translation_pkey: PRIMARY KEY (key)

+  ğŸ§ª Topp 5 rader:

+    - key=error_min_duration_fysiskt_kund, sv=MÃ¶testiden fÃ¶r 'Fysiskt hos kund' mÃ¥ste vara minst {{minutes}} minuter. Du visste det redan., en=The meeting time for 'On-site at customer' must be at least {{minutes}} minutes. You knew that.

+    - key=error_min_duration_fysiskt_mig, sv=MÃ¶testiden fÃ¶r 'Fysiskt hos mig' mÃ¥ste vara minst {{minutes}} minuter. Annars hinner vi bara sÃ¤ga hej., en=The meeting time for 'At my office' must be at least {{minutes}} minutes. Otherwise, weâ€™ll only have time to say hello.

+    - key=email_body_booking_received, sv=Hej {{name}}! Vi har tagit emot din bokning fÃ¶r {{meeting_type}} mellan {{start_time}} och {{end_time}}. Ingen panik â€“ vi Ã¥terkommer med bekrÃ¤ftelse. / Daniel, en=Hello {{name}}, Weâ€™ve received your booking for {{meeting_type}} between {{start_time}} and {{end_time}}. No need to panic â€“ weâ€™ll confirm shortly. / Daniel

+    - key=email_body_booking_confirmed, sv=Hej {{name}}! Din bokning fÃ¶r {{meeting_type}} mellan {{start_time}} och {{end_time}} Ã¤r nu spikad. Ser fram emot det! / Daniel, en=Hello {{name}}, Your booking for {{meeting_type}} between {{start_time}} and {{end_time}} is now locked in. Looking forward! / Daniel

+    - key=email_body_booking_cancelled, sv=Hej {{name}}! Din bokning fÃ¶r {{meeting_type}} mellan {{start_time}} och {{end_time}} Ã¤r avbokad. HÃ¶r av dig om du vill hitta en ny tid. / Daniel, en=Hello {{name}}, Your booking for {{meeting_type}} between {{start_time}} and {{end_time}} has been cancelled. Let me know if you'd like a new one. / Daniel

+

+ğŸ“ Tabell: ccrelation

+  â€¢ id (uuid)

+  â€¢ company_id (uuid)

+  â€¢ contact_id (uuid)

+  â€¢ main_contact (boolean)

+  â€¢ start_date (date)

+  â€¢ end_date (date)

+  â€¢ metadata (jsonb)

+  â€¢ created_at (timestamp with time zone)

+  â€¢ role (text)

+  ğŸ”‘ [p] ccrelation_pkey: PRIMARY KEY (id)

+  ğŸ”‘ [f] fk_ccrelation_contact_id: FOREIGN KEY (contact_id) REFERENCES contact(id) ON DELETE CASCADE

+  ğŸ”‘ [f] fk_ccrelation_company_id: FOREIGN KEY (company_id) REFERENCES company(id) ON DELETE CASCADE

 

 ğŸ“ Tabell: pending_changes

   â€¢ booking_id (uuid)

@@ -128,21 +94,28 @@
   ğŸ”‘ [p] pending_changes_pkey: PRIMARY KEY (id)

   ğŸ”‘ [f] fk_pending_changes_booking_id: FOREIGN KEY (booking_id) REFERENCES bookings(id) ON DELETE CASCADE

   ğŸ§ª Topp 5 rader:

-    - id=fff97701-6232-4ac2-ba9f-b1c02769b414, table_name=bookings, record_id=3d09c33e-52c9-4736-975b-61ee3713551c, change_type=INSERT, direction=cloud_to_local, processed=False, created_at=2025-06-01 20:38:19.055000+00:00, operation=None, payload=None, booking_id=3d09c33e-52c9-4736-975b-61ee3713551c

-    - id=93cd0ba6-50f9-4c4b-80f4-5822c0f14912, table_name=bookings, record_id=059ec692-02af-40c7-9501-0679d86b81dd, change_type=INSERT, direction=cloud_to_local, processed=False, created_at=2025-06-01 20:50:11.295000+00:00, operation=None, payload=None, booking_id=059ec692-02af-40c7-9501-0679d86b81dd

-    - id=c13128f8-3198-4d29-9b4b-673ff2dabe41, table_name=bookings, record_id=967fa70d-2409-4884-8d5b-f2c036eb1a99, change_type=INSERT, direction=cloud_to_local, processed=False, created_at=2025-06-01 20:56:03.629000+00:00, operation=None, payload=None, booking_id=967fa70d-2409-4884-8d5b-f2c036eb1a99

-    - id=fbd2921d-a75d-49b3-b1af-a62fc5cb4652, table_name=bookings, record_id=1a231d98-2e66-41ae-a718-6048aa624601, change_type=INSERT, direction=cloud_to_local, processed=False, created_at=2025-06-01 21:01:29.511000+00:00, operation=None, payload=None, booking_id=1a231d98-2e66-41ae-a718-6048aa624601

-    - id=9c53a7e8-4147-482e-93e7-0e5c9a4002a1, table_name=bookings, record_id=affd507f-ee62-4ad0-b723-609100422f3b, change_type=INSERT, direction=cloud_to_local, processed=False, created_at=2025-06-01 21:14:07.151000+00:00, operation=None, payload=None, booking_id=affd507f-ee62-4ad0-b723-609100422f3b

+    - id=aece4862-6155-4819-aaa3-a21f5ed522f5, table_name=bookings, record_id=967fa70d-2409-4884-8d5b-f2c036eb1a99, change_type=INSERT, direction=out, processed=True, created_at=2025-06-02 08:01:46.750394+02:00, operation=INSERT, payload={'id': '967fa70d-2409-4884-8d5b-f2c036eb1a99', 'end_time': '2025-06-02T11:00:00+02:00', 'metadata': {'phone': '098765432', 'company': 'persson AB', 'subject': 'MÃ¶te med KLRA LedningsrÃ¥dgivning', 'location': 'Online', 'last_name': 'Johansson', 'first_name': 'Per', 'ip_address': '172.226.49.45:47708', 'meeting_id': 86400396910, 'user_agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/18.5 Safari/605.1.15', 'online_link': 'https://us05web.zoom.us/j/86400396910?pwd=z8fdhAA8ibZ5hxJEpmebYHaX57JugC.1', 'meeting_length': 20, 'calendar_response_status': 'none'}, 'contact_id': '4ce9fc3f-d44f-40ca-aa9d-13e4db7f0f31', 'created_at': '2025-06-01T22:56:02.371+02:00', 'start_time': '2025-06-02T10:40:00+02:00', 'updated_at': '2025-06-01T22:56:02.371+02:00', 'meeting_type': 'zoom', 'booking_email': 'daniel.kallberg@mac.com'}, booking_id=967fa70d-2409-4884-8d5b-f2c036eb1a99

+    - id=eadc9857-e839-4eee-be8a-d5ee6ece7ee7, table_name=bookings, record_id=1a231d98-2e66-41ae-a718-6048aa624601, change_type=INSERT, direction=out, processed=True, created_at=2025-06-02 08:01:46.822683+02:00, operation=INSERT, payload={'id': '1a231d98-2e66-41ae-a718-6048aa624601', 'end_time': '2025-06-02T11:30:00+02:00', 'metadata': {'phone': '098765432', 'company': 'persson AB', 'subject': 'ZoommÃ¶te: Per | persson AB & Daniel | Kinnekulle LedningsrÃ¥dgivning AB', 'location': 'Online', 'last_name': 'Johansson', 'first_name': 'Per', 'ip_address': '172.226.49.45:46831', 'meeting_id': 81612591010, 'user_agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/18.5 Safari/605.1.15', 'online_link': 'https://us05web.zoom.us/j/81612591010?pwd=3Pu0VQxyWyR0pPab7OlpAfKb7CpiWq.1', 'meeting_length': 10, 'calendar_response_status': 'none'}, 'contact_id': '4ce9fc3f-d44f-40ca-aa9d-13e4db7f0f31', 'created_at': '2025-06-01T23:01:27.794+02:00', 'start_time': '2025-06-02T11:20:00+02:00', 'updated_at': '2025-06-01T23:01:27.794+02:00', 'meeting_type': 'zoom', 'booking_email': 'daniel.kallberg@mac.com'}, booking_id=1a231d98-2e66-41ae-a718-6048aa624601

+    - id=c4157273-3c00-4697-adfc-31cb615962c4, table_name=contact, record_id=4ce9fc3f-d44f-40ca-aa9d-13e4db7f0f31, change_type=INSERT, direction=out, processed=True, created_at=2025-06-02 08:01:46.519546+02:00, operation=INSERT, payload={'id': '4ce9fc3f-d44f-40ca-aa9d-13e4db7f0f31', 'email': 'daniel.kallberg@mac.com', 'metadata': {'phone': '098765432', 'company': 'persson AB', 'last_name': 'Johansson', 'first_name': 'Per'}, 'created_at': '2025-06-01T22:37:30.69989+02:00', 'updated_at': '2025-06-01T22:37:30.69989+02:00', 'booking_email': 'daniel.kallberg@mac.com'}, booking_id=None

+    - id=87f2374b-c890-48b4-bafe-8a05db36079f, table_name=bookings, record_id=3d09c33e-52c9-4736-975b-61ee3713551c, change_type=INSERT, direction=out, processed=True, created_at=2025-06-02 08:01:46.605879+02:00, operation=INSERT, payload={'id': '3d09c33e-52c9-4736-975b-61ee3713551c', 'end_time': '2025-06-02T08:30:00+02:00', 'metadata': {'phone': '098765432', 'company': 'persson AB', 'subject': 'MÃ¶te med KLRA LedningsrÃ¥dgivning', 'location': 'Online', 'last_name': 'Johansson', 'first_name': 'Per', 'ip_address': '172.226.49.45:48167', 'meeting_id': 82144172118, 'user_agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/18.5 Safari/605.1.15', 'online_link': 'https://us05web.zoom.us/j/82144172118?pwd=zJm2Xe3RjuaM7e7HeDLoeacSdnbaVc.1', 'meeting_length': 10, 'calendar_response_status': 'none'}, 'contact_id': '4ce9fc3f-d44f-40ca-aa9d-13e4db7f0f31', 'created_at': '2025-06-01T22:38:17.398+02:00', 'start_time': '2025-06-02T08:20:00+02:00', 'updated_at': '2025-06-01T22:38:17.398+02:00', 'meeting_type': 'zoom', 'booking_email': 'daniel.kallberg@mac.com'}, booking_id=3d09c33e-52c9-4736-975b-61ee3713551c

+    - id=fbb2164e-4690-4e16-8bd7-225294d9a75a, table_name=bookings, record_id=059ec692-02af-40c7-9501-0679d86b81dd, change_type=INSERT, direction=out, processed=True, created_at=2025-06-02 08:01:46.678529+02:00, operation=INSERT, payload={'id': '059ec692-02af-40c7-9501-0679d86b81dd', 'end_time': '2025-06-02T10:10:00+02:00', 'metadata': {'phone': '098765432', 'company': 'persson AB', 'subject': 'MÃ¶te med KLRA LedningsrÃ¥dgivning', 'location': 'Online', 'last_name': 'Johansson', 'first_name': 'Per', 'ip_address': '172.226.49.45:47716', 'meeting_id': 83811214708, 'user_agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/18.5 Safari/605.1.15', 'online_link': 'https://us05web.zoom.us/j/83811214708?pwd=uDzaG32s3i87PlV0pOwojrXUzZ7aEg.1', 'meeting_length': 10, 'calendar_response_status': 'none'}, 'contact_id': '4ce9fc3f-d44f-40ca-aa9d-13e4db7f0f31', 'created_at': '2025-06-01T22:50:09.892+02:00', 'start_time': '2025-06-02T10:00:00+02:00', 'updated_at': '2025-06-01T22:50:09.892+02:00', 'meeting_type': 'zoom', 'booking_email': 'daniel.kallberg@mac.com'}, booking_id=059ec692-02af-40c7-9501-0679d86b81dd

 

-ğŸ“ Tabell: contact

-  â€¢ metadata (jsonb)

-  â€¢ created_at (timestamp with time zone)

+ğŸ“ Tabell: event_log

+  â€¢ record_id (uuid)

+  â€¢ received_at (timestamp with time zone)

+  â€¢ timestamp (timestamp with time zone)

+  â€¢ booking_id (uuid)

   â€¢ id (uuid)

-  â€¢ updated_at (timestamp with time zone)

-  â€¢ booking_email (text)

-  â€¢ email (text)

-  ğŸ”‘ [p] contact_pkey: PRIMARY KEY (id)

+  â€¢ payload (jsonb)

+  â€¢ table_name (text)

+  â€¢ event_type (text)

+  â€¢ source (text)

+  â€¢ action (text)

+  ğŸ”‘ [p] event_log_pkey: PRIMARY KEY (id)

   ğŸ§ª Topp 5 rader:

-    - metadata={'phone': '098765432', 'origin': 'klrab.se', 'company': 'persson AB', 'last_name': 'Johansson', 'first_name': 'Per'}, created_at=2025-06-01 20:37:30.699890+00:00, id=4ce9fc3f-d44f-40ca-aa9d-13e4db7f0f31, booking_email=daniel.kallberg@mac.com, updated_at=2025-06-02 06:13:47.337045+00:00, email=daniel.kallberg@mac.com

-    - metadata={'phone': '070-2656868', 'origin': 'klrab.se', 'company': 'Anna AB', 'last_name': 'Sahlin', 'first_name': 'Anna'}, created_at=2025-06-01 21:13:46.657884+00:00, id=6dedbbd8-661f-4f87-9b54-e302bdd6f61a, booking_email=annapanna79@yahoo.com, updated_at=2025-06-02 06:13:47.337045+00:00, email=annapanna79@yahoo.com

+    - source=None, event_type=None, payload=None, received_at=2025-06-02 08:01:46.519546+02:00, id=276bd979-65e7-45ce-a637-d5b9a5a937db, table_name=contact, record_id=4ce9fc3f-d44f-40ca-aa9d-13e4db7f0f31, action=INSERT, timestamp=2025-06-02 08:01:46.519546+02:00, booking_id=None

+    - source=sync, event_type=insert_contact, payload={'id': '4ce9fc3f-d44f-40ca-aa9d-13e4db7f0f31', 'email': 'daniel.kallberg@mac.com', 'metadata': {'phone': '098765432', 'company': 'persson AB', 'last_name': 'Johansson', 'first_name': 'Per'}, 'created_at': '2025-06-01T20:37:30.69989+00:00', 'updated_at': '2025-06-01T20:37:30.69989+00:00', 'booking_email': 'daniel.kallberg@mac.com'}, received_at=2025-06-02 08:01:46.519546+02:00, id=40bc4c2c-cecf-4a26-8585-85693f57ae34, table_name=None, record_id=None, action=None, timestamp=2025-06-02 08:01:46.519546+02:00, booking_id=None

+    - source=None, event_type=None, payload=None, received_at=2025-06-02 08:01:46.605879+02:00, id=ce179f2c-5d73-4924-8bfd-4e6e7944a2d9, table_name=bookings, record_id=3d09c33e-52c9-4736-975b-61ee3713551c, action=INSERT, timestamp=2025-06-02 08:01:46.605879+02:00, booking_id=None

+    - source=sync, event_type=insert_bookings, payload={'id': '3d09c33e-52c9-4736-975b-61ee3713551c', 'end_time': '2025-06-02T06:30:00+00:00', 'metadata': {'phone': '098765432', 'company': 'persson AB', 'subject': 'MÃ¶te med KLRA LedningsrÃ¥dgivning', 'location': 'Online', 'last_name': 'Johansson', 'first_name': 'Per', 'ip_address': '172.226.49.45:48167', 'meeting_id': 82144172118, 'user_agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/18.5 Safari/605.1.15', 'online_link': 'https://us05web.zoom.us/j/82144172118?pwd=zJm2Xe3RjuaM7e7HeDLoeacSdnbaVc.1', 'meeting_length': 10, 'calendar_response_status': 'none'}, 'contact_id': '4ce9fc3f-d44f-40ca-aa9d-13e4db7f0f31', 'created_at': '2025-06-01T20:38:17.398+00:00', 'start_time': '2025-06-02T06:20:00+00:00', 'updated_at': '2025-06-01T20:38:17.398+00:00', 'meeting_type': 'zoom', 'booking_email': 'daniel.kallberg@mac.com'}, received_at=2025-06-02 08:01:46.605879+02:00, id=c39ce22a-8d19-459a-9c2b-cf78b6050e03, table_name=None, record_id=None, action=None, timestamp=2025-06-02 08:01:46.605879+02:00, booking_id=None

+    - source=None, event_type=None, payload=None, received_at=2025-06-02 08:01:46.678529+02:00, id=9ec839f6-4b26-4609-87a0-f6b9b39b9f85, table_name=bookings, record_id=059ec692-02af-40c7-9501-0679d86b81dd, action=INSERT, timestamp=2025-06-02 08:01:46.678529+02:00, booking_id=None

 


ğŸŒ HTML-diff finns Ã¤ven hÃ¤r:
file:///Users/danielkallberg/Documents/KLR_AI/Projekt_MacSpot/macspot-api/AllSyncCodes_history/ğŸ§®_diff_output.html
