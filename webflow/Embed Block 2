<script>
  async function validateContact() {
    const emailEl = document.querySelector('#booking_email');
    const email = emailEl ? emailEl.value.trim() : '';
    const meetingInput = document.querySelector('input[name="meeting_type"]:checked');
    const meetingType = meetingInput ? meetingInput.value : '';
    console.log("ðŸ“Œ Vald mÃ¶testyp:", meetingType);

    if (!email || !email.includes('@')) {
      return;
    }
    if (!meetingType) {
      return;
    }

    const response = await fetch('https://macspotbackend.azurewebsites.net/api/validate_contact', {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email, meeting_type: meetingType })
    });

    const result = await response.json();
    console.log("âœ… API-svar:", result);
    console.log("ðŸ§  Backend-svar (debug):", JSON.stringify(result, null, 2));

    const submitButton = document.querySelector('#contact-update-button');
    const addressWrapper = document.querySelector('#autofilled-fields-at-client');
    if (addressWrapper) {
      addressWrapper.classList.add('atClientField');
    }
    const fields = ['first_name', 'last_name', 'phone', 'company'];

    fields.forEach(field => {
      const input = document.querySelector(`#${field}`);
      if (input) {
        input.style.display = 'none';
        input.classList.remove('needs-filling');
      }
    });
    if (addressWrapper && result.status === "ok") addressWrapper.style.display = 'none';
    if (submitButton) submitButton.style.display = 'none';

    if (result.status === "ok") {
      const contact = result.contact || {};
      const metadata = contact.metadata || {};
      const combined = { ...contact, ...metadata };
      const allFields = ['first_name', 'last_name', 'phone', 'company', 'address', 'postal_code', 'city', 'country'];
      allFields.forEach(field => {
        const input = document.querySelector(`#${field}`);
        if (input) {
          if (combined[field]) {
            input.value = combined[field];
            input.style.display = 'none';
            input.classList.remove('needs-filling');
          } else {
            input.value = '';
            input.style.display = 'block';
            input.classList.add('needs-filling');
          }
        }
      });
      return;
    } else if (result.status === "incomplete") {
      const addressFields = ['address', 'postal_code', 'city', 'country'];
      const filteredMissing = result.missing_fields.filter(field => {
        return !(addressFields.includes(field) && meetingType !== 'atClient');
      });
      const onlyCountryMissing = filteredMissing.length === 1 && filteredMissing[0] === 'country';
      if (onlyCountryMissing) {
        const input = document.querySelector(`#country`);
        if (input) {
          input.style.display = 'block';
          input.classList.add('needs-filling');
        }
        if (addressWrapper) addressWrapper.style.display = 'block';
        if (submitButton) {
          submitButton.style.display = 'block';
          submitButton.value = 'Uppdatera land';
        }
        return;
      }
      console.log("ðŸ” Backend saknade fÃ¤lt:", result.missing_fields);
      if (filteredMissing.length === 0) {
        return;
      }

      console.log("ðŸŽ¯ Filtrerade fÃ¤lt:", filteredMissing);
      result.missing_fields = filteredMissing;
      fields.forEach(field => {
        const input = document.querySelector(`#${field}`);
        if (input && filteredMissing.includes(field)) {
          input.style.display = 'block';
          input.classList.add('needs-filling');
        }
      });

      if (meetingType !== 'atClient' && addressWrapper) {
        const anyAddressMissing = filteredMissing.some(f => addressFields.includes(f));
        if (anyAddressMissing) {
          addressWrapper.style.display = 'block';
        } else {
          addressWrapper.style.display = 'none';
        }
      }

      const needsFillingElements = document.querySelectorAll('.needs-filling');
      const allVisibleAndEmpty = Array.from(needsFillingElements).some(el => el.offsetParent !== null && !el.value.trim());

      if (submitButton) {
        if (allVisibleAndEmpty) {
          submitButton.style.display = 'block';
          submitButton.value = 'Uppdatera uppgifter';
        } else {
          submitButton.style.display = 'none';
        }
      }
    } else if (result.status === "new_customer") {
      fields.forEach(field => {
        const input = document.querySelector(`#${field}`);
        if (input) {
          input.style.display = 'block';
          input.classList.add('needs-filling');
        }
      });
      if (meetingType === 'atClient') {
        if (addressWrapper) {
          const allAddressFieldsFilled = ['address', 'postal_code', 'city', 'country'].every(field => {
            const el = document.querySelector(`#${field}`);
            return el && el.value.trim();
          });
          if (!allAddressFieldsFilled) addressWrapper.style.display = 'block';
          const addressFields = ['address', 'postal_code', 'city', 'country'];
          addressFields.forEach(field => {
            const input = document.querySelector(`#${field}`);
            if (input) input.classList.add('needs-filling');
          });
        }
      } else {
        if (addressWrapper) addressWrapper.style.display = 'none';
        const addressFields = ['address', 'postal_code', 'city', 'country'];
        addressFields.forEach(field => {
          const input = document.querySelector(`#${field}`);
          if (input) input.classList.remove('needs-filling');
        });
      }

      const needsFillingElements = document.querySelectorAll('.needs-filling');
      const allVisibleAndEmpty = Array.from(needsFillingElements).some(el => el.offsetParent !== null && !el.value.trim());

      if (submitButton) {
        if (allVisibleAndEmpty) {
          submitButton.style.display = 'block';
          submitButton.value = 'Skapa kontakt';
        } else {
          submitButton.style.display = 'none';
        }
      }
    }

    if (result.status === 'ok') {
      const visibleFields = document.querySelectorAll('.needs-filling');
      if (visibleFields.length === 0 && submitButton) {
        submitButton.style.display = 'none';
      }
    }
  }

  // --- NEW FUNCTION: submitContactUpdate ---
  async function submitContactUpdate() {
    const emailEl = document.querySelector('#booking_email');
    const email = emailEl ? emailEl.value.trim() : '';
    const meetingInput = document.querySelector('input[name="meeting_type"]:checked');
    const meetingType = meetingInput ? meetingInput.value : '';
    const fields = ['first_name', 'last_name', 'phone', 'company', 'address', 'postal_code', 'city', 'country'];

    const payload = { email, meeting_type: meetingType };
    fields.forEach(field => {
      const input = document.querySelector(`#${field}`);
      if (input && input.style.display !== 'none') {
        payload[field] = input.value.trim();
      }
    });

    try {
      const response = await fetch('https://macspotbackend.azurewebsites.net/api/update_contact', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      const result = await response.json();
      console.log('âœ… Kontaktuppdatering svar:', result);

      if (result.status === 'success') {
        if (typeof window.triggerSlotSearch === 'function') {
          window.triggerSlotSearch();
        }
        const submitButton = document.querySelector('#contact-update-button');
        if (submitButton) {
          submitButton.style.display = 'none';
        }
      } else {
        alert('Det gick inte att uppdatera kontakten. FÃ¶rsÃ¶k igen.');
      }
    } catch (error) {
      console.error('âŒ Fel vid kontaktuppdatering:', error);
      alert('Ett fel uppstod vid kontaktuppdatering.');
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    const meetingTypeGroup = document.querySelector('#meeting_type_group');
    const emailField = document.querySelector('#booking_email');
    const submitButton = document.querySelector('#contact-update-button');

    if (meetingTypeGroup) {
      meetingTypeGroup.style.display = 'none';
    }

    if (emailField) {
      emailField.addEventListener('blur', () => {
        const email = emailField.value.trim();
        if (email && email.includes('@')) {
          if (meetingTypeGroup) meetingTypeGroup.style.display = 'block';
        }
      });
    }

    if (submitButton) {
      submitButton.style.display = 'none';
      submitButton.addEventListener('click', (event) => {
        event.preventDefault();
        submitContactUpdate();
      });
    }

    document.querySelectorAll('input[name="meeting_type"]').forEach(radio => {
      radio.addEventListener('change', (e) => {
        console.log("ðŸŽ¯ Radioknapp valdes:", e.target.value);
        validateContact();
      });
    });
  });
</script>