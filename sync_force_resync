import psycopg2
import json
import sys
import argparse
from config import LOCAL_DB_CONFIG

parser = argparse.ArgumentParser(description="Hantera force_resync i metadata.")
parser.add_argument("email", help="Kontaktens e-postadress")
parser.add_argument("--clear", action="store_true", help="Ta bort force_resync")
parser.add_argument("--show", action="store_true", help="Visa befintlig metadata")

args = parser.parse_args()
email = args.email

clear = args.clear


conn = psycopg2.connect(**LOCAL_DB_CONFIG)
cur = conn.cursor()

cur.execute("SELECT id, metadata FROM contact WHERE booking_email = %s", (email,))
row = cur.fetchone()
if not row:
    print(f"‚ùå Hittade ingen kontakt med e-post: {email}")
    sys.exit(1)

contact_id, metadata = row
metadata = json.loads(metadata) if isinstance(metadata, str) else metadata

if args.show:
    print(json.dumps(metadata, indent=2, ensure_ascii=False))
    sys.exit(0)

if clear:
    metadata.pop("force_resync", None)
    print("üßπ force_resync borttagen")
else:
    metadata["force_resync"] = True
    print("‚úÖ force_resync satt")

cur.execute("UPDATE contact SET metadata = %s WHERE id = %s", (json.dumps(metadata), contact_id))
conn.commit()
cur.close()
conn.close()

print(f"üÜó Uppdaterad metadata f√∂r {email}")