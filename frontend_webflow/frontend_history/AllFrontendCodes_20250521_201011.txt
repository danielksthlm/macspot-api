ğŸ“‚ KODTRÃ„D
==========
â”œâ”€â”€ webflow
â”‚   â”œâ”€â”€ Embed Block 1.js
â”‚   â”œâ”€â”€ Embed Block 2.js
â”‚   â”œâ”€â”€ Embed Block 2b.js
â”‚   â”œâ”€â”€ Embed Block 3.js
==========

START: Embed Block 1.js
// âš ï¸ Filen 'Embed Block 1.js' hittades inte
END: Embed Block 1.js

START: Embed Block 2.js
// âš ï¸ Filen 'Embed Block 2.js' hittades inte
END: Embed Block 2.js

START: Embed Block 2b.js
// âš ï¸ Filen 'Embed Block 2b.js' hittades inte
END: Embed Block 2b.js

START: Embed Block 3.js
// âš ï¸ Filen 'Embed Block 3.js' hittades inte
END: Embed Block 3.js

ğŸ“ KONFIGURATIONSFILER (function.json / host.json / package.json / .funcignore)
====================================

ğŸ“„ .funcignore
   # Exclude dev-only files and folders
   .git
   .vscode
   .env
   *.log
   test/
   tests/
   
   # Explicitly include all required files and folders
   !host.json
   !package.json
   !package-lock.json
   
   !node_modules/
   !node_modules/**
   
   !shared/
   !shared/**
   
   !bookings/
   !bookings/**
   !getavailableslots/
   !getavailableslots/**
   !validate_contact/
   !validate_contact/**
   !meeting_types/
   !meeting_types/**
   !refreshCalendarOrigins/
   !refreshCalendarOrigins/**
   !refreshTravelTimes/
   !refreshTravelTimes/**
ğŸ“„ bookings/function.json
   {
     "bindings": [
       {
         "authLevel": "anonymous",
         "type": "httpTrigger",
         "direction": "in",
         "name": "req",
         "methods": ["post", "options"],
         "route": "bookings"
       },
       {
         "type": "http",
         "direction": "out",
         "name": "res"
       }
     ],
     "scriptFile": "index.js"
   }
ğŸ“„ getavailableslots/function.json
   {
     "bindings": [
       {
         "authLevel": "anonymous",
         "type": "httpTrigger",
         "direction": "in",
         "name": "req",
         "methods": ["post", "options"],
         "route": "getavailableslots"
       },
       {
         "type": "http",
         "direction": "out",
         "name": "res"
       }
     ],
     "scriptFile": "index.js"
   }
ğŸ“„ host.json
   {
     "version": "2.0",
     "extensionBundle": {
       "id": "Microsoft.Azure.Functions.ExtensionBundle",
       "version": "[4.*, 5.0.0)"
     },
     "extensions": {
       "http": {
         "cors": {
           "allowedOrigins": [
             "https://www.klrab.se"
           ],
           "supportCredentials": false
         }
       }
     }
   }
ğŸ“„ meeting_types/function.json
   {
     "bindings": [
       {
         "authLevel": "anonymous",
         "type": "httpTrigger",
         "direction": "in",
         "name": "req",
         "methods": [ "get" ],
         "route": "meeting_types"
       },
       {
         "type": "http",
         "direction": "out",
         "name": "res"
       }
     ],
     "scriptFile": "index.js"
   }
ğŸ“„ package.json
   {
     "name": "macspot-api",
     "version": "1.0.0",
     "description": "Azure Functions backend fÃ¶r MacSpot CRM/ERP",
     "scripts": {
       "start": "func start",
       "dev": "func start --verbose",
       "deploy": "func azure functionapp publish macspotbackend",
       "build": "echo 'Nothing to build'"
     },
     "dependencies": {
       "@azure/functions": "^4.7.0",
       "@azure/msal-node": "^3.5.1",
       "@microsoft/microsoft-graph-client": "^3.0.0",
       "dav": "^1.8.0",
       "dotenv": "^16.5.0",
       "isomorphic-fetch": "^3.0.0",
       "jsonwebtoken": "^9.0.0",
       "luxon": "^3.4.4",
       "node-fetch": "^2.7.0",
       "node-ical": "^0.20.1",
       "p-limit": "^6.2.0",
       "pg": "^8.15.6",
       "uuid": "^9.0.0",
       "xml2js": "^0.6.2"
     }
   }

ğŸ“„ refreshCalendarOrigins/function.json
   {
     "bindings": [
       {
         "name": "myTimer",
         "type": "timerTrigger",
         "direction": "in",
         "schedule": "0 0 * * * *"
       }
     ],
     "scriptFile": "index.js"
   }
ğŸ“„ refreshTravelTimes/function.json
   {
     "bindings": [
       {
         "name": "myTimer",
         "type": "timerTrigger",
         "direction": "in",
         "schedule": "0 0 * * * *"
       }
     ],
     "scriptFile": "index.js"
   }
ğŸ“„ validate_contact/function.json
   {
     "bindings": [
       {
         "authLevel": "anonymous",
         "type": "httpTrigger",
         "direction": "in",
         "name": "req",
         "methods": ["post"],
         "route": "validate_contact"
       },
       {
         "type": "http",
         "direction": "out",
         "name": "res"
       }
     ],
     "scriptFile": "index.js"
   }
ğŸ“ˆ SUMMERING AV ALLA JS-FILER
====================================
ğŸ“ Totalt antal rader kod: 0
ğŸ§© Totalt antal funktioner: 0
ğŸ§  Total komplexitetspoÃ¤ng: 0
ğŸ§ª Antal TODO/FIXME totalt: 0

ğŸ“Š Per fil:
fil,rader,funktioner,komplexitet,kommentarer,imports
ğŸ“Š MOLNDATABAS (Azure) â€“ STRUKTUR & INNEHÃ…LL
====================================

ğŸ“ Tabell: available_slots_cache
  â€¢ id (uuid)
  â€¢ travel_time_min (integer)
  â€¢ generated_at (timestamp without time zone)
  â€¢ expires_at (timestamp without time zone)
  â€¢ meeting_length (integer)
  â€¢ slot_day (date)
  â€¢ slot_score (integer)
  â€¢ meeting_type (text)
  â€¢ slot_part (text)
  â€¢ slot_iso (text)
  ğŸ”‘ [p] available_slots_cache_pkey: PRIMARY KEY (id)

ğŸ“ Tabell: slot_cache
  â€¢ created_at (timestamp without time zone)
  â€¢ slot_day (date)
  â€¢ slots (jsonb)
  â€¢ id (uuid)
  â€¢ meeting_length (integer)
  â€¢ booking_email (text)
  â€¢ meeting_type (text)
  â€¢ slot_part (text)
  ğŸ”‘ [p] slot_cache_pkey: PRIMARY KEY (id)

ğŸ“ Tabell: calendar_origin_cache
  â€¢ created_at (timestamp without time zone)
  â€¢ timestamp (timestamp with time zone)
  â€¢ event_date (date)
  â€¢ id (integer)
  â€¢ end_time (timestamp without time zone)
  â€¢ address (text)
  â€¢ source (text)
  ğŸ”‘ [c] calendar_origin_cache_source_check: CHECK ((source = ANY (ARRAY['Apple Calendar'::text, 'Microsoft 365'::text])))
  ğŸ”‘ [p] calendar_origin_cache_pkey: PRIMARY KEY (id)
  ğŸ§ª Topp 5 rader:
    - id=71, event_date=2025-05-21, source=Apple Calendar, address=â€“, end_time=2025-05-21 06:00:00, created_at=2025-05-21 14:43:51.546125, timestamp=2025-05-21 14:43:51.546125+00:00
    - id=72, event_date=2025-05-23, source=Apple Calendar, address=â€“, end_time=2025-05-23 06:00:00, created_at=2025-05-21 14:43:55.076780, timestamp=2025-05-21 14:43:55.076780+00:00
    - id=73, event_date=2025-05-26, source=Apple Calendar, address=â€“, end_time=2025-05-26 06:00:00, created_at=2025-05-21 14:43:56.126523, timestamp=2025-05-21 14:43:56.126523+00:00
    - id=74, event_date=2025-06-02, source=Apple Calendar, address=â€“, end_time=2025-06-02 06:00:00, created_at=2025-05-21 14:44:04.998700, timestamp=2025-05-21 14:44:04.998700+00:00
    - id=75, event_date=2025-06-09, source=Apple Calendar, address=â€“, end_time=2025-06-09 06:00:00, created_at=2025-05-21 14:44:13.830924, timestamp=2025-05-21 14:44:13.830924+00:00

ğŸ“ Tabell: travel_time_cache
  â€¢ travel_minutes (integer)
  â€¢ updated_at (timestamp with time zone)
  â€¢ is_fallback (boolean)
  â€¢ hour (integer)
  â€¢ created_at (timestamp with time zone)
  â€¢ to_address (text)
  â€¢ from_address (text)
  ğŸ”‘ [u] unique_travel_key: UNIQUE (from_address, to_address, hour)
  ğŸ§ª Topp 5 rader:
    - from_address=Taxgatan 4, 115 45 Stockholm, to_address=Maria Skolgata 79A, 118 53 Stockholm, hour=12, travel_minutes=20, created_at=2025-05-19 08:35:30.341217+00:00, updated_at=2025-05-19 08:35:30.341217+00:00, is_fallback=False
    - from_address=Taxgatan 4, 115 45 Stockholm, to_address=Maria Skolgata 79A, 118 53 Stockholm, hour=8, travel_minutes=22, created_at=2025-05-19 08:51:46.047719+00:00, updated_at=2025-05-19 08:51:46.047719+00:00, is_fallback=False
    - from_address=Taxgatan 4, 115 45 Stockholm, to_address=Maria Skolgata 79A, 118 53 Stockholm, hour=10, travel_minutes=23, created_at=2025-05-19 12:00:01.057723+00:00, updated_at=2025-05-19 12:00:01.057723+00:00, is_fallback=False
    - from_address=Taxgatan 4, 115 45 Stockholm, to_address=Maria Skolgata 79A, 118 53 Stockholm, hour=14, travel_minutes=23, created_at=2025-05-19 12:00:01.639717+00:00, updated_at=2025-05-19 12:00:01.639717+00:00, is_fallback=False

ğŸ“ Tabell: event_log
  â€¢ received_at (timestamp with time zone)
  â€¢ record_id (uuid)
  â€¢ timestamp (timestamp with time zone)
  â€¢ booking_id (uuid)
  â€¢ id (uuid)
  â€¢ payload (jsonb)
  â€¢ action (text)
  â€¢ event_type (text)
  â€¢ source (text)
  â€¢ table_name (text)
  ğŸ”‘ [p] event_log_pkey: PRIMARY KEY (id)
  ğŸ§ª Topp 5 rader:
    - source=None, event_type=None, payload=None, received_at=2025-05-16 09:40:53.307336+00:00, id=903c2758-e7e6-4f11-9a31-1871596e195c, action=INSERT, table_name=contact, record_id=c4e2d9dd-545e-4e05-99fe-16d377a87698, timestamp=2025-05-16 09:40:53.307336+00:00, booking_id=None
    - source=None, event_type=booking_created, payload=None, received_at=2025-05-18 11:56:16.897217+00:00, id=fb33d0d1-ff78-4506-82dd-026fd86cd781, action=None, table_name=None, record_id=None, timestamp=2025-05-18 11:56:16.897217+00:00, booking_id=fb6b2112-8dbf-4bed-aba4-c2882989db21
    - source=None, event_type=booking_created, payload=None, received_at=2025-05-18 12:06:54.686150+00:00, id=89690767-0414-4c48-b61d-8f9d350718e5, action=None, table_name=None, record_id=None, timestamp=2025-05-18 12:06:54.686150+00:00, booking_id=3ecff74d-cb9c-4e9f-9db5-b0a7b12666ee
    - source=None, event_type=None, payload=None, received_at=2025-05-18 12:32:42.290134+00:00, id=420ca821-9117-46b4-b9cb-6eedef51f4cb, action=INSERT, table_name=contact, record_id=14e1bef9-2833-40d5-b4fe-7576f7cffd6c, timestamp=2025-05-18 12:32:42.290134+00:00, booking_id=None
    - source=None, event_type=None, payload=None, received_at=2025-05-18 12:37:08.028330+00:00, id=931849cb-3a69-4861-83ba-258fe1de5e98, action=UPDATE, table_name=contact, record_id=14e1bef9-2833-40d5-b4fe-7576f7cffd6c, timestamp=2025-05-18 12:37:08.028330+00:00, booking_id=None

ğŸ“ Tabell: bookings
  â€¢ start_time (timestamp with time zone)
  â€¢ end_time (timestamp with time zone)
  â€¢ id (uuid)
  â€¢ updated_at (timestamp with time zone)
  â€¢ metadata (jsonb)
  â€¢ created_at (timestamp with time zone)
  â€¢ contact_id (uuid)
  â€¢ meeting_type (text)
  â€¢ booking_email (text)
  ğŸ”‘ [p] bookings_pkey: PRIMARY KEY (id)
  ğŸ”‘ [f] fk_bookings_contact: FOREIGN KEY (contact_id) REFERENCES contact(id) ON DELETE SET NULL
  ğŸ§ª Topp 5 rader:
    - start_time=2025-05-20 08:00:00+00:00, end_time=2025-05-20 08:20:00+00:00, meeting_type=facetime, metadata={}, created_at=2025-05-18 10:48:56.390000+00:00, contact_id=None, id=378a6541-8e61-465d-a37d-6242ba770dc7, updated_at=2025-05-18 10:48:56.390000+00:00, booking_email=None
    - start_time=2025-05-20 12:00:00+00:00, end_time=2025-05-20 12:20:00+00:00, meeting_type=facetime, metadata={}, created_at=2025-05-18 11:12:10.769000+00:00, contact_id=None, id=f861a2c5-f1ca-4f00-91af-276bac7f326d, updated_at=2025-05-18 11:12:10.769000+00:00, booking_email=None
    - start_time=2025-05-20 12:00:00+00:00, end_time=2025-05-20 12:20:00+00:00, meeting_type=facetime, metadata={}, created_at=2025-05-18 11:13:04.323000+00:00, contact_id=None, id=feccbea8-6a8f-44d8-9f9d-cf468b55bc0c, updated_at=2025-05-18 11:13:04.323000+00:00, booking_email=None
    - start_time=2025-05-20 12:00:00+00:00, end_time=2025-05-20 12:20:00+00:00, meeting_type=facetime, metadata={}, created_at=2025-05-18 11:13:07.009000+00:00, contact_id=None, id=40f2b6ab-51ba-4c50-844c-6d9ff3db52d2, updated_at=2025-05-18 11:13:07.009000+00:00, booking_email=None
    - start_time=2025-05-21 08:00:00+00:00, end_time=2025-05-21 08:20:00+00:00, meeting_type=facetime, metadata={}, created_at=2025-05-18 11:29:28.739000+00:00, contact_id=None, id=4c0d2868-f99d-4156-b92e-4e7a97fd1153, updated_at=2025-05-18 11:29:28.739000+00:00, booking_email=None

ğŸ“ Tabell: pending_changes
  â€¢ booking_id (uuid)
  â€¢ processed (boolean)
  â€¢ created_at (timestamp with time zone)
  â€¢ payload (jsonb)
  â€¢ id (uuid)
  â€¢ record_id (uuid)
  â€¢ table_name (text)
  â€¢ operation (text)
  â€¢ change_type (text)
  â€¢ direction (text)
  ğŸ”‘ [p] pending_changes_pkey: PRIMARY KEY (id)
  ğŸ”‘ [f] fk_pending_changes_booking_id: FOREIGN KEY (booking_id) REFERENCES bookings(id) ON DELETE CASCADE
  ğŸ§ª Topp 5 rader:
    - id=7d417b09-6288-490b-a73c-3f3b2792817e, table_name=contact, record_id=c4e2d9dd-545e-4e05-99fe-16d377a87698, change_type=INSERT, direction=out, processed=False, created_at=2025-05-16 09:40:53.307336+00:00, operation=INSERT, payload={'id': 'c4e2d9dd-545e-4e05-99fe-16d377a87698', 'email': None, 'metadata': {'city': '', 'phone': '0709561480', 'address': '', 'company': 'AnyNode', 'country': '', 'last_name': 'KÃ¤llberg', 'first_name': 'Daniel', 'postal_code': ''}, 'created_at': '2025-05-16T09:40:53.307336+00:00', 'updated_at': '2025-05-16T09:40:53.307336+00:00', 'booking_email': 'daniel@anynode.se'}, booking_id=None
    - id=6463cae5-e1e8-4899-903b-feccaf981229, table_name=bookings, record_id=378a6541-8e61-465d-a37d-6242ba770dc7, change_type=INSERT, direction=out, processed=False, created_at=2025-05-18 10:48:56.394310+00:00, operation=INSERT, payload={'id': '378a6541-8e61-465d-a37d-6242ba770dc7', 'end_time': '2025-05-20T08:20:00+00:00', 'metadata': {}, 'contact_id': None, 'created_at': '2025-05-18T10:48:56.39+00:00', 'start_time': '2025-05-20T08:00:00+00:00', 'updated_at': '2025-05-18T10:48:56.39+00:00', 'meeting_type': 'facetime', 'booking_email': None}, booking_id=378a6541-8e61-465d-a37d-6242ba770dc7
    - id=62176d8e-90ff-48d9-bfe6-9375995dede3, table_name=bookings, record_id=378a6541-8e61-465d-a37d-6242ba770dc7, change_type=INSERT, direction=cloud_to_local, processed=False, created_at=2025-05-18 10:48:56.440000+00:00, operation=None, payload=None, booking_id=378a6541-8e61-465d-a37d-6242ba770dc7
    - id=c6553a94-29ae-4721-b381-898f78f0d67c, table_name=bookings, record_id=f861a2c5-f1ca-4f00-91af-276bac7f326d, change_type=INSERT, direction=out, processed=False, created_at=2025-05-18 11:12:10.772513+00:00, operation=INSERT, payload={'id': 'f861a2c5-f1ca-4f00-91af-276bac7f326d', 'end_time': '2025-05-20T12:20:00+00:00', 'metadata': {}, 'contact_id': None, 'created_at': '2025-05-18T11:12:10.769+00:00', 'start_time': '2025-05-20T12:00:00+00:00', 'updated_at': '2025-05-18T11:12:10.769+00:00', 'meeting_type': 'facetime', 'booking_email': None}, booking_id=f861a2c5-f1ca-4f00-91af-276bac7f326d
    - id=4d1006a6-2ff8-4c60-a573-e2091d5d3917, table_name=bookings, record_id=f861a2c5-f1ca-4f00-91af-276bac7f326d, change_type=INSERT, direction=cloud_to_local, processed=False, created_at=2025-05-18 11:12:10.803000+00:00, operation=None, payload=None, booking_id=f861a2c5-f1ca-4f00-91af-276bac7f326d

ğŸ“ Tabell: contact
  â€¢ metadata (jsonb)
  â€¢ created_at (timestamp with time zone)
  â€¢ id (uuid)
  â€¢ updated_at (timestamp with time zone)
  â€¢ booking_email (text)
  â€¢ email (text)
  ğŸ”‘ [p] contact_pkey: PRIMARY KEY (id)
  ğŸ§ª Topp 5 rader:
    - metadata={'city': '', 'phone': '0709561480', 'address': '', 'company': 'AnyNode', 'country': '', 'last_name': 'KÃ¤llberg', 'first_name': 'Daniel', 'postal_code': ''}, created_at=2025-05-16 09:40:53.307336+00:00, id=c4e2d9dd-545e-4e05-99fe-16d377a87698, booking_email=daniel@anynode.se, updated_at=2025-05-16 09:40:53.307336+00:00, email=None
    - metadata={'city': 'Stockholm', 'address': 'Maria Skolgata 79A', 'postal_code': '118 53'}, created_at=2025-05-18 12:32:42.290134+00:00, id=14e1bef9-2833-40d5-b4fe-7576f7cffd6c, booking_email=None, updated_at=2025-05-18 12:32:42.290134+00:00, email=daniel@anynode.se

ğŸ“ Tabell: booking_settings
  â€¢ value (jsonb)
  â€¢ updated_at (timestamp with time zone)
  â€¢ key (text)
  â€¢ value_type (text)
  ğŸ§ª Topp 5 rader:
    - key=max_days_in_advance, value=30, value_type=int, updated_at=2025-04-23 12:48:49.778155+00:00
    - key=buffer_between_meetings, value=15, value_type=int, updated_at=2025-04-23 12:48:49.778155+00:00
    - key=max_weekly_booking_minutes, value=360, value_type=int, updated_at=2025-04-23 12:48:49.778155+00:00
    - key=default_office_address, value=Maria Skolgata 79A, 118 53 Stockholm, value_type=string, updated_at=2025-04-23 12:48:49.778155+00:00
    - key=fallback_travel_time_minutes, value=90, value_type=int, updated_at=2025-04-23 12:48:49.778155+00:00

ğŸ“ Tabell: translation
  â€¢ key (character varying)
  â€¢ sv (text)
  â€¢ en (text)
  ğŸ§ª Topp 5 rader:
    - key=error_min_duration_fysiskt_kund, sv=MÃ¶testiden fÃ¶r 'Fysiskt hos kund' mÃ¥ste vara minst {{minutes}} minuter. Du visste det redan., en=The meeting time for 'On-site at customer' must be at least {{minutes}} minutes. You knew that.
    - key=error_min_duration_fysiskt_mig, sv=MÃ¶testiden fÃ¶r 'Fysiskt hos mig' mÃ¥ste vara minst {{minutes}} minuter. Annars hinner vi bara sÃ¤ga hej., en=The meeting time for 'At my office' must be at least {{minutes}} minutes. Otherwise, weâ€™ll only have time to say hello.
    - key=email_body_booking_received, sv=Hej {{name}}! Vi har tagit emot din bokning fÃ¶r {{meeting_type}} mellan {{start_time}} och {{end_time}}. Ingen panik â€“ vi Ã¥terkommer med bekrÃ¤ftelse. / Daniel, en=Hello {{name}}, Weâ€™ve received your booking for {{meeting_type}} between {{start_time}} and {{end_time}}. No need to panic â€“ weâ€™ll confirm shortly. / Daniel
    - key=email_body_booking_confirmed, sv=Hej {{name}}! Din bokning fÃ¶r {{meeting_type}} mellan {{start_time}} och {{end_time}} Ã¤r nu spikad. Ser fram emot det! / Daniel, en=Hello {{name}}, Your booking for {{meeting_type}} between {{start_time}} and {{end_time}} is now locked in. Looking forward! / Daniel
    - key=email_body_booking_cancelled, sv=Hej {{name}}! Din bokning fÃ¶r {{meeting_type}} mellan {{start_time}} och {{end_time}} Ã¤r avbokad. HÃ¶r av dig om du vill hitta en ny tid. / Daniel, en=Hello {{name}}, Your booking for {{meeting_type}} between {{start_time}} and {{end_time}} has been cancelled. Let me know if you'd like a new one. / Daniel

