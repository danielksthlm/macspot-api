📂 KODTRÄD
==========
├── frontend_webflow
│   ├── Embed Block 1.js
│   ├── Embed Block 2.js
│   ├── Embed Block 2b.js
│   ├── Embed Block 3.js
==========

====================
📄 Fil: frontend_webflow/Embed Block 1.js
📂 Kodtyp: 📄 Övrigt
🗂 Filtyp: 🟨 JavaScript
📅 Senast ändrad: 2025-05-15 14:29:48
📏 Antal rader: 638
🧩 Antal funktioner: 14
💬 Kommentarstäckning: 38 rader (6.0%)
📥 Imports: 0 – Inga
🔍 Längsta funktion: 34 rader
🧠 Komplexitetspoäng: 63
🧪 TODO/FIXME: 0
====================
START: Embed Block 1.js
<script>
  // Återställer formulärstate (mötestyp, mötestid, tider, clt_ready)
  function resetFormState() {
    console.log('🔄 Återställer formulärstate');
    const fieldsToClear = [
      'clt_meetingtype',
      'clt_meetinglength',
      'clt_ready'
    ];
    fieldsToClear.forEach(id => {
      const el = document.getElementById(id);
      if (el) el.value = '';
    });

    const meetingRadios = document.querySelectorAll('input[name="meeting_type"]');
    meetingRadios.forEach(r => r.checked = false);
    const lengthRadios = document.querySelectorAll('input[name="meeting_length"]');
    lengthRadios.forEach(r => r.checked = false);

    const slotContainer = document.getElementById('time_slot_select');
    if (slotContainer) slotContainer.innerHTML = '';
    const slotGroup = document.getElementById('time_slot_group');
    if (slotGroup) slotGroup.style.display = 'none';
  }

  // Kontrollerar e-post och triggar laddning av mötestyper och validering.
  function validateEmail() {
    console.log('🔎 validateEmail() körs');
    const emailEl = document.querySelector('#booking_email');
    const email = emailEl ? emailEl.value.trim() : '';
    const cltEmail = document.getElementById('clt_email');
    if (cltEmail) {
      cltEmail.value = email;
      console.log('📥 Satt #clt_email:', email);
    }
    if (email.length > 0 && email.includes('@')) {
      loadMeetingTypes();
      resetFormState();
      // Lägg till logg direkt efter anropet
      console.log('🧪 Validering och mötestyper triggat, väntar på meeting_type_select');
      const typeGroup = document.getElementById('meeting_type_group');
      if (typeGroup) {
        typeGroup.style.display = 'block';
        console.log('✅ Visar #meeting_type_group via style.display');
      }
    } else {
      console.log('❌ Ogiltig e-post, laddar inte mötestyper');
    }
  }

  // Laddar mötestyper och längder från backend och renderar radioknappar.
  async function loadMeetingTypes() {
    console.log('🔎 loadMeetingTypes() körs');
    try {
      const res = await fetch('https://macspotbackend.azurewebsites.net/api/meeting_types');
      if (!res.ok) throw new Error('Failed to fetch meeting types');
      const { types, lengths: loadedLengths } = await res.json();
      window.lengths = {};
      Object.entries(loadedLengths || {}).forEach(([key, val]) => {
        window.lengths[key.toLowerCase()] = val;
      });
      console.log('📡 Hämtade mötestyper och längder:', types, window.lengths);
      console.log('📊 Mötestyper:', types);
      console.log('📊 Längder per typ:', window.lengths);

      const container = document.getElementById('meeting_type_select');
      if (!container) {
        console.warn('⚠️ #meeting_type_select saknas i DOM');
        return;
      }
      container.innerHTML = '';

      function createRadio({ name, value, label, checked, onChange }) {
        const div = document.createElement('div');
        div.className = 'radio-button-items';
        const labelEl = document.createElement('label');
        labelEl.className = 'radio-button-items';
        const input = document.createElement('input');
        input.type = 'radio';
        input.name = name;
        input.value = value;
        input.className = 'radio-button-items';
        // Ingen radioknapp ska förväljas eller klickas automatiskt
        if (typeof onChange === 'function') input.addEventListener('change', onChange);
        labelEl.appendChild(input);
        const text = document.createElement('span');
        text.textContent = ` ${label}`;
        text.style.display = 'block';
        text.style.marginLeft = '10px';
        text.style.marginTop = '-20px';
        text.style.lineHeight = '1.4';
        text.style.paddingLeft = '8px';
        labelEl.appendChild(text);
        div.appendChild(labelEl);
        return div;
      }

      (Array.isArray(types) ? types : JSON.parse(types)).forEach((type, index) => {
        const value = type.toLowerCase();
        const displayNames = {
          zoom: 'Digitalt via Zoom',
          facetime: 'Digitalt via FaceTime',
          teams: 'Digitalt via Teams',
          atclient: 'Möte hos dig (ange din adress)',
          atoffice: 'Möte på mitt kontor i Stockholm'
        };
        const label = displayNames[value] || type;
        const radio = createRadio({
          name: 'meeting_type',
          value,
          label,
          checked: false,
          onChange: () => {
            console.log('🔄 Mötestyp ändrad till:', value);
            renderMeetingLengths(value);
            validateAndRenderCustomerFields();
          }
        });
        container.appendChild(radio);
      });

      const renderedRadios = container.querySelectorAll('input[name="meeting_type"]');
      if (renderedRadios.length === 0) {
        console.warn('⚠️ Inga mötestyper renderades – kontrollera types-data');
      }

      const typeGroup = document.getElementById('meeting_type_group');
      if (typeGroup) {
        typeGroup.classList.remove('hidden');
        typeGroup.classList.add('visible-group');
        console.log('✅ Visar #meeting_type_group');
      }

    } catch (err) {
      console.error('❌ Error loading meeting types:', err);
      const container = document.getElementById('meeting_type_group');
      if (container) {
        container.innerHTML = '<p style="color: red;">Kunde inte ladda mötestyper - skyll inte på mig utan på Bill Gates.</p>';
      }
    }
  }

  // Renderar längdalternativ beroende på mötestyp.
  function renderMeetingLengths(type) {
    console.log('🔎 renderMeetingLengths() körs för typ:', type);
    const slotContainer = document.getElementById('time_slot_select');
    if (!slotContainer) {
      console.warn('⚠️ #time_slot_select saknas i DOM');
      return;
    }
    slotContainer.innerHTML = '';
    const values = (window.lengths && window.lengths[type]) ? window.lengths[type] : [90];
    console.log(`⏱ Renderar ${values.length} tider för ${type}`);

    function createLengthRadio(value, checked) {
      const div = document.createElement('div');
      div.className = 'radio-button-items';
      const labelEl = document.createElement('label');
      labelEl.className = 'radio-button-items';
      const input = document.createElement('input');
      input.type = 'radio';
      input.name = 'meeting_length';
      input.value = value;
      input.className = 'radio-button-items';
      if (checked) input.checked = true;
      input.addEventListener('change', () => {
        console.log('🔄 Möteslängd ändrad till:', value);
        const cltMeetingLength = document.getElementById('clt_meetinglength');
        if (cltMeetingLength) {
          cltMeetingLength.value = value;
          console.log('📥 Satt #clt_meetinglength:', value);
          // Kopiera radioknappens mötestyp till #clt_meetingtype om möjligt
          const cltMeetingType = document.getElementById('clt_meetingtype');
          const meetingTypeEl = document.querySelector('input[name="meeting_type"]:checked');
          if (cltMeetingType && meetingTypeEl) {
            cltMeetingType.value = meetingTypeEl.value;
            console.log('📥 Bekräftat #clt_meetingtype från radioknapp:', cltMeetingType.value);
          }
        }
        validateAndRenderCustomerFields();
      });
      labelEl.appendChild(input);
      const span = document.createElement('span');
      span.textContent = ` ${value} min`;
      span.className = 'radio-label-text';
      labelEl.appendChild(span);
      div.appendChild(labelEl);
      return div;
    }

    values.forEach((value, idx) => {
      slotContainer.appendChild(createLengthRadio(value, false));
    });

    const wrapper = document.getElementById('time_slot_group');
    if (wrapper) wrapper.classList.add('visible-group');

    const slotGroup = document.getElementById('time_slot_group');
    if (slotGroup) {
      slotGroup.classList.remove('hidden');
      slotGroup.classList.add('visible-group');
      console.log('✅ Visar #time_slot_group');
      slotGroup.style.display = 'block';
      console.log('✅ Visar #time_slot_group via style.display');
    }

  }

  // Validerar kontaktuppgifter mot backend och renderar nödvändiga kontaktfält.
  async function validateAndRenderCustomerFields() {
    // Döljer alltid submit-knappen i början av valideringen
    const submitButton = document.getElementById('contact-update-button');
    if (submitButton) submitButton.style.display = 'none';
    console.log('🔎 validateAndRenderCustomerFields() körs');
    const emailEl = document.querySelector('#booking_email');
    const email = emailEl ? emailEl.value.trim() : '';
    const meetingTypeEl = document.querySelector('input[name="meeting_type"]:checked');
    const meetingType = meetingTypeEl ? meetingTypeEl.value : '';
    const meetingLengthEl = document.querySelector('input[name="meeting_length"]:checked');
    const meetingLength = meetingLengthEl ? meetingLengthEl.value : '';

    const cltEmail = document.getElementById('clt_email');
    const cltMeetingType = document.getElementById('clt_meetingtype');
    const cltMeetingLength = document.getElementById('clt_meetinglength');
    const cltReady = document.getElementById('clt_ready');
    const cltContactId = document.getElementById('clt_contact_id');
    const addressField = document.querySelector('#address_fields');
    if (!meetingType || !meetingLength) {
      console.log('⏳ Väntar på mötestyp och mötestid innan validering av namn');
      return;
    }
    // Om email eller mötestyp saknas, göm fält och knapp
    if (!email || !meetingType) {
      console.log('⚠️ E-post eller mötestyp saknas, gömmer fält och knapp');
      const allFields = ['first_name', 'last_name', 'phone', 'company', 'address', 'postal_code', 'city', 'country'].map(id => document.getElementById(id)).filter(Boolean);
      allFields.forEach(f => {
        f.classList.add('hidden');
        f.classList.remove('needs-filling');
      });
      if (addressField) addressField.classList.add('hidden');
      if (submitButton) submitButton.style.display = 'none';
      if (cltReady) cltReady.value = 'false';
      return;
    }
    try {
      const url = 'https://macspotbackend.azurewebsites.net/api/validate_contact';
      const response = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, meeting_type: meetingType })
      });
      const data = await response.json();
      console.log('📡 validate_contact status:', response.status);
      console.log('🔍 API-svar – söker contact_id:', data);

      // --- LOGGAR: Kontrollmötestyp och clt-fält ---
      console.log('📋 Kontrollmötestyp:', meetingType);
      console.log('📊 Kontroll clt-fält:', {
        cltEmail: cltEmail?.value,
        cltMeetingType: cltMeetingType?.value,
        cltMeetingLength: cltMeetingLength?.value,
        cltContactId: cltContactId?.value,
        cltReady: cltReady?.value
      });

      await fetchAndUpdateCustomerState(email, meetingType);
      updateCustomerFieldVisibilityAndState(data, meetingType);
    } catch (err) {
      console.error('❌ Fel vid validering av kontakt:', err);
    }
  }

  // Kontrollera att validateEmail() kopplas vid input
  document.addEventListener('DOMContentLoaded', () => {
    // Sätt clt_ready till 'false' vid sidladdning
    const cltReady = document.getElementById('clt_ready');
    if (cltReady) cltReady.value = 'false';

    const emailEl = document.querySelector('#booking_email');
    if (emailEl) {
      emailEl.addEventListener('input', validateEmail);
      console.log('✅ Lyssnare på #booking_email aktiverad');
    } else {
      console.warn('⚠️ #booking_email hittades inte vid DOMContentLoaded');
    }
    // Lägg till lyssnare på alla kontaktfält så att validateAndRenderCustomerFields() körs vid input
    [
      'first_name', 'last_name', 'phone', 'company', 'address', 'postal_code', 'city', 'country', 'clt_contact_id'
    ].forEach(id => {
      const el = document.getElementById(id);
      if (el) {
        el.addEventListener('input', () => {
          validateAndRenderCustomerFields();
        });
      }
    });
    console.log('✅ Lyssnare på kontaktfält aktiverad');
    // Göm alltid kontaktknappen initialt vid sidladdning
    const submitButton = document.getElementById('contact-update-button');
    if (submitButton) {
      submitButton.style.display = 'none';
      submitButton.textContent = '';
      console.log('🚫 Gömmer kontaktknapp vid sidladdning och nollställer text');
    }

    // Lägg till click-lyssnare på #contact-update-button som POSTar till /validate_contact (write_if_valid)
    if (submitButton) {
      submitButton.addEventListener('click', async (e) => {
        // --- DEBUGLOGGAR: visar exakt vad som finns tillgängligt vid klicktillfället ---
        console.log('🧪 Knappklick mottaget.');
        console.log('🧪 Knappetikett:', submitButton.textContent);
        console.log('🧪 window.formState:', window.formState);
        // Lägg till loggning av varje relevant fält:
        ['first_name', 'last_name', 'phone', 'company', 'address', 'postal_code', 'city', 'country'].forEach(id => {
          const el = document.getElementById(id);
          console.log(`🧪 ${id}:`, el?.value || '(tomt)');
        });
        console.log('🧪 clt_ready:', document.getElementById('clt_ready')?.value);
        // -------------------------------------------------------------------------------
        e.preventDefault();
        const label = submitButton.tagName === 'INPUT' ? submitButton.value : submitButton.textContent;
        if (!['Skapa', 'Uppdatera'].includes(label)) {
          console.warn('⚠️ Avbryter klick – ogiltig knappetikett:', label);
          return;
        }

        if (!window.formState) {
          const metadata = {};
          ['first_name', 'last_name', 'phone', 'company', 'address', 'postal_code', 'city', 'country'].forEach(id => {
            const el = document.getElementById(id);
            metadata[id] = el?.value || '';
          });

          const emailEl = document.querySelector('#booking_email');
          const meetingTypeEl = document.querySelector('input[name="meeting_type"]:checked');
          const meetingLengthEl = document.querySelector('input[name="meeting_length"]:checked');
          const contactIdEl = document.getElementById('clt_contact_id');

          window.formState = {
            email: emailEl?.value.trim() || '',
            meeting_type: meetingTypeEl?.value || '',
            meeting_length: parseInt(meetingLengthEl?.value || '90', 10),
            contact_id: contactIdEl?.value || '',
            metadata
          };
          console.log('📥 Återskapade window.formState vid klick:', window.formState);
        }

        const body = {
          email: window.formState.email,
          meeting_type: window.formState.meeting_type,
          metadata: window.formState.metadata,
          write_if_valid: true
        };

        try {
          console.log('📤 Skickar kontaktdata till /validate_contact (write_if_valid)', body);
          const res = await fetch('https://macspotbackend.azurewebsites.net/api/validate_contact', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
          });
          const result = await res.json();
          console.log('✅ Kontaktdata sparad via validate_contact:', result);
          // --- NY LOGIK: Sätt clt_contact_id och trigga slot-fetch om contact_id finns ---
          if (result.contact_id) {
            const cltContactId = document.getElementById('clt_contact_id');
            if (cltContactId) cltContactId.value = result.contact_id;

            if (window.formState) {
              window.formState.contact_id = result.contact_id;
            }

            const cltReady = document.getElementById('clt_ready');
            if (cltReady) cltReady.value = 'true';

            if (window.initAvailableSlotFetch) {
              window.initAvailableSlotFetch();
              console.log('📡 initAvailableSlotFetch() anropad från Skapa/Uppdatera');
            }
            // --- Lägg till validateAndRenderCustomerFields() efter skapande/uppdatering ---
            validateAndRenderCustomerFields();
            console.log('🔁 Kör validateAndRenderCustomerFields() efter skapande');
            // Dölj knappen efter lyckad uppdatering
            submitButton.style.display = 'none';
            submitButton.style.opacity = '0';
            submitButton.style.pointerEvents = 'none';
            submitButton.style.visibility = 'hidden';
            console.log('🚫 Gömmer kontaktknapp efter att kunden skapats');
          }
        } catch (err) {
          console.error('❌ Misslyckades spara kontaktdata:', err);
        }
      });
    }
  });

  // --- Nya funktioner för API-anrop och fälthantering ---
  async function fetchAndUpdateCustomerState(email, meetingType) {
    const cltEmail = document.getElementById('clt_email');
    const cltMeetingType = document.getElementById('clt_meetingtype');
    const cltMeetingLength = document.getElementById('clt_meetinglength');
    const cltContactId = document.getElementById('clt_contact_id');

    if (cltEmail) cltEmail.value = email;
    if (cltMeetingType) {
      cltMeetingType.value = meetingType;
      console.log('📥 Satt cltMeetingType från fetchAndUpdateCustomerState:', cltMeetingType.value);
    }

    const response = await fetch('https://macspotbackend.azurewebsites.net/api/validate_contact', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, meeting_type: meetingType })
    });
    const data = await response.json();

    const idFromResponse = [data.contact_id, data.id].find(v => typeof v === 'string' && v.length > 10) || '';
    if (cltContactId) cltContactId.value = idFromResponse;

    return data;
  }

  function updateCustomerFieldVisibilityAndState(data, meetingType) {
    const submitButton = document.getElementById('contact-update-button');
    // Dölj submit-knappen direkt efter den definierats
    if (submitButton) {
      submitButton.style.display = 'none';
      submitButton.style.opacity = '0';
      submitButton.style.pointerEvents = 'none';
      submitButton.style.visibility = 'hidden';
    }
    const cltEmail = document.getElementById('clt_email');
    const cltMeetingType = document.getElementById('clt_meetingtype');
    const cltMeetingLength = document.getElementById('clt_meetinglength');
    const cltContactId = document.getElementById('clt_contact_id');
    const cltReady = document.getElementById('clt_ready');
    const emailEl = document.querySelector('#booking_email');
    const meetingLengthEl = document.querySelector('input[name="meeting_length"]:checked');
    const meetingLength = meetingLengthEl ? meetingLengthEl.value : '';
    const addressField = document.querySelector('#address_fields');
    const allFieldIds = ['first_name', 'last_name', 'phone', 'company', 'address', 'postal_code', 'city', 'country'];
    const fieldLabels = {
      first_name: 'Förnamn',
      last_name: 'Efternamn',
      phone: 'Telefonnummer',
      company: 'Företag',
      address: 'Gatuadress',
      postal_code: 'Postnummer',
      city: 'Stad',
      country: 'Land'
    };
    const allFields = allFieldIds.map(id => document.getElementById(id)).filter(Boolean);
    const missingFieldsContainer = document.getElementById('missing_fields_messages');
    if (missingFieldsContainer) missingFieldsContainer.innerHTML = '';

    // Döljer alla kontaktfält och address_fields
    allFields.forEach(f => {
      f.classList.add('hidden');
      f.classList.remove('needs-filling');
      f.style.display = 'none';
    });
    if (addressField) addressField.style.display = 'none';

    // Visa alltid dessa fält om kunden är ny eller har missing_fields
    const alwaysShow = ['first_name', 'last_name', 'phone', 'company'];
    allFields.forEach(input => {
      const fieldName = input.id;
      const isAddressField = ['address', 'postal_code', 'city', 'country'].includes(fieldName);
      const shouldShow = data.status === 'new_customer' && alwaysShow.includes(fieldName);
      const isMissing = data.missing_fields && data.missing_fields.includes(fieldName);
      const showField = shouldShow || isMissing;
      if (showField) {
        input.classList.remove('hidden');
        input.classList.add('needs-filling');
        input.style.display = 'block';
        if (missingFieldsContainer && isMissing) {
          const p = document.createElement('p');
          p.className = 'missing-field-message';
          p.textContent = `Saknat fält: ${fieldLabels[fieldName] || fieldName}`;
          missingFieldsContainer.appendChild(p);
        }
      }
    });

    // Visa #address_fields om meetingType === 'atclient' och (ny kund eller någon adress i missing_fields)
    const addressFieldIds = ['address', 'postal_code', 'city', 'country'];
    const addressRequired =
      meetingType === 'atclient' &&
      (
        data.status === 'new_customer' ||
        (data.missing_fields && addressFieldIds.some(id => data.missing_fields.includes(id)))
      );
    if (addressRequired && addressField) {
      addressField.style.display = 'block';
      console.log('✅ Visar #address_fields pga atclient + ny kund eller missing_fields');
    }

    // Visa knapp baserat på status och om alla synliga fält är ifyllda
    if (submitButton) {
      if (data.status === 'new_customer') {
        submitButton.style.display = 'flex';
        submitButton.style.opacity = '1';
        submitButton.style.pointerEvents = 'auto';
        submitButton.style.visibility = 'visible';
        if (submitButton.tagName === 'INPUT') {
          submitButton.value = 'Skapa';
        } else {
          submitButton.textContent = 'Skapa';
        }
        console.log('🆕 Ny kund – visa "Skapa" knapp');
      } else if (data.status === 'existing_customer' && Array.isArray(data.missing_fields) && data.missing_fields.length > 0) {
        submitButton.style.display = 'flex';
        submitButton.style.opacity = '1';
        submitButton.style.pointerEvents = 'auto';
        submitButton.style.visibility = 'visible';
        if (submitButton.tagName === 'INPUT') {
          submitButton.value = 'Uppdatera';
        } else {
          submitButton.textContent = 'Uppdatera';
        }
        console.log('✏️ Befintlig kund med saknade fält – visa "Uppdatera" knapp');
      } else {
        // submitButton already hidden above
        console.log('✅ Befintlig kund komplett – göm knapp');
      }
    }

    // Kontrollera att alla dolda fält är ifyllda
    const allCltFieldsFilled =
      cltEmail && String(cltEmail.value).trim() &&
      cltMeetingType && String(cltMeetingType.value).trim() &&
      cltMeetingLength && String(cltMeetingLength.value).trim() &&
      cltContactId && typeof cltContactId.value === 'string' && cltContactId.value.trim();
    if (!allCltFieldsFilled) {
      // Specifik logg när cltContactId.value saknas
      if (!cltContactId || !cltContactId.value.trim()) {
        console.warn('⚠️ clt_ready = false p.g.a: cltContactId.value saknas', {
          cltEmail: cltEmail?.value,
          cltMeetingType: cltMeetingType?.value,
          cltMeetingLength: cltMeetingLength?.value,
          cltContactId: cltContactId?.value
        });
      } else {
        console.warn('⚠️ clt_ready = false p.g.a: clt-fält saknas – detaljer:', {
          cltEmail: cltEmail?.value,
          cltMeetingType: cltMeetingType?.value,
          cltMeetingLength: cltMeetingLength?.value,
          cltContactId: cltContactId?.value
        });
      }
    }
    console.log('🧪 Kontroll av clt-fält:',
      {
        cltEmail: cltEmail?.value,
        cltMeetingType: cltMeetingType?.value,
        cltMeetingLength: cltMeetingLength?.value,
        cltContactId: cltContactId?.value
      }
    );

    // Kontrollera att alla synliga kontaktfält är ifyllda
    // Använd getComputedStyle för att säkert avgöra synlighet
    const visibleInputs = allFields.filter(el => el && window.getComputedStyle(el).display !== 'none');
    const allVisibleContactFieldsFilled = visibleInputs.every(input => input.value.trim());
    visibleInputs.forEach(input => {
      console.log(`🔍 Synligt fält: #${input.id} = "${input.value.trim()}"`);
    });

    if (allCltFieldsFilled && allVisibleContactFieldsFilled) {
      if (cltReady) {
        cltReady.value = 'true';
        // Sätt window.formState så att det alltid finns vid knapptryckning
        window.formState = {
          email: emailEl ? emailEl.value.trim() : '',
          meeting_type: meetingType,
          meeting_length: parseInt(meetingLength, 10),
          contact_id: cltContactId?.value || '',
          metadata: {
            first_name: document.getElementById('first_name')?.value || '',
            last_name: document.getElementById('last_name')?.value || '',
            phone: document.getElementById('phone')?.value || '',
            company: document.getElementById('company')?.value || '',
            address: document.getElementById('address')?.value || '',
            postal_code: document.getElementById('postal_code')?.value || '',
            city: document.getElementById('city')?.value || '',
            country: document.getElementById('country')?.value || ''
          }
        };
        // Lägg till källa för formState
        window.formState.source = 'frontend';
        // Döljer submit-knappen direkt när clt_ready = true (skapande/uppdatering klar)
        if (submitButton) {
          submitButton.style.display = 'none';
          submitButton.style.opacity = '0';
          submitButton.style.pointerEvents = 'none';
          submitButton.style.visibility = 'hidden';
          console.log('🚫 Gömmer knapp efter skapande eller uppdatering');
        }
        console.log('✅ formState satt:', window.formState);
        console.log('✅ Alla kund- och kontaktfält ifyllda, satt #clt_ready = true');
        // KOPPLAR Block 1 till Block 2: initiera slot-fetch om funktionen finns
        if (window.initAvailableSlotFetch) {
          window.initAvailableSlotFetch();
          console.log('📡 initAvailableSlotFetch() anropad från Block 1');
        } else {
          console.warn('⚠️ initAvailableSlotFetch() saknas – se till att Block 2 är laddad');
          setTimeout(() => {
            if (window.initAvailableSlotFetch) {
              window.initAvailableSlotFetch();
              console.log('📡 initAvailableSlotFetch() kördes via fallback');
            } else {
              console.warn('❌ initAvailableSlotFetch() saknas fortfarande efter timeout');
            }
          }, 500);
        }
      }
    } else {
      const debugMissing = [];
      if (!allCltFieldsFilled) debugMissing.push('clt-fält saknas');
      if (!allVisibleContactFieldsFilled) debugMissing.push('synliga kontaktfält saknas');
      console.warn('⚠️ clt_ready = false p.g.a:', debugMissing.join(' + '));
      if (cltReady) {
        cltReady.value = 'false';
        console.log('⚠️ Saknas ifyllda kontaktfält, satt #clt_ready = false');
      }
    }

    // Lägg till logg för slutstatus för clt-fält
    console.log('🧪 Slutstatus clt-fält:', {
      clt_email: cltEmail?.value,
      clt_meetingtype: cltMeetingType?.value,
      clt_meetinglength: cltMeetingLength?.value,
      clt_contact_id: cltContactId?.value,
      clt_ready: cltReady?.value
    });
  }
</script>
END: Embed Block 1.js

====================
📄 Fil: frontend_webflow/Embed Block 2.js
📂 Kodtyp: 📄 Övrigt
🗂 Filtyp: 🟨 JavaScript
📅 Senast ändrad: 2025-05-16 09:24:16
📏 Antal rader: 75
🧩 Antal funktioner: 0
💬 Kommentarstäckning: 1 rader (1.3%)
📥 Imports: 0 – Inga
🔍 Längsta funktion: 0 rader
🧠 Komplexitetspoäng: 8
🧪 TODO/FIXME: 0
====================
START: Embed Block 2.js
<script>
window.initAvailableSlotFetch = function() {
  const cltReady = document.getElementById('clt_ready')?.value;
  if (cltReady !== 'true' || !window.formState) {
    console.warn('❌ Kan inte hämta tillgängliga tider – formState eller clt_ready saknas');
    return;
  }

  console.log('📡 Hämtar tillgängliga tider för:', window.formState);
  if (!window.formState.contact_id) {
    console.warn('⚠️ contact_id saknas i formState – fetch avbryts');
  }

  fetch('https://macspotbackend.azurewebsites.net/api/getavailableslots', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      email: window.formState.email,
      meeting_type: window.formState.meeting_type,
      meeting_length: window.formState.meeting_length,
      contact_id: window.formState.contact_id
    })
  })
  .then(res => res.json())
  .then(data => {
    console.log('🧪 Rått slotData från API:', data);
    if (!Array.isArray(data.slots)) {
      console.warn('⚠️ API svarar utan slot-array:', data);
    }
    if (Array.isArray(data.slots)) {
      const grouped = {};
      data.slots.forEach(slot => {
        const localDate = new Date(slot.slot_iso);
        const localYear = localDate.getFullYear();
        const localMonth = String(localDate.getMonth() + 1).padStart(2, '0');
        const localDay = String(localDate.getDate()).padStart(2, '0');
        const date = `${localYear}-${localMonth}-${localDay}`;
        if (!grouped[date]) grouped[date] = [];
        grouped[date].push({
          slot_iso: slot.slot_iso,
          slot_local: slot.slot_local || slot.slot_iso
        });
      });
      console.log('📦 Skickar grouped slots till setAvailableSlots:', grouped);
      if (typeof window.setAvailableSlots === 'function') {
        window.setAvailableSlots(grouped);
      } else {
        console.warn('⚠️ setAvailableSlots() saknas – kontrollera att kalendermodul är laddad');
      }
    } else {
      console.warn('⚠️ Ogiltigt slotData-format:', data);
    }
  })
  .catch(err => {
    console.error('❌ Fetch error in getavailableslots:', err.message || err);
    alert('Fel vid hämtning av tider. Kontrollera din internetanslutning eller att servern är tillgänglig.');
  });
};

window.setAvailableSlots = function(groupedSlots) {
  console.log('🧠 [Kod 2b] setAvailableSlots anropad med:', groupedSlots);
  console.log('🧠 [Kod 2b] window.formState:', window.formState);
  if (!window.CalendarModule || typeof window.CalendarModule.renderCalendar !== 'function') {
    return;
  }

  // Konvertera groupedSlots från {datum: [{slot_iso, slot_local}]} till {datum: [slot_local]}
  const reformatted = {};
  for (const [date, slots] of Object.entries(groupedSlots)) {
    reformatted[date] = slots.map(slot => slot.slot_local || slot.slot_iso);
  }

  window.CalendarModule.renderCalendar(reformatted);
};
</script>
END: Embed Block 2.js

====================
📄 Fil: frontend_webflow/Embed Block 2b.js
📂 Kodtyp: 📄 Övrigt
🗂 Filtyp: 🟨 JavaScript
📅 Senast ändrad: 2025-05-16 09:42:15
📏 Antal rader: 422
🧩 Antal funktioner: 2
💬 Kommentarstäckning: 30 rader (7.1%)
📥 Imports: 0 – Inga
🔍 Längsta funktion: 14 rader
🧠 Komplexitetspoäng: 49
🧪 TODO/FIXME: 0
====================
START: Embed Block 2b.js
<script>
  window.getISOWeek = function(date) {
    const tempDate = new Date(date.getTime());
    tempDate.setHours(0, 0, 0, 0);
    tempDate.setDate(tempDate.getDate() + 3 - ((tempDate.getDay() + 6) % 7));
    const week1 = new Date(tempDate.getFullYear(), 0, 4);
    return 1 + Math.round(((tempDate.getTime() - week1.getTime()) / 86400000 - 3 + ((week1.getDay() + 6) % 7)) / 7);
  };

  window.CalendarModule = {
    // Hjälpfunktion: format YYYY-MM-DD
    formatDate: function(date) {
      return date.toLocaleDateString('sv-SE').replaceAll('.', '-');
    },

    highlightDate: function(selectedDayEl) {
      const calendarWrapper = document.getElementById('calendar_wrapper');
      const dayEls = calendarWrapper ? [document.getElementById('calendar_day')] : [];
      // Remove 'selected' from all Day elements by class
      const allDayEls = calendarWrapper ? calendarWrapper.querySelectorAll('.day') : [];
      allDayEls.forEach(el => {
        el.classList.remove('selected');
      });
      selectedDayEl.classList.add('selected');
      selectedDayEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
    },

    renderTimes: function(times, currentMonth) {
      if (!Array.isArray(times) || times.length === 0) {
        return;
      }
      if (!(currentMonth instanceof Date) || isNaN(currentMonth.getTime())) {
        return;
      }
      // Sort times array before rendering
      times = times.sort((a, b) => {
        // If slot_local exists, compare those, otherwise compare as strings
        const aStr = a.slot_local || (typeof a === 'string' ? a : '');
        const bStr = b.slot_local || (typeof b === 'string' ? b : '');
        return aStr.localeCompare(bStr);
      });

      const wrapper = document.getElementById('calendar_time_wrapper');
      const selectedDateEl = document.getElementById('selected_date');
      const timeGrid = document.getElementById('time_grid');
      const submitButton = document.getElementById('submit-booking-button');

      if (!wrapper || !selectedDateEl || !timeGrid || !submitButton) {
        return;
      }

      // Sätt submitButton till hidden
      submitButton.style.display = 'none';
      submitButton.style.opacity = '0';
      submitButton.style.pointerEvents = 'none';
      submitButton.style.visibility = 'hidden';

      // Visa wrapper
      wrapper.style.display = 'block';

      // Rensa föregående visning
      const selectedDayEl = document.querySelector('.day.selected');
      if (selectedDayEl) {
        selectedDayEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }

      if (!selectedDayEl || !selectedDayEl.textContent) {
        console.warn('⚠️ selectedDayEl saknas eller saknar textContent');
        return;
      }
      const selectedDay = selectedDayEl.textContent.padStart(2, '0');
      const year = currentMonth.getFullYear();
      const month = String(currentMonth.getMonth() + 1).padStart(2, '0');
      const date = new Date(`${year}-${month}-${selectedDay}`);
      const weekday = date.toLocaleDateString('sv-SE', { weekday: 'long' });
      const formatted = `${weekday.charAt(0).toUpperCase() + weekday.slice(1)} ${selectedDay} ${date.toLocaleDateString('sv-SE', { month: 'short' })}`;
      selectedDateEl.textContent = `${formatted}`;

      // Hämta alla .timeitems
      const timeItems = timeGrid.querySelectorAll('.timeitems');

      // Rensa alla
      timeItems.forEach(el => {
        let label = el.querySelector('.time-label');
        if (!label) label = el.querySelector('span.w-form-label');
        if (label) label.textContent = '';
        el.classList.remove('selected');
        el.style.display = 'none';
      });

      // Fyll tider
      times.forEach((slot, index) => {
        if (index >= timeItems.length) return;
        const el = timeItems[index];

        const uniqueId = `radio-${index}`;
        const radioInput = el.querySelector('input[type="radio"]');
        let label = el.querySelector('.time-label');
        if (!label) label = el.querySelector('span.w-form-label');

        const labelText = typeof slot === 'object' && slot.slot_local
          ? slot.slot_local.slice(11, 16)
          : typeof slot === 'string'
          ? slot.slice(11, 16)
          : '';

        if (label) {
          // Ensure the label has the 'time-label' class
          if (!label.classList.contains('time-label')) {
            label.classList.add('time-label');
          }
          label.textContent = labelText;
          label.setAttribute('for', uniqueId);
        }

        if (radioInput) {
          radioInput.value = slot.slot_iso || slot;
          radioInput.id = uniqueId;
          radioInput.name = 'meeting_time';
          radioInput.dataset.slotIso = slot.slot_iso || slot;
        }

        el.dataset.slotIso = slot.slot_iso || slot;
        el.style.display = 'block';
        el.onclick = () => {
          timeItems.forEach(t => t.classList.remove('selected'));
          el.classList.add('selected');

          if (!window.formState) window.formState = {};
          window.formState.slot_iso = slot.slot_iso || slot;
          window.formState.meeting_time = labelText;

          const slotIsoEl = document.getElementById('clt_slot_iso');
          if (slotIsoEl) slotIsoEl.textContent = slot.slot_iso || slot;

          const bookingButton = document.getElementById('submit-booking-button');
          if (bookingButton) {
            bookingButton.style.display = 'flex';
            bookingButton.style.opacity = '1';
            bookingButton.style.pointerEvents = 'auto';
            bookingButton.style.visibility = 'visible';
            if (bookingButton.tagName === 'INPUT') {
              bookingButton.value = 'Boka';
            } else {
              bookingButton.textContent = 'Boka';
            }
          }
          const cltReadyEl = document.getElementById('clt_ready');
          const cltMeetingTimeEl = document.getElementById('clt_meetingtime');
          if (cltMeetingTimeEl) cltMeetingTimeEl.value = slot.slot_iso || slot;
          if (cltReadyEl) cltReadyEl.value = 'true';
        };
      });

      // Visa bokningsknappen när en slot väljs via radio
      // (Eventlistener för radio borttagen då den är redundant och felaktig)
    },

    renderCalendar: function(availableSlots, currentMonth) {
      if (!(currentMonth instanceof Date) || isNaN(currentMonth.getTime())) {
        return;
      }
      const currentMonthKey = currentMonth.getFullYear() + '-' + currentMonth.getMonth();
      const calendarWrapper = document.getElementById('calendar_wrapper');
      if (!calendarWrapper) return;
      const monthStr = String(currentMonth.getMonth() + 1).padStart(2, '0');
      const yearStr = String(currentMonth.getFullYear());


      // Preserve calendar_times before resetting innerHTML
      const calendarTimes = document.getElementById('calendar_times');
      const shouldRestoreTimes = !!calendarTimes;

      // Reset wrapper
      // calendarWrapper.innerHTML = '';

      // Hantera header manuellt i Webflow – endast återställ innehåll om wrapper finns
      const existingHeaderWrapper = document.getElementById('calendar_header');
      if (existingHeaderWrapper) {
        existingHeaderWrapper.innerHTML = '';
        // Add optional dynamic header content here if needed
      }

      // month/year label and arrow handlers
      const monthEl = document.getElementById('calendar_month');
      if (monthEl) {
        monthEl.textContent = currentMonth.toLocaleString('sv-SE', { month: 'long', year: 'numeric' });
      }

      // Pilhantering i renderCalendar för att alltid binda korrekt
      const leftArrow = document.getElementById('cal_arrow_left');
      const rightArrow = document.getElementById('cal_arrow_right');
      if (leftArrow && rightArrow) {
        leftArrow.onclick = () => {
          const newMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() - 1);
          window.CalendarModule.renderCalendar(availableSlots, newMonth);
        };
        rightArrow.onclick = () => {
          const newMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1);
          window.CalendarModule.renderCalendar(availableSlots, newMonth);
        };
        // Gör pilarna till "pointer" vid hover
        leftArrow.style.cursor = 'pointer';
        rightArrow.style.cursor = 'pointer';
      }
      if (monthEl) {
        monthEl.onclick = () => {
          const today = new Date();
          window.CalendarModule.renderCalendar(window.latestAvailableSlots, today);
        };
        monthEl.style.cursor = 'pointer';
      }

      // Grid container
      const grid = document.getElementById('calendar_grid');
      if (!grid) {
        return;
      }
      // Update existing .weeklabel elements instead of recreating header row
      const weekLabelEls = grid.querySelectorAll('.weeklabel');
      const weekNumberEls = grid.querySelectorAll('.weeknumber');
      const dayEls = grid.querySelectorAll('.day');

      const labels = ['', 'M', 'T', 'O', 'T', 'F', 'L', 'S'];
      weekLabelEls.forEach((el, index) => {
        el.textContent = labels[index] || '';
      });

      // Date range setup
      const firstDay = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), 1);
      const lastDay = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 0);
      const jsDay = firstDay.getDay();
      const startOffset = jsDay === 0 ? 6 : jsDay - 1;
      const totalDays = startOffset + lastDay.getDate();
      // Always show dynamic number of weeks based on days
      const numWeeks = Math.ceil((startOffset + lastDay.getDate()) / 7);

      // (Ingen logg om weeknumber/day-element)

      const maxDayElements = dayEls.length;

      let dayIndex = 0;
      for (let week = 0; week < numWeeks; week++) {
        const monday = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), 1 - startOffset + week * 7);
        const weekNumber = window.getISOWeek(monday);
        if (week < weekNumberEls.length) {
          weekNumberEls[week].textContent = 'v' + weekNumber;
        }

        for (let wd = 0; wd < 7; wd++) {
          const gridIndex = week * 7 + wd;
          if (dayIndex >= maxDayElements) {
            break;
          }
          const dayEl = dayEls[dayIndex];
          if (!dayEl) {
            continue;
          }
          const cellDate = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), 1 - startOffset + gridIndex);
          if (cellDate.getMonth() !== currentMonth.getMonth()) {
            dayEl.textContent = '';
            dayEl.removeAttribute('data-date');
            dayEl.classList.remove('today', 'available', 'selected');
            dayIndex++;
            continue;
          } else {
            const isoDate = window.CalendarModule.formatDate(cellDate);
            if (!availableSlots) {
              return;
            }
            dayEl.textContent = cellDate.getDate();
            dayEl.dataset.date = isoDate;

            const isToday = cellDate.toDateString() === new Date().toDateString();
            dayEl.classList.toggle('today', isToday);

            const isAvailable = availableSlots[isoDate]?.length > 0;
            dayEl.classList.toggle('available', isAvailable);

            if (isAvailable) {
              const cloned = dayEl.cloneNode(true);
              dayEl.replaceWith(cloned);

              cloned.addEventListener('click', () => {
                window.CalendarModule.highlightDate(cloned);
                window.CalendarModule.renderTimes(availableSlots[isoDate], currentMonth);
                window.userHasManuallySelectedDate = true;
              });

              // Förvälj första tillgängliga dag om ingen är vald
              if (!document.querySelector('.day.selected')) {
                cloned.classList.add('selected');
                cloned.scrollIntoView({ behavior: 'smooth', block: 'center' });
                window.CalendarModule.renderTimes(availableSlots[isoDate], currentMonth);
                window.initialSlotRendered = true;
                window.lastRenderedMonth = currentMonthKey;
              }

              if (
                !window.userHasManuallySelectedDate &&
                (!window.initialSlotRendered || window.lastRenderedMonth !== currentMonthKey)
              ) {
                window.initialSlotRendered = true;
                window.lastRenderedMonth = currentMonthKey;
                window.CalendarModule.highlightDate(dayEl);
                window.CalendarModule.renderTimes(availableSlots[isoDate], currentMonth);
              }
            }
            dayIndex++;
          }
        }
      }

      for (let i = numWeeks; i < weekNumberEls.length; i++) {
        weekNumberEls[i].textContent = '';
      }

      // Töm alla .day efter sista dayIndex
      for (let i = dayIndex; i < dayEls.length; i++) {
        const el = dayEls[i];
        el.textContent = '';
        el.removeAttribute('data-date');
        el.classList.remove('today', 'available', 'selected');
      }

      if (shouldRestoreTimes && !calendarWrapper.contains(calendarTimes)) {
        calendarWrapper.appendChild(calendarTimes);
      }
    }
  };

window.setAvailableSlots = function(groupedSlots) {
  if (!window.CalendarModule || typeof window.CalendarModule.renderCalendar !== 'function') {
    return;
  }
  if (Object.keys(groupedSlots).length === 0) {
    return;
  }

  window.initialSlotRendered = false;
  window.latestAvailableSlots = groupedSlots;

  const firstAvailableDateStr = Object.keys(groupedSlots).sort()[0];
  const firstAvailableDate = new Date(firstAvailableDateStr);
  window.firstAvailableDate = firstAvailableDate;

  const monthLabel = document.getElementById('calendar_month');
  if (monthLabel) {
    monthLabel.textContent = firstAvailableDate.toLocaleString('sv-SE', { month: 'long', year: 'numeric' });
  }

  const wrapper = document.getElementById('calendar_wrapper');
  if (wrapper) wrapper.style.display = 'flex';

  const grid = document.getElementById('calendar_grid');
  if (grid) {
    window.CalendarModule.renderCalendar(groupedSlots, firstAvailableDate);
  } else {
    const waitForCalendarGrid = setInterval(() => {
      const g = document.getElementById('calendar_grid');
      if (g) {
        clearInterval(waitForCalendarGrid);
        window.CalendarModule.renderCalendar(groupedSlots, firstAvailableDate);
      }
    }, 100);
  }
};

  // Vänta på att #calendar_wrapper laddas in i DOM
  let waitForCalendarWrapper2b = setInterval(() => {
    const calendarWrapper = document.getElementById('calendar_wrapper');
    if (calendarWrapper) {
      clearInterval(waitForCalendarWrapper2b);
      let waitForCalendarGrid = setInterval(() => {
        const grid = document.getElementById('calendar_grid');
        if (grid) {
          clearInterval(waitForCalendarGrid);
          if (window.latestAvailableSlots && window.firstAvailableDate) {
            window.CalendarModule.renderCalendar(window.latestAvailableSlots, window.firstAvailableDate);
          }
        }
      }, 100);
    }
  }, 100);
// --- Inserted CSS for today and available day styling ---
const calendarStyle = document.createElement('style');
calendarStyle.textContent = `
.day.today,
.day.available,
.day.available.selected {
  display: flex;
  width: 100%;
  height: 100%;
  aspect-ratio: 1 / 1;
  border-radius: 50%;
  align-items: center;
  justify-content: center;
}

.day.today {
  border: 1px solid #B2B2B2;
}

.day.available {
  background-color: #B2B2B2;
  color: #F5F5F5;
  cursor: pointer;
}

.day.available:hover {
  background-color: #e9a56f;
  color: #F5F5F5;
}

.day.available.selected {
  background-color: #e9a56f;
  color: #F5F5F5;
  border: 1px solid #B2B2B2;
}
`;
document.head.appendChild(calendarStyle);
</script>
END: Embed Block 2b.js

====================
📄 Fil: frontend_webflow/Embed Block 3.js
📂 Kodtyp: 📄 Övrigt
🗂 Filtyp: 🟨 JavaScript
📅 Senast ändrad: 2025-05-16 09:15:38
📏 Antal rader: 93
🧩 Antal funktioner: 3
💬 Kommentarstäckning: 0 rader (0.0%)
📥 Imports: 0 – Inga
🔍 Längsta funktion: 5 rader
🧠 Komplexitetspoäng: 10
🧪 TODO/FIXME: 0
====================
START: Embed Block 3.js
<script>
  async function submitBooking(data) {
    if (!data.contact_id || !data.slot_iso || !data.meeting_type || !data.meeting_length) {
      return;
    }

    const startTime = new Date(data.slot_iso);
    const endTime = new Date(startTime.getTime() + data.meeting_length * 60000);

    const payload = {
      contact_id: data.contact_id,
      meeting_type: data.meeting_type,
      meeting_length: data.meeting_length,
      start_time: startTime.toISOString(),
      end_time: endTime.toISOString(),
      slot_iso: data.slot_iso
    };

    try {
      const response = await fetch('https://macspotbackend.azurewebsites.net/api/bookings', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      if (!response.ok) {
        const errorData = await response.json();
        alert('Bokningen misslyckades: ' + (errorData?.error || 'okänt fel'));
        return;
      }

      alert('Tack! Din bokning är genomförd.');
    } catch (error) {
      alert('Fel vid bokning, försök igen senare.');
    }
  }
  if (typeof window.submitBooking !== 'function') {
    window.submitBooking = submitBooking;
  }

  function initBookingButtonListener() {
    const btn = document.getElementById('submit-booking-button');
    if (!btn) return;

    btn.addEventListener('click', (e) => {
      e.preventDefault();

      const cltReadyEl = document.getElementById('clt_ready');
      const cltContactIdEl = document.getElementById('clt_contact_id');
      const cltMeetingTypeEl = document.getElementById('clt_meetingtype');
      const cltMeetingLengthEl = document.getElementById('clt_meetinglength');
      const cltSlotIsoEl = document.getElementById('clt_meetingtime');

      const cltContactId = cltContactIdEl?.value.trim();
      const cltMeetingType = cltMeetingTypeEl?.value.trim();
      const cltMeetingLength = parseInt(cltMeetingLengthEl?.value, 10);
      const cltSlotIso = cltSlotIsoEl?.value.trim();
      const cltReady = cltReadyEl?.value.trim();

      if (!cltContactId || !cltMeetingType || isNaN(cltMeetingLength) || !cltSlotIso || cltReady !== 'true') {
        return;
      }

      const bookingPayload = {
        contact_id: cltContactId,
        meeting_type: cltMeetingType,
        meeting_length: cltMeetingLength,
        slot_iso: cltSlotIso
      };

      submitBooking(bookingPayload);
    });
  }
  if (typeof window.initBookingButtonListener !== 'function') {
    window.initBookingButtonListener = initBookingButtonListener;
  }

  window.addEventListener('DOMContentLoaded', () => {
    try {
      if (document.getElementById('calendar_grid')) {
        initBookingButtonListener();
      } else {
        const interval = setInterval(() => {
          if (document.getElementById('calendar_grid')) {
            clearInterval(interval);
            initBookingButtonListener();
          }
        }, 100);
      }
    } catch (err) {
    }
  });
</script>
END: Embed Block 3.js

📁 KONFIGURATIONSFILER (function.json / host.json / package.json / .funcignore)
====================================

📄 .funcignore
   # Exclude dev-only files and folders
   .git
   .vscode
   .env
   *.log
   test/
   tests/
   
   # Explicitly include all required files and folders
   !host.json
   !package.json
   !package-lock.json
   
   !node_modules/
   !node_modules/**
   
   !shared/
   !shared/**
   
   !bookings/
   !bookings/**
   !getavailableslots/
   !getavailableslots/**
   !validate_contact/
   !validate_contact/**
   !meeting_types/
   !meeting_types/**
   !refreshCalendarOrigins/
   !refreshCalendarOrigins/**
   !refreshTravelTimes/
   !refreshTravelTimes/**
📄 bookings/function.json
   {
     "bindings": [
       {
         "authLevel": "anonymous",
         "type": "httpTrigger",
         "direction": "in",
         "name": "req",
         "methods": ["post", "options"],
         "route": "bookings"
       },
       {
         "type": "http",
         "direction": "out",
         "name": "res"
       }
     ],
     "scriptFile": "index.js"
   }
📄 getavailableslots/function.json
   {
     "bindings": [
       {
         "authLevel": "anonymous",
         "type": "httpTrigger",
         "direction": "in",
         "name": "req",
         "methods": ["post", "options"],
         "route": "getavailableslots"
       },
       {
         "type": "http",
         "direction": "out",
         "name": "res"
       }
     ],
     "scriptFile": "index.js"
   }
📄 host.json
   {
     "version": "2.0",
     "extensionBundle": {
       "id": "Microsoft.Azure.Functions.ExtensionBundle",
       "version": "[4.*, 5.0.0)"
     },
     "extensions": {
       "http": {
         "cors": {
           "allowedOrigins": [
             "https://www.klrab.se"
           ],
           "supportCredentials": false
         }
       }
     }
   }
📄 meeting_types/function.json
   {
     "bindings": [
       {
         "authLevel": "anonymous",
         "type": "httpTrigger",
         "direction": "in",
         "name": "req",
         "methods": [ "get" ],
         "route": "meeting_types"
       },
       {
         "type": "http",
         "direction": "out",
         "name": "res"
       }
     ],
     "scriptFile": "index.js"
   }
📄 package.json
   {
     "name": "macspot-api",
     "version": "1.0.0",
     "description": "Azure Functions backend för MacSpot CRM/ERP",
     "scripts": {
       "start": "func start",
       "dev": "func start --verbose",
       "deploy": "func azure functionapp publish macspotbackend",
       "build": "echo 'Nothing to build'"
     },
     "dependencies": {
       "@azure/functions": "^4.7.0",
       "@azure/msal-node": "^3.5.1",
       "@microsoft/microsoft-graph-client": "^3.0.0",
       "dav": "^1.8.0",
       "dotenv": "^16.5.0",
       "isomorphic-fetch": "^3.0.0",
       "jsonwebtoken": "^9.0.0",
       "luxon": "^3.4.4",
       "node-fetch": "^2.7.0",
       "node-ical": "^0.20.1",
       "p-limit": "^6.2.0",
       "pg": "^8.15.6",
       "uuid": "^9.0.0",
       "xml2js": "^0.6.2"
     }
   }

📄 refreshCalendarOrigins/function.json
   {
     "bindings": [
       {
         "name": "myTimer",
         "type": "timerTrigger",
         "direction": "in",
         "schedule": "0 0 * * * *"
       }
     ],
     "scriptFile": "index.js"
   }
📄 refreshTravelTimes/function.json
   {
     "bindings": [
       {
         "name": "myTimer",
         "type": "timerTrigger",
         "direction": "in",
         "schedule": "0 0 * * * *"
       }
     ],
     "scriptFile": "index.js"
   }
📄 validate_contact/function.json
   {
     "bindings": [
       {
         "authLevel": "anonymous",
         "type": "httpTrigger",
         "direction": "in",
         "name": "req",
         "methods": ["post"],
         "route": "validate_contact"
       },
       {
         "type": "http",
         "direction": "out",
         "name": "res"
       }
     ],
     "scriptFile": "index.js"
   }
📈 SUMMERING AV ALLA JS-FILER
====================================
📏 Totalt antal rader kod: 1228
🧩 Totalt antal funktioner: 19
🧠 Total komplexitetspoäng: 130
🧪 Antal TODO/FIXME totalt: 0

📊 Per fil:
fil,rader,funktioner,komplexitet,kommentarer,imports
Embed Block 1.js,638,14,63,38,0
Embed Block 2.js,75,0,8,1,0
Embed Block 2b.js,422,2,49,30,0
Embed Block 3.js,93,3,10,0,0
📊 MOLNDATABAS (Azure) – STRUKTUR & INNEHÅLL
====================================

📁 Tabell: available_slots_cache
  • id (uuid)
  • travel_time_min (integer)
  • generated_at (timestamp without time zone)
  • expires_at (timestamp without time zone)
  • meeting_length (integer)
  • slot_day (date)
  • slot_score (integer)
  • meeting_type (text)
  • slot_part (text)
  • slot_iso (text)
  🔑 [p] available_slots_cache_pkey: PRIMARY KEY (id)

📁 Tabell: slot_cache
  • created_at (timestamp without time zone)
  • slot_day (date)
  • slots (jsonb)
  • id (uuid)
  • meeting_length (integer)
  • booking_email (text)
  • meeting_type (text)
  • slot_part (text)
  🔑 [p] slot_cache_pkey: PRIMARY KEY (id)

📁 Tabell: calendar_origin_cache
  • created_at (timestamp without time zone)
  • timestamp (timestamp with time zone)
  • event_date (date)
  • id (integer)
  • end_time (timestamp without time zone)
  • address (text)
  • source (text)
  🔑 [c] calendar_origin_cache_source_check: CHECK ((source = ANY (ARRAY['Apple Calendar'::text, 'Microsoft 365'::text])))
  🔑 [p] calendar_origin_cache_pkey: PRIMARY KEY (id)
  🧪 Topp 5 rader:
    - id=71, event_date=2025-05-21, source=Apple Calendar, address=–, end_time=2025-05-21 06:00:00, created_at=2025-05-21 14:43:51.546125, timestamp=2025-05-21 14:43:51.546125+00:00
    - id=72, event_date=2025-05-23, source=Apple Calendar, address=–, end_time=2025-05-23 06:00:00, created_at=2025-05-21 14:43:55.076780, timestamp=2025-05-21 14:43:55.076780+00:00
    - id=73, event_date=2025-05-26, source=Apple Calendar, address=–, end_time=2025-05-26 06:00:00, created_at=2025-05-21 14:43:56.126523, timestamp=2025-05-21 14:43:56.126523+00:00
    - id=74, event_date=2025-06-02, source=Apple Calendar, address=–, end_time=2025-06-02 06:00:00, created_at=2025-05-21 14:44:04.998700, timestamp=2025-05-21 14:44:04.998700+00:00
    - id=75, event_date=2025-06-09, source=Apple Calendar, address=–, end_time=2025-06-09 06:00:00, created_at=2025-05-21 14:44:13.830924, timestamp=2025-05-21 14:44:13.830924+00:00

📁 Tabell: travel_time_cache
  • travel_minutes (integer)
  • updated_at (timestamp with time zone)
  • is_fallback (boolean)
  • hour (integer)
  • created_at (timestamp with time zone)
  • to_address (text)
  • from_address (text)
  🔑 [u] unique_travel_key: UNIQUE (from_address, to_address, hour)
  🧪 Topp 5 rader:
    - from_address=Taxgatan 4, 115 45 Stockholm, to_address=Maria Skolgata 79A, 118 53 Stockholm, hour=12, travel_minutes=20, created_at=2025-05-19 08:35:30.341217+00:00, updated_at=2025-05-19 08:35:30.341217+00:00, is_fallback=False
    - from_address=Taxgatan 4, 115 45 Stockholm, to_address=Maria Skolgata 79A, 118 53 Stockholm, hour=8, travel_minutes=22, created_at=2025-05-19 08:51:46.047719+00:00, updated_at=2025-05-19 08:51:46.047719+00:00, is_fallback=False
    - from_address=Taxgatan 4, 115 45 Stockholm, to_address=Maria Skolgata 79A, 118 53 Stockholm, hour=10, travel_minutes=23, created_at=2025-05-19 12:00:01.057723+00:00, updated_at=2025-05-19 12:00:01.057723+00:00, is_fallback=False
    - from_address=Taxgatan 4, 115 45 Stockholm, to_address=Maria Skolgata 79A, 118 53 Stockholm, hour=14, travel_minutes=23, created_at=2025-05-19 12:00:01.639717+00:00, updated_at=2025-05-19 12:00:01.639717+00:00, is_fallback=False

📁 Tabell: event_log
  • received_at (timestamp with time zone)
  • record_id (uuid)
  • timestamp (timestamp with time zone)
  • booking_id (uuid)
  • id (uuid)
  • payload (jsonb)
  • action (text)
  • event_type (text)
  • source (text)
  • table_name (text)
  🔑 [p] event_log_pkey: PRIMARY KEY (id)
  🧪 Topp 5 rader:
    - source=None, event_type=None, payload=None, received_at=2025-05-16 09:40:53.307336+00:00, id=903c2758-e7e6-4f11-9a31-1871596e195c, action=INSERT, table_name=contact, record_id=c4e2d9dd-545e-4e05-99fe-16d377a87698, timestamp=2025-05-16 09:40:53.307336+00:00, booking_id=None
    - source=None, event_type=booking_created, payload=None, received_at=2025-05-18 11:56:16.897217+00:00, id=fb33d0d1-ff78-4506-82dd-026fd86cd781, action=None, table_name=None, record_id=None, timestamp=2025-05-18 11:56:16.897217+00:00, booking_id=fb6b2112-8dbf-4bed-aba4-c2882989db21
    - source=None, event_type=booking_created, payload=None, received_at=2025-05-18 12:06:54.686150+00:00, id=89690767-0414-4c48-b61d-8f9d350718e5, action=None, table_name=None, record_id=None, timestamp=2025-05-18 12:06:54.686150+00:00, booking_id=3ecff74d-cb9c-4e9f-9db5-b0a7b12666ee
    - source=None, event_type=None, payload=None, received_at=2025-05-18 12:32:42.290134+00:00, id=420ca821-9117-46b4-b9cb-6eedef51f4cb, action=INSERT, table_name=contact, record_id=14e1bef9-2833-40d5-b4fe-7576f7cffd6c, timestamp=2025-05-18 12:32:42.290134+00:00, booking_id=None
    - source=None, event_type=None, payload=None, received_at=2025-05-18 12:37:08.028330+00:00, id=931849cb-3a69-4861-83ba-258fe1de5e98, action=UPDATE, table_name=contact, record_id=14e1bef9-2833-40d5-b4fe-7576f7cffd6c, timestamp=2025-05-18 12:37:08.028330+00:00, booking_id=None

📁 Tabell: bookings
  • start_time (timestamp with time zone)
  • end_time (timestamp with time zone)
  • id (uuid)
  • updated_at (timestamp with time zone)
  • metadata (jsonb)
  • created_at (timestamp with time zone)
  • contact_id (uuid)
  • meeting_type (text)
  • booking_email (text)
  🔑 [p] bookings_pkey: PRIMARY KEY (id)
  🔑 [f] fk_bookings_contact: FOREIGN KEY (contact_id) REFERENCES contact(id) ON DELETE SET NULL
  🧪 Topp 5 rader:
    - start_time=2025-05-20 08:00:00+00:00, end_time=2025-05-20 08:20:00+00:00, meeting_type=facetime, metadata={}, created_at=2025-05-18 10:48:56.390000+00:00, contact_id=None, id=378a6541-8e61-465d-a37d-6242ba770dc7, updated_at=2025-05-18 10:48:56.390000+00:00, booking_email=None
    - start_time=2025-05-20 12:00:00+00:00, end_time=2025-05-20 12:20:00+00:00, meeting_type=facetime, metadata={}, created_at=2025-05-18 11:12:10.769000+00:00, contact_id=None, id=f861a2c5-f1ca-4f00-91af-276bac7f326d, updated_at=2025-05-18 11:12:10.769000+00:00, booking_email=None
    - start_time=2025-05-20 12:00:00+00:00, end_time=2025-05-20 12:20:00+00:00, meeting_type=facetime, metadata={}, created_at=2025-05-18 11:13:04.323000+00:00, contact_id=None, id=feccbea8-6a8f-44d8-9f9d-cf468b55bc0c, updated_at=2025-05-18 11:13:04.323000+00:00, booking_email=None
    - start_time=2025-05-20 12:00:00+00:00, end_time=2025-05-20 12:20:00+00:00, meeting_type=facetime, metadata={}, created_at=2025-05-18 11:13:07.009000+00:00, contact_id=None, id=40f2b6ab-51ba-4c50-844c-6d9ff3db52d2, updated_at=2025-05-18 11:13:07.009000+00:00, booking_email=None
    - start_time=2025-05-21 08:00:00+00:00, end_time=2025-05-21 08:20:00+00:00, meeting_type=facetime, metadata={}, created_at=2025-05-18 11:29:28.739000+00:00, contact_id=None, id=4c0d2868-f99d-4156-b92e-4e7a97fd1153, updated_at=2025-05-18 11:29:28.739000+00:00, booking_email=None

📁 Tabell: pending_changes
  • booking_id (uuid)
  • processed (boolean)
  • created_at (timestamp with time zone)
  • payload (jsonb)
  • id (uuid)
  • record_id (uuid)
  • table_name (text)
  • operation (text)
  • change_type (text)
  • direction (text)
  🔑 [p] pending_changes_pkey: PRIMARY KEY (id)
  🔑 [f] fk_pending_changes_booking_id: FOREIGN KEY (booking_id) REFERENCES bookings(id) ON DELETE CASCADE
  🧪 Topp 5 rader:
    - id=7d417b09-6288-490b-a73c-3f3b2792817e, table_name=contact, record_id=c4e2d9dd-545e-4e05-99fe-16d377a87698, change_type=INSERT, direction=out, processed=False, created_at=2025-05-16 09:40:53.307336+00:00, operation=INSERT, payload={'id': 'c4e2d9dd-545e-4e05-99fe-16d377a87698', 'email': None, 'metadata': {'city': '', 'phone': '0709561480', 'address': '', 'company': 'AnyNode', 'country': '', 'last_name': 'Källberg', 'first_name': 'Daniel', 'postal_code': ''}, 'created_at': '2025-05-16T09:40:53.307336+00:00', 'updated_at': '2025-05-16T09:40:53.307336+00:00', 'booking_email': 'daniel@anynode.se'}, booking_id=None
    - id=6463cae5-e1e8-4899-903b-feccaf981229, table_name=bookings, record_id=378a6541-8e61-465d-a37d-6242ba770dc7, change_type=INSERT, direction=out, processed=False, created_at=2025-05-18 10:48:56.394310+00:00, operation=INSERT, payload={'id': '378a6541-8e61-465d-a37d-6242ba770dc7', 'end_time': '2025-05-20T08:20:00+00:00', 'metadata': {}, 'contact_id': None, 'created_at': '2025-05-18T10:48:56.39+00:00', 'start_time': '2025-05-20T08:00:00+00:00', 'updated_at': '2025-05-18T10:48:56.39+00:00', 'meeting_type': 'facetime', 'booking_email': None}, booking_id=378a6541-8e61-465d-a37d-6242ba770dc7
    - id=62176d8e-90ff-48d9-bfe6-9375995dede3, table_name=bookings, record_id=378a6541-8e61-465d-a37d-6242ba770dc7, change_type=INSERT, direction=cloud_to_local, processed=False, created_at=2025-05-18 10:48:56.440000+00:00, operation=None, payload=None, booking_id=378a6541-8e61-465d-a37d-6242ba770dc7
    - id=c6553a94-29ae-4721-b381-898f78f0d67c, table_name=bookings, record_id=f861a2c5-f1ca-4f00-91af-276bac7f326d, change_type=INSERT, direction=out, processed=False, created_at=2025-05-18 11:12:10.772513+00:00, operation=INSERT, payload={'id': 'f861a2c5-f1ca-4f00-91af-276bac7f326d', 'end_time': '2025-05-20T12:20:00+00:00', 'metadata': {}, 'contact_id': None, 'created_at': '2025-05-18T11:12:10.769+00:00', 'start_time': '2025-05-20T12:00:00+00:00', 'updated_at': '2025-05-18T11:12:10.769+00:00', 'meeting_type': 'facetime', 'booking_email': None}, booking_id=f861a2c5-f1ca-4f00-91af-276bac7f326d
    - id=4d1006a6-2ff8-4c60-a573-e2091d5d3917, table_name=bookings, record_id=f861a2c5-f1ca-4f00-91af-276bac7f326d, change_type=INSERT, direction=cloud_to_local, processed=False, created_at=2025-05-18 11:12:10.803000+00:00, operation=None, payload=None, booking_id=f861a2c5-f1ca-4f00-91af-276bac7f326d

📁 Tabell: contact
  • metadata (jsonb)
  • created_at (timestamp with time zone)
  • id (uuid)
  • updated_at (timestamp with time zone)
  • booking_email (text)
  • email (text)
  🔑 [p] contact_pkey: PRIMARY KEY (id)
  🧪 Topp 5 rader:
    - metadata={'city': '', 'phone': '0709561480', 'address': '', 'company': 'AnyNode', 'country': '', 'last_name': 'Källberg', 'first_name': 'Daniel', 'postal_code': ''}, created_at=2025-05-16 09:40:53.307336+00:00, id=c4e2d9dd-545e-4e05-99fe-16d377a87698, booking_email=daniel@anynode.se, updated_at=2025-05-16 09:40:53.307336+00:00, email=None
    - metadata={'city': 'Stockholm', 'address': 'Maria Skolgata 79A', 'postal_code': '118 53'}, created_at=2025-05-18 12:32:42.290134+00:00, id=14e1bef9-2833-40d5-b4fe-7576f7cffd6c, booking_email=None, updated_at=2025-05-18 12:32:42.290134+00:00, email=daniel@anynode.se

📁 Tabell: booking_settings
  • value (jsonb)
  • updated_at (timestamp with time zone)
  • key (text)
  • value_type (text)
  🧪 Topp 5 rader:
    - key=max_days_in_advance, value=30, value_type=int, updated_at=2025-04-23 12:48:49.778155+00:00
    - key=buffer_between_meetings, value=15, value_type=int, updated_at=2025-04-23 12:48:49.778155+00:00
    - key=max_weekly_booking_minutes, value=360, value_type=int, updated_at=2025-04-23 12:48:49.778155+00:00
    - key=default_office_address, value=Maria Skolgata 79A, 118 53 Stockholm, value_type=string, updated_at=2025-04-23 12:48:49.778155+00:00
    - key=fallback_travel_time_minutes, value=90, value_type=int, updated_at=2025-04-23 12:48:49.778155+00:00

📁 Tabell: translation
  • key (character varying)
  • sv (text)
  • en (text)
  🧪 Topp 5 rader:
    - key=error_min_duration_fysiskt_kund, sv=Mötestiden för 'Fysiskt hos kund' måste vara minst {{minutes}} minuter. Du visste det redan., en=The meeting time for 'On-site at customer' must be at least {{minutes}} minutes. You knew that.
    - key=error_min_duration_fysiskt_mig, sv=Mötestiden för 'Fysiskt hos mig' måste vara minst {{minutes}} minuter. Annars hinner vi bara säga hej., en=The meeting time for 'At my office' must be at least {{minutes}} minutes. Otherwise, we’ll only have time to say hello.
    - key=email_body_booking_received, sv=Hej {{name}}! Vi har tagit emot din bokning för {{meeting_type}} mellan {{start_time}} och {{end_time}}. Ingen panik – vi återkommer med bekräftelse. / Daniel, en=Hello {{name}}, We’ve received your booking for {{meeting_type}} between {{start_time}} and {{end_time}}. No need to panic – we’ll confirm shortly. / Daniel
    - key=email_body_booking_confirmed, sv=Hej {{name}}! Din bokning för {{meeting_type}} mellan {{start_time}} och {{end_time}} är nu spikad. Ser fram emot det! / Daniel, en=Hello {{name}}, Your booking for {{meeting_type}} between {{start_time}} and {{end_time}} is now locked in. Looking forward! / Daniel
    - key=email_body_booking_cancelled, sv=Hej {{name}}! Din bokning för {{meeting_type}} mellan {{start_time}} och {{end_time}} är avbokad. Hör av dig om du vill hitta en ny tid. / Daniel, en=Hello {{name}}, Your booking for {{meeting_type}} between {{start_time}} and {{end_time}} has been cancelled. Let me know if you'd like a new one. / Daniel

