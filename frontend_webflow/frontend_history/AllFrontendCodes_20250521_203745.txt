ğŸ“‚ KODTRÃ„D
==========
â”œâ”€â”€ frontend_webflow
â”‚   â”œâ”€â”€ Embed Block 1.js
â”‚   â”œâ”€â”€ Embed Block 2.js
â”‚   â”œâ”€â”€ Embed Block 3.js
==========

====================
ğŸ“„ Fil: frontend_webflow/Embed Block 1.js
ğŸ“‚ Kodtyp: ğŸ“„ Ã–vrigt
ğŸ—‚ Filtyp: ğŸŸ¨ JavaScript
ğŸ“… Senast Ã¤ndrad: 2025-05-15 14:29:48
ğŸ“ Antal rader: 638
ğŸ§© Antal funktioner: 14
ğŸ’¬ KommentarstÃ¤ckning: 38 rader (6.0%)
ğŸ“¥ Imports: 0 â€“ Inga
ğŸ” LÃ¤ngsta funktion: 34 rader
ğŸ§  KomplexitetspoÃ¤ng: 63
ğŸ§ª TODO/FIXME: 0
====================
START: Embed Block 1.js
<script>
  // Ã…terstÃ¤ller formulÃ¤rstate (mÃ¶testyp, mÃ¶testid, tider, clt_ready)
  function resetFormState() {
    console.log('ğŸ”„ Ã…terstÃ¤ller formulÃ¤rstate');
    const fieldsToClear = [
      'clt_meetingtype',
      'clt_meetinglength',
      'clt_ready'
    ];
    fieldsToClear.forEach(id => {
      const el = document.getElementById(id);
      if (el) el.value = '';
    });

    const meetingRadios = document.querySelectorAll('input[name="meeting_type"]');
    meetingRadios.forEach(r => r.checked = false);
    const lengthRadios = document.querySelectorAll('input[name="meeting_length"]');
    lengthRadios.forEach(r => r.checked = false);

    const slotContainer = document.getElementById('time_slot_select');
    if (slotContainer) slotContainer.innerHTML = '';
    const slotGroup = document.getElementById('time_slot_group');
    if (slotGroup) slotGroup.style.display = 'none';
  }

  // Kontrollerar e-post och triggar laddning av mÃ¶testyper och validering.
  function validateEmail() {
    console.log('ğŸ” validateEmail() kÃ¶rs');
    const emailEl = document.querySelector('#booking_email');
    const email = emailEl ? emailEl.value.trim() : '';
    const cltEmail = document.getElementById('clt_email');
    if (cltEmail) {
      cltEmail.value = email;
      console.log('ğŸ“¥ Satt #clt_email:', email);
    }
    if (email.length > 0 && email.includes('@')) {
      loadMeetingTypes();
      resetFormState();
      // LÃ¤gg till logg direkt efter anropet
      console.log('ğŸ§ª Validering och mÃ¶testyper triggat, vÃ¤ntar pÃ¥ meeting_type_select');
      const typeGroup = document.getElementById('meeting_type_group');
      if (typeGroup) {
        typeGroup.style.display = 'block';
        console.log('âœ… Visar #meeting_type_group via style.display');
      }
    } else {
      console.log('âŒ Ogiltig e-post, laddar inte mÃ¶testyper');
    }
  }

  // Laddar mÃ¶testyper och lÃ¤ngder frÃ¥n backend och renderar radioknappar.
  async function loadMeetingTypes() {
    console.log('ğŸ” loadMeetingTypes() kÃ¶rs');
    try {
      const res = await fetch('https://macspotbackend.azurewebsites.net/api/meeting_types');
      if (!res.ok) throw new Error('Failed to fetch meeting types');
      const { types, lengths: loadedLengths } = await res.json();
      window.lengths = {};
      Object.entries(loadedLengths || {}).forEach(([key, val]) => {
        window.lengths[key.toLowerCase()] = val;
      });
      console.log('ğŸ“¡ HÃ¤mtade mÃ¶testyper och lÃ¤ngder:', types, window.lengths);
      console.log('ğŸ“Š MÃ¶testyper:', types);
      console.log('ğŸ“Š LÃ¤ngder per typ:', window.lengths);

      const container = document.getElementById('meeting_type_select');
      if (!container) {
        console.warn('âš ï¸ #meeting_type_select saknas i DOM');
        return;
      }
      container.innerHTML = '';

      function createRadio({ name, value, label, checked, onChange }) {
        const div = document.createElement('div');
        div.className = 'radio-button-items';
        const labelEl = document.createElement('label');
        labelEl.className = 'radio-button-items';
        const input = document.createElement('input');
        input.type = 'radio';
        input.name = name;
        input.value = value;
        input.className = 'radio-button-items';
        // Ingen radioknapp ska fÃ¶rvÃ¤ljas eller klickas automatiskt
        if (typeof onChange === 'function') input.addEventListener('change', onChange);
        labelEl.appendChild(input);
        const text = document.createElement('span');
        text.textContent = ` ${label}`;
        text.style.display = 'block';
        text.style.marginLeft = '10px';
        text.style.marginTop = '-20px';
        text.style.lineHeight = '1.4';
        text.style.paddingLeft = '8px';
        labelEl.appendChild(text);
        div.appendChild(labelEl);
        return div;
      }

      (Array.isArray(types) ? types : JSON.parse(types)).forEach((type, index) => {
        const value = type.toLowerCase();
        const displayNames = {
          zoom: 'Digitalt via Zoom',
          facetime: 'Digitalt via FaceTime',
          teams: 'Digitalt via Teams',
          atclient: 'MÃ¶te hos dig (ange din adress)',
          atoffice: 'MÃ¶te pÃ¥ mitt kontor i Stockholm'
        };
        const label = displayNames[value] || type;
        const radio = createRadio({
          name: 'meeting_type',
          value,
          label,
          checked: false,
          onChange: () => {
            console.log('ğŸ”„ MÃ¶testyp Ã¤ndrad till:', value);
            renderMeetingLengths(value);
            validateAndRenderCustomerFields();
          }
        });
        container.appendChild(radio);
      });

      const renderedRadios = container.querySelectorAll('input[name="meeting_type"]');
      if (renderedRadios.length === 0) {
        console.warn('âš ï¸ Inga mÃ¶testyper renderades â€“ kontrollera types-data');
      }

      const typeGroup = document.getElementById('meeting_type_group');
      if (typeGroup) {
        typeGroup.classList.remove('hidden');
        typeGroup.classList.add('visible-group');
        console.log('âœ… Visar #meeting_type_group');
      }

    } catch (err) {
      console.error('âŒ Error loading meeting types:', err);
      const container = document.getElementById('meeting_type_group');
      if (container) {
        container.innerHTML = '<p style="color: red;">Kunde inte ladda mÃ¶testyper - skyll inte pÃ¥ mig utan pÃ¥ Bill Gates.</p>';
      }
    }
  }

  // Renderar lÃ¤ngdalternativ beroende pÃ¥ mÃ¶testyp.
  function renderMeetingLengths(type) {
    console.log('ğŸ” renderMeetingLengths() kÃ¶rs fÃ¶r typ:', type);
    const slotContainer = document.getElementById('time_slot_select');
    if (!slotContainer) {
      console.warn('âš ï¸ #time_slot_select saknas i DOM');
      return;
    }
    slotContainer.innerHTML = '';
    const values = (window.lengths && window.lengths[type]) ? window.lengths[type] : [90];
    console.log(`â± Renderar ${values.length} tider fÃ¶r ${type}`);

    function createLengthRadio(value, checked) {
      const div = document.createElement('div');
      div.className = 'radio-button-items';
      const labelEl = document.createElement('label');
      labelEl.className = 'radio-button-items';
      const input = document.createElement('input');
      input.type = 'radio';
      input.name = 'meeting_length';
      input.value = value;
      input.className = 'radio-button-items';
      if (checked) input.checked = true;
      input.addEventListener('change', () => {
        console.log('ğŸ”„ MÃ¶teslÃ¤ngd Ã¤ndrad till:', value);
        const cltMeetingLength = document.getElementById('clt_meetinglength');
        if (cltMeetingLength) {
          cltMeetingLength.value = value;
          console.log('ğŸ“¥ Satt #clt_meetinglength:', value);
          // Kopiera radioknappens mÃ¶testyp till #clt_meetingtype om mÃ¶jligt
          const cltMeetingType = document.getElementById('clt_meetingtype');
          const meetingTypeEl = document.querySelector('input[name="meeting_type"]:checked');
          if (cltMeetingType && meetingTypeEl) {
            cltMeetingType.value = meetingTypeEl.value;
            console.log('ğŸ“¥ BekrÃ¤ftat #clt_meetingtype frÃ¥n radioknapp:', cltMeetingType.value);
          }
        }
        validateAndRenderCustomerFields();
      });
      labelEl.appendChild(input);
      const span = document.createElement('span');
      span.textContent = ` ${value} min`;
      span.className = 'radio-label-text';
      labelEl.appendChild(span);
      div.appendChild(labelEl);
      return div;
    }

    values.forEach((value, idx) => {
      slotContainer.appendChild(createLengthRadio(value, false));
    });

    const wrapper = document.getElementById('time_slot_group');
    if (wrapper) wrapper.classList.add('visible-group');

    const slotGroup = document.getElementById('time_slot_group');
    if (slotGroup) {
      slotGroup.classList.remove('hidden');
      slotGroup.classList.add('visible-group');
      console.log('âœ… Visar #time_slot_group');
      slotGroup.style.display = 'block';
      console.log('âœ… Visar #time_slot_group via style.display');
    }

  }

  // Validerar kontaktuppgifter mot backend och renderar nÃ¶dvÃ¤ndiga kontaktfÃ¤lt.
  async function validateAndRenderCustomerFields() {
    // DÃ¶ljer alltid submit-knappen i bÃ¶rjan av valideringen
    const submitButton = document.getElementById('contact-update-button');
    if (submitButton) submitButton.style.display = 'none';
    console.log('ğŸ” validateAndRenderCustomerFields() kÃ¶rs');
    const emailEl = document.querySelector('#booking_email');
    const email = emailEl ? emailEl.value.trim() : '';
    const meetingTypeEl = document.querySelector('input[name="meeting_type"]:checked');
    const meetingType = meetingTypeEl ? meetingTypeEl.value : '';
    const meetingLengthEl = document.querySelector('input[name="meeting_length"]:checked');
    const meetingLength = meetingLengthEl ? meetingLengthEl.value : '';

    const cltEmail = document.getElementById('clt_email');
    const cltMeetingType = document.getElementById('clt_meetingtype');
    const cltMeetingLength = document.getElementById('clt_meetinglength');
    const cltReady = document.getElementById('clt_ready');
    const cltContactId = document.getElementById('clt_contact_id');
    const addressField = document.querySelector('#address_fields');
    if (!meetingType || !meetingLength) {
      console.log('â³ VÃ¤ntar pÃ¥ mÃ¶testyp och mÃ¶testid innan validering av namn');
      return;
    }
    // Om email eller mÃ¶testyp saknas, gÃ¶m fÃ¤lt och knapp
    if (!email || !meetingType) {
      console.log('âš ï¸ E-post eller mÃ¶testyp saknas, gÃ¶mmer fÃ¤lt och knapp');
      const allFields = ['first_name', 'last_name', 'phone', 'company', 'address', 'postal_code', 'city', 'country'].map(id => document.getElementById(id)).filter(Boolean);
      allFields.forEach(f => {
        f.classList.add('hidden');
        f.classList.remove('needs-filling');
      });
      if (addressField) addressField.classList.add('hidden');
      if (submitButton) submitButton.style.display = 'none';
      if (cltReady) cltReady.value = 'false';
      return;
    }
    try {
      const url = 'https://macspotbackend.azurewebsites.net/api/validate_contact';
      const response = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, meeting_type: meetingType })
      });
      const data = await response.json();
      console.log('ğŸ“¡ validate_contact status:', response.status);
      console.log('ğŸ” API-svar â€“ sÃ¶ker contact_id:', data);

      // --- LOGGAR: KontrollmÃ¶testyp och clt-fÃ¤lt ---
      console.log('ğŸ“‹ KontrollmÃ¶testyp:', meetingType);
      console.log('ğŸ“Š Kontroll clt-fÃ¤lt:', {
        cltEmail: cltEmail?.value,
        cltMeetingType: cltMeetingType?.value,
        cltMeetingLength: cltMeetingLength?.value,
        cltContactId: cltContactId?.value,
        cltReady: cltReady?.value
      });

      await fetchAndUpdateCustomerState(email, meetingType);
      updateCustomerFieldVisibilityAndState(data, meetingType);
    } catch (err) {
      console.error('âŒ Fel vid validering av kontakt:', err);
    }
  }

  // Kontrollera att validateEmail() kopplas vid input
  document.addEventListener('DOMContentLoaded', () => {
    // SÃ¤tt clt_ready till 'false' vid sidladdning
    const cltReady = document.getElementById('clt_ready');
    if (cltReady) cltReady.value = 'false';

    const emailEl = document.querySelector('#booking_email');
    if (emailEl) {
      emailEl.addEventListener('input', validateEmail);
      console.log('âœ… Lyssnare pÃ¥ #booking_email aktiverad');
    } else {
      console.warn('âš ï¸ #booking_email hittades inte vid DOMContentLoaded');
    }
    // LÃ¤gg till lyssnare pÃ¥ alla kontaktfÃ¤lt sÃ¥ att validateAndRenderCustomerFields() kÃ¶rs vid input
    [
      'first_name', 'last_name', 'phone', 'company', 'address', 'postal_code', 'city', 'country', 'clt_contact_id'
    ].forEach(id => {
      const el = document.getElementById(id);
      if (el) {
        el.addEventListener('input', () => {
          validateAndRenderCustomerFields();
        });
      }
    });
    console.log('âœ… Lyssnare pÃ¥ kontaktfÃ¤lt aktiverad');
    // GÃ¶m alltid kontaktknappen initialt vid sidladdning
    const submitButton = document.getElementById('contact-update-button');
    if (submitButton) {
      submitButton.style.display = 'none';
      submitButton.textContent = '';
      console.log('ğŸš« GÃ¶mmer kontaktknapp vid sidladdning och nollstÃ¤ller text');
    }

    // LÃ¤gg till click-lyssnare pÃ¥ #contact-update-button som POSTar till /validate_contact (write_if_valid)
    if (submitButton) {
      submitButton.addEventListener('click', async (e) => {
        // --- DEBUGLOGGAR: visar exakt vad som finns tillgÃ¤ngligt vid klicktillfÃ¤llet ---
        console.log('ğŸ§ª Knappklick mottaget.');
        console.log('ğŸ§ª Knappetikett:', submitButton.textContent);
        console.log('ğŸ§ª window.formState:', window.formState);
        // LÃ¤gg till loggning av varje relevant fÃ¤lt:
        ['first_name', 'last_name', 'phone', 'company', 'address', 'postal_code', 'city', 'country'].forEach(id => {
          const el = document.getElementById(id);
          console.log(`ğŸ§ª ${id}:`, el?.value || '(tomt)');
        });
        console.log('ğŸ§ª clt_ready:', document.getElementById('clt_ready')?.value);
        // -------------------------------------------------------------------------------
        e.preventDefault();
        const label = submitButton.tagName === 'INPUT' ? submitButton.value : submitButton.textContent;
        if (!['Skapa', 'Uppdatera'].includes(label)) {
          console.warn('âš ï¸ Avbryter klick â€“ ogiltig knappetikett:', label);
          return;
        }

        if (!window.formState) {
          const metadata = {};
          ['first_name', 'last_name', 'phone', 'company', 'address', 'postal_code', 'city', 'country'].forEach(id => {
            const el = document.getElementById(id);
            metadata[id] = el?.value || '';
          });

          const emailEl = document.querySelector('#booking_email');
          const meetingTypeEl = document.querySelector('input[name="meeting_type"]:checked');
          const meetingLengthEl = document.querySelector('input[name="meeting_length"]:checked');
          const contactIdEl = document.getElementById('clt_contact_id');

          window.formState = {
            email: emailEl?.value.trim() || '',
            meeting_type: meetingTypeEl?.value || '',
            meeting_length: parseInt(meetingLengthEl?.value || '90', 10),
            contact_id: contactIdEl?.value || '',
            metadata
          };
          console.log('ğŸ“¥ Ã…terskapade window.formState vid klick:', window.formState);
        }

        const body = {
          email: window.formState.email,
          meeting_type: window.formState.meeting_type,
          metadata: window.formState.metadata,
          write_if_valid: true
        };

        try {
          console.log('ğŸ“¤ Skickar kontaktdata till /validate_contact (write_if_valid)', body);
          const res = await fetch('https://macspotbackend.azurewebsites.net/api/validate_contact', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
          });
          const result = await res.json();
          console.log('âœ… Kontaktdata sparad via validate_contact:', result);
          // --- NY LOGIK: SÃ¤tt clt_contact_id och trigga slot-fetch om contact_id finns ---
          if (result.contact_id) {
            const cltContactId = document.getElementById('clt_contact_id');
            if (cltContactId) cltContactId.value = result.contact_id;

            if (window.formState) {
              window.formState.contact_id = result.contact_id;
            }

            const cltReady = document.getElementById('clt_ready');
            if (cltReady) cltReady.value = 'true';

            if (window.initAvailableSlotFetch) {
              window.initAvailableSlotFetch();
              console.log('ğŸ“¡ initAvailableSlotFetch() anropad frÃ¥n Skapa/Uppdatera');
            }
            // --- LÃ¤gg till validateAndRenderCustomerFields() efter skapande/uppdatering ---
            validateAndRenderCustomerFields();
            console.log('ğŸ” KÃ¶r validateAndRenderCustomerFields() efter skapande');
            // DÃ¶lj knappen efter lyckad uppdatering
            submitButton.style.display = 'none';
            submitButton.style.opacity = '0';
            submitButton.style.pointerEvents = 'none';
            submitButton.style.visibility = 'hidden';
            console.log('ğŸš« GÃ¶mmer kontaktknapp efter att kunden skapats');
          }
        } catch (err) {
          console.error('âŒ Misslyckades spara kontaktdata:', err);
        }
      });
    }
  });

  // --- Nya funktioner fÃ¶r API-anrop och fÃ¤lthantering ---
  async function fetchAndUpdateCustomerState(email, meetingType) {
    const cltEmail = document.getElementById('clt_email');
    const cltMeetingType = document.getElementById('clt_meetingtype');
    const cltMeetingLength = document.getElementById('clt_meetinglength');
    const cltContactId = document.getElementById('clt_contact_id');

    if (cltEmail) cltEmail.value = email;
    if (cltMeetingType) {
      cltMeetingType.value = meetingType;
      console.log('ğŸ“¥ Satt cltMeetingType frÃ¥n fetchAndUpdateCustomerState:', cltMeetingType.value);
    }

    const response = await fetch('https://macspotbackend.azurewebsites.net/api/validate_contact', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, meeting_type: meetingType })
    });
    const data = await response.json();

    const idFromResponse = [data.contact_id, data.id].find(v => typeof v === 'string' && v.length > 10) || '';
    if (cltContactId) cltContactId.value = idFromResponse;

    return data;
  }

  function updateCustomerFieldVisibilityAndState(data, meetingType) {
    const submitButton = document.getElementById('contact-update-button');
    // DÃ¶lj submit-knappen direkt efter den definierats
    if (submitButton) {
      submitButton.style.display = 'none';
      submitButton.style.opacity = '0';
      submitButton.style.pointerEvents = 'none';
      submitButton.style.visibility = 'hidden';
    }
    const cltEmail = document.getElementById('clt_email');
    const cltMeetingType = document.getElementById('clt_meetingtype');
    const cltMeetingLength = document.getElementById('clt_meetinglength');
    const cltContactId = document.getElementById('clt_contact_id');
    const cltReady = document.getElementById('clt_ready');
    const emailEl = document.querySelector('#booking_email');
    const meetingLengthEl = document.querySelector('input[name="meeting_length"]:checked');
    const meetingLength = meetingLengthEl ? meetingLengthEl.value : '';
    const addressField = document.querySelector('#address_fields');
    const allFieldIds = ['first_name', 'last_name', 'phone', 'company', 'address', 'postal_code', 'city', 'country'];
    const fieldLabels = {
      first_name: 'FÃ¶rnamn',
      last_name: 'Efternamn',
      phone: 'Telefonnummer',
      company: 'FÃ¶retag',
      address: 'Gatuadress',
      postal_code: 'Postnummer',
      city: 'Stad',
      country: 'Land'
    };
    const allFields = allFieldIds.map(id => document.getElementById(id)).filter(Boolean);
    const missingFieldsContainer = document.getElementById('missing_fields_messages');
    if (missingFieldsContainer) missingFieldsContainer.innerHTML = '';

    // DÃ¶ljer alla kontaktfÃ¤lt och address_fields
    allFields.forEach(f => {
      f.classList.add('hidden');
      f.classList.remove('needs-filling');
      f.style.display = 'none';
    });
    if (addressField) addressField.style.display = 'none';

    // Visa alltid dessa fÃ¤lt om kunden Ã¤r ny eller har missing_fields
    const alwaysShow = ['first_name', 'last_name', 'phone', 'company'];
    allFields.forEach(input => {
      const fieldName = input.id;
      const isAddressField = ['address', 'postal_code', 'city', 'country'].includes(fieldName);
      const shouldShow = data.status === 'new_customer' && alwaysShow.includes(fieldName);
      const isMissing = data.missing_fields && data.missing_fields.includes(fieldName);
      const showField = shouldShow || isMissing;
      if (showField) {
        input.classList.remove('hidden');
        input.classList.add('needs-filling');
        input.style.display = 'block';
        if (missingFieldsContainer && isMissing) {
          const p = document.createElement('p');
          p.className = 'missing-field-message';
          p.textContent = `Saknat fÃ¤lt: ${fieldLabels[fieldName] || fieldName}`;
          missingFieldsContainer.appendChild(p);
        }
      }
    });

    // Visa #address_fields om meetingType === 'atclient' och (ny kund eller nÃ¥gon adress i missing_fields)
    const addressFieldIds = ['address', 'postal_code', 'city', 'country'];
    const addressRequired =
      meetingType === 'atclient' &&
      (
        data.status === 'new_customer' ||
        (data.missing_fields && addressFieldIds.some(id => data.missing_fields.includes(id)))
      );
    if (addressRequired && addressField) {
      addressField.style.display = 'block';
      console.log('âœ… Visar #address_fields pga atclient + ny kund eller missing_fields');
    }

    // Visa knapp baserat pÃ¥ status och om alla synliga fÃ¤lt Ã¤r ifyllda
    if (submitButton) {
      if (data.status === 'new_customer') {
        submitButton.style.display = 'flex';
        submitButton.style.opacity = '1';
        submitButton.style.pointerEvents = 'auto';
        submitButton.style.visibility = 'visible';
        if (submitButton.tagName === 'INPUT') {
          submitButton.value = 'Skapa';
        } else {
          submitButton.textContent = 'Skapa';
        }
        console.log('ğŸ†• Ny kund â€“ visa "Skapa" knapp');
      } else if (data.status === 'existing_customer' && Array.isArray(data.missing_fields) && data.missing_fields.length > 0) {
        submitButton.style.display = 'flex';
        submitButton.style.opacity = '1';
        submitButton.style.pointerEvents = 'auto';
        submitButton.style.visibility = 'visible';
        if (submitButton.tagName === 'INPUT') {
          submitButton.value = 'Uppdatera';
        } else {
          submitButton.textContent = 'Uppdatera';
        }
        console.log('âœï¸ Befintlig kund med saknade fÃ¤lt â€“ visa "Uppdatera" knapp');
      } else {
        // submitButton already hidden above
        console.log('âœ… Befintlig kund komplett â€“ gÃ¶m knapp');
      }
    }

    // Kontrollera att alla dolda fÃ¤lt Ã¤r ifyllda
    const allCltFieldsFilled =
      cltEmail && String(cltEmail.value).trim() &&
      cltMeetingType && String(cltMeetingType.value).trim() &&
      cltMeetingLength && String(cltMeetingLength.value).trim() &&
      cltContactId && typeof cltContactId.value === 'string' && cltContactId.value.trim();
    if (!allCltFieldsFilled) {
      // Specifik logg nÃ¤r cltContactId.value saknas
      if (!cltContactId || !cltContactId.value.trim()) {
        console.warn('âš ï¸ clt_ready = false p.g.a: cltContactId.value saknas', {
          cltEmail: cltEmail?.value,
          cltMeetingType: cltMeetingType?.value,
          cltMeetingLength: cltMeetingLength?.value,
          cltContactId: cltContactId?.value
        });
      } else {
        console.warn('âš ï¸ clt_ready = false p.g.a: clt-fÃ¤lt saknas â€“ detaljer:', {
          cltEmail: cltEmail?.value,
          cltMeetingType: cltMeetingType?.value,
          cltMeetingLength: cltMeetingLength?.value,
          cltContactId: cltContactId?.value
        });
      }
    }
    console.log('ğŸ§ª Kontroll av clt-fÃ¤lt:',
      {
        cltEmail: cltEmail?.value,
        cltMeetingType: cltMeetingType?.value,
        cltMeetingLength: cltMeetingLength?.value,
        cltContactId: cltContactId?.value
      }
    );

    // Kontrollera att alla synliga kontaktfÃ¤lt Ã¤r ifyllda
    // AnvÃ¤nd getComputedStyle fÃ¶r att sÃ¤kert avgÃ¶ra synlighet
    const visibleInputs = allFields.filter(el => el && window.getComputedStyle(el).display !== 'none');
    const allVisibleContactFieldsFilled = visibleInputs.every(input => input.value.trim());
    visibleInputs.forEach(input => {
      console.log(`ğŸ” Synligt fÃ¤lt: #${input.id} = "${input.value.trim()}"`);
    });

    if (allCltFieldsFilled && allVisibleContactFieldsFilled) {
      if (cltReady) {
        cltReady.value = 'true';
        // SÃ¤tt window.formState sÃ¥ att det alltid finns vid knapptryckning
        window.formState = {
          email: emailEl ? emailEl.value.trim() : '',
          meeting_type: meetingType,
          meeting_length: parseInt(meetingLength, 10),
          contact_id: cltContactId?.value || '',
          metadata: {
            first_name: document.getElementById('first_name')?.value || '',
            last_name: document.getElementById('last_name')?.value || '',
            phone: document.getElementById('phone')?.value || '',
            company: document.getElementById('company')?.value || '',
            address: document.getElementById('address')?.value || '',
            postal_code: document.getElementById('postal_code')?.value || '',
            city: document.getElementById('city')?.value || '',
            country: document.getElementById('country')?.value || ''
          }
        };
        // LÃ¤gg till kÃ¤lla fÃ¶r formState
        window.formState.source = 'frontend';
        // DÃ¶ljer submit-knappen direkt nÃ¤r clt_ready = true (skapande/uppdatering klar)
        if (submitButton) {
          submitButton.style.display = 'none';
          submitButton.style.opacity = '0';
          submitButton.style.pointerEvents = 'none';
          submitButton.style.visibility = 'hidden';
          console.log('ğŸš« GÃ¶mmer knapp efter skapande eller uppdatering');
        }
        console.log('âœ… formState satt:', window.formState);
        console.log('âœ… Alla kund- och kontaktfÃ¤lt ifyllda, satt #clt_ready = true');
        // KOPPLAR Block 1 till Block 2: initiera slot-fetch om funktionen finns
        if (window.initAvailableSlotFetch) {
          window.initAvailableSlotFetch();
          console.log('ğŸ“¡ initAvailableSlotFetch() anropad frÃ¥n Block 1');
        } else {
          console.warn('âš ï¸ initAvailableSlotFetch() saknas â€“ se till att Block 2 Ã¤r laddad');
          setTimeout(() => {
            if (window.initAvailableSlotFetch) {
              window.initAvailableSlotFetch();
              console.log('ğŸ“¡ initAvailableSlotFetch() kÃ¶rdes via fallback');
            } else {
              console.warn('âŒ initAvailableSlotFetch() saknas fortfarande efter timeout');
            }
          }, 500);
        }
      }
    } else {
      const debugMissing = [];
      if (!allCltFieldsFilled) debugMissing.push('clt-fÃ¤lt saknas');
      if (!allVisibleContactFieldsFilled) debugMissing.push('synliga kontaktfÃ¤lt saknas');
      console.warn('âš ï¸ clt_ready = false p.g.a:', debugMissing.join(' + '));
      if (cltReady) {
        cltReady.value = 'false';
        console.log('âš ï¸ Saknas ifyllda kontaktfÃ¤lt, satt #clt_ready = false');
      }
    }

    // LÃ¤gg till logg fÃ¶r slutstatus fÃ¶r clt-fÃ¤lt
    console.log('ğŸ§ª Slutstatus clt-fÃ¤lt:', {
      clt_email: cltEmail?.value,
      clt_meetingtype: cltMeetingType?.value,
      clt_meetinglength: cltMeetingLength?.value,
      clt_contact_id: cltContactId?.value,
      clt_ready: cltReady?.value
    });
  }
</script>
END: Embed Block 1.js

====================
ğŸ“„ Fil: frontend_webflow/Embed Block 2.js
ğŸ“‚ Kodtyp: ğŸ“„ Ã–vrigt
ğŸ—‚ Filtyp: ğŸŸ¨ JavaScript
ğŸ“… Senast Ã¤ndrad: 2025-05-21 20:36:22
ğŸ“ Antal rader: 103
ğŸ§© Antal funktioner: 0
ğŸ’¬ KommentarstÃ¤ckning: 7 rader (6.8%)
ğŸ“¥ Imports: 0 â€“ Inga
ğŸ” LÃ¤ngsta funktion: 0 rader
ğŸ§  KomplexitetspoÃ¤ng: 7
ğŸ§ª TODO/FIXME: 0
====================
START: Embed Block 2.js
<script>
window.CalendarModule = {
  renderCalendar: function(groupedSlots, firstDate) {
    // Calendar rendering logic
    console.log('Rendering calendar with slots:', groupedSlots, 'starting from:', firstDate);
    // Implementation details...
  },
  renderTimes: function(times) {
    // Times rendering logic
    console.log('Rendering times:', times);
    // Implementation details...
  },
  highlightDate: function(date) {
    // Highlight date logic
    console.log('Highlighting date:', date);
    // Implementation details...
  },
  initAvailableSlotFetch: function() {
    const cltReady = document.getElementById('clt_ready')?.value;
    if (cltReady !== 'true' || !window.formState) {
      console.warn('âŒ Kan inte hÃ¤mta tillgÃ¤ngliga tider â€“ formState eller clt_ready saknas');
      return;
    }

    console.log('ğŸ“¡ HÃ¤mtar tillgÃ¤ngliga tider fÃ¶r:', window.formState);
    if (!window.formState.contact_id) {
      console.warn('âš ï¸ contact_id saknas i formState â€“ fetch avbryts');
    }

    fetch('https://macspotbackend.azurewebsites.net/api/getavailableslots', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        email: window.formState.email,
        meeting_type: window.formState.meeting_type,
        meeting_length: window.formState.meeting_length,
        contact_id: window.formState.contact_id
      })
    })
    .then(res => res.json())
    .then(data => {
      console.log('ğŸ§ª RÃ¥tt slotData frÃ¥n API:', data);
      if (!Array.isArray(data.slots)) {
        console.warn('âš ï¸ API svarar utan slot-array:', data);
      }
      if (Array.isArray(data.slots)) {
        const grouped = {};
        data.slots.forEach(slot => {
          const localDate = new Date(slot.slot_iso);
          const localYear = localDate.getFullYear();
          const localMonth = String(localDate.getMonth() + 1).padStart(2, '0');
          const localDay = String(localDate.getDate()).padStart(2, '0');
          const date = `${localYear}-${localMonth}-${localDay}`;
          if (!grouped[date]) grouped[date] = [];
          grouped[date].push({
            slot_iso: slot.slot_iso,
            slot_local: slot.slot_local || slot.slot_iso
          });
        });
        console.log('ğŸ“¦ Skickar grouped slots till renderCalendar:', grouped);
        if (typeof window.CalendarModule.renderCalendar === 'function') {
          const firstDateStr = Object.keys(grouped).sort()[0];
          const firstDate = new Date(firstDateStr);
          window.CalendarModule.renderCalendar(grouped, firstDate);
        }
      }
    })
    .catch(err => {
      console.error('âŒ Fetch error in getavailableslots:', err.message || err);
      alert('Fel vid hÃ¤mtning av tider. Kontrollera din internetanslutning eller att servern Ã¤r tillgÃ¤nglig.');
    });
  }
};

window.getISOWeek = function(date) {
  var target = new Date(date.valueOf());
  var dayNr = (date.getDay() + 6) % 7;
  target.setDate(target.getDate() - dayNr + 3);
  var firstThursday = target.valueOf();
  target.setMonth(0, 1);
  if (target.getDay() !== 4) {
    target.setMonth(0, 1 + ((4 - target.getDay()) + 7) % 7);
  }
  return 1 + Math.ceil((firstThursday - target) / 604800000);
};

// Inserted CSS
const style = document.createElement('style');
style.innerHTML = `
  .calendar-wrapper {
    font-family: Arial, sans-serif;
  }
  .calendar-day {
    padding: 5px;
    cursor: pointer;
  }
  .calendar-day.highlighted {
    background-color: #007BFF;
    color: white;
  }
`;
document.head.appendChild(style);
</script>
END: Embed Block 2.js

====================
ğŸ“„ Fil: frontend_webflow/Embed Block 3.js
ğŸ“‚ Kodtyp: ğŸ“„ Ã–vrigt
ğŸ—‚ Filtyp: ğŸŸ¨ JavaScript
ğŸ“… Senast Ã¤ndrad: 2025-05-16 09:15:38
ğŸ“ Antal rader: 93
ğŸ§© Antal funktioner: 3
ğŸ’¬ KommentarstÃ¤ckning: 0 rader (0.0%)
ğŸ“¥ Imports: 0 â€“ Inga
ğŸ” LÃ¤ngsta funktion: 5 rader
ğŸ§  KomplexitetspoÃ¤ng: 10
ğŸ§ª TODO/FIXME: 0
====================
START: Embed Block 3.js
<script>
  async function submitBooking(data) {
    if (!data.contact_id || !data.slot_iso || !data.meeting_type || !data.meeting_length) {
      return;
    }

    const startTime = new Date(data.slot_iso);
    const endTime = new Date(startTime.getTime() + data.meeting_length * 60000);

    const payload = {
      contact_id: data.contact_id,
      meeting_type: data.meeting_type,
      meeting_length: data.meeting_length,
      start_time: startTime.toISOString(),
      end_time: endTime.toISOString(),
      slot_iso: data.slot_iso
    };

    try {
      const response = await fetch('https://macspotbackend.azurewebsites.net/api/bookings', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      if (!response.ok) {
        const errorData = await response.json();
        alert('Bokningen misslyckades: ' + (errorData?.error || 'okÃ¤nt fel'));
        return;
      }

      alert('Tack! Din bokning Ã¤r genomfÃ¶rd.');
    } catch (error) {
      alert('Fel vid bokning, fÃ¶rsÃ¶k igen senare.');
    }
  }
  if (typeof window.submitBooking !== 'function') {
    window.submitBooking = submitBooking;
  }

  function initBookingButtonListener() {
    const btn = document.getElementById('submit-booking-button');
    if (!btn) return;

    btn.addEventListener('click', (e) => {
      e.preventDefault();

      const cltReadyEl = document.getElementById('clt_ready');
      const cltContactIdEl = document.getElementById('clt_contact_id');
      const cltMeetingTypeEl = document.getElementById('clt_meetingtype');
      const cltMeetingLengthEl = document.getElementById('clt_meetinglength');
      const cltSlotIsoEl = document.getElementById('clt_meetingtime');

      const cltContactId = cltContactIdEl?.value.trim();
      const cltMeetingType = cltMeetingTypeEl?.value.trim();
      const cltMeetingLength = parseInt(cltMeetingLengthEl?.value, 10);
      const cltSlotIso = cltSlotIsoEl?.value.trim();
      const cltReady = cltReadyEl?.value.trim();

      if (!cltContactId || !cltMeetingType || isNaN(cltMeetingLength) || !cltSlotIso || cltReady !== 'true') {
        return;
      }

      const bookingPayload = {
        contact_id: cltContactId,
        meeting_type: cltMeetingType,
        meeting_length: cltMeetingLength,
        slot_iso: cltSlotIso
      };

      submitBooking(bookingPayload);
    });
  }
  if (typeof window.initBookingButtonListener !== 'function') {
    window.initBookingButtonListener = initBookingButtonListener;
  }

  window.addEventListener('DOMContentLoaded', () => {
    try {
      if (document.getElementById('calendar_grid')) {
        initBookingButtonListener();
      } else {
        const interval = setInterval(() => {
          if (document.getElementById('calendar_grid')) {
            clearInterval(interval);
            initBookingButtonListener();
          }
        }, 100);
      }
    } catch (err) {
    }
  });
</script>
END: Embed Block 3.js

ğŸ“ KONFIGURATIONSFILER (function.json / host.json / package.json / .funcignore)
====================================

ğŸ“„ .funcignore
   # Exclude dev-only files and folders
   .git
   .vscode
   .env
   *.log
   test/
   tests/
   
   # Explicitly include all required files and folders
   !host.json
   !package.json
   !package-lock.json
   
   !node_modules/
   !node_modules/**
   
   !shared/
   !shared/**
   
   !bookings/
   !bookings/**
   !getavailableslots/
   !getavailableslots/**
   !validate_contact/
   !validate_contact/**
   !meeting_types/
   !meeting_types/**
   !refreshCalendarOrigins/
   !refreshCalendarOrigins/**
   !refreshTravelTimes/
   !refreshTravelTimes/**
ğŸ“„ bookings/function.json
   {
     "bindings": [
       {
         "authLevel": "anonymous",
         "type": "httpTrigger",
         "direction": "in",
         "name": "req",
         "methods": ["post", "options"],
         "route": "bookings"
       },
       {
         "type": "http",
         "direction": "out",
         "name": "res"
       }
     ],
     "scriptFile": "index.js"
   }
ğŸ“„ getavailableslots/function.json
   {
     "bindings": [
       {
         "authLevel": "anonymous",
         "type": "httpTrigger",
         "direction": "in",
         "name": "req",
         "methods": ["post", "options"],
         "route": "getavailableslots"
       },
       {
         "type": "http",
         "direction": "out",
         "name": "res"
       }
     ],
     "scriptFile": "index.js"
   }
ğŸ“„ host.json
   {
     "version": "2.0",
     "extensionBundle": {
       "id": "Microsoft.Azure.Functions.ExtensionBundle",
       "version": "[4.*, 5.0.0)"
     },
     "extensions": {
       "http": {
         "cors": {
           "allowedOrigins": [
             "https://www.klrab.se"
           ],
           "supportCredentials": false
         }
       }
     }
   }
ğŸ“„ meeting_types/function.json
   {
     "bindings": [
       {
         "authLevel": "anonymous",
         "type": "httpTrigger",
         "direction": "in",
         "name": "req",
         "methods": [ "get" ],
         "route": "meeting_types"
       },
       {
         "type": "http",
         "direction": "out",
         "name": "res"
       }
     ],
     "scriptFile": "index.js"
   }
ğŸ“„ package.json
   {
     "name": "macspot-api",
     "version": "1.0.0",
     "description": "Azure Functions backend fÃ¶r MacSpot CRM/ERP",
     "scripts": {
       "start": "func start",
       "dev": "func start --verbose",
       "deploy": "func azure functionapp publish macspotbackend",
       "build": "echo 'Nothing to build'"
     },
     "dependencies": {
       "@azure/functions": "^4.7.0",
       "@azure/msal-node": "^3.5.1",
       "@microsoft/microsoft-graph-client": "^3.0.0",
       "dav": "^1.8.0",
       "dotenv": "^16.5.0",
       "isomorphic-fetch": "^3.0.0",
       "jsonwebtoken": "^9.0.0",
       "luxon": "^3.4.4",
       "node-fetch": "^2.7.0",
       "node-ical": "^0.20.1",
       "p-limit": "^6.2.0",
       "pg": "^8.15.6",
       "uuid": "^9.0.0",
       "xml2js": "^0.6.2"
     }
   }

ğŸ“„ refreshCalendarOrigins/function.json
   {
     "bindings": [
       {
         "name": "myTimer",
         "type": "timerTrigger",
         "direction": "in",
         "schedule": "0 0 * * * *"
       }
     ],
     "scriptFile": "index.js"
   }
ğŸ“„ refreshTravelTimes/function.json
   {
     "bindings": [
       {
         "name": "myTimer",
         "type": "timerTrigger",
         "direction": "in",
         "schedule": "0 0 * * * *"
       }
     ],
     "scriptFile": "index.js"
   }
ğŸ“„ validate_contact/function.json
   {
     "bindings": [
       {
         "authLevel": "anonymous",
         "type": "httpTrigger",
         "direction": "in",
         "name": "req",
         "methods": ["post"],
         "route": "validate_contact"
       },
       {
         "type": "http",
         "direction": "out",
         "name": "res"
       }
     ],
     "scriptFile": "index.js"
   }
ğŸ“ˆ SUMMERING AV ALLA JS-FILER
====================================
ğŸ“ Totalt antal rader kod: 834
ğŸ§© Totalt antal funktioner: 17
ğŸ§  Total komplexitetspoÃ¤ng: 80
ğŸ§ª Antal TODO/FIXME totalt: 0

ğŸ“Š Per fil:
fil,rader,funktioner,komplexitet,kommentarer,imports
Embed Block 1.js,638,14,63,38,0
Embed Block 2.js,103,0,7,7,0
Embed Block 3.js,93,3,10,0,0
